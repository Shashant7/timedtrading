//@version=6
indicator("TimedTrading Capture Candles (Multi-TF)", overlay=false, max_labels_count=500)

// Sends a compact multi-timeframe OHLCV snapshot to the Worker for charting in the Right Rail.
//
// Worker endpoint:
//   POST /timed/ingest-candles?key=YOUR_API_KEY
//
// Recommended setup:
// - Add this indicator to a chart (10m or 30m timeframe recommended)
// - Create an alert on this indicator with "Any alert() function call"
// - Webhook URL: https://YOUR-WORKER.workers.dev/timed/ingest-candles?key=YOUR_API_KEY

groupCapture = "Capture Settings"
scriptVersion = input.string("candles_1.0.0", "Script Version", group=groupCapture)
sendEveryBars = input.int(1, "Send every N bars", minval=1, maxval=24, group=groupCapture)

// Fetch OHLCV + bar close timestamp for a given timeframe.
f_candle(tf) =>
    [o, h, l, c, v, tc] = request.security(
         syminfo.tickerid,
         tf,
         [open, high, low, close, volume, time_close],
         barmerge.gaps_off,
         barmerge.lookahead_off
     )
    [o, h, l, c, v, tc]

[o10, h10, l10, c10, v10, t10] = f_candle("10")
[o30, h30, l30, c30, v30, t30] = f_candle("30")
[o60, h60, l60, c60, v60, t60] = f_candle("60")
[o240, h240, l240, c240, v240, t240] = f_candle("240")
[oD, hD, lD, cD, vD, tD] = f_candle("D")
[oW, hW, lW, cW, vW, tW] = f_candle("W")

f_num(x) => na(x) ? "null" : str.tostring(x)

// Build JSON payload.
// Notes:
// - `ts` is this script's bar time; per-TF bars use their own `time_close`.
payload =
    "{" +
      "\"script_version\":\"" + scriptVersion + "\"," +
      "\"ts\":" + str.tostring(time) + "," +
      "\"ticker\":\"" + syminfo.ticker + "\"," +
      "\"tf_candles\":{" +
        "\"10\":{" +
          "\"ts\":" + f_num(t10) + ",\"o\":" + f_num(o10) + ",\"h\":" + f_num(h10) + ",\"l\":" + f_num(l10) + ",\"c\":" + f_num(c10) + ",\"v\":" + f_num(v10) +
        "}," +
        "\"30\":{" +
          "\"ts\":" + f_num(t30) + ",\"o\":" + f_num(o30) + ",\"h\":" + f_num(h30) + ",\"l\":" + f_num(l30) + ",\"c\":" + f_num(c30) + ",\"v\":" + f_num(v30) +
        "}," +
        "\"60\":{" +
          "\"ts\":" + f_num(t60) + ",\"o\":" + f_num(o60) + ",\"h\":" + f_num(h60) + ",\"l\":" + f_num(l60) + ",\"c\":" + f_num(c60) + ",\"v\":" + f_num(v60) +
        "}," +
        "\"240\":{" +
          "\"ts\":" + f_num(t240) + ",\"o\":" + f_num(o240) + ",\"h\":" + f_num(h240) + ",\"l\":" + f_num(l240) + ",\"c\":" + f_num(c240) + ",\"v\":" + f_num(v240) +
        "}," +
        "\"D\":{" +
          "\"ts\":" + f_num(tD) + ",\"o\":" + f_num(oD) + ",\"h\":" + f_num(hD) + ",\"l\":" + f_num(lD) + ",\"c\":" + f_num(cD) + ",\"v\":" + f_num(vD) +
        "}," +
        "\"W\":{" +
          "\"ts\":" + f_num(tW) + ",\"o\":" + f_num(oW) + ",\"h\":" + f_num(hW) + ",\"l\":" + f_num(lW) + ",\"c\":" + f_num(cW) + ",\"v\":" + f_num(vW) +
        "}" +
      "}," +
      "\"ingest_kind\":\"candles\"" +
    "}"

// Emit at the chosen cadence on confirmed bars.
var int barCount = 0
if barstate.isconfirmed
    barCount += 1
    if (barCount % sendEveryBars) == 0
        alert(payload, alert.freq_once_per_bar_close)

