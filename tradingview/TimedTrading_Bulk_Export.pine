//@version=6
indicator("TimedTrading Bulk Historical Export", overlay=false)

// Exports historical OHLCV for ~40 tickers at once (batch mode).
// Pine limit: ~40 request.security() calls per script.
// 
// Usage:
// 1. Add to a Daily or Weekly chart
// 2. Set batch number (1-4) to export different ticker groups
// 3. Open Pine Editor Logs panel
// 4. Wait for "EXPORT COMPLETE"
// 5. Copy CSV from logs â†’ save to file
// 6. Repeat for batches 2, 3, 4
// 7. Upload all CSV files using: node scripts/upload-candles-csv.js <file>

groupExport = "Export Settings"
batchNum = input.int(1, "Batch number (1-4)", minval=1, maxval=4, group=groupExport)
lookbackBars = input.int(200, "Lookback bars", minval=50, maxval=500, group=groupExport)

// Split 159 tickers into 4 batches (~40 each)
// Batch 1: 0-39, Batch 2: 40-79, Batch 3: 80-119, Batch 4: 120-159
tickers = array.new<string>()

// Batch 1 (40 tickers)
if batchNum == 1
    array.push(tickers, "AAPL")
    array.push(tickers, "AEHR")
    array.push(tickers, "AGQ")
    array.push(tickers, "ALB")
    array.push(tickers, "ALLY")
    array.push(tickers, "AMD")
    array.push(tickers, "AMGN")
    array.push(tickers, "AMZN")
    array.push(tickers, "ANET")
    array.push(tickers, "APLD")
    array.push(tickers, "APP")
    array.push(tickers, "ASTS")
    array.push(tickers, "AU")
    array.push(tickers, "AVAV")
    array.push(tickers, "AVGO")
    array.push(tickers, "AWI")
    array.push(tickers, "AXON")
    array.push(tickers, "AXP")
    array.push(tickers, "AYI")
    array.push(tickers, "B")
    array.push(tickers, "BA")
    array.push(tickers, "BABA")
    array.push(tickers, "BE")
    array.push(tickers, "BK")
    array.push(tickers, "BMNR")
    array.push(tickers, "BRK-B")
    array.push(tickers, "BTCUSD")
    array.push(tickers, "BWXT")
    array.push(tickers, "CAT")
    array.push(tickers, "CCJ")
    array.push(tickers, "CDNS")
    array.push(tickers, "CLS")
    array.push(tickers, "COST")
    array.push(tickers, "CRWD")
    array.push(tickers, "CRWS")
    array.push(tickers, "CVX")
    array.push(tickers, "DE")
    array.push(tickers, "DHI")
    array.push(tickers, "DOV")
    array.push(tickers, "DY")

// Batch 2 (40 tickers)
if batchNum == 2
    array.push(tickers, "ELF")
    array.push(tickers, "EME")
    array.push(tickers, "EMR")
    array.push(tickers, "ENPH")
    array.push(tickers, "EOG")
    array.push(tickers, "ETHUSD")
    array.push(tickers, "EXPE")
    array.push(tickers, "FIX")
    array.push(tickers, "FSLR")
    array.push(tickers, "GDDY")
    array.push(tickers, "GE")
    array.push(tickers, "GEV")
    array.push(tickers, "GLD")
    array.push(tickers, "GLDJ")
    array.push(tickers, "GOOGL")
    array.push(tickers, "GS")
    array.push(tickers, "GWW")
    array.push(tickers, "HCA")
    array.push(tickers, "HD")
    array.push(tickers, "HOOD")
    array.push(tickers, "HPE")
    array.push(tickers, "HWM")
    array.push(tickers, "HYG")
    array.push(tickers, "IOT")
    array.push(tickers, "IR")
    array.push(tickers, "ITT")
    array.push(tickers, "JBHT")
    array.push(tickers, "JPM")
    array.push(tickers, "KLAC")
    array.push(tickers, "KO")
    array.push(tickers, "KVUE")
    array.push(tickers, "LIN")
    array.push(tickers, "LLY")
    array.push(tickers, "LMT")
    array.push(tickers, "LOW")
    array.push(tickers, "LRCX")
    array.push(tickers, "LUV")
    array.push(tickers, "MA")
    array.push(tickers, "MCK")
    array.push(tickers, "MELI")

// Batch 3 (40 tickers)
if batchNum == 3
    array.push(tickers, "META")
    array.push(tickers, "MLM")
    array.push(tickers, "MNST")
    array.push(tickers, "MP")
    array.push(tickers, "MRK")
    array.push(tickers, "MS")
    array.push(tickers, "MSFT")
    array.push(tickers, "MSI")
    array.push(tickers, "NEE")
    array.push(tickers, "NEU")
    array.push(tickers, "NFLX")
    array.push(tickers, "NKE")
    array.push(tickers, "NOC")
    array.push(tickers, "NOW")
    array.push(tickers, "NRG")
    array.push(tickers, "NVDA")
    array.push(tickers, "OKTA")
    array.push(tickers, "ONTO")
    array.push(tickers, "ORCL")
    array.push(tickers, "OXY")
    array.push(tickers, "PANW")
    array.push(tickers, "PATH")
    array.push(tickers, "PAYC")
    array.push(tickers, "PG")
    array.push(tickers, "PH")
    array.push(tickers, "PHM")
    array.push(tickers, "PLTR")
    array.push(tickers, "PSTG")
    array.push(tickers, "PWR")
    array.push(tickers, "QLYS")
    array.push(tickers, "QQQ")
    array.push(tickers, "REGN")
    array.push(tickers, "RGLD")
    array.push(tickers, "ROP")
    array.push(tickers, "RSI")
    array.push(tickers, "SLB")
    array.push(tickers, "SLV")
    array.push(tickers, "SMH")
    array.push(tickers, "SN")
    array.push(tickers, "SOFI")

// Batch 4 (39 tickers)
if batchNum == 4
    array.push(tickers, "SPY")
    array.push(tickers, "STZ")
    array.push(tickers, "SYK")
    array.push(tickers, "TDG")
    array.push(tickers, "TECK")
    array.push(tickers, "TEAM")
    array.push(tickers, "TJX")
    array.push(tickers, "TLT")
    array.push(tickers, "TMUS")
    array.push(tickers, "TPL")
    array.push(tickers, "TRGP")
    array.push(tickers, "TSLA")
    array.push(tickers, "TSM")
    array.push(tickers, "TT")
    array.push(tickers, "TXN")
    array.push(tickers, "UNH")
    array.push(tickers, "URI")
    array.push(tickers, "V")
    array.push(tickers, "VRT")
    array.push(tickers, "VST")
    array.push(tickers, "WELL")
    array.push(tickers, "WM")
    array.push(tickers, "WMT")
    array.push(tickers, "WSM")
    array.push(tickers, "WTS")
    array.push(tickers, "XOM")
    array.push(tickers, "AOS")
    array.push(tickers, "AEHR")
    array.push(tickers, "BLDR")
    array.push(tickers, "CMI")
    array.push(tickers, "ELV")
    array.push(tickers, "ETSY")
    array.push(tickers, "GDDY")
    array.push(tickers, "LNG")
    array.push(tickers, "MOH")
    array.push(tickers, "NEM")
    array.push(tickers, "ODFL")
    array.push(tickers, "WAL")
    array.push(tickers, "ZTS")

tf = timeframe.period
n = array.size(tickers)

// Export on last bar
if barstate.islast
    log.info("=== BULK EXPORT START ===")
    log.info("Batch: " + str.tostring(batchNum) + " | TF: " + tf + " | Tickers: " + str.tostring(n))
    log.info("ticker,tf,ts,o,h,l,c,v")
    
    for i = 0 to math.min(n - 1, 39)
        sym = array.get(tickers, i)
        
        // Fetch historical bars for this ticker
        oData = request.security(sym, tf, open, lookahead=barmerge.lookahead_off)
        hData = request.security(sym, tf, high, lookahead=barmerge.lookahead_off)
        lData = request.security(sym, tf, low, lookahead=barmerge.lookahead_off)
        cData = request.security(sym, tf, close, lookahead=barmerge.lookahead_off)
        vData = request.security(sym, tf, volume, lookahead=barmerge.lookahead_off)
        tData = request.security(sym, tf, time_close, lookahead=barmerge.lookahead_off)
        
        // Export current bar
        if not na(oData) and not na(tData)
            row = sym + "," + tf + "," + str.tostring(tData) + "," + str.tostring(oData) + "," + str.tostring(hData) + "," + str.tostring(lData) + "," + str.tostring(cData) + "," + (na(vData) ? "" : str.tostring(vData))
            log.info(row)
    
    log.info("=== BATCH " + str.tostring(batchNum) + " COMPLETE ===")
