---
description: Price data pipeline, display consistency, and TwelveData integration rules
alwaysApply: true
---

# Price Data Pipeline

## Data Provider: TwelveData
- Primary provider is TwelveData (`DATA_PROVIDER=twelvedata`). Alpaca is used for execution and historical backfill.
- `parseTdQuote()` in `worker/twelvedata.js` MUST parse all native fields from `/quote?prepost=true`: `change`, `percent_change`, `extended_change`, `extended_percent_change`, `extended_price`, `is_market_open`.
- Price feed cron jobs MUST prefer TwelveData's native change fields over manual `price - prevClose` computation.

## KV Price Format (`timed:prices`)
- Short keys: `p` (price), `pc` (prev close), `dc` (day change $), `dp` (day change %), `dh`/`dl`/`dv` (daily high/low/volume), `t` (timestamp).
- Extended hours: `ahp` (extended price), `ahdc` (AH change $), `ahdp` (AH change %).
- Session-aware persistence using `isNyRegularMarketOpen()` (handles holidays, weekends, early closes):
  - **Market closed**: Preserve previous `dc`/`dp`/`pc` when TwelveData zeros them out (day-roll). Preserve `ahp`/`ahdc`/`ahdp` so EXT movers row stays visible.
  - **Market open (RTH)**: Let fresh values flow through. Zeros clear AH fields, hiding the EXT row. Daily change resets naturally for the new day.

## Frontend: Single Source of Truth
- `getDailyChange(t)` in `react-app/shared-price-utils.js` is the ONLY way to compute daily change. Returns `{ dayPct, dayChg }`.
- Every page showing daily change MUST import `shared-price-utils.js` and use `getDailyChange()`. NEVER use raw `t.dailyChgPct` or inline computation.
- Server endpoints returning ticker data MUST include field aliases (`prev_close`, `day_change_pct`, `day_change`) so getDailyChange's fallback chain works.
- Applies to: Cards (index-react.html), Right Rail, Open Trades Table (trades page), Investor Dashboard, Top Movers bar.

## RTH/ETH Movers
- Top Gainers/Losers has two rows: RTH (intraday, `getDailyChange(t).dayPct`) and EXT (extended hours, `_ah_change_pct`).
- **Market open**: EXT row auto-hides (AH fields cleared during RTH).
- **Market closed**: EXT row shows last-known data, persists overnight/weekends/holidays.
- Crypto tickers (BTCUSD, ETHUSD) are excluded from the EXT row (24/7 markets, no session distinction).

## Admin Gating & Attribution
- All live price/change data is gated behind `window._ttIsAdmin`. Non-admin users do not see prices.
- Footer MUST include "Market data powered by Twelve Data" for licensing compliance.
