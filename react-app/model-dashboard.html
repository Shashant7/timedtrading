<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timed Trading â€” Model Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="auth-gate.js?v=20260219a"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      body { font-family: "Inter", system-ui, sans-serif; background: #0b0e11; color: #e5e7eb; -webkit-font-smoothing: antialiased; letter-spacing: -0.01em; }
      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes pulse-badge {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.15); }
      }
      .card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; }
      .badge-bull { background: rgba(16, 185, 129, 0.15); color: #6ee7b7; }
      .badge-bear { background: rgba(244, 63, 94, 0.15); color: #fca5a5; }
      .badge-neutral { background: rgba(255,255,255,0.05); color: #d6d3d1; }
      .badge-degraded { background: rgba(251, 191, 36, 0.15); color: #fcd34d; }
      .badge-active { background: rgba(56, 189, 248, 0.12); color: #93c5fd; }
      .btn { padding: 6px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
      .btn-approve { background: #065f46; color: #6ee7b7; border: 1px solid #059669; }
      .btn-approve:hover { background: #047857; }
      .btn-reject { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
      .btn-reject:hover { background: #991b1b; }
      .btn-secondary { background: #334155; color: #94a3b8; border: 1px solid #475569; }
      .btn-secondary:hover { background: #475569; }
      .tab-active { border-bottom: 2px solid #10b981; color: #e8eaf0; }
      .tab-inactive { border-bottom: 2px solid transparent; color: #626b7d; }
      .tab-inactive:hover { color: #9098a8; }
      /* Admin-only nav links: hidden for non-admin users */
      body:not([data-user-role="admin"]) a[data-admin-only] {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback } = React;
const API_BASE = "";  // same-origin â€” proxied by Pages Function
// Auth via CF Access JWT cookie (sent automatically with credentials: "include")

// â”€â”€â”€ Data Hooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function useModelData() {
  const [health, setHealth] = useState(null);
  const [signals, setSignals] = useState(null);
  const [patterns, setPatterns] = useState([]);
  const [proposals, setProposals] = useState([]);
  const [predictions, setPredictions] = useState([]);
  const [retro, setRetro] = useState(null);
  const [dirAccuracy, setDirAccuracy] = useState(null);
  const [loading, setLoading] = useState(true);
  const [lastRefresh, setLastRefresh] = useState(null);

  const fetchAll = useCallback(async () => {
    setLoading(true);
    try {
      const [hRes, sRes, pRes, chRes, predRes, retroRes, daRes] = await Promise.all([
        fetch(`${API_BASE}/timed/model/health`).then(r => r.json()),
        fetch(`${API_BASE}/timed/model/signals`).then(r => r.json()),
        fetch(`${API_BASE}/timed/model/patterns?status=active`).then(r => r.json()),
        fetch(`${API_BASE}/timed/model/changelog?status=proposed&limit=30`).then(r => r.json()),
        fetch(`${API_BASE}/timed/model/predictions?limit=20`).then(r => r.json()),
        fetch(`${API_BASE}/timed/model/retrospective`).then(r => r.json()).catch(() => null),
        fetch(`${API_BASE}/timed/model/direction-accuracy?limit=100`).then(r => r.json()).catch(() => null),
      ]);
      if (hRes.ok) setHealth(hRes);
      if (sRes.ok) setSignals(sRes);
      if (pRes.ok) setPatterns(pRes.patterns || []);
      if (chRes.ok) setProposals(chRes.changes || []);
      if (predRes.ok) setPredictions(predRes.predictions || []);
      if (retroRes?.ok) setRetro(retroRes);
      if (daRes?.ok) setDirAccuracy(daRes);
      setLastRefresh(new Date());
    } catch (e) {
      console.error("Failed to fetch model data:", e);
    }
    setLoading(false);
  }, []);

  useEffect(() => { fetchAll(); }, [fetchAll]);

  return { health, signals, patterns, proposals, predictions, retro, dirAccuracy, loading, lastRefresh, refresh: fetchAll };
}

// â”€â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function NavHeader() {
  const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);
  const UserBadge = window.TimedUserBadge;
  const storedUser = window.TimedAuthHelpers?.getStoredSession();
  return (
    <nav className="sticky top-0 z-50 border-b border-white/[0.06]" style={{background:"rgba(10,10,15,0.95)",backdropFilter:"blur(12px)"}}>
      <div className="flex items-center justify-between px-4 py-2.5">
        <div className="flex items-center gap-3 md:gap-5 min-w-0">
          <a href="index-react.html" className="flex items-center gap-2 no-underline shrink-0">
            <div className="w-[28px] h-[28px] md:w-[32px] md:h-[32px] rounded-[8px] flex items-center justify-center" style={{background:"linear-gradient(135deg, #00c853, #00e676, #69f0ae)"}}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                <polyline points="16 7 22 7 22 13" />
              </svg>
            </div>
            <span className="text-[14px] md:text-[15px] font-bold text-white hidden sm:inline" style={{letterSpacing:"-0.03em"}}>Timed Trading</span>
          </a>
          <div className="hidden lg:flex items-center gap-0.5">
            <a href="index-react.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Active Trader</a>
            <a href="investor-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Investor</a>
            <a href="simulation-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Trades</a>
            <a href="model-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-white bg-white/[0.07] font-medium">Model</a>
            <a href="calibration.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Calibration</a>
            <a href="screener.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Screener</a>
            <a href="ticker-management.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Tickers</a>
            <a href="daily-brief.html" id="nav-daily-brief" className="relative px-3 py-1 rounded-md text-[13px] text-[#f59e0b]/80 hover:text-[#f59e0b] hover:bg-[#f59e0b]/[0.06] transition-all font-medium">
              Daily Brief
              <span id="brief-badge" className="hidden absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full bg-[#f59e0b]" style={{animation: "pulse-badge 2s ease-in-out infinite"}} />
            </a>
          </div>
        </div>
        <div className="flex items-center gap-2 md:gap-3 shrink-0">
          <span className="hidden sm:inline text-[11px] text-[#4b5563]">Self-Learning v1</span>
          {window.TimedNotificationCenter && <window.TimedNotificationCenter apiBase="" />}
          {UserBadge && <UserBadge user={storedUser} compact />}
          <button onClick={() => setMobileMenuOpen(v => !v)} className="lg:hidden p-1.5 rounded-md text-[#6b7280] hover:text-white hover:bg-white/[0.06] transition-all" aria-label="Toggle menu">
            {mobileMenuOpen ? (
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            ) : (
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            )}
          </button>
        </div>
      </div>
      {mobileMenuOpen && (
        <div className="lg:hidden border-t border-white/[0.06] px-4 py-2 flex flex-col gap-0.5" style={{background:"rgba(10,10,15,0.98)"}}>
          <a href="index-react.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Active Trader</a>
          <a href="investor-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Investor</a>
          <a href="simulation-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Trades</a>
          <a href="model-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-white bg-white/[0.07] font-medium" onClick={() => setMobileMenuOpen(false)}>Model</a>
          <a href="calibration.html" data-admin-only="true" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Calibration</a>
          <a href="screener.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Screener</a>
          <a href="ticker-management.html" data-admin-only="true" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Tickers</a>
          <a href="daily-brief.html" className="px-3 py-2 rounded-md text-[13px] text-[#f59e0b]/80 hover:text-[#f59e0b] hover:bg-[#f59e0b]/[0.06] transition-all font-medium" onClick={() => setMobileMenuOpen(false)}>Daily Brief</a>
          <div className="border-t border-white/[0.06] mt-1 pt-1 flex items-center gap-2">
            <a href="/faq.html" className="px-3 py-2 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">FAQ</a>
            <a href="mailto:support@timed-trading.com" className="px-3 py-2 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Contact</a>
          </div>
        </div>
      )}
    </nav>
  );
}

function StatCard({ label, value, sub, color }) {
  return (
    <div className="card p-4">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-1">{label}</div>
      <div className={`text-2xl font-bold ${color || "text-white"}`}>{value}</div>
      {sub && <div className="text-xs text-slate-500 mt-1">{sub}</div>}
    </div>
  );
}

function MarketRegimeCard({ market }) {
  if (!market) return null;
  const regimeColors = {
    STRONG_BULL: "text-[#00e676]",
    MILD_BULL: "text-[#69f0ae]",
    NEUTRAL: "text-slate-300",
    MILD_BEAR: "text-red-300",
    STRONG_BEAR: "text-red-400",
  };
  return (
    <div className="card p-5">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-2">Market Regime</div>
      <div className={`text-3xl font-bold ${regimeColors[market.signal] || "text-white"}`}>
        {market.signal?.replace(/_/g, " ")}
      </div>
      <div className="mt-3 grid grid-cols-3 gap-3 text-sm">
        <div>
          <span className="text-slate-400">Breadth</span>
          <div className="font-semibold text-[#00e676]">{market.breadthBullPct}% Bull</div>
        </div>
        <div>
          <span className="text-slate-400">Tickers</span>
          <div className="font-semibold">{market.totalTickers}</div>
        </div>
        <div>
          <span className="text-slate-400">Bear</span>
          <div className="font-semibold text-red-400">{market.bearish}</div>
        </div>
      </div>
      {market.riskFlag && (
        <div className="mt-3 p-2 rounded-lg bg-amber-900/30 border border-amber-700/50 text-amber-300 text-xs">
          {market.riskFlag}
        </div>
      )}
    </div>
  );
}

function SectorTable({ sectors }) {
  if (!sectors || sectors.length === 0) return null;
  return (
    <div className="card p-4">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Sector Signals</div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="text-slate-500 text-xs">
              <th className="text-left py-1 pr-4">Sector</th>
              <th className="text-right py-1 px-2">Total</th>
              <th className="text-right py-1 px-2">Bull</th>
              <th className="text-right py-1 px-2">Bear</th>
              <th className="text-right py-1 px-2">Breadth</th>
              <th className="text-left py-1 pl-3">Regime</th>
            </tr>
          </thead>
          <tbody>
            {sectors.map(s => (
              <tr key={s.sector} className="border-t border-white/[0.06]/50">
                <td className="py-1.5 pr-4 font-medium">{s.sector}</td>
                <td className="text-right py-1.5 px-2 text-slate-400">{s.total}</td>
                <td className="text-right py-1.5 px-2 text-[#00e676]">{s.bullish}</td>
                <td className="text-right py-1.5 px-2 text-red-400">{s.bearish}</td>
                <td className="text-right py-1.5 px-2">{s.breadthBullPct}%</td>
                <td className="py-1.5 pl-3">
                  <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                    s.regime === "BULLISH" ? "badge-bull" : s.regime === "BEARISH" ? "badge-bear" : "badge-neutral"
                  }`}>{s.regime}</span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function TickerSignals({ tickers }) {
  if (!tickers || tickers.length === 0) return null;
  const bull = tickers.filter(t => t.direction === "BULLISH").slice(0, 15);
  const bear = tickers.filter(t => t.direction === "BEARISH").slice(0, 15);
  return (
    <div className="card p-4">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Ticker Signals</div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <div className="text-xs font-semibold text-[#00e676] mb-2">BULLISH ({bull.length})</div>
          <div className="space-y-1">
            {bull.map(t => (
              <div key={t.ticker} className="flex items-center justify-between text-xs bg-[#00c853]/20 rounded px-2 py-1">
                <span className="font-semibold">{t.ticker}</span>
                <span className="text-slate-400">{t.state?.replace("HTF_","").replace("LTF_","")}</span>
                <span className="text-[#00e676]">+{t.netSignal.toFixed(2)}</span>
              </div>
            ))}
          </div>
        </div>
        <div>
          <div className="text-xs font-semibold text-red-400 mb-2">BEARISH ({bear.length})</div>
          <div className="space-y-1">
            {bear.length === 0 ? (
              <div className="text-xs text-slate-500 italic">No bearish signals currently</div>
            ) : bear.map(t => (
              <div key={t.ticker} className="flex items-center justify-between text-xs bg-red-900/20 rounded px-2 py-1">
                <span className="font-semibold">{t.ticker}</span>
                <span className="text-slate-400">{t.state?.replace("HTF_","").replace("LTF_","")}</span>
                <span className="text-red-400">{t.netSignal.toFixed(2)}</span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

function PatternLibrary({ patterns }) {
  if (!patterns || patterns.length === 0) return null;
  return (
    <div className="card p-4">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Pattern Library ({patterns.length} active)</div>
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="text-slate-500 text-xs">
              <th className="text-left py-1 pr-3">Pattern</th>
              <th className="text-left py-1 px-2">Dir</th>
              <th className="text-right py-1 px-2">Hit Rate</th>
              <th className="text-right py-1 px-2">N</th>
              <th className="text-right py-1 px-2">EV</th>
              <th className="text-right py-1 px-2">Conf</th>
              <th className="text-left py-1 pl-2">Status</th>
            </tr>
          </thead>
          <tbody>
            {patterns.map(p => (
              <tr key={p.pattern_id} className="border-t border-white/[0.06]/50">
                <td className="py-1.5 pr-3 font-medium text-xs">{p.name}</td>
                <td className="py-1.5 px-2">
                  <span className={`px-1.5 py-0.5 rounded text-xs font-semibold ${
                    p.expected_direction === "UP" ? "badge-bull" : p.expected_direction === "DOWN" ? "badge-bear" : "badge-neutral"
                  }`}>{p.expected_direction || "â€”"}</span>
                </td>
                <td className="text-right py-1.5 px-2">{(p.hit_rate * 100).toFixed(0)}%</td>
                <td className="text-right py-1.5 px-2 text-slate-400">{p.sample_count}</td>
                <td className={`text-right py-1.5 px-2 ${p.expected_value > 0 ? "text-[#00e676]" : p.expected_value < 0 ? "text-red-400" : ""}`}>
                  {p.expected_value > 0 ? "+" : ""}{p.expected_value}
                </td>
                <td className="text-right py-1.5 px-2">{(p.confidence * 100).toFixed(0)}%</td>
                <td className="py-1.5 pl-2">
                  <span className={`px-1.5 py-0.5 rounded text-xs font-semibold ${
                    p.status === "active" ? "badge-active" : p.status === "degraded" ? "badge-degraded" : "badge-neutral"
                  }`}>{p.status}</span>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function ProposalsPanel({ proposals, onRefresh }) {
  const [processing, setProcessing] = useState({});

  async function handleAction(changeId, action) {
    setProcessing(prev => ({ ...prev, [changeId]: action }));
    try {
      const res = await fetch(`${API_BASE}/timed/admin/model-approve?change_id=${encodeURIComponent(changeId)}&action=${action}`, { method: "POST", credentials: "include" });
      const data = await res.json();
      if (data.ok) {
        onRefresh();
      } else {
        alert(`Failed: ${data.error}`);
      }
    } catch (e) {
      alert(`Error: ${e.message}`);
    }
    setProcessing(prev => { const n = {...prev}; delete n[changeId]; return n; });
  }

  if (!proposals || proposals.length === 0) {
    return (
      <div className="card p-4">
        <div className="text-xs text-slate-400 uppercase tracking-wide mb-2">Pending Proposals</div>
        <div className="text-sm text-slate-500 italic">No pending proposals</div>
      </div>
    );
  }

  return (
    <div className="card p-4">
      <div className="flex items-center justify-between mb-3">
        <div className="text-xs text-slate-400 uppercase tracking-wide">
          Pending Proposals ({proposals.length})
        </div>
      </div>
      <div className="space-y-2">
        {proposals.map(p => (
          <div key={p.change_id} className="bg-slate-800/50 rounded-lg p-3 border border-white/[0.06]/50">
            <div className="flex items-start justify-between gap-2">
              <div className="flex-1">
                <span className={`inline-block px-1.5 py-0.5 rounded text-xs font-semibold mr-2 ${
                  p.change_type.includes("degrade") ? "badge-bear" :
                  p.change_type.includes("promote") ? "badge-bull" :
                  p.change_type.includes("add") ? "badge-active" :
                  "badge-neutral"
                }`}>{p.change_type}</span>
                <span className="text-xs text-slate-300">{p.description}</span>
              </div>
              <div className="flex gap-1 shrink-0">
                <button
                  className="btn btn-approve text-xs"
                  disabled={!!processing[p.change_id]}
                  onClick={() => handleAction(p.change_id, "approve")}
                >
                  {processing[p.change_id] === "approve" ? "..." : "Approve"}
                </button>
                <button
                  className="btn btn-reject text-xs"
                  disabled={!!processing[p.change_id]}
                  onClick={() => handleAction(p.change_id, "reject")}
                >
                  {processing[p.change_id] === "reject" ? "..." : "Reject"}
                </button>
              </div>
            </div>
            <div className="text-xs text-slate-500 mt-1">
              {new Date(p.proposed_at).toLocaleDateString()} {new Date(p.proposed_at).toLocaleTimeString()}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function RecentPredictions({ predictions }) {
  if (!predictions || predictions.length === 0) {
    return (
      <div className="card p-4">
        <div className="text-xs text-slate-400 uppercase tracking-wide mb-2">Recent Predictions</div>
        <div className="text-sm text-slate-500 italic">No predictions logged yet. Predictions will appear after the next market session.</div>
      </div>
    );
  }
  return (
    <div className="card p-4">
      <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Recent Predictions ({predictions.length})</div>
      <div className="space-y-1">
        {predictions.map(p => (
          <div key={p.prediction_id} className="flex items-center justify-between text-xs bg-slate-800/50 rounded px-3 py-2">
            <span className="font-semibold w-16">{p.ticker}</span>
            <span className={`px-1.5 py-0.5 rounded font-semibold ${p.direction === "UP" ? "badge-bull" : "badge-bear"}`}>
              {p.direction}
            </span>
            <span className="text-slate-400">{p.trigger_type}</span>
            <span className="text-slate-400">{p.state?.replace("HTF_","").replace("LTF_","")}</span>
            <span className={`font-semibold ${p.resolved ? "text-slate-400" : "text-blue-400"}`}>
              {p.resolved ? "Resolved" : "Open"}
            </span>
            <span className="text-slate-500 w-20 text-right">{new Date(p.ts).toLocaleDateString()}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€ Learning Loop Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function LearningLoopPanel({ retro, dirAccuracy }) {
  const overall = retro?.overall || {};
  const bySource = retro?.by_source || [];
  const byPath = retro?.by_path || [];
  const pathPerf = retro?.path_performance || [];
  const summary = dirAccuracy?.summary || {};
  const recentTrades = (dirAccuracy?.records || []).slice(0, 30);

  return (
    <div className="space-y-6">
      {/* Overall Accuracy */}
      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <StatCard label="Total Closed" value={overall.total || 0} sub={`${overall.wins || 0}W / ${overall.losses || 0}L`} />
        <StatCard
          label="Direction Accuracy"
          value={summary.accuracy || "N/A"}
          sub={`${summary.correct || 0} correct / ${summary.incorrect || 0} wrong`}
          color={parseFloat(summary.accuracy) > 55 ? "text-[#00e676]" : parseFloat(summary.accuracy) > 40 ? "text-amber-400" : "text-red-400"}
        />
        <StatCard label="Avg Win" value={overall.avg_win_pct != null ? `${overall.avg_win_pct}%` : "â€”"} color="text-[#00e676]" />
        <StatCard label="Avg Loss" value={overall.avg_loss_pct != null ? `${overall.avg_loss_pct}%` : "â€”"} color="text-red-400" />
        <StatCard label="Avg PnL" value={overall.avg_pnl_pct != null ? `${overall.avg_pnl_pct}%` : "â€”"}
          color={overall.avg_pnl_pct > 0 ? "text-[#00e676]" : overall.avg_pnl_pct < 0 ? "text-red-400" : "text-white"} />
      </div>

      {/* Direction Source Accuracy */}
      {bySource.length > 0 && (
        <div className="card p-4">
          <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Accuracy by Direction Source</div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead><tr className="text-slate-500 text-xs">
                <th className="text-left py-1 pr-3">Source</th>
                <th className="text-right py-1 px-2">Trades</th>
                <th className="text-right py-1 px-2">Correct</th>
                <th className="text-right py-1 px-2">Wrong</th>
                <th className="text-right py-1 px-2">Accuracy</th>
                <th className="text-right py-1 px-2">Avg PnL%</th>
              </tr></thead>
              <tbody>
                {bySource.map(s => {
                  const acc = s.total > 0 ? ((s.correct / s.total) * 100).toFixed(1) : "â€”";
                  return (
                    <tr key={s.direction_source} className="border-t border-white/[0.04]">
                      <td className="py-1.5 pr-3 font-medium text-xs">{s.direction_source || "unknown"}</td>
                      <td className="text-right py-1.5 px-2 text-slate-400">{s.total}</td>
                      <td className="text-right py-1.5 px-2 text-[#00e676]">{s.correct}</td>
                      <td className="text-right py-1.5 px-2 text-red-400">{s.incorrect}</td>
                      <td className={`text-right py-1.5 px-2 font-semibold ${parseFloat(acc) > 55 ? "text-[#00e676]" : parseFloat(acc) > 40 ? "text-amber-400" : "text-red-400"}`}>{acc}%</td>
                      <td className={`text-right py-1.5 px-2 ${s.avg_pnl_pct > 0 ? "text-[#00e676]" : "text-red-400"}`}>{s.avg_pnl_pct ?? "â€”"}%</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Entry Path Performance */}
      {(pathPerf.length > 0 || byPath.length > 0) && (
        <div className="card p-4">
          <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Entry Path Performance</div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead><tr className="text-slate-500 text-xs">
                <th className="text-left py-1 pr-3">Path</th>
                <th className="text-right py-1 px-2">Trades</th>
                <th className="text-right py-1 px-2">Win Rate</th>
                <th className="text-right py-1 px-2">Recent WR</th>
                <th className="text-right py-1 px-2">Avg PnL%</th>
                <th className="text-right py-1 px-2">Avg MFE%</th>
                <th className="text-right py-1 px-2">Avg MAE%</th>
                <th className="text-left py-1 pl-2">Status</th>
              </tr></thead>
              <tbody>
                {(pathPerf.length > 0 ? pathPerf : byPath).map(p => {
                  const wr = p.win_rate != null ? (p.win_rate * 100).toFixed(1) : (p.total > 0 ? ((p.wins || p.correct || 0) / p.total * 100).toFixed(1) : "â€”");
                  const rwr = p.recent_win_rate != null ? (p.recent_win_rate * 100).toFixed(1) : "â€”";
                  const enabled = p.enabled !== 0;
                  return (
                    <tr key={p.entry_path} className={`border-t border-white/[0.04] ${!enabled ? "opacity-50" : ""}`}>
                      <td className="py-1.5 pr-3 font-medium text-xs">{p.entry_path}</td>
                      <td className="text-right py-1.5 px-2 text-slate-400">{p.total_trades || p.total || 0}</td>
                      <td className={`text-right py-1.5 px-2 font-semibold ${parseFloat(wr) > 50 ? "text-[#00e676]" : parseFloat(wr) > 35 ? "text-amber-400" : "text-red-400"}`}>{wr}%</td>
                      <td className={`text-right py-1.5 px-2 ${parseFloat(rwr) > 50 ? "text-[#00e676]" : parseFloat(rwr) > 35 ? "text-amber-400" : "text-red-400"}`}>{rwr}%</td>
                      <td className={`text-right py-1.5 px-2 ${(p.avg_pnl_pct || 0) > 0 ? "text-[#00e676]" : "text-red-400"}`}>{p.avg_pnl_pct ?? "â€”"}%</td>
                      <td className="text-right py-1.5 px-2 text-slate-400">{p.avg_mfe ?? "â€”"}%</td>
                      <td className="text-right py-1.5 px-2 text-slate-400">{p.avg_mae ?? "â€”"}%</td>
                      <td className="py-1.5 pl-2">
                        <span className={`px-1.5 py-0.5 rounded text-xs font-semibold ${enabled ? "badge-active" : "badge-bear"}`}>
                          {enabled ? "Active" : "Disabled"}
                        </span>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* Recent Direction Accuracy Records */}
      {recentTrades.length > 0 && (
        <div className="card p-4">
          <div className="text-xs text-slate-400 uppercase tracking-wide mb-3">Recent Trades â€” Direction Tracking ({recentTrades.length})</div>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead><tr className="text-slate-500 text-xs">
                <th className="text-left py-1 pr-2">Ticker</th>
                <th className="text-left py-1 px-2">Dir</th>
                <th className="text-left py-1 px-2">Source</th>
                <th className="text-left py-1 px-2">Path</th>
                <th className="text-right py-1 px-2">HTF</th>
                <th className="text-right py-1 px-2">LTF</th>
                <th className="text-right py-1 px-2">PnL%</th>
                <th className="text-left py-1 px-2">Status</th>
                <th className="text-left py-1 pl-2">Correct?</th>
              </tr></thead>
              <tbody>
                {recentTrades.map((r, i) => (
                  <tr key={r.trade_id || i} className="border-t border-white/[0.04]">
                    <td className="py-1.5 pr-2 font-semibold text-xs">{r.ticker}</td>
                    <td className="py-1.5 px-2">
                      <span className={`px-1.5 py-0.5 rounded text-xs font-semibold ${r.traded_direction === "LONG" ? "badge-bull" : "badge-bear"}`}>{r.traded_direction}</span>
                    </td>
                    <td className="py-1.5 px-2 text-xs text-slate-400">{r.direction_source || "â€”"}</td>
                    <td className="py-1.5 px-2 text-xs text-slate-400">{r.entry_path || "â€”"}</td>
                    <td className={`text-right py-1.5 px-2 text-xs ${(r.htf_score || 0) >= 0 ? "text-[#00e676]" : "text-red-400"}`}>{r.htf_score?.toFixed(1) || "â€”"}</td>
                    <td className={`text-right py-1.5 px-2 text-xs ${(r.ltf_score || 0) >= 0 ? "text-[#00e676]" : "text-red-400"}`}>{r.ltf_score?.toFixed(1) || "â€”"}</td>
                    <td className={`text-right py-1.5 px-2 text-xs font-semibold ${(r.pnl_pct || 0) > 0 ? "text-[#00e676]" : (r.pnl_pct || 0) < 0 ? "text-red-400" : "text-slate-400"}`}>
                      {r.pnl_pct != null ? `${r.pnl_pct > 0 ? "+" : ""}${r.pnl_pct.toFixed(2)}%` : "â€”"}
                    </td>
                    <td className="py-1.5 px-2">
                      <span className={`px-1.5 py-0.5 rounded text-xs font-semibold ${
                        r.status === "WIN" ? "badge-bull" : r.status === "LOSS" ? "badge-bear" : r.status === "OPEN" ? "badge-active" : "badge-neutral"
                      }`}>{r.status}</span>
                    </td>
                    <td className="py-1.5 pl-2 text-xs">
                      {r.direction_correct === 1 ? <span className="text-[#00e676] font-bold">Yes</span> :
                       r.direction_correct === 0 ? <span className="text-red-400 font-bold">No</span> :
                       <span className="text-slate-500">â€”</span>}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {!retro && !dirAccuracy && (
        <div className="card p-8 text-center text-slate-500">
          <div className="text-sm">No learning loop data yet. Data will populate after trades are entered and closed.</div>
        </div>
      )}
    </div>
  );
}

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function App({ user }) {
  const { health, signals, patterns, proposals, predictions, retro, dirAccuracy, loading, lastRefresh, refresh } = useModelData();
  const [tab, setTab] = useState("overview");
  const isAdmin = user?.role === "admin" || user?.tier === "admin";

  return (
    <div className="min-h-screen flex flex-col">
      <NavHeader />

      {/* Sub-navigation */}
      <div className="border-b border-white/[0.06] px-6 flex items-center justify-between">
        <div className="flex gap-6">
          {["overview", "learning", "patterns", "proposals", "predictions"].map(t => {
            const isProposalLocked = t === "proposals" && !isAdmin;
            return (
              <button
                key={t}
                onClick={() => !isProposalLocked && setTab(t)}
                className={`py-3 text-sm font-medium capitalize ${tab === t ? "tab-active" : "tab-inactive"} ${isProposalLocked ? "opacity-40 cursor-not-allowed" : ""}`}
                title={isProposalLocked ? "Admin access required" : ""}
              >
                {t}
                {isProposalLocked && <span className="ml-1 text-[10px]">ðŸ”’</span>}
                {t === "proposals" && !isProposalLocked && proposals.length > 0 && (
                  <span className="ml-1.5 px-1.5 py-0.5 rounded-full bg-amber-600 text-white text-xs">
                    {proposals.length}
                  </span>
                )}
              </button>
            );
          })}
        </div>
        <div className="flex items-center gap-3">
          {lastRefresh && <span className="text-xs text-slate-500">Updated {lastRefresh.toLocaleTimeString()}</span>}
          <button onClick={refresh} disabled={loading} className="btn btn-secondary text-xs">
            {loading ? "Loading..." : "Refresh"}
          </button>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1 p-6 overflow-y-auto">
        {loading && !health ? (
          <div className="flex items-center justify-center h-64 text-slate-400">Loading model data...</div>
        ) : (
          <>
            {tab === "overview" && (
              <div className="space-y-6">
                {/* Health stats row */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <StatCard label="Predictions" value={health?.predictions?.total || 0} sub={`${health?.predictions?.open || 0} open`} />
                  <StatCard
                    label="Hit Rate"
                    value={health?.outcomes?.total > 0 ? `${health.outcomes.hitRate}%` : "â€”"}
                    sub={health?.outcomes?.total > 0 ? `${health.outcomes.hits}/${health.outcomes.total}` : "No outcomes yet"}
                    color={health?.outcomes?.hitRate > 60 ? "text-[#00e676]" : health?.outcomes?.hitRate > 40 ? "text-amber-400" : "text-red-400"}
                  />
                  <StatCard label="Active Patterns" value={health?.patterns?.active || 0} sub={health?.patterns?.degraded > 0 ? `${health.patterns.degraded} degraded` : "All healthy"} />
                  {isAdmin ? (
                    <StatCard
                      label="Pending Proposals"
                      value={proposals.length}
                      sub={proposals.length > 0 ? "Review needed" : "None"}
                      color={proposals.length > 0 ? "text-amber-400" : "text-slate-300"}
                    />
                  ) : (
                    <StatCard label="Proposals" value="ðŸ”’" sub="Admin only" color="text-slate-500" />
                  )}
                </div>

                {/* Market + Sectors */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <MarketRegimeCard market={signals?.market} />
                  <div className="lg:col-span-2">
                    <SectorTable sectors={signals?.sector} />
                  </div>
                </div>

                {/* Ticker Signals */}
                <TickerSignals tickers={signals?.ticker} />
              </div>
            )}

            {tab === "learning" && (
              <LearningLoopPanel retro={retro} dirAccuracy={dirAccuracy} />
            )}

            {tab === "patterns" && (
              <PatternLibrary patterns={patterns} />
            )}

            {tab === "proposals" && (
              isAdmin
                ? <ProposalsPanel proposals={proposals} onRefresh={refresh} />
                : <div className="card p-8 text-center text-slate-500">
                    <div className="text-2xl mb-2">ðŸ”’</div>
                    <div className="text-sm font-medium">Admin Access Required</div>
                    <div className="text-xs mt-1">Model proposals are only accessible to admin users.</div>
                  </div>
            )}

            {tab === "predictions" && (
              <RecentPredictions predictions={predictions} />
            )}
          </>
        )}
      </div>
    </div>
  );
}

const AuthGate = window.TimedAuthGate;
const modelApp = AuthGate
  ? <AuthGate apiBase={API_BASE} requiredTier="pro">{(user) => <App user={user} />}</AuthGate>
  : <App />;
ReactDOM.createRoot(document.getElementById("root")).render(modelApp);
    </script>
    <script>
      (function() {
        fetch("/timed/daily-brief/badge", { cache: "no-store" })
          .then(r => r.json())
          .then(d => {
            if (d?.badge?.ts) {
              const seen = Number(localStorage.getItem("tt_brief_seen") || 0);
              if (d.badge.ts > seen) {
                const el = document.getElementById("brief-badge");
                if (el) el.classList.remove("hidden");
              }
            }
          })
          .catch(() => {});
      })();
    </script>
  </body>
</html>
