<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timed Trading ‚Äî React Dashboard</title>

    <!-- React & ReactDOM via CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
      onerror="console.error('Failed to load React')"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      onerror="console.error('Failed to load ReactDOM')"
    ></script>

    <!-- Babel Standalone for JSX -->
    <script
      src="https://unpkg.com/@babel/standalone/babel.min.js"
      onerror="console.error('Failed to load Babel')"
    ></script>

    <!-- Tailwind CSS -->
    <script
      src="https://cdn.tailwindcss.com"
      onerror="console.error('Failed to load Tailwind')"
    ></script>

    <!-- Recharts for lightweight charting - try multiple sources -->
    <script
      src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"
      onerror="console.error('Failed to load Recharts from unpkg, trying alternative...'); loadRechartsFallback();"
    ></script>
    <script>
      function loadRechartsFallback() {
        // Try alternative CDN
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.js';
        script.onerror = function() {
          console.error('Recharts failed to load from all sources');
          window.RechartsFailed = true;
        };
        script.onload = function() {
          console.log('Recharts loaded from jsdelivr');
        };
        document.head.appendChild(script);
      }
      
      // Check if Recharts loaded after a delay
      window.addEventListener('load', function() {
        setTimeout(function() {
          if (typeof Recharts === 'undefined' && !window.RechartsFailed) {
            console.warn('Recharts may not have loaded yet');
          }
        }, 2000);
      });
    </script>

    <!-- Loading indicator while scripts load -->
    <script>
      window.addEventListener("load", function () {
        // Check if all scripts loaded
        setTimeout(function () {
          const root = document.getElementById("root");
          if (root && root.innerHTML === "") {
            if (typeof React === "undefined") {
              root.innerHTML =
                '<div style="padding: 40px; text-align: center; color: #e7ecff;"><h2 style="color: #e74c3c;">Loading Error</h2><p>React failed to load. Check console (F12) for details.</p></div>';
            }
          }
        }, 2000);
      });
    </script>

    <style>
      :root {
        --bg: #0b1020;
        --card: #121a33;
        --text: #e7ecff;
        --muted: #93a4d6;
        --line: #26325f;
        --good: #2ecc71;
        --bad: #e74c3c;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Arial;
        background: var(--bg);
        color: var(--text);
      }

      .loading-spinner {
        border: 2px solid var(--line);
        border-top: 2px solid var(--text);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .prime-glow {
        box-shadow: 0 0 12px rgba(46, 204, 113, 0.4);
        animation: pulse-glow 2s ease-in-out infinite;
      }
      
      @keyframes pulse-glow {
        0%, 100% { box-shadow: 0 0 12px rgba(46, 204, 113, 0.4); }
        50% { box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); }
      }
      
      .bubble-transition {
        transition: all 0.2s ease-out;
      }
      
      .bubble-hover {
        transform: scale(1.15);
        filter: brightness(1.2);
      }
      
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .slide-in {
        animation: slideIn 0.3s ease-out;
      }
      
      @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
      }
      
      /* Phase color gradient helper */
      .phase-gradient {
        background: linear-gradient(to right, 
          #2ecc71 0%, 
          #27ae60 20%, 
          #f39c12 40%, 
          #e67e22 60%, 
          #e74c3c 80%, 
          #c0392b 100%
        );
      }
    </style>
  </head>
  <body>
    <div id="root">
      <div style="padding: 40px; text-align: center; color: #e7ecff">
        <div class="loading-spinner" style="margin: 0 auto 20px"></div>
        <p>Loading dashboard...</p>
      </div>
    </div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, memo } = React;
      
      // Get Recharts components with fallback
      let RechartsComponents = null;
      if (typeof Recharts !== 'undefined') {
        RechartsComponents = {
          ScatterChart: Recharts.ScatterChart,
          Scatter: Recharts.Scatter,
          XAxis: Recharts.XAxis,
          YAxis: Recharts.YAxis,
          CartesianGrid: Recharts.CartesianGrid,
          Tooltip: Recharts.Tooltip,
          ResponsiveContainer: Recharts.ResponsiveContainer,
        };
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Types & Constants
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const LONG_CORRIDOR = { ltfMin: -8, ltfMax: 12 };
      const SHORT_CORRIDOR = { ltfMin: -12, ltfMax: 8 };
      const API_BASE = "https://timed-trading-ingest.shashant.workers.dev";

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Hooks
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function useTickerData() {
        const [data, setData] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastUpdate, setLastUpdate] = useState(null);

        const fetchData = useCallback(async () => {
          try {
            setLoading(true);
            const res = await fetch(`${API_BASE}/timed/all`);
            const json = await res.json();
            if (json.ok) {
              setData(json.data || {});
              setLastUpdate(new Date());
              setError(null);
            } else {
              setError("Failed to fetch data");
            }
          } catch (e) {
            setError(e.message);
          } finally {
            setLoading(false);
          }
        }, []);

        useEffect(() => {
          fetchData();
          const interval = setInterval(fetchData, 30000); // 30s auto-refresh
          return () => clearInterval(interval);
        }, [fetchData]);

        return { data, loading, error, lastUpdate, refetch: fetchData };
      }

      function useDebounce(value, delay) {
        const [debouncedValue, setDebouncedValue] = useState(value);

        useEffect(() => {
          const handler = setTimeout(() => {
            setDebouncedValue(value);
          }, delay);

          return () => {
            clearTimeout(handler);
          };
        }, [value, delay]);

        return debouncedValue;
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Groups (matching original)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const GROUPS = {
        UPTICKS: new Set([
          "APLD", "TSLA", "STX", "AU", "CCJ", "CLS", "CRS", "VST", "FSLR", "JCI",
          "ORCL", "AMZN", "BRK.B", "BABA", "WMT", "PH", "GEV", "HII", "ULTA", "SHOP",
          "CSX", "PWR", "HOOD", "SPGI", "APP", "PANW", "RDDT", "TT", "GLXY", "ETHA",
        ]),
        SuperGranny: new Set(["META", "NVDA", "AMD", "ANET", "GS"]),
        GRNI: new Set([
          "VST", "TSLA", "TJX", "SPGI", "SOFI", "PWR", "PNC", "PLTR", "PANW", "NVDA",
          "NFLX", "MSTR", "MSFT", "MNST", "META", "LRCX", "KLAC", "JPM", "HOOD", "GS",
          "GOOGL", "GEV", "GE", "EXPE", "ETN", "EMR", "DE", "CRWD", "COST", "CDNS",
          "CAT", "BK", "AXP", "AXON", "AVGO", "ANET", "AMZN", "AMD", "AAPL",
        ]),
        GRNJ: new Set([
          "RKLB", "LITE", "SN", "ALB", "RDDT", "RGLD", "MTZ", "ON", "ALLY", "DY",
          "CCJ", "EWBC", "PATH", "WFRD", "WAL", "IESC", "ENS", "TWLO", "MLI", "KTOS",
          "MDB", "TLN", "EME", "AWI", "IBP", "DCI", "WTS", "FIX", "UTHR", "NBIS",
          "SGI", "AYI", "RIOT", "NXT", "SANM", "BWXT", "PEGA", "JOBY", "IONQ", "SOFI",
          "ITT", "STRL", "QLYS", "MP", "GLXY", "HIMS", "IOT", "BE", "NEU", "AVAV",
          "PSTG", "RBLX",
        ]),
        GRNY: new Set([
          "GEV", "LRCX", "PNC", "GOOGL", "GS", "META", "MNST", "KLAC", "TJX", "GE",
          "EXPE", "CAT", "BK", "SPGI", "TSLA", "EMR", "JPM", "AXP", "ANET", "AXON",
          "AAPL", "NVDA", "AVGO", "PWR", "CDNS", "DE", "MSFT", "COST", "VST", "PLTR",
          "AMZN", "HOOD", "ETN", "SOFI", "AMD", "PANW", "CRWD", "NFLX", "MSTR",
        ]),
        Social: new Set(["CSCO", "BA", "NKE", "AAPL", "PI", "APLD"]),
        SP_Sectors: new Set([
          "XLK", "XLF", "XLY", "XLP", "XLC", "XLI", "XLB", "XLE", "XLRE", "XLU", "XLV",
        ]),
      };

      const GROUP_LABELS = {
        SP_Sectors: "S&P Sectors",
      };

      const GROUP_ORDER = [
        "SP_Sectors",
        "UPTICKS",
        "SuperGranny",
        "GRNI",
        "GRNJ",
        "GRNY",
        "Social",
      ];

      function normTicker(t) {
        const s = String(t || "").trim().toUpperCase();
        if (s === "BRK-B") return "BRK.B";
        return s;
      }

      function groupsForTicker(t) {
        const T = normTicker(t);
        const out = [];
        for (const [g, set] of Object.entries(GROUPS))
          if (set.has(T)) out.push(g);
        return out;
      }

      // Check if ticker is in any group
      function isTickerInGroups(t) {
        const T = normTicker(t);
        for (const [g, set] of Object.entries(GROUPS))
          if (set.has(T)) return true;
        return false;
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Utils
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      
      // Phase-based color (Turbo-like gradient: 0=green, 0.5=yellow, 1=red)
      function phaseToColor(phase) {
        const p = Math.max(0, Math.min(1, phase));
        if (p < 0.2) {
          // Green to light green: #2ecc71 to #27ae60
          const t = p / 0.2;
          return `rgb(${Math.round(46 + (39 - 46) * t)}, ${Math.round(204 + (174 - 204) * t)}, ${Math.round(113 + (96 - 113) * t)})`;
        } else if (p < 0.4) {
          // Light green to yellow: #27ae60 to #f39c12
          const t = (p - 0.2) / 0.2;
          return `rgb(${Math.round(39 + (243 - 39) * t)}, ${Math.round(174 + (156 - 174) * t)}, ${Math.round(96 + (18 - 96) * t)})`;
        } else if (p < 0.6) {
          // Yellow to orange: #f39c12 to #e67e22
          const t = (p - 0.4) / 0.2;
          return `rgb(${Math.round(243 + (230 - 243) * t)}, ${Math.round(156 + (126 - 156) * t)}, ${Math.round(18 + (34 - 18) * t)})`;
        } else if (p < 0.8) {
          // Orange to red: #e67e22 to #e74c3c
          const t = (p - 0.6) / 0.2;
          return `rgb(${Math.round(230 + (231 - 230) * t)}, ${Math.round(126 + (76 - 126) * t)}, ${Math.round(34 + (60 - 34) * t)})`;
        } else {
          // Red to dark red: #e74c3c to #c0392b
          const t = (p - 0.8) / 0.2;
          return `rgb(${Math.round(231 + (192 - 231) * t)}, ${Math.round(76 + (57 - 76) * t)}, ${Math.round(60 + (43 - 60) * t)})`;
        }
      }
      
      function isPrimeBubble(ticker) {
        const rank = Number(ticker.rank || 0);
        const rr = ticker.rr != null ? Number(ticker.rr) : 0;
        const comp = ticker.completion != null ? Number(ticker.completion) : 1;
        const phase = ticker.phase_pct != null ? Number(ticker.phase_pct) : 1;
        const flags = ticker.flags || {};
        const sqRel = !!flags.sq30_release;
        const phaseZoneChange = !!flags.phase_zone_change;
        const state = String(ticker.state || "");
        const aligned =
          state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";

        return (
          rank >= 75 &&
          rr >= 1.5 &&
          comp < 0.4 &&
          phase < 0.6 &&
          (aligned || sqRel || phaseZoneChange)
        );
      }

      function entryType(ticker) {
        const h = Number(ticker.htf_score);
        const l = Number(ticker.ltf_score);
        if (!Number.isFinite(h) || !Number.isFinite(l)) {
          return { corridor: false, side: null };
        }
        if (h > 0 && l >= LONG_CORRIDOR.ltfMin && l <= LONG_CORRIDOR.ltfMax) {
          return { corridor: true, side: "LONG" };
        }
        if (h < 0 && l >= SHORT_CORRIDOR.ltfMin && l <= SHORT_CORRIDOR.ltfMax) {
          return { corridor: true, side: "SHORT" };
        }
        return { corridor: false, side: null };
      }

      function completionForSize(ticker) {
        const c = Number(ticker.completion);
        const trig = Number(ticker.trigger_price);
        const tp = Number(ticker.tp);
        const px = Number(ticker.price);
        if ([trig, tp, px].every(Number.isFinite) && tp !== trig) {
          const prog = (px - trig) / (tp - trig);
          return Math.max(0, Math.min(1, Math.abs(prog)));
        }
        return Number.isFinite(c) ? Math.max(0, Math.min(1, c)) : 0;
      }

      function applyFilters(dataObj, filters) {
        const out = [];
        for (const [tickerRaw, d] of Object.entries(dataObj)) {
          if (!d) continue;
          const ticker = String(tickerRaw).trim().toUpperCase();

          // Only show tickers that are in at least one group
          if (!isTickerInGroups(ticker)) continue;

          if (filters.search && !ticker.includes(filters.search.toUpperCase()))
            continue;
          
          // Group filter
          if (filters.group && filters.group !== "ALL") {
            const T = normTicker(ticker);
            const gs = groupsForTicker(T);
            if (filters.group === "ANY") {
              if (gs.length === 0) continue;
            } else if (filters.group === "UNGROUPED") {
              if (gs.length > 0) continue;
            } else {
              if (!gs.includes(filters.group)) continue;
            }
          }

          if (filters.quadrants && !filters.quadrants.includes(d.state))
            continue;
          if (filters.minRank && (Number(d.rank) || 0) < filters.minRank)
            continue;
          if (filters.minRR && (Number(d.rr) || 0) < filters.minRR) continue;
          if (
            filters.maxCompletion &&
            completionForSize(d) > filters.maxCompletion
          )
            continue;
          if (filters.inCorridor) {
            const ent = entryType(d);
            if (!ent.corridor) continue;
          }
          if (filters.squeezeRelease) {
            const flags = d.flags || {};
            if (!flags.sq30_release) continue;
          }

          out.push({ ticker, ...d });
        }
        return out;
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Components
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Native SVG Bubble component (works without Recharts)
      const SVGBubble = memo(({ ticker, onClick, onHover, isHovered, scaleX, scaleY, offsetX, offsetY, showLabels }) => {
        const comp = completionForSize(ticker);
        // Smaller bubbles: reduced from 10+comp*40 to 4+comp*12
        const size = 4 + comp * 12;
        const phase = Number(ticker.phase_pct) || 0;
        const prime = isPrimeBubble(ticker);
        const flags = ticker.flags || {};
        const ent = entryType(ticker);

        // Phase-based gradient color
        const color = phaseToColor(phase);
        const opacity = isHovered ? 1 : (prime ? 0.9 : 0.7);
        const borderWidth = prime ? 3 : flags.sq30_release ? 2 : flags.sq30_on ? 2 : 1;
        const borderColor = prime 
          ? "#2ecc71" 
          : flags.sq30_release 
          ? "#00ffff" 
          : flags.sq30_on
          ? "#ffd700"
          : "#ffffff";
        
        const bubbleSize = isHovered ? size * 1.2 : size;

        const x = (Number(ticker.ltf_score) || 0) * scaleX + offsetX;
        const y = (Number(ticker.htf_score) || 0) * scaleY + offsetY;

        // Determine emoji and label position
        const hasSqueeze = flags.sq30_release || flags.sq30_on;
        const emoji = prime ? "‚≠ê" : flags.sq30_release ? "‚ö°" : flags.sq30_on ? "üß®" : "";
        const labelY = y - bubbleSize - (emoji ? 12 : 8);

        return (
          <g
            onClick={() => onClick(ticker.ticker)}
            onMouseEnter={() => onHover(ticker.ticker)}
            onMouseLeave={() => onHover(null)}
            style={{ cursor: "pointer", transition: "all 0.2s ease-out" }}
          >
            {/* Glow effect for prime */}
            {prime && (
              <circle
                cx={x}
                cy={y}
                r={bubbleSize + 2}
                fill="none"
                stroke="#2ecc71"
                strokeWidth="1"
                opacity="0.3"
              />
            )}
            <circle
              cx={x}
              cy={y}
              r={bubbleSize}
              fill={color}
              fillOpacity={opacity}
              stroke={borderColor}
              strokeWidth={borderWidth}
              style={{ transition: "all 0.2s ease-out" }}
            />
            {/* Emoji above bubble */}
            {emoji && (
              <text
                x={x}
                y={labelY}
                textAnchor="middle"
                fontSize={prime ? "14" : "12"}
                fill={prime ? "#2ecc71" : flags.sq30_release ? "#00ffff" : "#ffd700"}
                fontWeight="bold"
                style={{ textShadow: "0 0 3px rgba(0,0,0,0.8)" }}
              >
                {emoji}
              </text>
            )}
            {/* Ticker label */}
            {(showLabels || isHovered) && (
              <text
                x={x}
                y={labelY - (emoji ? 14 : 8)}
                textAnchor="middle"
                fontSize="10"
                fill="#e7ecff"
                fontWeight="600"
                style={{ 
                  textShadow: "0 0 4px rgba(0,0,0,0.9)",
                  pointerEvents: "none"
                }}
              >
                {ticker.ticker}
              </text>
            )}
          </g>
        );
      });

      const Bubble = memo(({ ticker, onClick, onHover, isHovered, showLabels }) => {
        const comp = completionForSize(ticker);
        // Smaller bubbles: reduced from 10+comp*40 to 4+comp*12
        const size = 4 + comp * 12;
        const phase = Number(ticker.phase_pct) || 0;
        const prime = isPrimeBubble(ticker);
        const flags = ticker.flags || {};

        // Phase-based gradient color
        const color = phaseToColor(phase);
        const opacity = isHovered ? 1 : (prime ? 0.9 : 0.7);
        const borderWidth = prime ? 3 : flags.sq30_release ? 2 : flags.sq30_on ? 2 : 1;
        const borderColor = prime 
          ? "#2ecc71" 
          : flags.sq30_release 
          ? "#00ffff" 
          : flags.sq30_on
          ? "#ffd700"
          : "#ffffff";
        
        const bubbleSize = isHovered ? size * 1.2 : size;
        const x = Number(ticker.ltf_score) || 0;
        const y = Number(ticker.htf_score) || 0;

        // Determine emoji and label position
        const hasSqueeze = flags.sq30_release || flags.sq30_on;
        const emoji = prime ? "‚≠ê" : flags.sq30_release ? "‚ö°" : flags.sq30_on ? "üß®" : "";
        const labelY = y - bubbleSize - (emoji ? 12 : 8);

        return (
          <g
            onClick={() => onClick(ticker.ticker)}
            onMouseEnter={() => onHover(ticker.ticker)}
            onMouseLeave={() => onHover(null)}
            style={{ cursor: "pointer", transition: "all 0.2s ease-out" }}
          >
            {/* Glow effect for prime */}
            {prime && (
              <circle
                cx={x}
                cy={y}
                r={bubbleSize + 2}
                fill="none"
                stroke="#2ecc71"
                strokeWidth="1"
                opacity="0.3"
              />
            )}
            <circle
              cx={x}
              cy={y}
              r={bubbleSize}
              fill={color}
              fillOpacity={opacity}
              stroke={borderColor}
              strokeWidth={borderWidth}
              style={{ transition: "all 0.2s ease-out" }}
            />
            {/* Emoji above bubble */}
            {emoji && (
              <text
                x={x}
                y={labelY}
                textAnchor="middle"
                fontSize={prime ? "14" : "12"}
                fill={prime ? "#2ecc71" : flags.sq30_release ? "#00ffff" : "#ffd700"}
                fontWeight="bold"
                style={{ textShadow: "0 0 3px rgba(0,0,0,0.8)" }}
              >
                {emoji}
              </text>
            )}
            {/* Ticker label */}
            {(showLabels || isHovered) && (
              <text
                x={x}
                y={labelY - (emoji ? 14 : 8)}
                textAnchor="middle"
                fontSize="10"
                fill="#e7ecff"
                fontWeight="600"
                style={{ 
                  textShadow: "0 0 4px rgba(0,0,0,0.9)",
                  pointerEvents: "none"
                }}
              >
                {ticker.ticker}
              </text>
            )}
          </g>
        );
      });

      function BubbleChart({ tickers, onBubbleClick, hoveredTicker, onHover }) {
        const [tooltip, setTooltip] = useState(null);
        const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });
        const [showLabels, setShowLabels] = useState(true);
        
        // Fallback: Native SVG chart (works without Recharts)
        if (!RechartsComponents) {
          // Larger chart: increased from 800x600 to 1200x800
          const chartWidth = 1200;
          const chartHeight = 800;
          const margin = 80;
          const plotWidth = chartWidth - 2 * margin;
          const plotHeight = chartHeight - 2 * margin;
          
          // More precise scaling for better granularity
          const scaleX = plotWidth / 100; // -50 to 50 range
          const scaleY = plotHeight / 100;
          const offsetX = margin;
          const offsetY = margin;
          
          const handleMouseMove = (e) => {
            const rect = e.currentTarget.getBoundingClientRect();
            setTooltipPos({ x: e.clientX - rect.left, y: e.clientY - rect.top });
          };
          
          return (
            <div className="w-full h-full bg-[#121a33] rounded-xl border border-[#26325f] p-4 relative">
              {/* Label toggle */}
              <div className="absolute top-2 right-2 z-10">
                <button
                  onClick={() => setShowLabels(!showLabels)}
                  className="px-3 py-1.5 rounded-lg bg-[#0f1630] border border-[#26325f] text-xs text-[#93a4d6] hover:bg-[#1a2550] transition-colors"
                >
                  {showLabels ? "Hide Labels" : "Show Labels"}
                </button>
              </div>
              <svg 
                width="100%" 
                height="100%" 
                viewBox={`0 0 ${chartWidth} ${chartHeight}`}
                onMouseMove={handleMouseMove}
                onMouseLeave={() => setTooltip(null)}
                style={{ minHeight: "800px" }}
              >
                {/* Grid with better styling */}
                <defs>
                  <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                    <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#26325f" strokeWidth="0.5" opacity="0.5"/>
                  </pattern>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
                
                {/* Axes - Much more visible - Both center lines same style */}
                {/* Vertical center line (x=0) */}
                <line x1={offsetX + 50 * scaleX} y1={offsetY} x2={offsetX + 50 * scaleX} y2={offsetY + plotHeight} stroke="#e7ecff" strokeWidth="3" opacity="0.9" />
                <line x1={offsetX + 50 * scaleX} y1={offsetY} x2={offsetX + 50 * scaleX} y2={offsetY + plotHeight} stroke="#ffffff" strokeWidth="1" opacity="0.5" />
                {/* Horizontal center line (y=0) */}
                <line x1={offsetX} y1={offsetY + plotHeight / 2} x2={offsetX + plotWidth} y2={offsetY + plotHeight / 2} stroke="#e7ecff" strokeWidth="3" opacity="0.9" />
                <line x1={offsetX} y1={offsetY + plotHeight / 2} x2={offsetX + plotWidth} y2={offsetY + plotHeight / 2} stroke="#ffffff" strokeWidth="1" opacity="0.5" />
                {/* Vertical axis line (y-axis) */}
                <line x1={offsetX} y1={offsetY} x2={offsetX} y2={offsetY + plotHeight} stroke="#93a4d6" strokeWidth="2" opacity="0.6" />
                
                {/* Axis labels */}
                <text x={offsetX - 30} y={offsetY + plotHeight / 2} fill="#93a4d6" textAnchor="middle" fontSize="13" fontWeight="600">HTF Score</text>
                <text x={offsetX + plotWidth / 2} y={offsetY + plotHeight + 40} fill="#93a4d6" textAnchor="middle" fontSize="13" fontWeight="600">LTF Score</text>
                
                {/* Axis scale markers */}
                {[-50, -25, 0, 25, 50].map(val => {
                  const x = offsetX + (val + 50) * scaleX;
                  const y = offsetY + plotHeight / 2;
                  return (
                    <g key={`x-${val}`}>
                      <line x1={x} y1={y - 5} x2={x} y2={y + 5} stroke="#93a4d6" strokeWidth="2" />
                      <text x={x} y={y + 20} fill="#93a4d6" textAnchor="middle" fontSize="10">{val}</text>
                    </g>
                  );
                })}
                {[-50, -25, 0, 25, 50].map(val => {
                  const x = offsetX;
                  const y = offsetY + plotHeight - (val + 50) * scaleY;
                  return (
                    <g key={`y-${val}`}>
                      <line x1={x - 5} y1={y} x2={x + 5} y2={y} stroke="#93a4d6" strokeWidth="2" />
                      <text x={x - 15} y={y + 4} fill="#93a4d6" textAnchor="end" fontSize="10">{val}</text>
                    </g>
                  );
                })}
                
                {/* Quadrant labels with better styling */}
                <text x={offsetX + plotWidth * 0.25} y={offsetY + 30} fill="#93a4d6" fontSize="12" fontWeight="600" textAnchor="middle">Q1 Prep</text>
                <text x={offsetX + plotWidth * 0.75} y={offsetY + 30} fill="#93a4d6" fontSize="12" fontWeight="600" textAnchor="middle">Q2 Bull</text>
                <text x={offsetX + plotWidth * 0.25} y={offsetY + plotHeight - 10} fill="#93a4d6" fontSize="12" fontWeight="600" textAnchor="middle">Q3 Bear</text>
                <text x={offsetX + plotWidth * 0.75} y={offsetY + plotHeight - 10} fill="#93a4d6" fontSize="12" fontWeight="600" textAnchor="middle">Q4 Pullback</text>
                
                {/* Corridors */}
                <rect 
                  x={offsetX + (LONG_CORRIDOR.ltfMin + 50) * scaleX} 
                  y={offsetY} 
                  width={(LONG_CORRIDOR.ltfMax - LONG_CORRIDOR.ltfMin) * scaleX} 
                  height={plotHeight / 2} 
                  fill="rgba(46,204,113,0.1)" 
                />
                <rect 
                  x={offsetX + (SHORT_CORRIDOR.ltfMin + 50) * scaleX} 
                  y={offsetY + plotHeight / 2} 
                  width={(SHORT_CORRIDOR.ltfMax - SHORT_CORRIDOR.ltfMin) * scaleX} 
                  height={plotHeight / 2} 
                  fill="rgba(231,76,60,0.1)" 
                />
                
                {/* Bubbles */}
                {tickers.map(ticker => (
                  <SVGBubble
                    key={ticker.ticker}
                    ticker={ticker}
                    onClick={onBubbleClick}
                    onHover={(t) => {
                      onHover(t);
                      if (t) setTooltip(tickers.find(tt => tt.ticker === t));
                    }}
                    isHovered={hoveredTicker === ticker.ticker}
                    scaleX={scaleX}
                    scaleY={-scaleY}
                    offsetX={offsetX + 50 * scaleX}
                    offsetY={offsetY + plotHeight - 50 * scaleY}
                    showLabels={showLabels}
                  />
                ))}
              </svg>
              
                {/* Tooltip */}
              {tooltip && (
                <div 
                  className="absolute bg-[#121a33] border-2 border-[#26325f] rounded-lg p-3 text-sm pointer-events-none z-10 shadow-xl fade-in"
                  style={{ 
                    left: tooltipPos.x + 10, 
                    top: tooltipPos.y - 10,
                    minWidth: "200px"
                  }}
                >
                  <div className="font-bold text-base mb-2">{tooltip.ticker}</div>
                  {isPrimeBubble(tooltip) && (
                    <div className="mb-2 px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-semibold text-center">
                      ‚≠ê PRIME SETUP
                    </div>
                  )}
                  <div className="space-y-1">
                    <div className="flex justify-between">
                      <span className="text-[#93a4d6]">Rank</span>
                      <span className="font-semibold">{tooltip.rank || "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-[#93a4d6]">RR</span>
                      <span className="font-semibold">{tooltip.rr ? Number(tooltip.rr).toFixed(2) : "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-[#93a4d6]">State</span>
                      <span className="font-semibold">{tooltip.state || "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-[#93a4d6]">Phase</span>
                      <span className="font-semibold" style={{ color: phaseToColor(Number(tooltip.phase_pct) || 0) }}>
                        {Math.round((Number(tooltip.phase_pct) || 0) * 100)}%
                        {tooltip.phase_zone && ` (${tooltip.phase_zone})`}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-[#93a4d6]">Completion</span>
                      <span className="font-semibold">{Math.round(completionForSize(tooltip) * 100)}%</span>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }
        
        // Recharts version (if loaded)
        const { ScatterChart, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = RechartsComponents;
        
        const data = useMemo(
          () =>
            tickers.map((t) => ({
              x: Number(t.ltf_score) || 0,
              y: Number(t.htf_score) || 0,
              ticker: t,
            })),
          [tickers]
        );

        return (
          <div className="w-full h-full bg-[#121a33] rounded-xl border border-[#26325f] p-4">
            <ResponsiveContainer width="100%" height="100%">
              <ScatterChart
                margin={{ top: 20, right: 20, bottom: 20, left: 20 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#26325f" />
                <XAxis
                  type="number"
                  dataKey="x"
                  name="LTF Score"
                  domain={[-50, 50]}
                  stroke="#93a4d6"
                />
                <YAxis
                  type="number"
                  dataKey="y"
                  name="HTF Score"
                  domain={[-50, 50]}
                  stroke="#93a4d6"
                />
                <Tooltip
                  content={({ active, payload }) => {
                    if (!active || !payload?.[0]) return null;
                    const t = payload[0].payload.ticker;
                    return (
                      <div className="bg-[#121a33] border border-[#26325f] rounded p-3 text-sm">
                        <div className="font-bold">{t.ticker}</div>
                        <div>Rank: {t.rank || "‚Äî"}</div>
                        <div>RR: {t.rr ? Number(t.rr).toFixed(2) : "‚Äî"}</div>
                        <div>State: {t.state || "‚Äî"}</div>
                        {isPrimeBubble(t) && (
                          <div className="text-[#2ecc71]">‚≠ê PRIME SETUP</div>
                        )}
                      </div>
                    );
                  }}
                />
                <Scatter data={data}>
                  {data.map((entry, index) => (
                    <Bubble
                      key={entry.ticker.ticker}
                      ticker={entry.ticker}
                      onClick={onBubbleClick}
                      onHover={onHover}
                      isHovered={hoveredTicker === entry.ticker.ticker}
                    />
                  ))}
                </Scatter>
              </ScatterChart>
            </ResponsiveContainer>
          </div>
        );
      }

      // Format date/time from timestamp
      function formatTriggerDateTime(ts) {
        if (!ts || typeof ts !== "number") return "‚Äî";
        const date = new Date(ts);
        return {
          date: date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }),
          time: date.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true }),
        };
      }

      // Get "Why" reason from ticker data
      function getWhyReason(ticker) {
        const reasons = ticker.reasons || [];
        const flags = ticker.flags || {};
        const state = String(ticker.state || "");
        
        if (flags.sq30_release) return "Squeeze Release";
        if (flags.phase_zone_change) return "Phase Zone Change";
        if (state.includes("BULL") && state.includes("BULL")) return "Both Timeframes Bullish";
        if (state.includes("BEAR") && state.includes("BEAR")) return "Both Timeframes Bearish";
        if (reasons.length > 0) return reasons[0];
        return "Setup Active";
      }

      // Get direction from state
      function getDirection(ticker) {
        const state = String(ticker.state || "");
        if (state.includes("BULL")) return { text: "LONG", color: "text-green-400", bg: "bg-green-500/20" };
        if (state.includes("BEAR")) return { text: "SHORT", color: "text-red-400", bg: "bg-red-500/20" };
        return { text: "‚Äî", color: "text-[#93a4d6]", bg: "bg-[#26325f]" };
      }

      function SetupCard({ ticker, isSelected, onClick }) {
        const prime = isPrimeBubble(ticker);
        const ent = entryType(ticker);
        const flags = ticker.flags || {};
        const phase = Number(ticker.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const dir = getDirection(ticker);
        const why = getWhyReason(ticker);
        const triggerDT = formatTriggerDateTime(ticker.trigger_ts);
        const tpLevels = ticker.tp_levels || [];
        const comp = completionForSize(ticker);

        return (
          <div
            className={`p-3 rounded-lg border cursor-pointer transition-all ${
              isSelected
                ? "border-blue-500 bg-blue-500/10 shadow-lg"
                : prime
                ? "border-green-500 bg-green-500/10 prime-glow"
                : "border-[#26325f] bg-[#0f1630] hover:bg-[#1a2550] hover:border-[#3a4aa0]"
            }`}
            onClick={onClick}
          >
            {/* Header */}
            <div className="flex items-center justify-between mb-2">
              <div className="flex items-center gap-1.5">
                <span className="font-bold text-base">{ticker.ticker}</span>
                {prime && <span className="text-green-500 text-sm">‚≠ê</span>}
                {flags.sq30_release && <span className="text-cyan-400 text-sm">‚ö°</span>}
                {flags.sq30_on && <span className="text-yellow-400 text-sm">üß®</span>}
              </div>
              <div className={`px-2 py-0.5 rounded font-bold text-xs ${dir.bg} ${dir.color}`}>
                {dir.text}
              </div>
            </div>

            {/* Bias/Direction - More prominent */}
            <div className="mb-2">
              <div className="text-[10px] text-[#93a4d6] mb-0.5">Bias / Direction</div>
              <div className={`inline-block px-3 py-1 rounded font-bold text-sm ${dir.bg} ${dir.color} border-2 border-current/30`}>
                {dir.text === "LONG" ? "üìà LONG" : dir.text === "SHORT" ? "üìâ SHORT" : dir.text}
              </div>
            </div>

            {/* Why */}
            <div className="mb-2">
              <div className="text-[10px] text-[#93a4d6] mb-0.5">Why</div>
              <div className="text-xs font-semibold text-white leading-tight">{why}</div>
            </div>

            {/* Action Description */}
            {(() => {
              const actionInfo = getActionDescription(ticker);
              return (
                <div className={`mb-2 p-1.5 rounded border ${actionInfo.bg} border-current/20`}>
                  <div className={`text-[10px] font-bold mb-0.5 ${actionInfo.color}`}>
                    {actionInfo.action}
                  </div>
                  <div className="text-[9px] text-[#93a4d6] leading-tight">
                    {actionInfo.description}
                  </div>
                </div>
              );
            })()}

            {/* Trigger Info */}
            {ticker.trigger_price && (
              <div className="grid grid-cols-2 gap-2 mb-2 text-xs">
                <div>
                  <div className="text-[10px] text-[#93a4d6] mb-0.5">Trigger Price</div>
                  <div className="font-semibold text-white text-xs">
                    ${Number(ticker.trigger_price).toFixed(2)}
                  </div>
                </div>
                {ticker.trigger_ts && (
                  <div>
                    <div className="text-[10px] text-[#93a4d6] mb-0.5">Trigger Date/Time</div>
                    <div className="font-semibold text-white text-[10px] leading-tight">
                      {triggerDT.date}<br/>{triggerDT.time}
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* SL and TP */}
            <div className="grid grid-cols-2 gap-2 mb-2 text-xs">
              <div>
                <div className="text-[10px] text-[#93a4d6] mb-0.5">Stop Loss (SL)</div>
                <div className="font-semibold text-red-400 text-xs">
                  {ticker.sl ? `$${Number(ticker.sl).toFixed(2)}` : "‚Äî"}
                </div>
              </div>
              <div>
                <div className="text-[10px] text-[#93a4d6] mb-0.5">Take Profit (TP)</div>
                <div className="font-semibold text-green-400 text-xs">
                  {ticker.tp ? `$${Number(ticker.tp).toFixed(2)}` : "‚Äî"}
                </div>
              </div>
            </div>

            {/* TP Levels */}
            {tpLevels.length > 1 && (
              <div className="mb-2">
                <div className="text-[10px] text-[#93a4d6] mb-0.5">TP Levels</div>
                <div className="flex flex-wrap gap-1">
                  {tpLevels.slice(0, 2).map((tp, idx) => (
                    <span
                      key={idx}
                      className="px-1.5 py-0.5 rounded bg-green-500/20 text-green-400 text-[9px] font-mono"
                    >
                      TP{idx + 1}: ${Number(tp).toFixed(2)}
                    </span>
                  ))}
                  {tpLevels.length > 2 && (
                    <span className="px-1.5 py-0.5 rounded bg-[#26325f] text-[#93a4d6] text-[9px]">
                      +{tpLevels.length - 2}
                    </span>
                  )}
                </div>
              </div>
            )}

            {/* Phase and Completion */}
            <div className="grid grid-cols-2 gap-2 mb-2">
              <div>
                <div className="text-xs text-[#93a4d6] mb-1">Phase</div>
                <div className="h-2 bg-[#26325f] rounded-full overflow-hidden">
                  <div
                    className="h-full rounded-full transition-all"
                    style={{
                      width: `${phase * 100}%`,
                      backgroundColor: phaseColor,
                    }}
                  />
                </div>
                <div className="text-xs mt-1" style={{ color: phaseColor }}>
                  {Math.round(phase * 100)}%
                  {ticker.phase_zone && ` (${ticker.phase_zone})`}
                </div>
              </div>
              <div>
                <div className="text-xs text-[#93a4d6] mb-1">Completion</div>
                <div className="h-2 bg-[#26325f] rounded-full overflow-hidden">
                  <div
                    className="h-full rounded-full bg-blue-500 transition-all"
                    style={{ width: `${comp * 100}%` }}
                  />
                </div>
                <div className="text-xs mt-1 text-blue-400">
                  {Math.round(comp * 100)}%
                </div>
              </div>
            </div>

            {/* Additional Info */}
            <div className="flex items-center justify-between text-[10px] pt-1.5 border-t border-[#26325f]/50">
              <div className="flex gap-1">
                <span className="px-1.5 py-0.5 rounded bg-[#26325f]">
                  Rank: {ticker.rank || "‚Äî"}
                </span>
                {ticker.rr && (
                  <span className="px-1.5 py-0.5 rounded bg-[#26325f]">
                    RR: {Number(ticker.rr).toFixed(2)}
                  </span>
                )}
              </div>
              {ent.corridor && (
                <span className={`px-1.5 py-0.5 rounded text-[9px] font-semibold ${dir.bg} ${dir.color}`}>
                  {ent.side}
                </span>
              )}
            </div>
          </div>
        );
      }

      // Generate plain English action description
      function getActionDescription(ticker) {
        const state = String(ticker.state || "");
        const phase = Number(ticker.phase_pct) || 0;
        const comp = completionForSize(ticker);
        const flags = ticker.flags || {};
        const ent = entryType(ticker);
        const rank = Number(ticker.rank || 0);
        const rr = Number(ticker.rr || 0);
        
        const isAligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const isPullback = state === "HTF_BULL_LTF_PULLBACK" || state === "HTF_BEAR_LTF_PULLBACK";
        const isPrime = isPrimeBubble(ticker);
        const inCorridor = ent.corridor;
        const sqRelease = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        
        // High completion = near target, consider exit/trim
        if (comp > 0.8) {
          return {
            action: "Prepare for Exit",
            description: "Position is near completion target. Consider taking profits or trimming position.",
            color: "text-yellow-400",
            bg: "bg-yellow-500/20"
          };
        }
        
        // High phase = late in cycle, be cautious
        if (phase > 0.7) {
          return {
            action: "Wait / Trim",
            description: "Phase is advanced. Wait for better entry or trim existing position.",
            color: "text-orange-400",
            bg: "bg-orange-500/20"
          };
        }
        
        // Prime setup with good conditions = initiate
        if (isPrime && inCorridor && rank >= 75 && rr >= 1.5) {
          return {
            action: "Initiate Position",
            description: "Prime setup detected. Both timeframes aligned, in corridor, with strong rank and risk/reward. Consider entering position.",
            color: "text-green-400",
            bg: "bg-green-500/20"
          };
        }
        
        // Squeeze release in corridor = strong signal
        if (sqRelease && inCorridor && isAligned) {
          return {
            action: "Initiate Position",
            description: "Squeeze release detected with alignment. Strong momentum signal. Consider entering position.",
            color: "text-green-400",
            bg: "bg-green-500/20"
          };
        }
        
        // In corridor and aligned = good setup
        if (inCorridor && isAligned && comp < 0.5 && phase < 0.6) {
          return {
            action: "Consider Entry",
            description: "Setup is in corridor with both timeframes aligned. Early phase with room to run. Monitor for entry opportunity.",
            color: "text-blue-400",
            bg: "bg-blue-500/20"
          };
        }
        
        // Pullback setup = wait for confirmation
        if (isPullback && !inCorridor) {
          return {
            action: "Wait for Entry",
            description: "Pullback detected but not yet in corridor. Wait for price to enter corridor before considering entry.",
            color: "text-cyan-400",
            bg: "bg-cyan-500/20"
          };
        }
        
        // Squeeze on but not released = building pressure
        if (sqOn && !sqRelease) {
          return {
            action: "Monitor Closely",
            description: "Squeeze building but not yet released. Monitor for squeeze release signal before entering.",
            color: "text-yellow-400",
            bg: "bg-yellow-500/20"
          };
        }
        
        // Default: wait
        return {
          action: "Wait",
          description: "Setup not yet optimal. Wait for better conditions or confirmation signals.",
          color: "text-[#93a4d6]",
          bg: "bg-[#26325f]"
        };
      }

      function QuickFilters({ filters, onFilterChange }) {
        const presets = [
          {
            label: "Prime Only",
            filter: { minRank: 75, minRR: 1.5, maxCompletion: 0.4 },
            icon: "‚≠ê",
          },
          { 
            label: "In Corridor", 
            filter: { inCorridor: true },
            icon: "üéØ",
          },
          { 
            label: "Squeeze Release", 
            filter: { squeezeRelease: true },
            icon: "‚ö°",
          },
        ];

        const isActive = (preset) => {
          if (preset.label === "Prime Only") {
            return filters.minRank === 75 && filters.minRR === 1.5 && filters.maxCompletion === 0.4;
          }
          if (preset.label === "In Corridor") {
            return filters.inCorridor === true;
          }
          if (preset.label === "Squeeze Release") {
            return filters.squeezeRelease === true;
          }
          return false;
        };

        const handlePresetClick = (preset) => {
          const active = isActive(preset);
          if (active) {
            // Toggle off - reset to defaults
            if (preset.label === "Prime Only") {
              onFilterChange({ minRank: 0, minRR: 0, maxCompletion: 1.01 });
            } else if (preset.label === "In Corridor") {
              onFilterChange({ inCorridor: false });
            } else if (preset.label === "Squeeze Release") {
              onFilterChange({ squeezeRelease: false });
            }
          } else {
            // Toggle on - apply filter
            onFilterChange(preset.filter);
          }
        };

        // Build group options
        const groupKeys = Object.keys(GROUPS).filter(Boolean);
        const ordered = [];
        for (const k of GROUP_ORDER) if (groupKeys.includes(k)) ordered.push(k);
        const remaining = groupKeys.filter((k) => !ordered.includes(k)).sort();
        ordered.push(...remaining);

        return (
          <div className="space-y-3 mb-4">
            <div className="flex gap-2 flex-wrap">
              {presets.map((preset, i) => {
                const active = isActive(preset);
                return (
                  <button
                    key={i}
                    className={`px-4 py-2 rounded-lg border text-sm font-semibold transition-all ${
                      active
                        ? "border-green-500 bg-green-500/20 text-green-400 shadow-lg"
                        : "border-[#26325f] bg-[#0f1630] hover:bg-[#1a2550] hover:border-[#3a4aa0] text-[#93a4d6]"
                    }`}
                    onClick={() => handlePresetClick(preset)}
                  >
                    {preset.icon} {preset.label}
                  </button>
                );
              })}
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm text-[#93a4d6] font-semibold">Group:</label>
              <select
                value={filters.group || "ALL"}
                onChange={(e) => onFilterChange({ group: e.target.value })}
                className="px-3 py-2 rounded-lg border border-[#26325f] bg-[#0f1630] text-[#93a4d6] text-sm hover:bg-[#1a2550] focus:outline-none focus:border-[#3a4aa0]"
              >
                <option value="ALL">All Tickers</option>
                <option value="ANY">Any Group</option>
                <option value="UNGROUPED">Ungrouped</option>
                <option value="__DIVIDER__" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                {ordered.map((key) => (
                  <option key={key} value={key}>
                    {GROUP_LABELS[key] || key}
                  </option>
                ))}
              </select>
            </div>
          </div>
        );
      }

      function TickerDetails({ ticker, onClose }) {
        if (!ticker) return null;

        const prime = isPrimeBubble(ticker);
        const ent = entryType(ticker);
        const flags = ticker.flags || {};
        const phase = Number(ticker.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const actionInfo = getActionDescription(ticker);

        return (
          <>
            {/* Backdrop */}
            <div 
              className="fixed inset-0 bg-black/60 z-40"
              onClick={onClose}
            />
            {/* Overlay Card */}
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
              <div 
                className="bg-[#121a33] border-2 border-[#26325f] rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto slide-in pointer-events-auto shadow-2xl"
                onClick={(e) => e.stopPropagation()}
              >
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-xl font-bold">{ticker.ticker}</h3>
              <button
                onClick={onClose}
                className="text-[#93a4d6] hover:text-white transition-colors text-xl leading-none w-6 h-6 flex items-center justify-center rounded hover:bg-[#26325f]"
              >
                ‚úï
              </button>
            </div>

            {prime && (
              <div className="mb-4 p-3 bg-green-500/20 border-2 border-green-500 rounded-lg text-center font-bold text-green-500 prime-glow">
                ‚≠ê PRIME SETUP ‚≠ê
              </div>
            )}

            {/* Bias/Direction - Prominent */}
            {(() => {
              const dir = getDirection(ticker);
              return (
                <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                  <div className="text-sm text-[#93a4d6] mb-2">Bias / Direction</div>
                  <div className={`inline-block px-4 py-2 rounded-lg font-bold text-lg ${dir.bg} ${dir.color} border-2 border-current/30`}>
                    {dir.text === "LONG" ? "üìà LONG" : dir.text === "SHORT" ? "üìâ SHORT" : dir.text}
                  </div>
                </div>
              );
            })()}

            {/* Action Description */}
            <div className={`mb-4 p-4 rounded-lg border ${actionInfo.bg} border-current/30`}>
              <div className={`text-lg font-bold mb-2 ${actionInfo.color}`}>
                {actionInfo.action}
              </div>
              <div className="text-sm text-[#93a4d6]">
                {actionInfo.description}
              </div>
            </div>

            {/* Phase indicator */}
            <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-[#93a4d6]">Phase</span>
                <span className="text-sm font-semibold" style={{ color: phaseColor }}>
                  {Math.round(phase * 100)}%
                  {ticker.phase_zone && ` (${ticker.phase_zone})`}
                </span>
              </div>
              <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                <div 
                  className="h-full rounded-full transition-all duration-500"
                  style={{ 
                    width: `${phase * 100}%`,
                    backgroundColor: phaseColor,
                    boxShadow: `0 0 8px ${phaseColor}40`
                  }}
                />
              </div>
            </div>

            <div className="space-y-2.5 text-sm">
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">Rank</span>
                <span className="font-semibold">{ticker.rank || "‚Äî"}</span>
              </div>
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">RR</span>
                <span className="font-semibold">{ticker.rr ? Number(ticker.rr).toFixed(2) : "‚Äî"}</span>
              </div>
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">State</span>
                <span className="font-semibold">{ticker.state || "‚Äî"}</span>
              </div>
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">Completion</span>
                <span className="font-semibold">{Math.round(completionForSize(ticker) * 100)}%</span>
              </div>
              {ent.corridor && (
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Corridor</span>
                  <span className="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-semibold">
                    {ent.side}
                  </span>
                </div>
              )}
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">Price</span>
                <span className="font-semibold">
                  {ticker.price ? Number(ticker.price).toFixed(2) : "‚Äî"}
                </span>
              </div>
              <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                <span className="text-[#93a4d6]">TP</span>
                <span className="font-semibold">{ticker.tp ? Number(ticker.tp).toFixed(2) : "‚Äî"}</span>
              </div>
              {ticker.tp_levels && Array.isArray(ticker.tp_levels) && ticker.tp_levels.length > 1 && (
                <div className="py-1 border-b border-[#26325f]/50">
                  <div className="text-[#93a4d6] text-xs mb-1">TP Levels</div>
                  <div className="text-xs font-mono text-[#93a4d6]">
                    {ticker.tp_levels.map(tp => Number(tp).toFixed(2)).join(", ")}
                  </div>
                </div>
              )}
              <div className="flex justify-between items-center py-1">
                <span className="text-[#93a4d6]">SL</span>
                <span className="font-semibold">{ticker.sl ? Number(ticker.sl).toFixed(2) : "‚Äî"}</span>
              </div>
            </div>

            {/* Flags */}
            {(flags.sq30_on || flags.sq30_release || flags.phase_dot || flags.phase_zone_change) && (
              <div className="mt-4 pt-4 border-t border-[#26325f]">
                <div className="text-xs text-[#93a4d6] mb-2">Flags:</div>
                <div className="flex flex-wrap gap-2">
                  {flags.sq30_on && (
                    <span className="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs">
                      üß® Squeeze ON
                    </span>
                  )}
                  {flags.sq30_release && (
                    <span className="px-2 py-1 rounded bg-cyan-500/20 text-cyan-400 text-xs">
                      ‚ö° Squeeze Release
                    </span>
                  )}
                  {flags.phase_dot && (
                    <span className="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs">
                      Phase Dot
                    </span>
                  )}
                  {flags.phase_zone_change && (
                    <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs">
                      Zone Change
                    </span>
                  )}
                </div>
              </div>
            )}

            <div className="mt-4 pt-4 border-t border-[#26325f]">
              <a
                href={`https://www.tradingview.com/chart/MgotVBUg/?symbol=${encodeURIComponent(
                  ticker.ticker
                )}`}
                target="_blank"
                rel="noopener noreferrer"
                className="block w-full text-center px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-all hover:scale-105 font-semibold"
              >
                üìä Open in TradingView
              </a>
            </div>
              </div>
            </div>
          </>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Main App
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function App() {
        const { data, loading, error, lastUpdate, refetch } = useTickerData();
        const [filters, setFilters] = useState({
          search: "",
          quadrants: [
            "HTF_BULL_LTF_PULLBACK",
            "HTF_BULL_LTF_BULL",
            "HTF_BEAR_LTF_BEAR",
            "HTF_BEAR_LTF_PULLBACK",
          ],
          minRank: 0,
          minRR: 0,
          maxCompletion: 1.01,
          group: "ALL",
        });
        const [selectedTicker, setSelectedTicker] = useState(null);
        const [hoveredTicker, setHoveredTicker] = useState(null);

        const debouncedSearch = useDebounce(filters.search, 300);
        const effectiveFilters = { ...filters, search: debouncedSearch };

        const tickers = useMemo(() => {
          return applyFilters(data, effectiveFilters);
        }, [data, effectiveFilters]);

        const primeTickers = useMemo(
          () => tickers.filter(isPrimeBubble),
          [tickers]
        );

        const handleFilterChange = useCallback((newFilters) => {
          setFilters((prev) => ({ ...prev, ...newFilters }));
        }, []);

        return (
          <div className="min-h-screen p-4">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <header className="mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h1 className="text-3xl font-bold">
                    Timed Trading ‚Äî React Dashboard
                  </h1>
                  <div className="flex items-center gap-4">
                    {loading && <div className="loading-spinner"></div>}
                    <button
                      onClick={refetch}
                      className="px-4 py-2 bg-[#1a2550] border border-[#26325f] rounded-lg hover:bg-[#26325f] transition-colors"
                    >
                      Refresh
                    </button>
                    {lastUpdate && (
                      <span className="text-sm text-[#93a4d6]">
                        Updated {lastUpdate.toLocaleTimeString()}
                      </span>
                    )}
                  </div>
                </div>

              {/* Quick Stats */}
              <div className="flex gap-4 text-sm items-center">
                <div className="px-3 py-1.5 rounded-lg bg-[#0f1630] border border-[#26325f]">
                  <span className="text-[#93a4d6]">Tickers: </span>
                  <span className="font-bold text-white">{tickers.length}</span>
                </div>
                <div className="px-3 py-1.5 rounded-lg bg-green-500/10 border border-green-500/30">
                  <span className="text-green-400">Prime: </span>
                  <span className="font-bold text-green-400">{primeTickers.length}</span>
                </div>
                {tickers.length > 0 && (
                  <div className="px-3 py-1.5 rounded-lg bg-[#0f1630] border border-[#26325f]">
                    <span className="text-[#93a4d6]">In Corridor: </span>
                    <span className="font-bold text-white">
                      {tickers.filter(t => entryType(t).corridor).length}
                    </span>
                  </div>
                )}
                {error && (
                  <div className="px-3 py-1.5 rounded-lg bg-red-500/10 border border-red-500/30">
                    <span className="text-red-400">Error: {error}</span>
                  </div>
                )}
              </div>

                {/* Filters */}
                <div className="mt-4">
                  <input
                    type="text"
                    placeholder="Search ticker..."
                    value={filters.search}
                    onChange={(e) =>
                      handleFilterChange({ search: e.target.value })
                    }
                    className="w-full px-4 py-2 bg-[#0f1630] border border-[#26325f] rounded-lg text-white placeholder-[#93a4d6] mb-4"
                  />
                  <QuickFilters
                    filters={filters}
                    onFilterChange={handleFilterChange}
                  />
                </div>
              </header>

              {/* Main Content - Chart on top, full width */}
              <div className="space-y-4">
                {/* Chart - Full width, larger */}
                <div>
                  <div className="h-[800px]">
                    {loading && tickers.length === 0 ? (
                      <div className="w-full h-full bg-[#121a33] rounded-xl border border-[#26325f] flex items-center justify-center">
                        <div className="text-center">
                          <div className="loading-spinner mx-auto mb-4"></div>
                          <div className="text-[#93a4d6]">
                            Loading tickers...
                          </div>
                        </div>
                      </div>
                    ) : (
                      <BubbleChart
                        tickers={tickers}
                        onBubbleClick={setSelectedTicker}
                        hoveredTicker={hoveredTicker}
                        onHover={setHoveredTicker}
                      />
                    )}
                  </div>
                </div>

                {/* Lists below - Multiple columns */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                  {/* Multiple setup lists */}
                  {[
                    { title: "Top Ranked", sort: (a, b) => (Number(b.rank) || 0) - (Number(a.rank) || 0), limit: 15 },
                    { title: "Prime Setups", filter: (t) => isPrimeBubble(t), sort: (a, b) => (Number(b.rank) || 0) - (Number(a.rank) || 0), limit: 15 },
                    { title: "In Corridor", filter: (t) => entryType(t).corridor, sort: (a, b) => (Number(b.rank) || 0) - (Number(a.rank) || 0), limit: 15 },
                    { title: "Squeeze Release", filter: (t) => t.flags?.sq30_release, sort: (a, b) => (Number(b.rank) || 0) - (Number(a.rank) || 0), limit: 15 },
                  ].map((listConfig, idx) => {
                    const listTickers = tickers
                      .filter(listConfig.filter || (() => true))
                      .sort(listConfig.sort)
                      .slice(0, listConfig.limit);
                    
                    if (listTickers.length === 0) return null;
                    
                    return (
                      <div key={idx} className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                        <h2 className="text-lg font-bold mb-4">{listConfig.title}</h2>
                        <div className="max-h-[500px] overflow-y-auto space-y-2">
                          {listTickers.map((ticker) => (
                            <SetupCard
                              key={ticker.ticker}
                              ticker={ticker}
                              isSelected={selectedTicker === ticker.ticker}
                              onClick={() => setSelectedTicker(ticker.ticker)}
                            />
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Selected Ticker Details Overlay */}
                {selectedTicker && (
                  <TickerDetails
                    ticker={tickers.find((t) => t.ticker === selectedTicker)}
                    onClose={() => setSelectedTicker(null)}
                  />
                )}
              </div>
            </div>
          </div>
        );
      }

      // Render with error handling
      try {
        if (typeof React === "undefined" || typeof ReactDOM === "undefined") {
          throw new Error("React or ReactDOM not loaded");
        }

        const rootElement = document.getElementById("root");
        if (!rootElement) {
          throw new Error("Root element not found");
        }

        // Check if React 18 createRoot is available
        if (ReactDOM.createRoot) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(<App />);
        } else {
          // Fallback for React 17
          ReactDOM.render(<App />, rootElement);
        }
      } catch (error) {
        console.error("Error rendering app:", error);
        document.getElementById("root").innerHTML = `
          <div style="padding: 40px; text-align: center; color: #e7ecff;">
            <h2 style="color: #e74c3c;">Error Loading Dashboard</h2>
            <p>${error.message}</p>
            <p style="margin-top: 20px; color: #93a4d6;">
              Please check the browser console (F12) for details.
            </p>
            <p style="margin-top: 10px; color: #93a4d6;">
              Make sure you have an internet connection to load CDN resources.
            </p>
          </div>
        `;
      }
    </script>
  </body>
</html>
