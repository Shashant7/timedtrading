<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timed Trading — System Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="auth-gate.js?v=20260220a"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] } } },
      };
    </script>
    <style>
      body { font-family: "Inter", system-ui, sans-serif; background: #0b0e11; color: #e5e7eb; -webkit-font-smoothing: antialiased; letter-spacing: -0.01em; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; }
      .badge-good { background: rgba(16,185,129,0.15); color: #6ee7b7; }
      .badge-warn { background: rgba(251,191,36,0.15); color: #fcd34d; }
      .badge-bad { background: rgba(244,63,94,0.15); color: #fca5a5; }
      .badge-info { background: rgba(56,189,248,0.12); color: #93c5fd; }
      .btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s; border: none; }
      .btn-primary { background: linear-gradient(135deg, #059669, #10b981); color: white; }
      .btn-primary:hover { background: linear-gradient(135deg, #047857, #059669); }
      .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
      .btn-apply { background: #1d4ed8; color: white; }
      .btn-apply:hover { background: #2563eb; }
      .btn-secondary { background: #334155; color: #94a3b8; border: 1px solid #475569; }
      .btn-secondary:hover { background: #475569; }
      .tab-active { border-bottom: 2px solid #10b981; color: #e8eaf0; }
      .tab-inactive { border-bottom: 2px solid transparent; color: #626b7d; cursor: pointer; }
      .tab-inactive:hover { color: #9098a8; }
      .meter-bar { height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden; }
      .meter-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
      body:not([data-user-role="admin"]) [data-admin-only] { display: none !important; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback } = React;
const API_BASE = "";

function NavHeader() {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const UserBadge = window.TimedUserBadge;
  const storedUser = window.TimedAuthHelpers?.getStoredSession();
  return (
    <nav className="sticky top-0 z-50 border-b border-white/[0.06]" style={{background:"rgba(10,10,15,0.95)",backdropFilter:"blur(12px)"}}>
      <div className="flex items-center justify-between px-4 py-2.5">
        <div className="flex items-center gap-3 md:gap-5 min-w-0">
          <a href="index-react.html" className="flex items-center gap-2 no-underline shrink-0">
            <div className="w-[28px] h-[28px] md:w-[32px] md:h-[32px] rounded-[8px] flex items-center justify-center" style={{background:"linear-gradient(135deg, #00c853, #00e676, #69f0ae)"}}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                <polyline points="16 7 22 7 22 13" />
              </svg>
            </div>
            <span className="text-[14px] md:text-[15px] font-bold text-white hidden sm:inline" style={{letterSpacing:"-0.03em"}}>Timed Trading</span>
          </a>
          <div className="hidden lg:flex items-center gap-0.5">
            <a href="index-react.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Active Trader</a>
            <a href="investor-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Investor</a>
            <a href="simulation-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Trades</a>
            <a href="system-intelligence.html" className="px-3 py-1 rounded-md text-[13px] text-white bg-white/[0.07] font-medium">System Intelligence</a>
            <a href="screener.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Screener</a>
            <a href="ticker-management.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Tickers</a>
            <a href="daily-brief.html" className="relative px-3 py-1 rounded-md text-[13px] text-[#f59e0b]/80 hover:text-[#f59e0b] hover:bg-[#f59e0b]/[0.06] transition-all font-medium">Daily Brief</a>
          </div>
        </div>
        <div className="flex items-center gap-1.5 md:gap-2 shrink-0">
          <a href="/faq.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Guide</a>
          <a href="/faq.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">FAQ</a>
          <a href="index-react.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#60a5fa] hover:text-[#93bbfc] hover:bg-[#60a5fa]/[0.06] transition-all font-medium">Ask AI</a>
          {(storedUser?.role === 'admin' || storedUser?.tier === 'admin') && (
            <a href="admin-clients.html" data-admin-only="true" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#a78bfa]/80 hover:text-[#a78bfa] font-medium">Admin</a>
          )}
          {window.TimedNotificationCenter && <window.TimedNotificationCenter apiBase="" />}
          {UserBadge && <UserBadge user={storedUser} compact />}
        </div>
      </div>
    </nav>
  );
}

// ── Shared helpers ──
function SQNBadge({ sqn }) {
  if (sqn == null) return null;
  const cls = sqn >= 3 ? "badge-good" : sqn >= 2 ? "badge-info" : sqn >= 1 ? "badge-warn" : "badge-bad";
  const label = sqn >= 3 ? "Excellent" : sqn >= 2 ? "Good" : sqn >= 1 ? "Needs Work" : "Broken";
  return <span className={`inline-block px-2 py-0.5 rounded-full text-[11px] font-semibold ${cls}`}>{sqn.toFixed(2)} — {label}</span>;
}
function DeltaBadge({ value, suffix = "", invert = false }) {
  if (value == null || value === 0) return null;
  const positive = invert ? value < 0 : value > 0;
  return <span className={`text-[10px] font-semibold ml-1.5 ${positive ? "text-emerald-400" : "text-rose-400"}`}>{value > 0 ? "+" : ""}{value}{suffix}</span>;
}
function MetricBox({ label, value, delta, suffix = "", color }) {
  return (
    <div className="card p-3">
      <div className="text-[10px] text-slate-500 uppercase tracking-wide mb-1">{label}</div>
      <div className="flex items-baseline gap-1">
        <span className={`text-lg font-bold ${color || "text-white"}`}>{value ?? "—"}{suffix && <span className="text-xs text-slate-400 ml-0.5">{suffix}</span>}</span>
        <DeltaBadge value={delta} />
      </div>
    </div>
  );
}
function BarChart({ data, maxVal, colorFn }) {
  if (!data || !data.length) return null;
  const max = maxVal || Math.max(...data.map(d => Math.abs(d.value)), 1);
  return (
    <div className="space-y-1">
      {data.map((d, i) => (
        <div key={i} className="flex items-center gap-2">
          <span className="text-[10px] text-slate-400 w-16 shrink-0 text-right">{d.label}</span>
          <div className="flex-1 meter-bar">
            <div className="meter-fill" style={{width:`${Math.min(100, Math.abs(d.value)/max*100)}%`, background: colorFn ? colorFn(d.value) : (d.value >= 0 ? "#10b981" : "#f43f5e")}} />
          </div>
          <span className="text-[10px] text-slate-300 w-10 text-right">{d.value}</span>
        </div>
      ))}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// TAB: Dashboard
// ═══════════════════════════════════════════════════════════════
function DashboardTab({ dashboard }) {
  if (!dashboard) return <div className="text-slate-500 text-sm py-8 text-center">Loading dashboard...</div>;
  const s = dashboard.summary || {};
  const d = dashboard.delta || {};
  const mh = dashboard.model_health || {};
  const da = dashboard.direction_accuracy || {};
  return (
    <div className="space-y-5">
      {s.generation && (
        <div className="flex items-center gap-3 mb-2">
          <span className="text-xs text-slate-400">Generation <span className="text-white font-bold">#{s.generation}</span></span>
          {s.run_ts && <span className="text-[10px] text-slate-500">{new Date(s.run_ts).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}</span>}
          {s.applied && <span className="px-1.5 py-0.5 rounded text-[10px] font-semibold badge-good">Applied</span>}
          <SQNBadge sqn={s.sqn} />
        </div>
      )}

      <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        <MetricBox label="SQN" value={s.sqn} delta={d.sqn} color={s.sqn >= 2 ? "text-emerald-400" : s.sqn >= 1 ? "text-amber-400" : "text-rose-400"} />
        <MetricBox label="Win Rate" value={s.win_rate} delta={d.win_rate} suffix="%" />
        <MetricBox label="Expectancy" value={s.expectancy} delta={d.expectancy} color={s.expectancy >= 0 ? "text-emerald-400" : "text-rose-400"} />
        <MetricBox label="Avg R" value={s.avg_r} delta={d.avg_r} color={s.avg_r >= 0 ? "text-emerald-400" : "text-rose-400"} />
        <MetricBox label="Trades" value={s.n || s.trade_count} delta={d.trade_count} />
        <MetricBox label="Profit Factor" value={s.profit_factor} />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Model Health */}
        <div className="card p-4">
          <h3 className="text-sm font-semibold text-white mb-3">Model Health</h3>
          <div className="space-y-2 text-xs">
            <div className="flex justify-between"><span className="text-slate-400">Predictions (total)</span><span className="text-white font-medium">{mh.predictions?.total ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Open predictions</span><span className="text-white font-medium">{mh.predictions?.open ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Hit rate</span><span className="text-white font-medium">{mh.outcomes?.hitRate ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Active patterns</span><span className="text-white font-medium">{mh.patterns?.active ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Degraded patterns</span><span className={`font-medium ${(mh.patterns?.degraded || 0) > 0 ? "text-rose-400" : "text-white"}`}>{mh.patterns?.degraded ?? "—"}</span></div>
          </div>
        </div>

        {/* Direction Accuracy */}
        <div className="card p-4">
          <h3 className="text-sm font-semibold text-white mb-3">Direction Accuracy</h3>
          <div className="space-y-2 text-xs">
            <div className="flex justify-between"><span className="text-slate-400">Total resolved</span><span className="text-white font-medium">{da.total ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Correct</span><span className="text-emerald-400 font-medium">{da.correct ?? "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Accuracy</span><span className="text-white font-bold">{da.accuracy != null ? da.accuracy + "%" : "—"}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Wins / Losses</span><span className="text-white font-medium">{da.wins ?? "—"} / {da.losses ?? "—"}</span></div>
          </div>
        </div>
      </div>

      {/* What's working / Proceed with caution */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="card p-4">
          <h3 className="text-sm font-semibold text-emerald-400 mb-3">What's Working</h3>
          {(dashboard.whats_working || []).length === 0 ? (
            <p className="text-xs text-slate-500">No data yet — run a calibration first.</p>
          ) : (
            <div className="space-y-2">
              {dashboard.whats_working.map((p, i) => (
                <div key={i} className="flex items-center justify-between text-xs">
                  <span className="font-mono text-slate-300">{p.path}</span>
                  <div className="flex items-center gap-3">
                    <span className="text-slate-400">{p.n} trades</span>
                    <span className="text-emerald-400 font-medium">{p.win_rate}% WR</span>
                    <span className="text-white font-medium">{p.expectancy} exp</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
        <div className="card p-4">
          <h3 className="text-sm font-semibold text-amber-400 mb-3">Proceed with Caution</h3>
          {(dashboard.proceed_with_caution || []).length === 0 ? (
            <p className="text-xs text-slate-500">No concerning paths identified.</p>
          ) : (
            <div className="space-y-2">
              {dashboard.proceed_with_caution.map((p, i) => (
                <div key={i} className="flex items-center justify-between text-xs">
                  <span className="font-mono text-slate-300">{p.path}</span>
                  <div className="flex items-center gap-3">
                    <span className="text-slate-400">{p.n} trades</span>
                    <span className="text-rose-400 font-medium">{p.win_rate}% WR</span>
                    <span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${p.action === "DISABLE" ? "badge-bad" : "badge-warn"}`}>{p.action}</span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// TAB: Calibration (all analysis sub-tabs)
// ═══════════════════════════════════════════════════════════════
function SystemHealthCard({ health }) {
  if (!health) return null;
  const o = health.overall;
  return (
    <div className="card p-5">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-sm font-semibold text-white">System Health (SQN)</h3>
        <SQNBadge sqn={o.sqn} />
      </div>
      <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
        <div><div className="text-[10px] text-slate-500 uppercase">Trades</div><div className="text-lg font-bold">{o.n}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Win Rate</div><div className="text-lg font-bold">{o.win_rate}%</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Expectancy</div><div className={`text-lg font-bold ${o.expectancy >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{o.expectancy}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Avg R</div><div className={`text-lg font-bold ${o.avg_r >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{o.avg_r}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Profit Factor</div><div className="text-lg font-bold">{o.profit_factor}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">SQN</div><div className="text-lg font-bold">{o.sqn}</div></div>
      </div>
      {health.by_regime && Object.keys(health.by_regime).length > 0 && (
        <div>
          <div className="text-xs text-slate-400 mb-2 font-medium">By Regime</div>
          <div className="overflow-x-auto">
            <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
              <th className="text-left py-1.5 pr-3 font-medium">Regime</th><th className="text-right px-2 font-medium">N</th><th className="text-right px-2 font-medium">Win%</th><th className="text-right px-2 font-medium">Exp</th><th className="text-right pl-2 font-medium">SQN</th>
            </tr></thead><tbody>
              {Object.entries(health.by_regime).map(([r, d]) => (
                <tr key={r} className="border-b border-white/[0.03]">
                  <td className="py-1.5 pr-3 text-slate-300">{r}</td><td className="text-right px-2">{d.n}</td><td className="text-right px-2">{d.win_rate}%</td>
                  <td className={`text-right px-2 ${d.expectancy >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{d.expectancy}</td>
                  <td className="text-right pl-2"><SQNBadge sqn={d.sqn} /></td>
                </tr>
              ))}
            </tbody></table>
          </div>
        </div>
      )}
    </div>
  );
}
function EntryPathsCard({ paths }) {
  if (!paths) return null;
  const sorted = Object.entries(paths).sort((a, b) => (b[1].n || 0) - (a[1].n || 0));
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Entry Path Performance</h3>
      <div className="overflow-x-auto">
        <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
          <th className="text-left py-1.5 font-medium">Path</th><th className="text-right px-2 font-medium">N</th><th className="text-right px-2 font-medium">Win%</th>
          <th className="text-right px-2 font-medium">Exp</th><th className="text-right px-2 font-medium">SQN</th><th className="text-right px-2 font-medium">MFE(ATR)</th>
          <th className="text-right px-2 font-medium">Kelly%</th><th className="text-right pl-2 font-medium">Action</th>
        </tr></thead><tbody>
          {sorted.map(([path, d]) => (
            <tr key={path} className="border-b border-white/[0.03]">
              <td className="py-1.5 font-mono text-slate-300">{path}</td><td className="text-right px-2">{d.n}</td><td className="text-right px-2">{d.win_rate}%</td>
              <td className={`text-right px-2 ${d.expectancy >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{d.expectancy}</td>
              <td className="text-right px-2">{d.sqn?.toFixed(2)}</td><td className="text-right px-2">{d.avg_mfe_atr?.toFixed(2)}</td>
              <td className="text-right px-2">{d.half_kelly_pct?.toFixed(1)}%</td>
              <td className="text-right pl-2"><span className={`px-1.5 py-0.5 rounded text-[10px] font-semibold ${d.action === "BOOST" ? "badge-good" : d.action === "DISABLE" ? "badge-bad" : d.action === "RESTRICT" ? "badge-warn" : "badge-info"}`}>{d.action}</span></td>
            </tr>
          ))}
        </tbody></table>
      </div>
    </div>
  );
}
function SignalICCard({ ic }) {
  if (!ic) return null;
  const data = Object.entries(ic).map(([k, v]) => ({ label: k, value: v.ic != null ? Number(v.ic.toFixed(3)) : 0 })).sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Signal Information Coefficient</h3>
      <BarChart data={data} colorFn={v => Math.abs(v) > 0.10 ? "#10b981" : Math.abs(v) > 0.05 ? "#fbbf24" : "#6b7280"} />
      <div className="mt-3 text-[10px] text-slate-500">|IC| &gt; 0.10 = strong, &gt; 0.05 = useful, near 0 = noise</div>
    </div>
  );
}
function SLTPCard({ sltp }) {
  if (!sltp) return null;
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">SL/TP Calibration</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div className="text-xs text-slate-400 font-medium mb-2">Stop Loss (Winner MAE in ATR)</div>
          <div className="space-y-1 text-xs">
            <div className="flex justify-between"><span className="text-slate-400">P50</span><span>{sltp.winner_mae?.p50?.toFixed(2)}</span></div>
            <div className="flex justify-between font-medium"><span className="text-amber-400">P75 (recommended)</span><span>{sltp.winner_mae?.p75?.toFixed(2)}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">P90</span><span>{sltp.winner_mae?.p90?.toFixed(2)}</span></div>
          </div>
        </div>
        <div>
          <div className="text-xs text-slate-400 font-medium mb-2">Take Profit (Trade MFE in ATR)</div>
          <div className="space-y-1 text-xs">
            <div className="flex justify-between"><span className="text-slate-400">Trim (P50)</span><span>{sltp.trade_mfe?.p50?.toFixed(2)}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Exit (P75)</span><span>{sltp.trade_mfe?.p75?.toFixed(2)}</span></div>
            <div className="flex justify-between"><span className="text-slate-400">Runner (P90)</span><span>{sltp.trade_mfe?.p90?.toFixed(2)}</span></div>
          </div>
        </div>
      </div>
    </div>
  );
}
function RankCard({ rank }) {
  if (!rank) return null;
  const deciles = rank.deciles || {};
  const data = Object.entries(deciles).map(([k, v]) => ({ label: k, value: v.sqn || 0 }));
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Rank Threshold Optimization</h3>
      <BarChart data={data} />
      <div className="mt-3 text-xs text-slate-400">Best cutoff: <span className="text-white font-semibold">{rank.best_cutoff}</span> (SQN {rank.best_sqn?.toFixed(2)})</div>
    </div>
  );
}
function WFOCard({ wfo }) {
  if (!wfo) return null;
  const pass = wfo.verdict === "PASS";
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Walk-Forward Validation</h3>
      <div className="grid grid-cols-3 gap-4 text-center mb-3">
        <div><div className="text-[10px] text-slate-500 uppercase">In-Sample SQN</div><div className="text-lg font-bold">{wfo.in_sample_sqn?.toFixed(2)}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Out-Sample SQN</div><div className="text-lg font-bold">{wfo.out_sample_sqn?.toFixed(2)}</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Degradation</div><div className="text-lg font-bold">{wfo.degradation_pct?.toFixed(1)}%</div></div>
      </div>
      <div className="text-center"><span className={`px-3 py-1 rounded-full text-xs font-semibold ${pass ? "badge-good" : "badge-warn"}`}>{wfo.verdict}</span></div>
    </div>
  );
}
function MissedOpCard({ missed }) {
  if (!missed) return null;
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Missed Opportunities</h3>
      <div className="text-xs text-slate-400 mb-3">{missed.count} missed out of {missed.total_moves} total moves</div>
      {missed.common_signals && Object.keys(missed.common_signals).length > 0 && (
        <div>
          <div className="text-xs text-slate-400 font-medium mb-2">Common signals at missed moves</div>
          <div className="space-y-1">
            {Object.entries(missed.common_signals).sort((a,b) => b[1] - a[1]).slice(0,8).map(([sig, count]) => (
              <div key={sig} className="flex items-center justify-between text-xs">
                <span className="text-slate-300">{sig}</span><span className="text-slate-400">{count}x</span>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}
function PositionSizingCard({ sizing }) {
  if (!sizing) return null;
  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-3">Position Sizing (Kelly)</h3>
      <div className="grid grid-cols-3 gap-4 text-center">
        <div><div className="text-[10px] text-slate-500 uppercase">Full Kelly</div><div className="text-lg font-bold">{sizing.kelly_full_pct?.toFixed(1)}%</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Half Kelly</div><div className="text-lg font-bold text-emerald-400">{sizing.half_kelly_pct?.toFixed(1)}%</div></div>
        <div><div className="text-[10px] text-slate-500 uppercase">Current</div><div className="text-lg font-bold">{sizing.current_sizing_pct || "5-7%"}</div></div>
      </div>
    </div>
  );
}

function CalibrationTab({ report, recs, reportId, onApply, applying, appliedMsg }) {
  const [sub, setSub] = useState("health");
  if (!report) return <div className="card p-12 text-center text-slate-400 text-sm">No calibration report. Run a calibration first.</div>;
  const subs = [
    { id: "health", label: "Health" }, { id: "paths", label: "Entry Paths" }, { id: "signals", label: "Signals" },
    { id: "sltp", label: "SL/TP" }, { id: "rank", label: "Rank" }, { id: "wfo", label: "Walk-Forward" },
    { id: "missed", label: "Missed" }, { id: "sizing", label: "Sizing" }, { id: "apply", label: "Apply" },
  ];
  return (
    <div>
      <div className="flex gap-1 border-b border-white/[0.06] mb-4 overflow-x-auto">
        {subs.map(t => (
          <button key={t.id} onClick={() => setSub(t.id)} className={`px-3 py-1.5 text-[11px] font-medium whitespace-nowrap ${sub === t.id ? "tab-active" : "tab-inactive"}`}>{t.label}</button>
        ))}
      </div>
      {sub === "health" && <SystemHealthCard health={report.system_health} />}
      {sub === "paths" && <EntryPathsCard paths={report.entry_paths} />}
      {sub === "signals" && <SignalICCard ic={report.signal_ic} />}
      {sub === "sltp" && <SLTPCard sltp={report.sl_tp_calibration} />}
      {sub === "rank" && <RankCard rank={report.rank_optimization} />}
      {sub === "wfo" && <WFOCard wfo={report.wfo_summary} />}
      {sub === "missed" && <MissedOpCard missed={report.missed_opportunities} />}
      {sub === "sizing" && <PositionSizingCard sizing={report.position_sizing} />}
      {sub === "apply" && recs && (
        <div className="card p-5">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-white">Recommendations</h3>
            <button className="btn btn-apply text-xs" onClick={() => onApply(reportId)} disabled={applying}>{applying ? "Applying..." : "Apply All"}</button>
          </div>
          {appliedMsg && <div className="mb-3 p-2 rounded bg-emerald-500/10 border border-emerald-500/20 text-xs text-emerald-300">{appliedMsg}</div>}
          {report.wfo_summary?.verdict === "WARNING" && <div className="mb-3 p-2 rounded bg-amber-500/10 border border-amber-500/20 text-xs text-amber-300">WFO verdict is WARNING — apply with caution.</div>}
          <div className="space-y-2 text-xs">
            {recs.sl_atr != null && <div className="flex justify-between"><span className="text-slate-400">SL (ATR)</span><span className="text-white font-medium">{recs.sl_atr}</span></div>}
            {recs.tp_tiers && <div className="flex justify-between"><span className="text-slate-400">TP Tiers</span><span className="text-white font-medium">Trim {recs.tp_tiers.trim}, Exit {recs.tp_tiers.exit}, Runner {recs.tp_tiers.runner}</span></div>}
            {recs.rank_threshold != null && <div className="flex justify-between"><span className="text-slate-400">Rank Min</span><span className="text-white font-medium">{recs.rank_threshold}</span></div>}
          </div>
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// TAB: Patterns (from Model dashboard)
// ═══════════════════════════════════════════════════════════════
function PatternsTab() {
  const [patterns, setPatterns] = useState(null);
  const [predictions, setPredictions] = useState(null);
  const [retro, setRetro] = useState(null);
  const [sub, setSub] = useState("patterns");

  useEffect(() => {
    const load = async () => {
      try {
        const [patRes, predRes, retroRes] = await Promise.all([
          fetch(`${API_BASE}/timed/model/patterns`, { credentials: "include" }).then(r => r.json()),
          fetch(`${API_BASE}/timed/model/predictions?limit=30`, { credentials: "include" }).then(r => r.json()),
          fetch(`${API_BASE}/timed/model/retrospective`, { credentials: "include" }).then(r => r.json()),
        ]);
        if (patRes.ok) setPatterns(patRes.patterns || []);
        if (predRes.ok) setPredictions(predRes.predictions || []);
        if (retroRes.ok) setRetro(retroRes);
      } catch (_) {}
    };
    load();
  }, []);

  const subs = [
    { id: "patterns", label: "Pattern Library" },
    { id: "predictions", label: "Predictions" },
    { id: "learning", label: "Learning Loop" },
  ];

  return (
    <div>
      <div className="flex gap-1 border-b border-white/[0.06] mb-4 overflow-x-auto">
        {subs.map(t => (
          <button key={t.id} onClick={() => setSub(t.id)} className={`px-3 py-1.5 text-[11px] font-medium whitespace-nowrap ${sub === t.id ? "tab-active" : "tab-inactive"}`}>{t.label}</button>
        ))}
      </div>

      {sub === "patterns" && (
        <div className="card p-5">
          <h3 className="text-sm font-semibold text-white mb-3">Active Patterns</h3>
          {!patterns ? <p className="text-slate-500 text-xs">Loading...</p> : patterns.length === 0 ? <p className="text-slate-500 text-xs">No active patterns.</p> : (
            <div className="overflow-x-auto">
              <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
                <th className="text-left py-1.5 font-medium">Pattern</th><th className="text-right px-2 font-medium">Hit Rate</th>
                <th className="text-right px-2 font-medium">Samples</th><th className="text-right px-2 font-medium">EV</th><th className="text-right pl-2 font-medium">Confidence</th>
              </tr></thead><tbody>
                {patterns.map((p, i) => (
                  <tr key={i} className="border-b border-white/[0.03]">
                    <td className="py-1.5 text-slate-300">{p.name || p.pattern_id}</td>
                    <td className="text-right px-2">{(Number(p.hit_rate) * 100).toFixed(0)}%</td>
                    <td className="text-right px-2">{p.sample_count}</td>
                    <td className={`text-right px-2 ${Number(p.expected_value) >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{Number(p.expected_value).toFixed(2)}</td>
                    <td className="text-right pl-2">{(Number(p.confidence) * 100).toFixed(0)}%</td>
                  </tr>
                ))}
              </tbody></table>
            </div>
          )}
        </div>
      )}

      {sub === "predictions" && (
        <div className="card p-5">
          <h3 className="text-sm font-semibold text-white mb-3">Recent Predictions</h3>
          {!predictions ? <p className="text-slate-500 text-xs">Loading...</p> : predictions.length === 0 ? <p className="text-slate-500 text-xs">No predictions yet.</p> : (
            <div className="overflow-x-auto">
              <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
                <th className="text-left py-1.5 font-medium">Ticker</th><th className="text-left px-2 font-medium">Direction</th>
                <th className="text-left px-2 font-medium">Trigger</th><th className="text-right px-2 font-medium">Confidence</th><th className="text-right pl-2 font-medium">Resolved</th>
              </tr></thead><tbody>
                {predictions.slice(0, 20).map((p, i) => (
                  <tr key={i} className="border-b border-white/[0.03]">
                    <td className="py-1.5 text-white font-medium">{p.ticker}</td>
                    <td className="px-2"><span className={p.direction === "LONG" ? "text-emerald-400" : "text-rose-400"}>{p.direction}</span></td>
                    <td className="px-2 text-slate-400">{p.trigger_type}</td>
                    <td className="text-right px-2">{p.confidence ? (Number(p.confidence) * 100).toFixed(0) + "%" : "—"}</td>
                    <td className="text-right pl-2">{p.resolved ? (p.outcome === "HIT" ? <span className="badge-good px-1.5 py-0.5 rounded text-[10px]">HIT</span> : <span className="badge-bad px-1.5 py-0.5 rounded text-[10px]">MISS</span>) : <span className="text-slate-500">Open</span>}</td>
                  </tr>
                ))}
              </tbody></table>
            </div>
          )}
        </div>
      )}

      {sub === "learning" && retro && (
        <div className="space-y-4">
          <div className="card p-5">
            <h3 className="text-sm font-semibold text-white mb-3">Overall Direction Accuracy</h3>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center">
              <div><div className="text-[10px] text-slate-500 uppercase">Total</div><div className="text-lg font-bold">{retro.overall?.total || 0}</div></div>
              <div><div className="text-[10px] text-slate-500 uppercase">Correct</div><div className="text-lg font-bold text-emerald-400">{retro.overall?.correct || 0}</div></div>
              <div><div className="text-[10px] text-slate-500 uppercase">Wins</div><div className="text-lg font-bold">{retro.overall?.wins || 0}</div></div>
              <div><div className="text-[10px] text-slate-500 uppercase">Avg P&L</div><div className={`text-lg font-bold ${(retro.overall?.avg_pnl_pct || 0) >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{retro.overall?.avg_pnl_pct || 0}%</div></div>
            </div>
          </div>
          {retro.by_path && retro.by_path.length > 0 && (
            <div className="card p-5">
              <h3 className="text-sm font-semibold text-white mb-3">Accuracy by Entry Path</h3>
              <div className="overflow-x-auto">
                <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
                  <th className="text-left py-1.5 font-medium">Path</th><th className="text-right px-2 font-medium">Total</th><th className="text-right px-2 font-medium">Correct</th>
                  <th className="text-right px-2 font-medium">Accuracy</th><th className="text-right pl-2 font-medium">Avg P&L</th>
                </tr></thead><tbody>
                  {retro.by_path.map((p, i) => (
                    <tr key={i} className="border-b border-white/[0.03]">
                      <td className="py-1.5 font-mono text-slate-300">{p.entry_path}</td>
                      <td className="text-right px-2">{p.total}</td><td className="text-right px-2 text-emerald-400">{p.correct}</td>
                      <td className="text-right px-2">{p.total > 0 ? ((p.correct / p.total) * 100).toFixed(0) + "%" : "—"}</td>
                      <td className={`text-right pl-2 ${(p.avg_pnl_pct || 0) >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{p.avg_pnl_pct || 0}%</td>
                    </tr>
                  ))}
                </tbody></table>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// TAB: History
// ═══════════════════════════════════════════════════════════════
function HistoryTab({ onViewReport }) {
  const [history, setHistory] = useState(null);
  useEffect(() => {
    const load = async () => {
      try {
        const res = await fetch(`${API_BASE}/timed/system/history`, { credentials: "include" });
        const data = await res.json();
        if (data.ok) setHistory(data.history || []);
      } catch (_) {}
    };
    load();
  }, []);

  if (!history) return <div className="text-slate-500 text-sm py-8 text-center">Loading history...</div>;
  if (history.length === 0) return <div className="card p-12 text-center text-slate-400 text-sm">No calibration history yet.</div>;

  return (
    <div className="card p-5">
      <h3 className="text-sm font-semibold text-white mb-4">Calibration History</h3>
      <div className="overflow-x-auto">
        <table className="w-full text-xs"><thead><tr className="text-slate-500 border-b border-white/[0.05]">
          <th className="text-left py-1.5 font-medium">Gen</th>
          <th className="text-left px-2 font-medium">Date</th>
          <th className="text-right px-2 font-medium">Trades</th>
          <th className="text-right px-2 font-medium">SQN</th>
          <th className="text-right px-2 font-medium">Win%</th>
          <th className="text-right px-2 font-medium">Exp</th>
          <th className="text-right px-2 font-medium">Avg R</th>
          <th className="text-center px-2 font-medium">Applied</th>
          <th className="text-right pl-2 font-medium"></th>
        </tr></thead><tbody>
          {history.map((row, i) => (
            <tr key={i} className="border-b border-white/[0.03] hover:bg-white/[0.02] cursor-pointer" onClick={() => onViewReport(row.report_id)}>
              <td className="py-2 text-white font-bold">#{row.generation || "?"}</td>
              <td className="px-2 text-slate-400">{row.run_ts ? new Date(row.run_ts).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }) : "—"}</td>
              <td className="text-right px-2">{row.n || row.trade_count}</td>
              <td className="text-right px-2">
                <span className="text-white font-medium">{row.sqn?.toFixed(2) ?? "—"}</span>
                <DeltaBadge value={row.delta_sqn} />
              </td>
              <td className="text-right px-2">
                <span>{row.win_rate ?? "—"}%</span>
                <DeltaBadge value={row.delta_win_rate} suffix="%" />
              </td>
              <td className="text-right px-2">
                <span className={`${(row.expectancy || 0) >= 0 ? "text-emerald-400" : "text-rose-400"}`}>{row.expectancy ?? "—"}</span>
                <DeltaBadge value={row.delta_expectancy} />
              </td>
              <td className="text-right px-2">{row.avg_r ?? "—"}</td>
              <td className="text-center px-2">{row.applied ? <span className="text-emerald-400">✓</span> : <span className="text-slate-600">—</span>}</td>
              <td className="text-right pl-2 text-[10px] text-blue-400 hover:text-blue-300">View</td>
            </tr>
          ))}
        </tbody></table>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════
// MAIN APP
// ═══════════════════════════════════════════════════════════════
function App() {
  const [tab, setTab] = useState("dashboard");
  const [dashboard, setDashboard] = useState(null);
  const [report, setReport] = useState(null);
  const [recs, setRecs] = useState(null);
  const [reportId, setReportId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [running, setRunning] = useState(false);
  const [queued, setQueued] = useState(false);
  const [progress, setProgress] = useState(null);
  const [applying, setApplying] = useState(false);
  const [appliedMsg, setAppliedMsg] = useState(null);
  const [resetting, setResetting] = useState(false);
  const [resetMsg, setResetMsg] = useState(null);
  const [error, setError] = useState(null);
  const pollIntervalRef = React.useRef(null);
  const statusPollRef = React.useRef(null);

  useEffect(() => {
    const session = window.TimedAuthHelpers?.getStoredSession();
    const r = String(session?.role || "").toLowerCase();
    const t = String(session?.tier || "").toLowerCase();
    document.body.setAttribute("data-user-role", (r === "admin" || t === "admin") ? "admin" : (session?.role || ""));
  }, []);

  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const [dashRes, reportRes] = await Promise.all([
        fetch(`${API_BASE}/timed/system/dashboard`, { credentials: "include" }).then(r => r.json()).catch(() => null),
        fetch(`${API_BASE}/timed/calibration/report`, { credentials: "include" }).then(r => r.json()).catch(() => null),
      ]);
      if (dashRes?.ok) setDashboard(dashRes);
      if (reportRes?.ok) {
        setReport(reportRes.report);
        setRecs(reportRes.recommendations);
        setReportId(reportRes.report_id);
      }
    } catch (e) { setError(String(e)); }
    setLoading(false);
  }, []);

  useEffect(() => { fetchData(); }, [fetchData]);

  // Poll status when queued
  useEffect(() => {
    if (!queued) return;
    const fetchStatus = async () => {
      try {
        const res = await fetch(`${API_BASE}/timed/calibration/status`, { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          if (data.ok) {
            setProgress({ message: data.message, step: data.step, total_steps: data.total_steps, steps: data.steps, status: data.status });
            if (data.status === "error" && data.message) setError(data.message);
          }
        }
      } catch (_) {}
    };
    fetchStatus();
    statusPollRef.current = setInterval(fetchStatus, 5000);
    return () => { if (statusPollRef.current) clearInterval(statusPollRef.current); statusPollRef.current = null; };
  }, [queued]);

  useEffect(() => {
    if (!queued) return;
    const tick = async () => {
      try {
        const res = await fetch(`${API_BASE}/timed/calibration/report`, { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          if (data.ok && data.report) {
            setReport(data.report); setRecs(data.recommendations); setReportId(data.report_id);
            setQueued(false); setProgress(null);
            if (pollIntervalRef.current) clearInterval(pollIntervalRef.current);
            fetchData();
            return;
          }
        }
      } catch (_) {}
    };
    pollIntervalRef.current = setInterval(tick, 20000);
    tick();
    return () => { if (pollIntervalRef.current) clearInterval(pollIntervalRef.current); };
  }, [queued]);

  const handleRun = async () => {
    setRunning(true); setError(null); setQueued(false);
    try {
      const res = await fetch(`${API_BASE}/timed/calibration/run`, { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}", credentials: "include" });
      const data = await res.json();
      if (data.ok) { if (data.queued) { setQueued(true); setProgress(null); } else if (data.report) { setReport(data.report); setRecs(data.report?.recommendations); fetchData(); } }
      else setError(data.error || "Calibration failed");
    } catch (e) { setError(String(e)); }
    setRunning(false);
  };
  const handleApply = async (id) => {
    setApplying(true); setAppliedMsg(null);
    try {
      const res = await fetch(`${API_BASE}/timed/calibration/apply`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ report_id: id }), credentials: "include" });
      const data = await res.json();
      if (data.ok) setAppliedMsg(`Applied: ${data.applied?.join(", ")}`);
      else setError(data.error);
    } catch (e) { setError(String(e)); }
    setApplying(false);
  };
  const handleReset = async () => {
    if (!confirm("This will permanently delete ALL trades and reset the account to $100,000. Continue?")) return;
    setResetting(true); setResetMsg(null); setError(null);
    try {
      const res = await fetch(`${API_BASE}/timed/trades/reset`, { method: "POST", headers: { "Content-Type": "application/json" }, body: "{}", credentials: "include" });
      const data = await res.json();
      if (data.ok) { setResetMsg(data.message || "Account reset to $100,000."); setReport(null); setRecs(null); fetchData(); }
      else setError(data.error || "Reset failed");
    } catch (e) { setError(String(e)); }
    setResetting(false);
  };
  const handleViewReport = async (rid) => {
    try {
      const res = await fetch(`${API_BASE}/timed/calibration/report?report_id=${rid}`, { credentials: "include" });
      const data = await res.json();
      if (data.ok) { setReport(data.report); setRecs(data.recommendations); setReportId(data.report_id); setTab("calibration"); }
    } catch (_) {}
  };

  const tabs = [
    { id: "dashboard", label: "Dashboard" },
    { id: "calibration", label: "Calibration" },
    { id: "patterns", label: "Patterns & Learning" },
    { id: "history", label: "History" },
  ];

  return (
    <div className="min-h-screen">
      <NavHeader />
      <div className="max-w-6xl mx-auto px-4 py-6">
        <div className="flex items-center justify-between mb-5">
          <div>
            <h1 className="text-xl font-bold text-white">System Intelligence</h1>
            <p className="text-xs text-slate-400 mt-1">Unified calibration, model performance, and learning loop</p>
          </div>
          <div className="flex items-center gap-2">
            <button className="btn btn-primary text-xs" onClick={handleRun} disabled={running}>
              {running ? <span className="flex items-center gap-1.5"><span className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full" style={{animation:"spin 0.7s linear infinite"}} />Calibrating...</span> : "Run Calibration"}
            </button>
            <button className="btn text-xs" style={{background:"rgba(239,68,68,0.15)", color:"#fca5a5", border:"1px solid rgba(239,68,68,0.25)"}} onClick={handleReset} disabled={resetting}>
              {resetting ? <span className="flex items-center gap-1.5"><span className="w-3 h-3 border-2 border-rose-400/30 border-t-rose-400 rounded-full" style={{animation:"spin 0.7s linear infinite"}} />Resetting...</span> : "Reset Account"}
            </button>
          </div>
        </div>

        {queued && (
          <div className="mb-4 p-4 rounded-lg bg-amber-500/10 border border-amber-500/20 text-sm text-amber-300">
            <div className="font-medium mb-2">Calibration progress</div>
            {progress?.steps && progress.steps.length > 0 ? (
              <ul className="space-y-1.5 mb-3">
                {progress.steps.map((label, idx) => {
                  const stepNum = idx + 1;
                  const completed = progress.step != null && (progress.step > stepNum || (progress.step === stepNum && progress.status === "done"));
                  const current = progress.step === stepNum && progress.status !== "done";
                  return (
                    <li key={idx} className={`flex items-center gap-2 text-xs ${completed ? "text-emerald-400/90" : current ? "text-amber-200 font-medium" : "text-slate-500"}`}>
                      {completed ? <span className="text-emerald-400">✓</span> : current ? <span className="w-3 h-3 border-2 border-amber-400 border-t-transparent rounded-full animate-spin" /> : <span className="w-3 h-3 rounded-full bg-white/10" />}
                      <span>{stepNum}. {label}</span>
                    </li>
                  );
                })}
              </ul>
            ) : <p className="mb-2">Calibration queued. Waiting for next half-hour cron (within ~30 min).</p>}
            {progress?.message && <p className="text-xs text-amber-400/90 mb-1">{progress.message}</p>}
          </div>
        )}
        {error && <div className="mb-4 p-3 rounded-lg bg-rose-500/10 border border-rose-500/20 text-sm text-rose-300">{error}</div>}
        {resetMsg && <div className="mb-4 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-sm text-emerald-300">{resetMsg}</div>}

        {/* Main tabs */}
        <div className="flex gap-1 border-b border-white/[0.06] mb-5 overflow-x-auto">
          {tabs.map(t => (
            <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 text-xs font-medium whitespace-nowrap ${tab === t.id ? "tab-active" : "tab-inactive"}`}>{t.label}</button>
          ))}
        </div>

        {loading && tab === "dashboard" ? (
          <div className="flex items-center justify-center py-20">
            <div className="w-6 h-6 border-2 border-white/20 border-t-emerald-500 rounded-full" style={{animation:"spin 0.7s linear infinite"}} />
          </div>
        ) : (
          <>
            {tab === "dashboard" && <DashboardTab dashboard={dashboard} />}
            {tab === "calibration" && <CalibrationTab report={report} recs={recs} reportId={reportId} onApply={handleApply} applying={applying} appliedMsg={appliedMsg} />}
            {tab === "patterns" && <PatternsTab />}
            {tab === "history" && <HistoryTab onViewReport={handleViewReport} />}
          </>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
