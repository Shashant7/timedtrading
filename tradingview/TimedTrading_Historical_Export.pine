//@version=6
indicator("TimedTrading Historical Candle Export", overlay=false)

// Exports historical OHLCV data for multiple timeframes to backfill the Worker's D1 database.
// 
// Usage:
// 1. Add this indicator to a chart
// 2. Open the Pine Editor "Logs" panel (bottom right)
// 3. Wait for the script to finish (it will print "EXPORT COMPLETE")
// 4. Copy the CSV output from the logs
// 5. Save to a file (e.g., candles_export.csv)
// 6. Run a backfill script to POST each row to /timed/ingest-candles

groupExport = "Export Settings"
exportTicker = input.string("", "Ticker (leave empty for chart symbol)", group=groupExport)
lookbackBars = input.int(200, "Lookback bars per TF", minval=10, maxval=5000, group=groupExport)
batchSize = input.int(50, "Batch size (bars per log)", minval=10, maxval=100, group=groupExport)

sym = exportTicker != "" ? exportTicker : syminfo.ticker

// Build historical arrays for a given timeframe (request.security approach)
var oArr = array.new<float>()
var hArr = array.new<float>()
var lArr = array.new<float>()
var cArr = array.new<float>()
var vArr = array.new<float>()
var tArr = array.new<int>()

// Populate arrays with current bar data (Pine will run this on every bar)
if barstate.isconfirmed
    array.push(oArr, open)
    array.push(hArr, high)
    array.push(lArr, low)
    array.push(cArr, close)
    array.push(vArr, volume)
    array.push(tArr, time_close)
    
    // Keep array size bounded
    if array.size(oArr) > lookbackBars
        array.shift(oArr)
        array.shift(hArr)
        array.shift(lArr)
        array.shift(cArr)
        array.shift(vArr)
        array.shift(tArr)

// Export CSV on the last bar
if barstate.islast and array.size(oArr) > 0
    log.info("=== HISTORICAL CANDLE EXPORT ===")
    log.info("Ticker: " + sym + " | TF: " + timeframe.period + " | Bars: " + str.tostring(array.size(oArr)))
    log.info("ticker,tf,ts,o,h,l,c,v")
    
    // Export in batches to avoid log truncation
    total = array.size(oArr)
    batches = math.ceil(total / batchSize)
    
    for b = 0 to batches - 1
        start = b * batchSize
        end_ = math.min(start + batchSize, total)
        
        batch = ""
        for i = start to end_ - 1
            if i < array.size(oArr)
                o = array.get(oArr, i)
                h = array.get(hArr, i)
                l = array.get(lArr, i)
                c = array.get(cArr, i)
                v = array.get(vArr, i)
                t = array.get(tArr, i)
                
                if not na(o) and not na(h) and not na(l) and not na(c) and not na(t)
                    row = sym + "," + timeframe.period + "," + str.tostring(t) + "," + str.tostring(o) + "," + str.tostring(h) + "," + str.tostring(l) + "," + str.tostring(c) + "," + (na(v) ? "" : str.tostring(v))
                    batch := batch + row + "\n"
        
        if batch != ""
            log.info(batch)
    
    log.info("=== EXPORT COMPLETE ===")
    log.info("IMPORTANT: Run this script on EACH timeframe chart you want to export (1m, 3m, 5m, 10m, 30m, 1H, 4H, D, W)")
