<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Trade Autopsy — Timed Trading</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2300c853'/%3E%3Cstop offset='50%25' stop-color='%2300e676'/%3E%3Cstop offset='100%25' stop-color='%2369f0ae'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='24' height='24' rx='5.5' fill='url(%23g)'/%3E%3Cpolyline points='22 7 13.5 15.5 8.5 10.5 2 17' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpolyline points='16 7 22 7 22 13' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="auth-gate.js?v=20260219a"></script>
    <style>
      :root {
        --tt-bg-base: #0b0e11;
        --tt-bg-surface: rgba(255,255,255,0.02);
        --tt-bg-elevated: rgba(255,255,255,0.035);
        --tt-bg-hover: rgba(255,255,255,0.04);
        --tt-border: rgba(255,255,255,0.04);
        --tt-border-strong: rgba(255,255,255,0.08);
        --tt-text: #e5e7eb;
        --tt-text-muted: #6b7280;
        --tt-text-faint: #4b5563;
        --tt-accent: #14b8a6;
        --tt-negative: #e11d48;
        --tt-amber: #f59e0b;
        --tt-radius: 12px;
        --tt-radius-sm: 8px;
        --tt-font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      body { background: var(--tt-bg-base); color: var(--tt-text); font-family: var(--tt-font); -webkit-font-smoothing: antialiased; margin: 0; }
      .tt-card { background: var(--tt-bg-surface); border: 1px solid var(--tt-border); border-radius: var(--tt-radius); }
      .loading-spinner { width: 28px; height: 28px; position: relative; display: inline-block; }
      .loading-spinner::before { content: ""; position: absolute; inset: 0; border-radius: 6px; background: linear-gradient(135deg, rgba(0,200,83,0.15), rgba(0,200,83,0.04)); animation: tt-loader-pulse 1.6s ease-in-out infinite; }
      .loading-spinner::after { content: ""; position: absolute; left: 3px; right: 3px; top: 50%; height: 2px; background: linear-gradient(90deg, transparent, #00c853, #00e676, #69f0ae, transparent); background-size: 200% 100%; border-radius: 1px; animation: tt-loader-sweep 1.2s ease-in-out infinite; }
      @keyframes tt-loader-pulse { 0%, 100% { opacity: 0.4; transform: scale(0.92); } 50% { opacity: 1; transform: scale(1); } }
      @keyframes tt-loader-sweep { 0% { background-position: -100% 0; opacity: 0.5; } 50% { opacity: 1; } 100% { background-position: 200% 0; opacity: 0.5; } }
      body:not([data-user-role="admin"]) a[data-admin-only] { display: none !important; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
      .trade-row:hover { background: rgba(255,255,255,0.03); cursor: pointer; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;

      const API_BASE = "";

      const CLASSIFICATION_OPTIONS = [
        { value: "", label: "— Select classification —" },
        { value: "bad_trade", label: "Bad Trade" },
        { value: "valid_loss", label: "Valid Trade - Loss" },
        { value: "valid_win", label: "Valid Trade - Win" },
        { value: "improvement_opportunity", label: "Improvement Opportunity" },
        { value: "data_error", label: "Data Error" },
        { value: "edge_case", label: "Edge Case" },
        { value: "execution_issue", label: "Execution Issue" },
        { value: "good_trade", label: "Good Trade (confirmation)" },
      ];

      const fetchOpts = { cache: "no-store", credentials: "include" };

      function formatSignals(snap) {
        if (!snap) return "(no snapshot)";
        try {
          const parsed = typeof snap === "string" ? JSON.parse(snap) : snap;
          if (!parsed?.tf || typeof parsed.tf !== "object") return "(empty)";
          const lines = [];
          for (const [tf, data] of Object.entries(parsed.tf)) {
            const sigs = data?.signals;
            if (!sigs || typeof sigs !== "object") continue;
            const parts = [];
            for (const [k, v] of Object.entries(sigs)) {
              if (v != null && Number.isFinite(v)) parts.push(`${k}=${v}`);
            }
            if (parts.length) lines.push(`  ${tf}: ${parts.join(", ")}`);
          }
          return lines.length ? lines.join("\n") : "(no signals)";
        } catch { return "(parse error)"; }
      }

      function formatTfStack(tfStackJson) {
        if (!tfStackJson) return "(no stack)";
        try {
          const parsed = typeof tfStackJson === "string" ? JSON.parse(tfStackJson) : tfStackJson;
          if (!Array.isArray(parsed)) return "(empty)";
          return parsed.map(e => `  ${e.tf}: ${e.bias || "?"}`).join("\n") || "(empty)";
        } catch { return "(parse error)"; }
      }

      function formatDate(ms) {
        if (!Number.isFinite(ms)) return "—";
        const d = new Date(ms);
        return d.toLocaleString("en-US", { timeZone: "America/New_York", month: "short", day: "numeric", hour: "numeric", minute: "2-digit", hour12: true });
      }

      function fmtUsd(n) {
        if (!Number.isFinite(n)) return "—";
        return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 2 }).format(n);
      }

      // ── Interactive Chart (TradingView Lightweight Charts) ───────────────────
      function AutopsyChart({ ticker, entryTs, exitTs, entryPrice, exitPrice }) {
        const containerRef = useRef(null);
        const chartRef = useRef(null);
        const seriesRef = useRef(null);
        const priceLinesRef = useRef([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [tf, setTf] = useState("10");

        const mapCandles = useCallback((candles) => {
          return candles.map(c => {
            const rawTs = Number(c.ts);
            const ts = rawTs > 1e12 ? rawTs / 1000 : rawTs;
            const up = Number(c.c) >= Number(c.o);
            return {
              time: ts,
              open: Number(c.o),
              high: Number(c.h),
              low: Number(c.l),
              close: Number(c.c),
            };
          }).filter(c => c.open > 0 && c.high > 0).sort((a, b) => a.time - b.time);
        }, []);

        useEffect(() => {
          if (!containerRef.current || !ticker || typeof LightweightCharts === "undefined") {
            setLoading(false);
            setError("Charts unavailable");
            return;
          }

          const asOfTs = exitTs && Number.isFinite(exitTs) ? exitTs : null;
          const limit = 250;

          const chart = LightweightCharts.createChart(containerRef.current, {
            width: containerRef.current.clientWidth,
            height: 360,
            layout: {
              background: { type: "solid", color: "#0b0e11" },
              textColor: "#6b7280",
              fontSize: 10,
            },
            grid: {
              vertLines: { color: "rgba(38,50,95,0.35)" },
              horzLines: { color: "rgba(38,50,95,0.35)" },
            },
            crosshair: {
              mode: LightweightCharts.CrosshairMode.Normal,
              vertLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2, labelBackgroundColor: "#1e293b" },
              horzLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2, labelBackgroundColor: "#1e293b" },
            },
            rightPriceScale: {
              borderColor: "rgba(38,50,95,0.5)",
              scaleMargins: { top: 0.08, bottom: 0.08 },
              autoScale: true,
            },
            timeScale: {
              borderColor: "rgba(38,50,95,0.5)",
              timeVisible: true,
              secondsVisible: false,
              rightOffset: 3,
              tickMarkFormatter: (time) => {
                try {
                  const d = new Date(time * 1000);
                  return d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", timeZone: "America/New_York" });
                } catch { return ""; }
              },
            },
            localization: {
              timeFormatter: (time) => {
                try {
                  const d = new Date(time * 1000);
                  return d.toLocaleString("en-US", { hour: "numeric", minute: "2-digit", second: "2-digit", timeZone: "America/New_York" });
                } catch { return ""; }
              },
            },
            handleScroll: { vertTouchDrag: false },
          });
          chartRef.current = chart;

          const candleSeries = chart.addCandlestickSeries({
            upColor: "#22c55e",
            downColor: "#ef4444",
            borderUpColor: "#22c55e",
            borderDownColor: "#ef4444",
            wickUpColor: "#22c55e",
            wickDownColor: "#ef4444",
          });
          seriesRef.current = candleSeries;

          const url = `${API_BASE}/timed/candles?ticker=${encodeURIComponent(ticker)}&tf=${tf}&limit=${limit}${asOfTs ? "&asOfTs=" + asOfTs : ""}`;
          fetch(url, { cache: "no-store" })
            .then(r => r.json())
            .then(data => {
              if (!data.ok || !data.candles || data.candles.length === 0) {
                setError("No chart data for this ticker");
                setLoading(false);
                return;
              }
              const mapped = mapCandles(data.candles);
              candleSeries.setData(mapped);

              // Add entry/exit price lines
              for (const pl of priceLinesRef.current) {
                try { candleSeries.removePriceLine(pl); } catch (_) {}
              }
              priceLinesRef.current = [];
              const ep = Number(entryPrice);
              const xp = Number(exitPrice);
              if (Number.isFinite(ep) && ep > 0) {
                const pl = candleSeries.createPriceLine({
                  price: ep,
                  color: "#60a5fa",
                  lineWidth: 1,
                  lineStyle: LightweightCharts.LineStyle.Dashed,
                  axisLabelVisible: true,
                  title: "Entry",
                });
                priceLinesRef.current.push(pl);
              }
              if (Number.isFinite(xp) && xp > 0 && xp !== ep) {
                const pl = candleSeries.createPriceLine({
                  price: xp,
                  color: "#f59e0b",
                  lineWidth: 1,
                  lineStyle: LightweightCharts.LineStyle.Dashed,
                  axisLabelVisible: true,
                  title: "Exit",
                });
                priceLinesRef.current.push(pl);
              }

              chart.timeScale().fitContent();
              requestAnimationFrame(() => {
                if (chartRef.current) chartRef.current.timeScale().scrollToPosition(-3, false);
              });
              setLoading(false);
            })
            .catch(e => {
              setError("Failed to load chart");
              setLoading(false);
            });

          const handleResize = () => {
            if (containerRef.current && chartRef.current) {
              chartRef.current.applyOptions({ width: containerRef.current.clientWidth });
            }
          };
          const ro = typeof ResizeObserver !== "undefined" ? new ResizeObserver(handleResize) : null;
          if (ro) ro.observe(containerRef.current);
          window.addEventListener("resize", handleResize);

          return () => {
            if (ro) ro.disconnect();
            window.removeEventListener("resize", handleResize);
            priceLinesRef.current = [];
            chart.remove();
            chartRef.current = null;
            seriesRef.current = null;
          };
        }, [ticker, exitTs, tf, entryPrice, exitPrice, mapCandles]);

        return (
          <div className="tt-card overflow-hidden">
            <div className="px-3 py-2 flex items-center justify-between border-b border-white/[0.04]">
              <span className="text-[13px] font-semibold text-[#14b8a6]">{ticker}</span>
              <div className="flex items-center gap-1">
                {["5", "10", "60", "D"].map(t => (
                  <button
                    key={t}
                    onClick={() => setTf(t)}
                    className={`px-2 py-1 rounded text-[11px] font-medium ${tf === t ? "bg-white/10 text-white" : "text-[#6b7280] hover:text-white"}`}
                  >
                    {t === "D" ? "1D" : t + "m"}
                  </button>
                ))}
              </div>
            </div>
            <div ref={containerRef} style={{ height: 360 }}>
              {error && !loading && (
                <div className="flex items-center justify-center h-full text-[#6b7280] text-[13px]">{error}</div>
              )}
              {loading && (
                <div className="flex items-center justify-center h-full">
                  <div className="loading-spinner" style={{ width: 24, height: 24 }} />
                </div>
              )}
            </div>
          </div>
        );
      }

      // ── Autopsy Modal ───────────────────────────────────────────────────────
      function AutopsyModal({ trade, annotations, onSave, onClose }) {
        const [notes, setNotes] = useState(annotations?.notes ?? "");
        const [classification, setClassification] = useState(annotations?.classification ?? "");
        const [saving, setSaving] = useState(false);

        const tradeId = trade?.trade_id || trade?.id || `${trade?.ticker}-${trade?.entry_ts}`;

        const handleSave = async () => {
          setSaving(true);
          try {
            const res = await fetch(`${API_BASE}/timed/admin/trade-autopsy/annotations`, {
              ...fetchOpts,
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ trade_id: tradeId, classification, notes }),
            });
            const data = await res.json();
            if (data.ok) {
              onSave?.();
              onClose?.();
            }
          } finally {
            setSaving(false);
          }
        };

        const entrySnap = trade?.signal_snapshot_json;
        const tfStack = trade?.tf_stack_json;
        const mfe = trade?.max_favorable_excursion;
        const mae = trade?.max_adverse_excursion;
        const exitReason = trade?.exit_reason;

        return (
          <div className="fixed inset-0 z-[100] flex items-center justify-center p-4" style={{ background: "rgba(0,0,0,0.7)", backdropFilter: "blur(4px)" }} onClick={onClose}>
            <div className="tt-card w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
              <div className="sticky top-0 z-10 flex items-center justify-between px-4 py-3 border-b border-white/[0.06]" style={{ background: "var(--tt-bg-surface)" }}>
                <h2 className="text-[15px] font-semibold text-white">
                  {trade?.ticker} {trade?.direction || ""} — Trade Autopsy
                </h2>
                <button onClick={onClose} className="p-1.5 rounded-md text-[#6b7280] hover:text-white hover:bg-white/[0.06]">✕</button>
              </div>

              <div className="p-4 space-y-4">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-[12px] text-[#9ca3af]">
                  <div>Entry: {formatDate(trade?.entry_ts)} @ {fmtUsd(trade?.entry_price || trade?.entryPrice)}</div>
                  <div>Exit: {formatDate(trade?.exit_ts)} @ {fmtUsd(trade?.exit_price || trade?.exitPrice)}</div>
                  <div>P&L: <span className={Number(trade?.pnl) >= 0 ? "text-[#22c55e]" : "text-[#ef4444]"}>{fmtUsd(trade?.pnl)}</span></div>
                  <div>Status: {trade?.status || "—"}</div>
                </div>

                {(entrySnap || tfStack) && (
                  <div className="tt-card p-3">
                    <div className="text-[11px] font-semibold text-[#6b7280] uppercase tracking-wider mb-1.5">Signal snapshot at entry</div>
                    {entrySnap && <pre className="text-[11px] text-[#9ca3af] whitespace-pre-wrap font-mono">{formatSignals(entrySnap)}</pre>}
                    {tfStack && <><div className="text-[11px] text-[#6b7280] mt-1.5">TF bias stack:</div><pre className="text-[11px] text-[#9ca3af] whitespace-pre-wrap font-mono">{formatTfStack(tfStack)}</pre></>}
                    {trade?.entry_path && <div className="text-[11px] text-[#6b7280] mt-1">Path: {trade.entry_path}</div>}
                  </div>
                )}

                {(exitReason != null || Number.isFinite(mfe) || Number.isFinite(mae)) && (
                  <div className="tt-card p-3">
                    <div className="text-[11px] font-semibold text-[#6b7280] uppercase tracking-wider mb-1.5">Exit context</div>
                    <div className="text-[12px] text-[#9ca3af] space-y-0.5">
                      {exitReason && <div>Reason: {exitReason}</div>}
                      {Number.isFinite(mfe) && <div>MFE: {mfe.toFixed(2)}%</div>}
                      {Number.isFinite(mae) && <div>MAE: {mae.toFixed(2)}%</div>}
                    </div>
                  </div>
                )}

                <AutopsyChart
                  ticker={trade?.ticker}
                  entryTs={trade?.entry_ts}
                  exitTs={trade?.exit_ts}
                  entryPrice={trade?.entry_price || trade?.entryPrice}
                  exitPrice={trade?.exit_price || trade?.exitPrice}
                />

                <div>
                  <label className="block text-[12px] font-medium text-[#9ca3af] mb-1.5">Classification</label>
                  <select
                    value={classification}
                    onChange={e => setClassification(e.target.value)}
                    className="w-full px-3 py-2 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white focus:outline-none focus:ring-1 focus:ring-[#14b8a6]/50"
                  >
                    {CLASSIFICATION_OPTIONS.map(opt => (
                      <option key={opt.value || "empty"} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-[12px] font-medium text-[#9ca3af] mb-1.5">Notes / Description</label>
                  <textarea
                    value={notes}
                    onChange={e => setNotes(e.target.value)}
                    placeholder="Add notes about this trade (e.g., what went wrong, lessons learned, data issues...)"
                    rows={4}
                    className="w-full px-3 py-2 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white placeholder-[#4b5563] focus:outline-none focus:ring-1 focus:ring-[#14b8a6]/50 resize-none"
                  />
                </div>

                <div className="flex justify-end gap-2 pt-2">
                  <button onClick={onClose} className="px-4 py-2 rounded-lg text-[13px] text-[#9ca3af] hover:bg-white/[0.04]" disabled={saving}>Cancel</button>
                  <button onClick={handleSave} disabled={saving} className="px-4 py-2 rounded-lg text-[13px] font-medium bg-[#14b8a6]/20 text-[#14b8a6] hover:bg-[#14b8a6]/30 disabled:opacity-50">{saving ? "Saving…" : "Save"}</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ── Main App ───────────────────────────────────────────────────────────
      function App({ user }) {
        const [trades, setTrades] = useState([]);
        const [annotations, setAnnotations] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedTrade, setSelectedTrade] = useState(null);
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
        const [filterTicker, setFilterTicker] = useState("");
        const [filterClassification, setFilterClassification] = useState("");
        const [filterDateFrom, setFilterDateFrom] = useState("");
        const [filterDateTo, setFilterDateTo] = useState("");

        const refreshAnnotations = useCallback(async () => {
          try {
            const r = await fetch(`${API_BASE}/timed/admin/trade-autopsy/annotations?all=1`, fetchOpts);
            const d = await r.json();
            if (d.ok && d.annotations) setAnnotations(d.annotations);
          } catch (_) {}
        }, []);

        useEffect(() => {
          Promise.all([
            fetch(`${API_BASE}/timed/admin/trade-autopsy/trades`, fetchOpts).then(r => r.json()),
            fetch(`${API_BASE}/timed/admin/trade-autopsy/annotations?all=1`, fetchOpts).then(r => r.json()),
          ]).then(([tradesData, annData]) => {
            if (tradesData.ok && Array.isArray(tradesData.trades)) setTrades(tradesData.trades);
            else setError(tradesData?.error === "unauthorized" ? "Admin access required" : "Failed to load trades");
            if (annData.ok && annData.annotations) setAnnotations(annData.annotations);
          }).catch(() => setError("Failed to load trades")).finally(() => setLoading(false));
        }, []);

        const filteredTrades = useMemo(() => {
          let out = trades;
          if (filterTicker.trim()) {
            const q = filterTicker.trim().toUpperCase();
            out = out.filter(t => String(t.ticker || "").toUpperCase().includes(q));
          }
          if (filterClassification) {
            out = out.filter(t => {
              const id = t?.trade_id || t?.id || `${t?.ticker}-${t?.entry_ts}`;
              return (annotations[id]?.classification || "") === filterClassification;
            });
          }
          if (filterDateFrom) {
            const fromMs = new Date(filterDateFrom + "T00:00:00").getTime();
            out = out.filter(t => (t.entry_ts || 0) >= fromMs);
          }
          if (filterDateTo) {
            const toMs = new Date(filterDateTo + "T23:59:59").getTime();
            out = out.filter(t => (t.entry_ts || 0) <= toMs);
          }
          return out;
        }, [trades, annotations, filterTicker, filterClassification, filterDateFrom, filterDateTo]);

        const getAnnotation = (t) => {
          const id = t?.trade_id || t?.id || `${t?.ticker}-${t?.entry_ts}`;
          return annotations[id] || {};
        };

        return (
          <div className="min-h-screen pb-16" style={{ background: "var(--tt-bg-base)" }}>
            <nav className="sticky top-0 z-50 border-b border-white/[0.04]" style={{ background: "rgba(11,14,17,0.85)", backdropFilter: "blur(12px)" }}>
              <div className="max-w-[1400px] mx-auto px-4 md:px-6 py-2.5 md:py-3 flex items-center justify-between">
                <div className="flex items-center gap-3 md:gap-5 min-w-0">
                  <a href="index-react.html" className="flex items-center gap-2 no-underline shrink-0">
                    <div className="w-[28px] h-[28px] rounded-[8px] flex items-center justify-center" style={{ background: "linear-gradient(135deg, #00c853, #00e676, #69f0ae)" }}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" />
                      </svg>
                    </div>
                    <span className="text-[14px] md:text-[15px] font-bold text-white hidden sm:inline" style={{ letterSpacing: "-0.03em" }}>Timed Trading</span>
                  </a>
                  <div className="hidden lg:flex items-center gap-1">
                    <a href="index-react.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Analysis</a>
                    <a href="simulation-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Trades</a>
                    <a href="trade-autopsy.html" className="px-3 py-1.5 rounded-md text-[13px] font-medium text-[#14b8a6] bg-[#14b8a6]/[0.08] border border-[#14b8a6]/20">Trade Autopsy</a>
                    <a href="daily-brief.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Daily Brief</a>
                  </div>
                </div>
                <button onClick={() => setMobileMenuOpen(v => !v)} className="lg:hidden p-1.5 rounded-md text-[#6b7280] hover:text-white" aria-label="Menu">
                  {mobileMenuOpen ? <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> : <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>}
                </button>
              </div>
              {mobileMenuOpen && (
                <div className="lg:hidden border-t border-white/[0.06] px-4 py-2 flex flex-col gap-0.5" style={{ background: "rgba(10,10,15,0.98)" }}>
                  <a href="index-react.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white" onClick={() => setMobileMenuOpen(false)}>Analysis</a>
                  <a href="simulation-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white" onClick={() => setMobileMenuOpen(false)}>Trades</a>
                  <a href="trade-autopsy.html" className="px-3 py-2 rounded-md text-[13px] text-[#14b8a6] font-medium" onClick={() => setMobileMenuOpen(false)}>Trade Autopsy</a>
                  <a href="daily-brief.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white" onClick={() => setMobileMenuOpen(false)}>Daily Brief</a>
                </div>
              )}
            </nav>

            <main className="max-w-[1200px] mx-auto px-4 md:px-6 py-6">
              <h1 className="text-xl font-semibold text-white mb-1">Trade Autopsy</h1>
              <p className="text-[13px] text-[#6b7280] mb-4">Review and annotate trades. Click a row to open the chart and add classification.</p>

              {!loading && !error && trades.length > 0 && (
                <div className="flex flex-wrap gap-3 mb-4">
                  <input
                    type="text"
                    placeholder="Filter by ticker"
                    value={filterTicker}
                    onChange={e => setFilterTicker(e.target.value)}
                    className="px-3 py-1.5 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white placeholder-[#4b5563] w-32"
                  />
                  <select
                    value={filterClassification}
                    onChange={e => setFilterClassification(e.target.value)}
                    className="px-3 py-1.5 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white"
                  >
                    <option value="">All classifications</option>
                    {CLASSIFICATION_OPTIONS.filter(o => o.value).map(o => (
                      <option key={o.value} value={o.value}>{o.label}</option>
                    ))}
                  </select>
                  <input
                    type="date"
                    value={filterDateFrom}
                    onChange={e => setFilterDateFrom(e.target.value)}
                    className="px-3 py-1.5 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white"
                  />
                  <input
                    type="date"
                    value={filterDateTo}
                    onChange={e => setFilterDateTo(e.target.value)}
                    className="px-3 py-1.5 rounded-lg bg-white/[0.04] border border-white/[0.06] text-[13px] text-white"
                  />
                  {(filterTicker || filterClassification || filterDateFrom || filterDateTo) && (
                    <button onClick={() => { setFilterTicker(""); setFilterClassification(""); setFilterDateFrom(""); setFilterDateTo(""); }} className="px-2 py-1.5 text-[12px] text-[#6b7280] hover:text-white">Clear</button>
                  )}
                  {filteredTrades.length !== trades.length && (
                    <span className="text-[12px] text-[#6b7280] self-center">Showing {filteredTrades.length} of {trades.length}</span>
                  )}
                </div>
              )}

              {loading && (
                <div className="flex items-center justify-center py-16">
                  <div className="loading-spinner" />
                </div>
              )}

              {error && (
                <div className="tt-card p-6 text-center text-[#ef4444]">{error}</div>
              )}

              {!loading && !error && trades.length === 0 && (
                <div className="tt-card p-12 text-center text-[#6b7280]">No closed trades to review.</div>
              )}

              {!loading && !error && trades.length > 0 && filteredTrades.length === 0 && (
                <div className="tt-card p-12 text-center text-[#6b7280]">No trades match the current filters.</div>
              )}

              {!loading && !error && filteredTrades.length > 0 && (
                <div className="tt-card overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full text-[13px]">
                      <thead>
                        <tr className="border-b border-white/[0.06]">
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Ticker</th>
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Dir</th>
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Entry</th>
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Exit</th>
                          <th className="px-4 py-3 text-right font-semibold text-[#6b7280]">P&L</th>
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Status</th>
                          <th className="px-4 py-3 text-left font-semibold text-[#6b7280]">Classification</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredTrades.map((t, i) => {
                          const ann = getAnnotation(t);
                          const clsOpt = CLASSIFICATION_OPTIONS.find(o => o.value === ann.classification);
                          return (
                            <tr
                              key={t.trade_id || t.id || i}
                              className="trade-row border-b border-white/[0.04]"
                              onClick={() => setSelectedTrade(t)}
                            >
                              <td className="px-4 py-2.5 font-medium text-white">{t.ticker}</td>
                              <td className="px-4 py-2.5 text-[#9ca3af]">{t.direction || "—"}</td>
                              <td className="px-4 py-2.5 text-[#9ca3af]">{formatDate(t.entry_ts)}</td>
                              <td className="px-4 py-2.5 text-[#9ca3af]">{formatDate(t.exit_ts)}</td>
                              <td className={`px-4 py-2.5 text-right font-medium ${Number(t.pnl) >= 0 ? "text-[#22c55e]" : "text-[#ef4444]"}`}>{fmtUsd(t.pnl)}</td>
                              <td className="px-4 py-2.5 text-[#9ca3af]">{t.status || "—"}</td>
                              <td className="px-4 py-2.5 text-[#6b7280]">{clsOpt?.label || "—"}</td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </main>

            <footer className="max-w-[1200px] mx-auto px-4 md:px-6 py-4 text-center text-[11px] text-[#4b5563]">
              For informational and educational purposes only. Not investment advice. Past performance does not guarantee future results. All trading involves risk of loss. <a href="/terms.html" className="text-[#6b7280] underline hover:text-[#9ca3af]">Full Terms</a> · Market data powered by <a href="https://twelvedata.com" target="_blank" rel="noopener" className="text-[#6b7280] underline hover:text-[#9ca3af]">Twelve Data</a>
            </footer>

            {selectedTrade && (
              <AutopsyModal
                trade={selectedTrade}
                annotations={getAnnotation(selectedTrade)}
                onSave={refreshAnnotations}
                onClose={() => setSelectedTrade(null)}
              />
            )}
          </div>
        );
      }

      // Bootstrap
      (function () {
        const session = window.TimedAuthHelpers?.getStoredSession?.();
        const root = document.getElementById("root");
        if (!session) {
          root.innerHTML = '<div class="flex items-center justify-center min-h-screen bg-[#0b0e11] text-[#6b7280] font-[Inter]"><p>Please <a href="index-react.html" class="text-[#00c853]">sign in</a> to view Trade Autopsy.</p></div>';
          return;
        }
        ReactDOM.createRoot(root).render(<App user={session} />);
      })();
    </script>
  </body>
</html>
