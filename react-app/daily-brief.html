<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Daily Brief â€” Timed Trading</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="auth-gate.js"></script>
    <style>
      :root {
        --tt-bg-base: #0b0e11;
        --tt-bg-surface: rgba(255,255,255,0.02);
        --tt-bg-elevated: rgba(255,255,255,0.035);
        --tt-bg-hover: rgba(255,255,255,0.04);
        --tt-border: rgba(255,255,255,0.04);
        --tt-border-strong: rgba(255,255,255,0.08);
        --tt-text: #e5e7eb;
        --tt-text-muted: #6b7280;
        --tt-text-faint: #4b5563;
        --tt-accent: #00c853;
        --tt-accent-dim: rgba(0, 200, 83, 0.12);
        --tt-negative: #ff5252;
        --tt-negative-dim: rgba(255, 82, 82, 0.12);
        --tt-amber: #f59e0b;
        --tt-amber-dim: rgba(245, 158, 11, 0.12);
        --tt-indigo: #6366f1;
        --tt-indigo-dim: rgba(99, 102, 241, 0.12);
        --tt-radius: 12px;
        --tt-radius-sm: 8px;
        --tt-font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      body {
        background: var(--tt-bg-base);
        color: var(--tt-text);
        font-family: var(--tt-font);
        -webkit-font-smoothing: antialiased;
        margin: 0;
      }
      .tt-card {
        background: var(--tt-bg-surface);
        border: 1px solid var(--tt-border);
        border-radius: var(--tt-radius);
      }
      .loading-spinner {
        border: 2px solid var(--tt-border);
        border-top-color: var(--tt-accent);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes pulse-badge {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.15); }
      }
      .badge-pulse { animation: pulse-badge 2s ease-in-out infinite; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
      body:not([data-user-role="admin"]) a[data-admin-only] {
        opacity: 0.35;
        pointer-events: none;
        position: relative;
      }
      body:not([data-user-role="admin"]) a[data-admin-only]::after {
        content: " ðŸ”’";
        font-size: 9px;
      }
      /* Markdown styling for brief content */
      .brief-content h2 {
        font-size: 15px;
        font-weight: 600;
        color: #e5e7eb;
        margin: 20px 0 8px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }
      .brief-content h3 {
        font-size: 13px;
        font-weight: 600;
        color: #d1d5db;
        margin: 16px 0 6px 0;
      }
      .brief-content p {
        font-size: 13px;
        line-height: 1.7;
        color: #9ca3af;
        margin: 6px 0;
      }
      .brief-content ul, .brief-content ol {
        font-size: 13px;
        line-height: 1.7;
        color: #9ca3af;
        margin: 6px 0;
        padding-left: 20px;
      }
      .brief-content li { margin: 3px 0; }
      .brief-content strong { color: #e5e7eb; }
      .brief-content em { color: #d1d5db; }
      .brief-content code {
        background: rgba(255,255,255,0.05);
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 12px;
        color: #f59e0b;
      }
      .brief-content blockquote {
        border-left: 3px solid rgba(245, 158, 11, 0.4);
        padding-left: 12px;
        margin: 12px 0;
        color: #9ca3af;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;

      const API_BASE = "";

      // â”€â”€ Markdown Renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function renderMarkdown(md) {
        if (!md) return "";
        if (typeof marked !== "undefined" && marked.parse) {
          return marked.parse(md, { breaks: true, gfm: true });
        }
        // Fallback: basic line breaks
        return md.replace(/\n/g, "<br/>");
      }

      // â”€â”€ Brief Card Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function BriefCard({ brief, type }) {
        if (!brief) return null;
        const isMorning = type === "morning";
        const accentColor = isMorning ? "var(--tt-amber)" : "var(--tt-indigo)";
        const bgDim = isMorning ? "var(--tt-amber-dim)" : "var(--tt-indigo-dim)";
        const icon = isMorning ? "\u2600\uFE0F" : "\uD83C\uDF19";
        const label = isMorning ? "Morning Brief" : "Evening Brief";
        const time = brief.publishedAt
          ? new Date(brief.publishedAt).toLocaleString("en-US", { timeZone: "America/New_York", hour: "numeric", minute: "2-digit", hour12: true })
          : "";

        return (
          <div className="tt-card p-6 mb-4">
            <div className="flex items-center gap-3 mb-4">
              <div style={{ background: bgDim, color: accentColor }} className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-semibold">
                {icon}
              </div>
              <div>
                <div className="text-[14px] font-semibold text-white">{label}</div>
                {time && <div className="text-[11px] text-[#6b7280]">Published at {time} ET</div>}
              </div>
              {brief.esPrediction && (
                <div className="ml-auto px-3 py-1 rounded-full text-[11px] font-medium" style={{ background: bgDim, color: accentColor }}>
                  {brief.esPrediction.slice(0, 80)}{brief.esPrediction.length > 80 ? "..." : ""}
                </div>
              )}
            </div>
            <div className="brief-content" dangerouslySetInnerHTML={{ __html: renderMarkdown(brief.content) }} />
          </div>
        );
      }

      // â”€â”€ Placeholder Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function BriefPlaceholder({ type }) {
        const isMorning = type === "morning";
        const label = isMorning ? "Morning Brief" : "Evening Brief";
        const time = isMorning ? "9:00 AM" : "5:00 PM";
        const icon = isMorning ? "\u2600\uFE0F" : "\uD83C\uDF19";
        return (
          <div className="tt-card p-6 mb-4">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm bg-white/[0.03] text-[#4b5563]">
                {icon}
              </div>
              <div className="text-[14px] font-semibold text-[#4b5563]">{label}</div>
            </div>
            <div className="text-[13px] text-[#4b5563] leading-relaxed">
              The {label.toLowerCase()} is being prepared and will be available by <span className="text-[#6b7280] font-medium">{time} ET</span>.
            </div>
            <div className="mt-4 flex gap-3">
              {[1, 2, 3].map(i => (
                <div key={i} className="flex-1 h-2 rounded-full bg-white/[0.03] overflow-hidden">
                  <div className="h-full bg-white/[0.04] rounded-full" style={{ width: `${30 + i * 20}%`, animation: `pulse-badge ${2 + i * 0.3}s ease-in-out infinite` }} />
                </div>
              ))}
            </div>
          </div>
        );
      }

      // â”€â”€ Prediction Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function PredictionBadge({ value }) {
        if (value === 1) return <span className="text-[11px] font-medium text-[#00c853]" title="ES prediction correct">&#10003;</span>;
        if (value === 0) return <span className="text-[11px] font-medium text-[#ff5252]" title="ES prediction incorrect">&#10007;</span>;
        return <span className="text-[11px] text-[#4b5563]" title="Pending">{"\u23F3"}</span>;
      }

      // â”€â”€ Archive Tree Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function ArchiveTree({ briefs, onSelect }) {
        const [expandedMonths, setExpandedMonths] = useState({});
        const [expandedDays, setExpandedDays] = useState({});

        // Group by month, then by day
        const tree = useMemo(() => {
          const grouped = {};
          for (const b of briefs) {
            const month = b.date?.slice(0, 7); // YYYY-MM
            const day = b.date; // YYYY-MM-DD
            if (!month || !day) continue;
            if (!grouped[month]) grouped[month] = {};
            if (!grouped[month][day]) grouped[month][day] = [];
            grouped[month][day].push(b);
          }
          return grouped;
        }, [briefs]);

        const months = Object.keys(tree).sort().reverse();

        const toggleMonth = (m) => setExpandedMonths(prev => ({ ...prev, [m]: !prev[m] }));
        const toggleDay = (d) => setExpandedDays(prev => ({ ...prev, [d]: !prev[d] }));

        const fmtMonthLabel = (m) => {
          const [y, mo] = m.split("-");
          const d = new Date(Number(y), Number(mo) - 1, 1);
          return d.toLocaleDateString("en-US", { month: "long", year: "numeric" });
        };

        const fmtDayLabel = (d) => {
          const dt = new Date(d + "T12:00:00");
          const dow = dt.toLocaleDateString("en-US", { weekday: "short" });
          const day = dt.toLocaleDateString("en-US", { month: "short", day: "numeric" });
          return `${dow}, ${day}`;
        };

        if (months.length === 0) {
          return <div className="text-[13px] text-[#4b5563] py-4">No archived briefs yet.</div>;
        }

        return (
          <div className="space-y-1">
            {months.map(month => (
              <div key={month}>
                <button
                  onClick={() => toggleMonth(month)}
                  className="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-[13px] font-medium text-[#9ca3af] hover:bg-white/[0.03] transition-all"
                >
                  <span className="text-[10px] text-[#4b5563]">{expandedMonths[month] ? "\u25BC" : "\u25B6"}</span>
                  {fmtMonthLabel(month)}
                  <span className="text-[11px] text-[#4b5563] ml-auto">{Object.keys(tree[month]).length} days</span>
                </button>
                {expandedMonths[month] && (
                  <div className="ml-4 space-y-0.5">
                    {Object.keys(tree[month]).sort().reverse().map(day => {
                      const dayBriefs = tree[month][day];
                      const morning = dayBriefs.find(b => b.type === "morning");
                      const evening = dayBriefs.find(b => b.type === "evening");
                      return (
                        <div key={day}>
                          <button
                            onClick={() => toggleDay(day)}
                            className="w-full flex items-center gap-2 px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:bg-white/[0.03] transition-all"
                          >
                            <span className="text-[9px] text-[#4b5563]">{expandedDays[day] ? "\u25BC" : "\u25B6"}</span>
                            <span>{fmtDayLabel(day)}</span>
                            <div className="ml-auto flex items-center gap-3">
                              {morning && (
                                <span className="flex items-center gap-1 text-[11px]">
                                  <span className="text-[#f59e0b]">{"\u2600\uFE0F"}</span>
                                  <PredictionBadge value={morning.es_prediction_correct} />
                                </span>
                              )}
                              {evening && (
                                <span className="flex items-center gap-1 text-[11px]">
                                  <span className="text-[#6366f1]">{"\uD83C\uDF19"}</span>
                                  <PredictionBadge value={evening.es_prediction_correct} />
                                </span>
                              )}
                            </div>
                          </button>
                          {expandedDays[day] && (
                            <div className="ml-6 py-1 space-y-1">
                              {morning && (
                                <button
                                  onClick={() => onSelect(morning.id)}
                                  className="w-full text-left px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all flex items-center gap-2"
                                >
                                  <span>{"\u2600\uFE0F"}</span> Morning Brief
                                  <PredictionBadge value={morning.es_prediction_correct} />
                                  {morning.es_prediction && (
                                    <span className="ml-auto text-[10px] text-[#4b5563] truncate max-w-[200px]">{morning.es_prediction}</span>
                                  )}
                                </button>
                              )}
                              {evening && (
                                <button
                                  onClick={() => onSelect(evening.id)}
                                  className="w-full text-left px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all flex items-center gap-2"
                                >
                                  <span>{"\uD83C\uDF19"}</span> Evening Brief
                                  <PredictionBadge value={evening.es_prediction_correct} />
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      }

      // â”€â”€ Mini Chart Component (TradingView Lightweight Charts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const CHART_SYMBOLS = [
        { sym: "ES1!", label: "ES", color: "#f59e0b" },
        { sym: "NQ1!", label: "NQ", color: "#6366f1" },
        { sym: "SPY", label: "SPY", color: "#00c853" },
        { sym: "QQQ", label: "QQQ", color: "#2196f3" },
        { sym: "IWM", label: "IWM", color: "#e91e63" },
      ];
      const TF_OPTIONS = [
        { value: "5", label: "5m", limit: 250 },
        { value: "15", label: "15m", limit: 120 },
        { value: "60", label: "1H", limit: 100 },
        { value: "D", label: "D", limit: 60 },
      ];

      // Check if we're currently in Regular Trading Hours (for live update frequency)
      function isMarketOpen() {
        const d = new Date();
        const et = new Date(d.toLocaleString("en-US", { timeZone: "America/New_York" }));
        const day = et.getDay();
        const min = et.getHours() * 60 + et.getMinutes();
        if (day === 0 || day === 6) return false;
        return min >= 570 && min < 960; // 9:30 AM - 4:00 PM ET
      }

      // Stable empty array reference â€” avoids useEffect re-runs from levels={[]}
      const EMPTY_LEVELS = [];

      function MiniChart({ sym, label, accentColor, tf, limit }) {
        const containerRef = useRef(null);
        const chartRef = useRef(null);
        const seriesRef = useRef(null);
        const firstCandleRef = useRef(null);
        const priceLinesRef = useRef([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastPrice, setLastPrice] = useState(null);
        const [change, setChange] = useState(null);
        const [isLive, setIsLive] = useState(false);

        // Map raw API candles to chart format
        const mapCandles = useCallback((candles) => {
          return candles.map(c => ({
            time: c.ts / 1000,
            open: Number(c.o),
            high: Number(c.h),
            low: Number(c.l),
            close: Number(c.c),
          })).filter(c => c.open > 0 && c.high > 0);
        }, []);

        // Fetch candle data from API
        const fetchCandles = useCallback(async (fetchLimit) => {
          const res = await fetch(
            `${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=${tf}&limit=${fetchLimit}`,
            { cache: "no-store" }
          );
          const data = await res.json();
          if (!data.ok || !data.candles || data.candles.length === 0) return [];
          return data.candles;
        }, [sym, tf]);

        // Initial chart setup + full data load
        useEffect(() => {
          let cancelled = false; // prevents stale async from adding duplicate levels

          if (!containerRef.current || typeof LightweightCharts === "undefined") {
            setError("Charts unavailable");
            setLoading(false);
            return;
          }

          // Create chart
          const chart = LightweightCharts.createChart(containerRef.current, {
            width: containerRef.current.clientWidth,
            height: 220,
            layout: {
              background: { type: "solid", color: "transparent" },
              textColor: "#6b7280",
              fontSize: 10,
            },
            grid: {
              vertLines: { color: "rgba(255,255,255,0.03)" },
              horzLines: { color: "rgba(255,255,255,0.03)" },
            },
            crosshair: {
              mode: LightweightCharts.CrosshairMode.Normal,
              vertLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2 },
              horzLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2 },
            },
            rightPriceScale: {
              borderColor: "rgba(255,255,255,0.06)",
              scaleMargins: { top: 0.1, bottom: 0.1 },
            },
            timeScale: {
              borderColor: "rgba(255,255,255,0.06)",
              timeVisible: tf !== "D" && tf !== "W",
              secondsVisible: false,
            },
            handleScroll: { vertTouchDrag: false },
          });
          chartRef.current = chart;

          const candleSeries = chart.addCandlestickSeries({
            upColor: "#00c853",
            downColor: "#ff5252",
            borderUpColor: "#00c853",
            borderDownColor: "#ff5252",
            wickUpColor: "#00c853",
            wickDownColor: "#ff5252",
          });
          seriesRef.current = candleSeries;

          // Initial full load with retry + fallback to 1m if sparse data
          const loadWithRetry = async (retriesLeft = 2) => {
            let raw = await fetchCandles(limit);
            // If 5m has very few candles, try fetching more or fall back to 1m
            if (raw.length < 5 && (tf === "5" || tf === "15")) {
              const fallbackRes = await fetch(
                `${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=1&limit=500`,
                { cache: "no-store" }
              );
              const fallbackData = await fallbackRes.json();
              if (fallbackData.ok && fallbackData.candles?.length > raw.length) {
                raw = fallbackData.candles;
              }
            }
            if (raw.length === 0 && retriesLeft > 0) {
              await new Promise(r => setTimeout(r, 3000));
              return loadWithRetry(retriesLeft - 1);
            }
            return raw;
          };
          loadWithRetry().then(raw => {
            const mapped = mapCandles(raw);
            if (mapped.length === 0) {
              setError("No data");
              setLoading(false);
              return;
            }

            candleSeries.setData(mapped);
            firstCandleRef.current = mapped[0];
            const lastCandle = mapped[mapped.length - 1];
            setLastPrice(lastCandle.close);
            setChange((lastCandle.close - mapped[0].open) / mapped[0].open * 100);

            chart.timeScale().fitContent();
            setLoading(false);
            setIsLive(true);

            // Async: fetch daily ATR levels and overlay on intraday charts
            // Use cancelled flag to prevent stale fetches from adding duplicate levels
            if (tf === "5" || tf === "15" || tf === "60") {
              fetchAtrFibLevels(sym).then(fibData => {
                if (cancelled || !fibData?.levels || !seriesRef.current) return;
                // Remove any existing price lines first
                for (const pl of priceLinesRef.current) {
                  try { seriesRef.current.removePriceLine(pl); } catch (_) {}
                }
                priceLinesRef.current = [];
                for (const lvl of fibData.levels) {
                  const pl = seriesRef.current.createPriceLine({
                    price: lvl.price,
                    color: lvl.color || "rgba(255,255,255,0.2)",
                    lineWidth: lvl.label?.startsWith("Target") || lvl.label?.startsWith("Watch") ? 2 : 1,
                    lineStyle: lvl.label?.startsWith("Target") || lvl.label?.startsWith("Watch")
                      ? LightweightCharts.LineStyle.LargeDashed
                      : LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: lvl.label || "",
                  });
                  priceLinesRef.current.push(pl);
                }
              }).catch(() => {});
            }
          }).catch(e => {
            console.error(`Chart ${sym} initial load error:`, e);
            setError("Load failed");
            setLoading(false);
          });

          // Resize handler
          const handleResize = () => {
            if (containerRef.current && chart) {
              chart.applyOptions({ width: containerRef.current.clientWidth });
            }
          };
          window.addEventListener("resize", handleResize);

          return () => {
            cancelled = true; // prevent stale async fetchAtrFibLevels from adding levels
            window.removeEventListener("resize", handleResize);
            priceLinesRef.current = [];
            chart.remove();
            chartRef.current = null;
            seriesRef.current = null;
            firstCandleRef.current = null;
          };
        }, [sym, tf, limit, fetchCandles, mapCandles]);

        // Live update polling â€” fetches last few candles and updates the series
        useEffect(() => {
          if (!isLive) return;

          const poll = async () => {
            try {
              // Fetch only last 5 candles for the update
              const raw = await fetchCandles(5);
              const mapped = mapCandles(raw);
              if (mapped.length === 0 || !seriesRef.current) return;

              // update() adds new candles or updates the last one in-place
              // without resetting zoom/pan state
              for (const candle of mapped) {
                seriesRef.current.update(candle);
              }

              const lastCandle = mapped[mapped.length - 1];
              setLastPrice(lastCandle.close);
              if (firstCandleRef.current) {
                setChange((lastCandle.close - firstCandleRef.current.open) / firstCandleRef.current.open * 100);
              }
            } catch (_) { /* silent â€” next tick will retry */ }
          };

          // Poll every 30s during market hours, 60s otherwise
          const intervalMs = isMarketOpen() ? 30000 : 60000;
          const id = setInterval(poll, intervalMs);
          return () => clearInterval(id);
        }, [isLive, fetchCandles, mapCandles]);

        return (
          <div className="tt-card overflow-hidden">
            <div className="px-3 py-2 flex items-center justify-between border-b border-white/[0.04]">
              <div className="flex items-center gap-2">
                <span className="text-[13px] font-semibold" style={{ color: accentColor }}>{label}</span>
                {lastPrice != null && (
                  <span className="text-[12px] text-[#9ca3af]">{lastPrice.toFixed(2)}</span>
                )}
                {change != null && (
                  <span className={`text-[11px] font-medium ${change >= 0 ? "text-[#00c853]" : "text-[#ff5252]"}`}>
                    {change >= 0 ? "+" : ""}{change.toFixed(2)}%
                  </span>
                )}
              </div>
              {loading && <div className="loading-spinner" style={{ width: 12, height: 12, borderWidth: 1.5 }} />}
              {isLive && !loading && (
                <span className="flex items-center gap-1 text-[9px] font-medium text-[#00c853] uppercase tracking-wider">
                  <span className="inline-block w-1.5 h-1.5 rounded-full bg-[#00c853] badge-pulse" />
                  Live
                </span>
              )}
            </div>
            <div ref={containerRef} style={{ height: 220 }}>
              {error && (
                <div className="flex items-center justify-center h-full">
                  <span className="text-[11px] text-[#4b5563]">{error}</span>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Fetch daily ATR and compute ATR Fibonacci levels for a symbol
      // Uses actual daily candles for accurate day-level ATR (not scaled from intraday)
      const atrLevelCache = {};
      async function fetchAtrFibLevels(sym) {
        if (atrLevelCache[sym] && Date.now() - atrLevelCache[sym].ts < 300000) {
          return atrLevelCache[sym].data;
        }
        try {
          // Fetch last 20 daily candles for ATR calculation
          const res = await fetch(`${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=D&limit=20`, { cache: "no-store" });
          const data = await res.json();
          if (!data.ok || !data.candles || data.candles.length < 5) return null;

          const dailies = data.candles;
          // Previous day close = anchor
          const prevDay = dailies[dailies.length - 2];
          const lastDay = dailies[dailies.length - 1];
          if (!prevDay || !lastDay) return null;
          const anchor = Number(prevDay.c);
          if (anchor <= 0) return null;

          // Compute 14-period daily ATR (true range: max of H-L, |H-prevC|, |L-prevC|)
          let atrSum = 0;
          let atrCount = 0;
          for (let i = 1; i < dailies.length; i++) {
            const h = Number(dailies[i].h);
            const l = Number(dailies[i].l);
            const pc = Number(dailies[i - 1].c);
            const tr = Math.max(h - l, Math.abs(h - pc), Math.abs(l - pc));
            if (tr > 0) { atrSum += tr; atrCount++; }
          }
          const dayAtr = atrCount > 0 ? atrSum / atrCount : 0;
          if (dayAtr <= 0) return null;

          // Get current price from /timed/latest
          let currentPrice = Number(lastDay.c);
          try {
            const latestRes = await fetch(`${API_BASE}/timed/latest?ticker=${encodeURIComponent(sym)}`, { cache: "no-store" });
            const latestData = await latestRes.json();
            if (latestData.ok && latestData.data?.price) currentPrice = Number(latestData.data.price);
          } catch (_) {}

          const rnd = (v) => Math.round(v * 100) / 100;
          const fibs = [0.236, 0.382, 0.5, 0.618, 1.0];
          const levels = [];

          // Anchor line (previous close)
          levels.push({ price: rnd(anchor), color: "rgba(255,255,255,0.35)", label: "Prev Close" });

          // Fib levels
          for (const f of fibs) {
            const pctLabel = (f * 100).toFixed(1).replace(/\.0$/, "");
            levels.push({ price: rnd(anchor + dayAtr * f), color: `rgba(0,200,83,${0.25 + f * 0.45})`, label: `+${pctLabel}%` });
            levels.push({ price: rnd(anchor - dayAtr * f), color: `rgba(255,82,82,${0.25 + f * 0.45})`, label: `-${pctLabel}%` });
          }

          // Directional assessment â€” where is price relative to the ATR levels?
          let direction = "neutral";
          let targetLevels = [];
          const distFromAnchor = currentPrice - anchor;
          const pctOfAtr = distFromAnchor / dayAtr;

          if (pctOfAtr > 0.382) {
            // Price crossed +38.2% â€” Golden Gate OPEN UP
            direction = "bullish";
            targetLevels = [
              { price: rnd(anchor + dayAtr * 0.5), label: "Target +50%" },
              { price: rnd(anchor + dayAtr * 0.618), label: "Target +61.8%" },
            ];
          } else if (pctOfAtr < -0.382) {
            // Price crossed -38.2% â€” Golden Gate OPEN DOWN
            direction = "bearish";
            targetLevels = [
              { price: rnd(anchor - dayAtr * 0.5), label: "Target -50%" },
              { price: rnd(anchor - dayAtr * 0.618), label: "Target -61.8%" },
            ];
          } else {
            // Between gates â€” watch for breakout
            targetLevels = [
              { price: rnd(anchor + dayAtr * 0.382), label: "Watch +38.2%" },
              { price: rnd(anchor - dayAtr * 0.382), label: "Watch -38.2%" },
            ];
          }

          // Add highlighted target lines (thicker amber dashed)
          for (const tgt of targetLevels) {
            levels.push({ price: tgt.price, color: "rgba(245,158,11,0.7)", label: tgt.label });
          }

          const result = { levels, dayAtr: rnd(dayAtr), anchor: rnd(anchor), currentPrice: rnd(currentPrice), direction, pctOfAtr: rnd(pctOfAtr) };
          atrLevelCache[sym] = { data: result, ts: Date.now() };
          return result;
        } catch (e) {
          console.error(`ATR levels error for ${sym}:`, e);
          return null;
        }
      }

      function MarketCharts() {
        const [tf, setTf] = useState("5");
        const tfConfig = TF_OPTIONS.find(t => t.value === tf) || TF_OPTIONS[0];

        return (
          <div className="mb-6">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-[13px] font-semibold text-[#9ca3af] flex items-center gap-2">
                Market Overview
                <span className="text-[10px] text-[#4b5563] font-normal">Live Charts</span>
              </h2>
              <div className="flex items-center gap-1 bg-white/[0.02] rounded-lg p-0.5 border border-white/[0.04]">
                {TF_OPTIONS.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => setTf(opt.value)}
                    className={`px-2.5 py-1 rounded-md text-[11px] font-medium transition-all ${
                      tf === opt.value
                        ? "bg-white/[0.08] text-white"
                        : "text-[#6b7280] hover:text-white hover:bg-white/[0.04]"
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {CHART_SYMBOLS.map(({ sym, label, color }) => (
                <MiniChart
                  key={`${sym}-${tf}`}
                  sym={sym}
                  label={label}
                  accentColor={color}
                  tf={tfConfig.value}
                  limit={tfConfig.limit}
                />
              ))}
            </div>
          </div>
        );
      }

      // â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function App({ user }) {
        const isAdmin = user?.role === "admin" || user?.tier === "admin";
        const [brief, setBrief] = useState(null);
        const [loading, setLoading] = useState(true);
        const [archiveBriefs, setArchiveBriefs] = useState([]);
        const [archiveLoading, setArchiveLoading] = useState(false);
        const [selectedArchive, setSelectedArchive] = useState(null);
        const [selectedArchiveData, setSelectedArchiveData] = useState(null);
        const [archiveDetailLoading, setArchiveDetailLoading] = useState(false);

        // Fetch current brief
        const fetchBrief = useCallback(async () => {
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setBrief(data.brief || {});
            }
          } catch (e) {
            console.error("Failed to fetch brief:", e);
          } finally {
            setLoading(false);
          }
        }, []);

        // Fetch archive
        const fetchArchive = useCallback(async () => {
          setArchiveLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/archive`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setArchiveBriefs(data.briefs || []);
            }
          } catch (e) {
            console.error("Failed to fetch archive:", e);
          } finally {
            setArchiveLoading(false);
          }
        }, []);

        // Fetch single archive brief
        const fetchArchiveBrief = useCallback(async (id) => {
          setSelectedArchive(id);
          setArchiveDetailLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/archive/${encodeURIComponent(id)}`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setSelectedArchiveData(data.brief || null);
            }
          } catch (e) {
            console.error("Failed to fetch archive brief:", e);
          } finally {
            setArchiveDetailLoading(false);
          }
        }, []);

        // Mark ES prediction
        const markPrediction = useCallback(async (id, correct) => {
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/predict?id=${encodeURIComponent(id)}&correct=${correct}`, { method: "POST" });
            if (res.ok) {
              fetchArchive(); // refresh
            }
          } catch (e) {
            console.error("Failed to mark prediction:", e);
          }
        }, [fetchArchive]);

        useEffect(() => {
          fetchBrief();
          fetchArchive();
          // Mark brief as seen for badge
          localStorage.setItem("tt_brief_seen", String(Date.now()));
        }, [fetchBrief, fetchArchive]);

        // Determine current ET time for placeholder logic
        const etNow = useMemo(() => {
          const d = new Date();
          const et = d.toLocaleString("en-US", { timeZone: "America/New_York", hour: "numeric", minute: "numeric", hour12: false });
          const [h] = et.split(":").map(Number);
          return h;
        }, []);

        const hasMorning = brief?.morning?.content;
        const hasEvening = brief?.evening?.content;
        const today = new Date().toLocaleDateString("en-US", { timeZone: "America/New_York", weekday: "long", month: "long", day: "numeric", year: "numeric" });

        return (
          <div className="min-h-screen" style={{ background: "var(--tt-bg-base)" }}>
            {/* Nav */}
            <nav className="sticky top-0 z-50 border-b border-white/[0.04]" style={{ background: "rgba(11,14,17,0.85)", backdropFilter: "blur(12px)" }}>
              <div className="max-w-[1400px] mx-auto px-6 py-3 flex items-center justify-between">
                <div className="flex items-center gap-5">
                  <a href="index-react.html" className="flex items-center gap-2.5 no-underline">
                    <div className="w-[32px] h-[32px] rounded-[8px] flex items-center justify-center" style={{background:"linear-gradient(135deg, #00c853, #00e676, #69f0ae)"}}>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                        <polyline points="16 7 22 7 22 13" />
                      </svg>
                    </div>
                    <span className="text-[15px] font-bold text-white" style={{letterSpacing:"-0.03em"}}>Timed Trading</span>
                  </a>
                  <div className="flex items-center gap-1">
                    <a href="index-react.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Active Trader</a>
                    <a href="investor-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Investor</a>
                    <a href="simulation-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Trades</a>
                    <a href="model-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Model</a>
                    <a href="screener.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Screener</a>
                    <a href="ticker-management.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Tickers</a>
                    <a href="daily-brief.html" className="px-3 py-1.5 rounded-md text-[13px] font-medium text-[#f59e0b] bg-[#f59e0b]/[0.08] border border-[#f59e0b]/20">Daily Brief</a>
                  </div>
                </div>
              </div>
            </nav>

            {/* Content */}
            <div className="max-w-[1100px] mx-auto px-6 py-8">
              {/* Header */}
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h1 className="text-lg font-semibold tracking-tight text-white flex items-center gap-2">
                    Daily Brief
                    <span className="text-[11px] font-normal text-[#f59e0b] bg-[#f59e0b]/10 px-2 py-0.5 rounded-full">AI-Powered</span>
                  </h1>
                  <p className="text-[13px] text-[#6b7280] mt-0.5">{today}</p>
                </div>
                {loading && <div className="loading-spinner" />}
              </div>

              {/* Market Overview Charts */}
              <MarketCharts />

              {/* Current Briefs */}
              {loading ? (
                <div className="flex items-center justify-center py-20">
                  <div className="loading-spinner mr-3" />
                  <span className="text-[13px] text-[#6b7280]">Loading brief...</span>
                </div>
              ) : (
                <div>
                  {/* Morning Brief */}
                  {hasMorning ? (
                    <BriefCard brief={brief.morning} type="morning" />
                  ) : (
                    <BriefPlaceholder type="morning" />
                  )}

                  {/* Evening Brief */}
                  {hasEvening ? (
                    <BriefCard brief={brief.evening} type="evening" />
                  ) : etNow >= 17 ? (
                    <BriefPlaceholder type="evening" />
                  ) : null}
                </div>
              )}

              {/* Selected Archive Brief */}
              {selectedArchive && (
                <div className="mt-6">
                  <div className="flex items-center gap-3 mb-3">
                    <button onClick={() => { setSelectedArchive(null); setSelectedArchiveData(null); }} className="text-[12px] text-[#6b7280] hover:text-white transition-all">&larr; Back to current</button>
                    <span className="text-[12px] text-[#4b5563]">{selectedArchive}</span>
                    {isAdmin && selectedArchiveData && (
                      <div className="ml-auto flex items-center gap-2">
                        <span className="text-[11px] text-[#4b5563]">ES Prediction:</span>
                        <button onClick={() => markPrediction(selectedArchive, 1)} className="text-[11px] px-2 py-0.5 rounded bg-[#00c853]/10 text-[#00c853] hover:bg-[#00c853]/20 transition-all">Correct</button>
                        <button onClick={() => markPrediction(selectedArchive, 0)} className="text-[11px] px-2 py-0.5 rounded bg-[#ff5252]/10 text-[#ff5252] hover:bg-[#ff5252]/20 transition-all">Incorrect</button>
                      </div>
                    )}
                  </div>
                  {archiveDetailLoading ? (
                    <div className="flex items-center py-8"><div className="loading-spinner mr-3" /><span className="text-[13px] text-[#6b7280]">Loading...</span></div>
                  ) : selectedArchiveData ? (
                    <div className="tt-card p-6">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="text-sm">{selectedArchiveData.type === "morning" ? "\u2600\uFE0F" : "\uD83C\uDF19"}</span>
                        <span className="text-[14px] font-semibold text-white">{selectedArchiveData.type === "morning" ? "Morning Brief" : "Evening Brief"}</span>
                        <span className="text-[11px] text-[#6b7280]">{selectedArchiveData.date}</span>
                        {selectedArchiveData.es_prediction_correct != null && (
                          <PredictionBadge value={selectedArchiveData.es_prediction_correct} />
                        )}
                      </div>
                      <div className="brief-content" dangerouslySetInnerHTML={{ __html: renderMarkdown(selectedArchiveData.content) }} />
                    </div>
                  ) : (
                    <div className="text-[13px] text-[#4b5563]">Brief not found.</div>
                  )}
                </div>
              )}

              {/* Archive Section */}
              <div className="mt-10">
                <div className="flex items-center gap-3 mb-4">
                  <h2 className="text-[14px] font-semibold text-[#9ca3af]">Archive</h2>
                  {archiveLoading && <div className="loading-spinner" style={{ width: 14, height: 14, borderWidth: 1.5 }} />}
                </div>
                <div className="tt-card p-4">
                  <ArchiveTree briefs={archiveBriefs} onSelect={fetchArchiveBrief} />
                </div>
              </div>
            </div>
          </div>
        );
      }

      // â”€â”€ Mount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const AuthGate = window.TimedAuthGate;
      const briefApp = AuthGate
        ? <AuthGate apiBase={API_BASE}>{(user) => <App user={user} />}</AuthGate>
        : <App />;
      ReactDOM.createRoot(document.getElementById("root")).render(briefApp);
    </script>
  </body>
</html>
