name = "timed-trading-ingest"
main = "index.js"
compatibility_date = "2024-01-01"

[env.production]
name = "timed-trading-ingest"
main = "index.js"
# Note: workers.dev subdomains don't need route configuration
# Routes are only needed for custom domains
# The worker is automatically available at: timed-trading-ingest.shashant.workers.dev

# KV Namespace binding for production
# IMPORTANT: Configure bindings in wrangler.toml to persist across deployments
# Dashboard bindings are NOT preserved when deploying via wrangler
# 
# To get your KV namespace ID:
# 1. Go to: https://dash.cloudflare.com -> Workers & Pages -> KV
# 2. Click on your namespace (e.g., "TIMED_TRADING_KV")
# 3. Copy the "Namespace ID" (long alphanumeric string)
# 4. Replace "YOUR_KV_NAMESPACE_ID" below with your actual ID
#
[[env.production.kv_namespaces]]
binding = "KV_TIMED"
id = "e48593af3ef74bf986b2592909ed40cb"

# D1 Database binding (for 7-day historical trails)
# Create via: `wrangler d1 create timed_trading_db`
# Then paste the resulting database_id below.
[[env.production.d1_databases]]
binding = "DB"
database_name = "timed-trading-ledger"
database_id = "99fae5d6-98df-4e29-bab5-0665cac7a9ff"

# Environment variables (non-sensitive config - stored here for persistence)
# IMPORTANT: Secrets (API keys, webhooks) are NOT stored here for security
# Secrets must be set via Cloudflare Dashboard or `wrangler secret put`
#
# Required Secrets (set via Dashboard or CLI):
# - TIMED_API_KEY: API key for POST /timed/ingest authentication
# - DISCORD_WEBHOOK_URL: Discord webhook URL
# - OPENAI_API_KEY: OpenAI API key for AI Assistant
# - ALPACA_API_KEY_ID: Alpaca Markets API Key ID (Algo Trader+ plan)
# - ALPACA_API_SECRET_KEY: Alpaca Markets API Secret Key
#
# Environment Variables (non-sensitive - stored in wrangler.toml):
[env.production.vars]
DISCORD_ENABLE = "true"
ALERT_MIN_RR = "1.5"
ALERT_MAX_COMPLETION = "0.4"
ALERT_MAX_PHASE = "0.6"
ALERT_MIN_RANK = "70"
OPENAI_MODEL = "gpt-3.5-turbo"
CORS_ALLOW_ORIGIN = "*"
TV_ACK_ALWAYS_200 = "true"
ALPACA_ENABLED = "true"
EXECUTION_MODE = "simulation"
ALPACA_BASE_URL = "https://paper-api.alpaca.markets"

# Scheduled triggers for periodic AI updates
# Times are in UTC (9:45 AM ET = 14:45 UTC, 12:00 PM ET = 17:00 UTC, 3:30 PM ET = 20:30 UTC)
[env.production.triggers]
crons = [
  "45 14 * * 1-5",  # 9:45 AM ET (14:45 UTC) on weekdays - AI Market Update
  "0 17 * * 1-5",   # 12:00 PM ET (17:00 UTC) on weekdays - AI Market Update
  "30 20 * * 1-5",  # 3:30 PM ET (20:30 UTC) on weekdays - AI Market Update
  "*/1 13-21 * * 1-5", # Every 1 min during market hours (8AM-4PM ET = 13-21 UTC weekdays) - Full universe scoring
  "*/5 * * * *",    # Every 5 minutes - Off-hours scoring + trade updates
  "*/15 * * * 1-5", # Every 15 minutes during market hours (weekdays) - Proactive Alerts & Pattern Recognition
  "0 */6 * * *",    # Every 6 hours - ML model training from labeled queue
  "0 4 * * *",      # 4:00 AM UTC daily - Data lifecycle (aggregate trail â†’ 5m, purge old raw)
  "*/1 9-21 * * 1-5",  # Every 1 min pre-market + market hours (4AM-4PM ET = 9-21 UTC) - Alpaca bar fetching
  "*/5 21-23 * * 1-5", # Every 5 min after-hours early (4PM-7PM ET = 21-23 UTC) - Alpaca AH bar fetching
  "*/5 0-1 * * 2-6",   # Every 5 min after-hours late (7PM-8PM ET = 0-1 UTC next day, Tue-Sat) - Alpaca AH bar fetching
  "15 21 * * 5",        # Fridays 4:15 PM ET (21:15 UTC) - Weekly model retrospective
]

