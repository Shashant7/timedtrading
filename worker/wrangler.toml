name = "timed-trading-ingest"
main = "index.js"
compatibility_date = "2024-01-01"

# Top-level bindings (used when deploying without --env flag)
[[kv_namespaces]]
binding = "KV_TIMED"
id = "e48593af3ef74bf986b2592909ed40cb"

[[d1_databases]]
binding = "DB"
database_name = "timed-trading-ledger"
database_id = "99fae5d6-98df-4e29-bab5-0665cac7a9ff"

# Durable Object: PriceHub — real-time WebSocket price + scoring push
[[durable_objects.bindings]]
name = "PRICE_HUB"
class_name = "PriceHub"

[[migrations]]
tag = "v1"
new_classes = ["PriceHub"]

[vars]
DISCORD_ENABLE = "true"
ALERT_MIN_RR = "1.5"
ALERT_MAX_COMPLETION = "0.4"
ALERT_MAX_PHASE = "0.6"
ALERT_MIN_RANK = "70"
OPENAI_MODEL = "gpt-3.5-turbo"
CORS_ALLOW_ORIGIN = "*"
TV_ACK_ALWAYS_200 = "true"
ALPACA_ENABLED = "true"
EXECUTION_MODE = "simulation"
ALPACA_BASE_URL = "https://paper-api.alpaca.markets"
CF_ACCESS_TEAM_DOMAIN = "timedtrading"
ADMIN_EMAIL = "shashant@gmail.com"

# Top-level triggers (used when deploying without --env flag)
# Architecture: 3 loops — Price feed, Scoring, Bar fetching
# Times: Sunday 6pm ET = 23:00 UTC, pre-market 4am ET = 09:00 UTC, close 4pm ET = 21:00 UTC
[triggers]
crons = [
  # ── Price Feed (Alpaca snapshots → KV timed:prices, chains into scoring) ──
  "*/1 9-23 * * 1-5",    # Mon-Fri 4am-6pm ET: pre-market + RTH + early AH
  "*/1 0-1 * * 2-6",     # Mon-Fri 7pm-8pm ET: after-hours (next UTC day)
  "*/5 22-23 * * 7",     # Sunday 5-6pm ET: futures/crypto market open
  # ── Scoring (every 5m, all tickers, 24/7 — price feed also chains scoring) ──
  "*/5 * * * *",
  # ── Alpaca Bar Fetching (candle data for charts + scoring) ──
  "*/1 9-21 * * 1-5",    # Mon-Fri pre-market + RTH: 1-min bar fetching
  "*/5 21-23 * * 1-5",   # Mon-Fri after-hours: 5-min bar fetching
  "*/5 0-1 * * 2-6",     # After-hours carry-over (next UTC day)
  # ── AI Market Updates ──
  "45 14 * * 1-5",       # 9:45 AM ET
  "0 17 * * 1-5",        # 12:00 PM ET
  "30 20 * * 1-5",       # 3:30 PM ET
  # ── Alerts & Housekeeping ──
  "*/15 * * * 1-5",      # Proactive alerts every 15 min weekdays
  "0 */6 * * *",         # ML model training every 6 hours
  "0 4 * * *",           # Daily data lifecycle
  "15 21 * * 5",         # Friday 4:15 PM ET: weekly retrospective
  # ── Investor Intelligence ──
  "0 14-21 * * 1-5",     # Mon-Fri hourly 9AM-4PM ET: investor scoring refresh
  "30 21 * * 1-5",       # Mon-Fri 4:30 PM ET: daily investor scoring + DCA execution
  "0 15 * * 6",          # Saturday 10:00 AM ET: weekly investor digest
]

[env.production]
name = "timed-trading-ingest"
main = "index.js"
# Note: workers.dev subdomains don't need route configuration
# Routes are only needed for custom domains
# The worker is automatically available at: timed-trading-ingest.shashant.workers.dev

# KV Namespace binding for production
# IMPORTANT: Configure bindings in wrangler.toml to persist across deployments
# Dashboard bindings are NOT preserved when deploying via wrangler
# 
# To get your KV namespace ID:
# 1. Go to: https://dash.cloudflare.com -> Workers & Pages -> KV
# 2. Click on your namespace (e.g., "TIMED_TRADING_KV")
# 3. Copy the "Namespace ID" (long alphanumeric string)
# 4. Replace "YOUR_KV_NAMESPACE_ID" below with your actual ID
#
[[env.production.kv_namespaces]]
binding = "KV_TIMED"
id = "e48593af3ef74bf986b2592909ed40cb"

# D1 Database binding (for 7-day historical trails)
# Create via: `wrangler d1 create timed_trading_db`
# Then paste the resulting database_id below.
[[env.production.d1_databases]]
binding = "DB"
database_name = "timed-trading-ledger"
database_id = "99fae5d6-98df-4e29-bab5-0665cac7a9ff"

# Durable Object: PriceHub — real-time WebSocket price + scoring push
[[env.production.durable_objects.bindings]]
name = "PRICE_HUB"
class_name = "PriceHub"

# Environment variables (non-sensitive config - stored here for persistence)
# IMPORTANT: Secrets (API keys, webhooks) are NOT stored here for security
# Secrets must be set via Cloudflare Dashboard or `wrangler secret put`
#
# Required Secrets (set via Dashboard or CLI):
# - TIMED_API_KEY: API key for POST /timed/ingest authentication
# - DISCORD_WEBHOOK_URL: Discord webhook URL
# - OPENAI_API_KEY: OpenAI API key for AI Assistant
# - ALPACA_API_KEY_ID: Alpaca Markets API Key ID (Algo Trader+ plan)
# - ALPACA_API_SECRET_KEY: Alpaca Markets API Secret Key
#
# Environment Variables (non-sensitive - stored in wrangler.toml):
# Required Secrets for Cloudflare Access (set via `wrangler secret put --env production`):
# - CF_ACCESS_AUD: Application Audience (AUD) tag from Zero Trust dashboard
#
# Non-sensitive Access config (stored here):
# CF_ACCESS_TEAM_DOMAIN: Your Cloudflare Zero Trust team domain (e.g., "myteam")
# ADMIN_EMAIL: Email address of the admin user (auto-promoted to admin role)

[env.production.vars]
DISCORD_ENABLE = "true"
ALERT_MIN_RR = "1.5"
ALERT_MAX_COMPLETION = "0.4"
ALERT_MAX_PHASE = "0.6"
ALERT_MIN_RANK = "70"
OPENAI_MODEL = "gpt-3.5-turbo"
CORS_ALLOW_ORIGIN = "*"
TV_ACK_ALWAYS_200 = "true"
ALPACA_ENABLED = "true"
EXECUTION_MODE = "simulation"
ALPACA_BASE_URL = "https://paper-api.alpaca.markets"
# Cloudflare Access — user auth via Google SSO / One-time PIN
CF_ACCESS_TEAM_DOMAIN = "timedtrading"
ADMIN_EMAIL = "shashant@gmail.com"

# Scheduled triggers — mirrors top-level [triggers] above
[env.production.triggers]
crons = [
  "*/1 9-23 * * 1-5",
  "*/1 0-1 * * 2-6",
  "*/5 22-23 * * 7",
  "*/5 * * * *",
  "*/1 9-21 * * 1-5",
  "*/5 21-23 * * 1-5",
  "*/5 0-1 * * 2-6",
  "45 14 * * 1-5",
  "0 17 * * 1-5",
  "30 20 * * 1-5",
  "*/15 * * * 1-5",
  "0 */6 * * *",
  "0 4 * * *",
  "15 21 * * 5",
  "0 14-21 * * 1-5",
  "30 21 * * 1-5",
  "0 15 * * 6",
]

