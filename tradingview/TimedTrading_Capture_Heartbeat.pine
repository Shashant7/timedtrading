//@version=5
indicator("TimedTrading Capture Heartbeat", overlay=false, max_labels_count=500)

// Focused capture-only script for watchlist alerts.
// Sends a minimal payload on every bar close.

groupCapture = "Capture Settings"
scriptVersion = input.string("capture_1.0.0", "Script Version", group=groupCapture)
includeOHLC = input.bool(false, "Include OHLC", group=groupCapture)
includeVolume = input.bool(false, "Include Volume", group=groupCapture)

// Daily change vs previous close (watchlist style)
prevCloseD = request.security(syminfo.tickerid, "D", close[1], barmerge.gaps_off, barmerge.lookahead_off)
dayChange = not na(prevCloseD) and prevCloseD > 0 ? (close - prevCloseD) : na
dayChangePct = not na(dayChange) and prevCloseD > 0 ? ((dayChange / prevCloseD) * 100.0) : na
prevCloseStr = not na(prevCloseD) ? (",\"prev_close\":" + str.tostring(prevCloseD)) : ""
chgStr = not na(dayChange) ? (",\"day_change\":" + str.tostring(dayChange) + ",\"change\":" + str.tostring(dayChange)) : ""
pctStr = not na(dayChangePct) ? (",\"day_change_pct\":" + str.tostring(dayChangePct) + ",\"change_pct\":" + str.tostring(dayChangePct)) : ""

payload = "{" +
  "\"script_version\":\"" + scriptVersion + "\"," +
  "\"ts\":" + str.tostring(time) + "," +
  "\"time_close\":" + str.tostring(time_close) + "," +
  "\"bar_index\":" + str.tostring(bar_index) + "," +
  "\"ticker\":\"" + syminfo.ticker + "\"," +
  "\"tf_hint\":\"" + timeframe.period + "\"," +
  "\"price\":" + str.tostring(close) +
  prevCloseStr + chgStr + pctStr +
  (includeOHLC
    ? ",\"o\":" + str.tostring(open) +
      ",\"h\":" + str.tostring(high) +
      ",\"l\":" + str.tostring(low)
    : ""
  ) +
  (includeVolume ? ",\"volume\":" + str.tostring(volume) : "") +
  ",\"ingest_kind\":\"capture\"" +
  "}"

if barstate.isconfirmed
    alert(payload, alert.freq_once_per_bar_close)
