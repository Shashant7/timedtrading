<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timed Trading - Trade Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: #0a0f1e;
        color: #e7ecff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .loading-spinner {
        border: 3px solid #26325f;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, memo } = React;

      // ─────────────────────────────────────────────────────────────
      // Constants
      // ─────────────────────────────────────────────────────────────
      const API_BASE = "https://timed-trading-ingest.shashant.workers.dev";
      // API_KEY removed for security - write operations disabled for public access
      // To enable trade management, implement proper authentication
      const TRADE_SIZE = 1000; // $1000 per trade
      const FUTURES_TICKERS = new Set(["ES", "NQ", "YM", "RTY", "CL", "GC", "SI", "HG", "NG"]);

      // Futures contract specifications (point value per contract) - matches worker
      const FUTURES_SPECS = {
        "ES1!": { pointValue: 50, name: "E-mini S&P 500" },
        "NQ1!": { pointValue: 20, name: "E-mini Nasdaq-100" },
        "MES1!": { pointValue: 5, name: "Micro E-mini S&P 500" },
        "MNQ1!": { pointValue: 2, name: "Micro E-mini Nasdaq-100" },
        "YM1!": { pointValue: 5, name: "E-mini Dow" },
        "RTY1!": { pointValue: 50, name: "E-mini Russell 2000" },
        "ES": { pointValue: 50, name: "E-mini S&P 500" },
        "NQ": { pointValue: 20, name: "E-mini Nasdaq-100" },
        "YM": { pointValue: 5, name: "E-mini Dow" },
      };

      const USD_FMT = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 2,
      });
      const INT_FMT = new Intl.NumberFormat("en-US");

      function fmtUsd(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "—";
        return USD_FMT.format(n);
      }

      function fmtInt(v) {
        const n = Number(v);
        if (!Number.isFinite(n)) return "—";
        return INT_FMT.format(n);
      }

      function resolveDirection(src) {
        const direct = String(src?.direction || "").toUpperCase();
        if (direct === "LONG" || direct === "SHORT") return direct;
        const state = String(src?.state || "");
        if (state.includes("BULL")) return "LONG";
        if (state.includes("BEAR")) return "SHORT";
        const triggerDir = String(src?.trigger_dir || "").toUpperCase();
        if (triggerDir.includes("BULL")) return "LONG";
        if (triggerDir.includes("BEAR")) return "SHORT";
        return null;
      }

      function computeEntryRef(src) {
        const entryRef = Number(src?.entry_ref);
        if (Number.isFinite(entryRef) && entryRef > 0) return entryRef;
        const trigger = Number(src?.trigger_price);
        if (Number.isFinite(trigger) && trigger > 0) return trigger;
        const entryPrice = Number(src?.entryPrice);
        if (Number.isFinite(entryPrice) && entryPrice > 0) return entryPrice;
        const price = Number(src?.price ?? src?.currentPrice);
        return Number.isFinite(price) && price > 0 ? price : null;
      }

      function computeTpTargetPrice(src) {
        const directTarget = Number(src?.tp_target_price ?? src?.tp_target);
        if (Number.isFinite(directTarget) && directTarget > 0) return directTarget;
        const tp = Number(src?.tp);
        if (Number.isFinite(tp) && tp > 0) return tp;
        return null;
      }

      function computeTpMaxPrice(src) {
        const directMax = Number(src?.tp_max_price ?? src?.tp_max);
        if (Number.isFinite(directMax) && directMax > 0) return directMax;
        const entry = computeEntryRef(src);
        if (!Number.isFinite(entry)) return null;
        const dir = resolveDirection(src);
        const tpLevels = Array.isArray(src?.tp_levels) ? src.tp_levels : [];
        const candidates = tpLevels
          .map((tp) => {
            const price =
              tp && typeof tp === "object" && tp.price != null
                ? Number(tp.price)
                : Number(tp);
            return Number.isFinite(price) ? price : null;
          })
          .filter((p) => Number.isFinite(p));
        if (candidates.length === 0) return null;
        if (dir === "LONG") {
          const valid = candidates.filter((p) => p > entry);
          return valid.length > 0 ? Math.max(...valid) : null;
        }
        if (dir === "SHORT") {
          const valid = candidates.filter((p) => p < entry);
          return valid.length > 0 ? Math.min(...valid) : null;
        }
        return null;
      }

      function computeReturnPct(src) {
        const direct =
          Number(src?.expected_return_pct) ||
          Number(src?.tp_target_pct) ||
          Number(src?.tp_max_pct);
        if (Number.isFinite(direct)) return direct;
        const entry = computeEntryRef(src);
        const tpTarget = computeTpTargetPrice(src) ?? computeTpMaxPrice(src);
        if (!Number.isFinite(entry) || !Number.isFinite(tpTarget)) return null;
        return (Math.abs(tpTarget - entry) / entry) * 100;
      }

      function computeRiskPct(src) {
        const direct = Number(src?.risk_pct);
        if (Number.isFinite(direct)) return direct;
        const entry = computeEntryRef(src);
        const sl = Number(src?.sl);
        if (!Number.isFinite(entry) || !Number.isFinite(sl)) return null;
        return (Math.abs(entry - sl) / entry) * 100;
      }

      function computeEtaDays(src) {
        const staleness = String(src?.staleness || "").toUpperCase();
        if (staleness && staleness !== "FRESH") return null;
        const baseEta = Number(src?.eta_days_v2 ?? src?.eta_days);
        if (!Number.isFinite(baseEta) || baseEta <= 0) return null;
        const dir = resolveDirection(src);
        const entry = computeEntryRef(src);
        const target = computeTpTargetPrice(src);
        const current = Number(src?.price ?? src?.currentPrice);
        if (
          !Number.isFinite(entry) ||
          !Number.isFinite(target) ||
          !Number.isFinite(current) ||
          !dir
        ) {
          return baseEta;
        }
        const totalDist = Math.abs(target - entry);
        if (!Number.isFinite(totalDist) || totalDist <= 0) return baseEta;
        const progress =
          dir === "LONG"
            ? (current - entry) / (target - entry)
            : (entry - current) / (entry - target);
        if (!Number.isFinite(progress)) return baseEta;
        const clamped = Math.max(0, Math.min(1, progress));
        const remaining = baseEta * (1 - clamped);
        return Math.max(0.1, Math.round(remaining * 100) / 100);
      }

      function computeHorizonBucket(src) {
        const bucket = String(src?.horizon_bucket || "")
          .trim()
          .toUpperCase();
        if (bucket) return bucket.replace("_", " ");
        const eta = computeEtaDays(src);
        if (!Number.isFinite(eta)) return "—";
        if (eta <= 7) return "SHORT TERM";
        if (eta <= 30) return "SWING";
        return "POSITIONAL";
      }

      function computeHorizonKey(src) {
        const bucket = String(src?.horizon_bucket || "")
          .trim()
          .toUpperCase();
        if (bucket) return bucket;
        const eta = computeEtaDays(src);
        if (!Number.isFinite(eta)) return "UNKNOWN";
        if (eta <= 7) return "SHORT_TERM";
        if (eta <= 30) return "SWING";
        return "POSITIONAL";
      }

      // ─────────────────────────────────────────────────────────────
      // Hooks
      // ─────────────────────────────────────────────────────────────
      function useTickerData() {
        const [data, setData] = useState({});
        const [loading, setLoading] = useState(true);
        const [refreshing, setRefreshing] = useState(false);
        const [error, setError] = useState(null);
        const [lastUpdate, setLastUpdate] = useState(null);
        const hasLoadedRef = React.useRef(false);

        const fetchData = useCallback(async () => {
          try {
            if (!hasLoadedRef.current) setLoading(true);
            setRefreshing(true);
            setError(null);
            const timestamp = Date.now();
            const res = await fetch(`${API_BASE}/timed/all?_t=${timestamp}`, {
              cache: "no-store",
              headers: {
                "Cache-Control": "no-cache, no-store, must-revalidate",
                Pragma: "no-cache",
                Expires: "0",
              },
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (json.ok && json.data) {
              setData(json.data);
              setLastUpdate(new Date());
              hasLoadedRef.current = true;
            } else {
              throw new Error(json.error || "Invalid response");
            }
          } catch (err) {
            setError(err.message);
            console.error("Fetch error:", err);
          } finally {
            setLoading(false);
            setRefreshing(false);
          }
        }, []);

        useEffect(() => {
          fetchData();
          const interval = setInterval(fetchData, 30000); // Refresh every 30 seconds (keep prices fresh)
          return () => clearInterval(interval);
        }, [fetchData]);

        return { data, loading, refreshing, error, lastUpdate, refetch: fetchData };
      }

      function useSimulatedTrades() {
        const [trades, setTrades] = useState([]);
        const [loading, setLoading] = useState(true);
        const [refreshing, setRefreshing] = useState(false);
        const [error, setError] = useState(null);
        const hasLoadedRef = React.useRef(false);

        // Fetch trades from Worker
        const fetchTrades = useCallback(async (version = null) => {
          try {
            if (!hasLoadedRef.current) setLoading(true);
            setRefreshing(true);
            setError(null);
            const ts = Date.now();
            const baseUrl = version
              ? `${API_BASE}/timed/trades?version=${encodeURIComponent(version)}`
              : `${API_BASE}/timed/trades`;
            const url = `${baseUrl}${baseUrl.includes("?") ? "&" : "?"}_t=${ts}`;
            console.log(`[UI] Fetching trades from ${url}`);
            const res = await fetch(url, {
              cache: "no-store",
              headers: {
                "Cache-Control": "no-cache, no-store, must-revalidate",
                Pragma: "no-cache",
                Expires: "0",
              },
            });
            console.log(`[UI] Response status: ${res.status}, ok: ${res.ok}`);
            if (!res.ok) {
              const errorText = await res.text();
              console.error(`[UI] HTTP ${res.status} error:`, errorText);
              throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 100)}`);
            }
            const json = await res.json();
            console.log(`[UI] Response:`, { 
              ok: json.ok, 
              count: json.count, 
              totalCount: json.totalCount, 
              tradesLength: json.trades?.length,
              versions: json.versions 
            });
            if (json.ok && Array.isArray(json.trades)) {
              console.log(`[UI] ✅ Setting ${json.trades.length} trades`);
              setTrades(json.trades);
              hasLoadedRef.current = true;
            } else {
              console.error(`[UI] ❌ Invalid response:`, json);
              setTrades([]); // Set empty array instead of throwing
              throw new Error(json.error || "Invalid response format");
            }
          } catch (err) {
            setError(err.message);
            console.error("[UI] Fetch trades error:", err);
            setTrades([]); // Ensure trades is set to empty array on error
          } finally {
            setLoading(false);
            setRefreshing(false);
          }
        }, []);

        // Load trades on mount
        useEffect(() => {
          fetchTrades();
        }, [fetchTrades]);

        // Save trade to Worker - DISABLED for public access (security)
        const saveTrade = useCallback(async (trade) => {
          throw new Error("Trade management is disabled for public access. This is a read-only dashboard.");
        }, []);

        const addTrade = useCallback(async (trade) => {
          await saveTrade(trade);
        }, [saveTrade]);

        const updateTrade = useCallback(async (tradeId, updates) => {
          const existingTrade = trades.find((t) => t.id === tradeId);
          if (!existingTrade) {
            console.error("Trade not found:", tradeId);
            return;
          }
          const updatedTrade = { ...existingTrade, ...updates };
          await saveTrade(updatedTrade);
        }, [trades, saveTrade]);


        return { trades, loading, refreshing, error, addTrade, updateTrade, refetch: fetchTrades };
      }

      // ─────────────────────────────────────────────────────────────
      // Ledger (D1) Hooks
      // ─────────────────────────────────────────────────────────────

      function useLedgerSummary({ since = null, until = null } = {}) {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        const fetchSummary = useCallback(async () => {
          try {
            setLoading(true);
            setError(null);
            const qs = new URLSearchParams();
            if (since != null) qs.set("since", String(since));
            if (until != null) qs.set("until", String(until));
            const url = `${API_BASE}/timed/ledger/summary?${qs.toString()}`;
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_summary_failed");
            setData(json);
          } catch (e) {
            setError(String(e.message || e));
            setData(null);
          } finally {
            setLoading(false);
          }
        }, [since, until]);

        useEffect(() => {
          fetchSummary();
        }, [fetchSummary]);

        return { data, loading, error, refetch: fetchSummary };
      }

      function useLedgerTrades({ ticker = "", status = "all", since = null, until = null, pageSize = 200 } = {}) {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [loadingMore, setLoadingMore] = useState(false);
        const [error, setError] = useState(null);
        const [hasMore, setHasMore] = useState(false);
        const [cursor, setCursor] = useState(null);

        const buildUrl = useCallback((cursorVal) => {
          const qs = new URLSearchParams();
          if (ticker) qs.set("ticker", ticker);
          if (status && status !== "all") qs.set("status", status);
          if (since != null) qs.set("since", String(since));
          if (until != null) qs.set("until", String(until));
          qs.set("limit", String(pageSize));
          if (cursorVal) qs.set("cursor", String(cursorVal));
          return `${API_BASE}/timed/ledger/trades?${qs.toString()}`;
        }, [ticker, status, since, until, pageSize]);

        const fetchFirstPage = useCallback(async () => {
          try {
            setLoading(true);
            setError(null);
            const res = await fetch(buildUrl(null), { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_trades_failed");
            const trades = Array.isArray(json.trades) ? json.trades : [];
            setItems(trades);
            setHasMore(!!json.hasMore);
            setCursor(json.nextCursor || null);
          } catch (e) {
            setError(String(e.message || e));
            setItems([]);
            setHasMore(false);
            setCursor(null);
          } finally {
            setLoading(false);
          }
        }, [buildUrl]);

        const fetchMore = useCallback(async () => {
          if (!cursor || loadingMore) return;
          try {
            setLoadingMore(true);
            const res = await fetch(buildUrl(cursor), { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_trades_failed");
            const trades = Array.isArray(json.trades) ? json.trades : [];
            setItems((prev) => [...prev, ...trades]);
            setHasMore(!!json.hasMore);
            setCursor(json.nextCursor || null);
          } catch (e) {
            setError(String(e.message || e));
          } finally {
            setLoadingMore(false);
          }
        }, [buildUrl, cursor, loadingMore]);

        useEffect(() => {
          fetchFirstPage();
        }, [fetchFirstPage]);

        return { items, loading, loadingMore, error, hasMore, fetchMore, refetch: fetchFirstPage };
      }

      function useLedgerAlerts({ ticker = "", since = null, until = null, pageSize = 200 } = {}) {
        const [items, setItems] = useState([]);
        const [loading, setLoading] = useState(true);
        const [loadingMore, setLoadingMore] = useState(false);
        const [error, setError] = useState(null);
        const [hasMore, setHasMore] = useState(false);
        const [cursor, setCursor] = useState(null);

        const buildUrl = useCallback((cursorVal) => {
          const qs = new URLSearchParams();
          if (ticker) qs.set("ticker", ticker);
          if (since != null) qs.set("since", String(since));
          if (until != null) qs.set("until", String(until));
          qs.set("limit", String(pageSize));
          if (cursorVal) qs.set("cursor", String(cursorVal));
          return `${API_BASE}/timed/ledger/alerts?${qs.toString()}`;
        }, [ticker, since, until, pageSize]);

        const fetchFirstPage = useCallback(async () => {
          try {
            setLoading(true);
            setError(null);
            const res = await fetch(buildUrl(null), { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_alerts_failed");
            const alerts = Array.isArray(json.alerts) ? json.alerts : [];
            setItems(alerts);
            setHasMore(!!json.hasMore);
            setCursor(json.nextCursor || null);
          } catch (e) {
            setError(String(e.message || e));
            setItems([]);
            setHasMore(false);
            setCursor(null);
          } finally {
            setLoading(false);
          }
        }, [buildUrl]);

        const fetchMore = useCallback(async () => {
          if (!cursor || loadingMore) return;
          try {
            setLoadingMore(true);
            const res = await fetch(buildUrl(cursor), { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_alerts_failed");
            const alerts = Array.isArray(json.alerts) ? json.alerts : [];
            setItems((prev) => [...prev, ...alerts]);
            setHasMore(!!json.hasMore);
            setCursor(json.nextCursor || null);
          } catch (e) {
            setError(String(e.message || e));
          } finally {
            setLoadingMore(false);
          }
        }, [buildUrl, cursor, loadingMore]);

        useEffect(() => {
          fetchFirstPage();
        }, [fetchFirstPage]);

        return { items, loading, loadingMore, error, hasMore, fetchMore, refetch: fetchFirstPage };
      }

      function useLedgerTradeDetail(tradeId, includeEvidence = false) {
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        const fetchDetail = useCallback(async () => {
          if (!tradeId) {
            setData(null);
            setError(null);
            return;
          }
          try {
            setLoading(true);
            setError(null);
            const qs = includeEvidence ? "?includeEvidence=1" : "";
            const res = await fetch(`${API_BASE}/timed/ledger/trades/${encodeURIComponent(tradeId)}${qs}`, { cache: "no-store" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (!json.ok) throw new Error(json.error || "ledger_trade_detail_failed");
            setData(json);
          } catch (e) {
            setError(String(e.message || e));
            setData(null);
          } finally {
            setLoading(false);
          }
        }, [tradeId, includeEvidence]);

        useEffect(() => {
          fetchDetail();
        }, [fetchDetail]);

        return { data, loading, error, refetch: fetchDetail };
      }

      function useSectors() {
        const [sectors, setSectors] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        const fetchSectors = useCallback(async () => {
          try {
            setLoading(true);
            setError(null);
            const res = await fetch(`${API_BASE}/timed/sectors`, {
              cache: "no-store",
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (json.ok && Array.isArray(json.sectors)) {
              setSectors(json.sectors);
            } else {
              setSectors([]);
            }
          } catch (err) {
            setError(err.message);
            setSectors([]);
          } finally {
            setLoading(false);
          }
        }, []);

        useEffect(() => {
          fetchSectors();
          const interval = setInterval(fetchSectors, 300000);
          return () => clearInterval(interval);
        }, [fetchSectors]);

        return { sectors, loading, error, refetch: fetchSectors };
      }

      // ─────────────────────────────────────────────────────────────
      // Trade Simulation Logic
      // ─────────────────────────────────────────────────────────────
      function shouldTriggerTrade(ticker, prevData) {
        // Skip futures
        if (FUTURES_TICKERS.has(ticker.ticker.toUpperCase())) return false;

        // Must have valid entry/exit levels
        if (!ticker.price || !ticker.sl || !ticker.tp) return false;

        const flags = ticker.flags || {};
        const state = String(ticker.state || "");
        const alignedLong = state === "HTF_BULL_LTF_BULL";
        const alignedShort = state === "HTF_BEAR_LTF_BEAR";
        const aligned = alignedLong || alignedShort;
        const ent = entryType(ticker);
        const inCorridor = ent.corridor;
        const side = ent.side; // LONG or SHORT

        // Corridor must match alignment
        const corridorAlignedOK =
          (side === "LONG" && alignedLong) ||
          (side === "SHORT" && alignedShort);

        if (!inCorridor || !corridorAlignedOK) return false;

        // Check for trigger conditions (matches worker logic)
        const enteredAligned = prevData && prevData.state !== state && aligned;
        const trigReason = String(ticker.trigger_reason || "");
        const trigOk = trigReason === "EMA_CROSS" || trigReason === "SQUEEZE_RELEASE";
        const sqRelease = !!flags.sq30_release;
        const hasTrigger = !!ticker.trigger_price && !!ticker.trigger_ts;

        // Must be: in corridor + corridor aligns + (entered aligned OR trigger OR squeeze release)
        const shouldConsiderAlert =
          inCorridor &&
          corridorAlignedOK &&
          (enteredAligned || trigOk || sqRelease || hasTrigger);

        // Check Momentum Elite status
        const momentumElite = !!flags.momentum_elite;
        
        // Threshold gates (with Momentum Elite adjustments - matching worker logic)
        const baseMinRR = 1.5;
        const baseMaxComp = 0.4;
        const baseMaxPhase = 0.6;
        const baseMinRank = 70;
        
        // Adjust thresholds for Momentum Elite (more lenient for quality stocks)
        const minRR = momentumElite ? Math.max(1.2, baseMinRR * 0.9) : baseMinRR; // Lower RR requirement
        const maxComp = momentumElite ? Math.min(0.5, baseMaxComp * 1.25) : baseMaxComp; // Allow higher completion
        const maxPhase = momentumElite ? Math.min(0.7, baseMaxPhase * 1.17) : baseMaxPhase; // Allow higher phase
        const minRank = momentumElite ? Math.max(60, baseMinRank - 10) : baseMinRank; // Lower rank requirement

        const rr = Number(ticker.rr) || 0;
        const comp = Number(ticker.completion) || 0;
        const phase = Number(ticker.phase_pct) || 0;
        const rank = Number(ticker.rank) || 0;

        const rrOk = rr >= minRR;
        const compOk = comp <= maxComp;
        const phaseOk = phase <= maxPhase;
        const rankOk = rank >= minRank;

        // Also consider Momentum Elite as a trigger condition (quality signal)
        const momentumEliteTrigger = momentumElite && inCorridor && corridorAlignedOK;
        
        // Enhanced trigger: original conditions OR Momentum Elite in good setup
        const enhancedTrigger = shouldConsiderAlert || momentumEliteTrigger;

        return enhancedTrigger && rrOk && compOk && phaseOk && rankOk;
      }

      function entryType(ticker) {
        const h = Number(ticker.htf_score);
        const l = Number(ticker.ltf_score);
        if (!Number.isFinite(h) || !Number.isFinite(l)) {
          return { corridor: false, side: null };
        }
        const LONG_CORRIDOR = { ltfMin: -8, ltfMax: 12 };
        const SHORT_CORRIDOR = { ltfMin: -12, ltfMax: 8 };
        if (h > 0 && l >= LONG_CORRIDOR.ltfMin && l <= LONG_CORRIDOR.ltfMax) {
          return { corridor: true, side: "LONG" };
        }
        if (h < 0 && l >= SHORT_CORRIDOR.ltfMin && l <= SHORT_CORRIDOR.ltfMax) {
          return { corridor: true, side: "SHORT" };
        }
        return { corridor: false, side: null };
      }

      function getDirection(ticker) {
        const state = String(ticker.state || "");
        if (state.includes("BULL")) return { text: "LONG", color: "text-green-400", bg: "bg-green-500/20" };
        if (state.includes("BEAR")) return { text: "SHORT", color: "text-red-400", bg: "bg-red-500/20" };
        return { text: null, color: "text-[#93a4d6]", bg: "bg-[#26325f]" };
      }

      function calculateTrade(ticker, entryPrice, existingTrade = null) {
        const directionObj = getDirection(ticker);
        const direction = directionObj.text;
        if (!direction) return null;

        const sl = Number(ticker.sl);
        const tp = Number(ticker.tp);
        const currentPrice = Number(ticker.price);

        if (!Number.isFinite(sl) || !Number.isFinite(tp) || !Number.isFinite(currentPrice)) {
          return null;
        }

        // Determine if this is a futures contract
        const tickerSymbol = String(ticker.ticker || "").toUpperCase();
        const isFutures = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        
        // For futures: trade 1 contract, calculate P&L based on point value
        // For stocks: calculate shares based on dollar amount
        let shares;
        let pointValue = 1; // Default for stocks (price per share)
        
        if (isFutures && FUTURES_SPECS[tickerSymbol]) {
          // Futures: always trade 1 contract
          shares = 1;
          pointValue = FUTURES_SPECS[tickerSymbol].pointValue;
        } else {
          // Stocks: calculate shares from dollar amount
          shares = TRADE_SIZE / entryPrice;
        }

        // Calculate P&L based on current price
        let pnl = 0;
        let pnlPct = 0;
        let status = "OPEN";

        // Check for partial trim (if position was already trimmed)
        const trimmedPct = existingTrade ? (existingTrade.trimmedPct || 0) : 0;
        const remainingShares = shares * (1 - trimmedPct);
        
        // Calculate price differences (in points for futures, dollars for stocks)
        const priceDiff = currentPrice - entryPrice;
        const tpDiff = tp - entryPrice;
        const slDiff = sl - entryPrice;
        
        if (direction === "LONG") {
          // Check if hit TP or SL first
          const hitTP = currentPrice >= tp;
          const hitSL = currentPrice <= sl;
          
          if (hitTP) {
            // If not already trimmed, trim 50% at first TP hit
            if (trimmedPct === 0) {
              const trimPnl = tpDiff * shares * pointValue * 0.5;
              const trimPnlPct = ((tp - entryPrice) / entryPrice) * 100;
              // Return special status for trimming
              return {
                shares,
                pnl: trimPnl,
                pnlPct: trimPnlPct,
                status: "TP_HIT_TRIM",
                currentPrice,
                trimmedPct: 0.5, // Mark as 50% trimmed
              };
            } else {
              // Already trimmed, full exit at TP
              pnl = tpDiff * shares * pointValue;
              pnlPct = ((tp - entryPrice) / entryPrice) * 100;
              // Status based on actual P&L, not just TP hit
              status = pnl >= 0 ? "WIN" : "LOSS";
            }
          } else if (hitSL) {
            pnl = slDiff * shares * pointValue;
            pnlPct = ((sl - entryPrice) / entryPrice) * 100;
            status = "LOSS";
          } else {
            // Still open - calculate current P&L
            pnl = priceDiff * shares * pointValue;
            pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;
            status = "OPEN";
          }
        } else {
          // SHORT
          // Check if hit TP or SL first
          const hitTP = currentPrice <= tp;
          const hitSL = currentPrice >= sl;
          
          if (hitTP) {
            // If not already trimmed, trim 50% at first TP hit
            if (trimmedPct === 0) {
              const shortTpDiff = entryPrice - tp;
              const trimPnl = shortTpDiff * shares * pointValue * 0.5;
              const trimPnlPct = ((entryPrice - tp) / entryPrice) * 100;
              // Return special status for trimming
              return {
                shares,
                pnl: trimPnl,
                pnlPct: trimPnlPct,
                status: "TP_HIT_TRIM",
                currentPrice,
                trimmedPct: 0.5, // Mark as 50% trimmed
              };
            } else {
              // Already trimmed, full exit at TP
              const shortTpDiff = entryPrice - tp;
              pnl = shortTpDiff * shares * pointValue;
              pnlPct = ((entryPrice - tp) / entryPrice) * 100;
              // Status based on actual P&L, not just TP hit
              status = pnl >= 0 ? "WIN" : "LOSS";
            }
          } else if (hitSL) {
            const shortSlDiff = entryPrice - sl;
            pnl = shortSlDiff * shares * pointValue;
            pnlPct = ((entryPrice - sl) / entryPrice) * 100;
            status = "LOSS";
          } else {
            // Still open - calculate current P&L
            const shortPriceDiff = entryPrice - currentPrice;
            pnl = shortPriceDiff * shares * pointValue;
            pnlPct = ((entryPrice - currentPrice) / entryPrice) * 100;
            status = "OPEN";
          }
        }

        return {
          shares,
          pnl,
          pnlPct,
          status,
          currentPrice,
        };
      }

      // ─────────────────────────────────────────────────────────────
      // Trade Tracking
      // ─────────────────────────────────────────────────────────────
      // Trade simulation is now handled by Worker - UI just fetches and displays
      // No need for useTradeSimulation hook anymore - Worker handles everything

      // ─────────────────────────────────────────────────────────────
      // Analytics & Learning
      // ─────────────────────────────────────────────────────────────
      function useTradeAnalytics(trades) {
        return useMemo(() => {
          const EPS = 1e-6;

          const clamp01 = (x) => Math.max(0, Math.min(1, x));
          const smoothWinRate = (wins, losses) => {
            // Laplace smoothing (prevents noisy 1/1 = 100% claims)
            const w = Number(wins || 0);
            const l = Number(losses || 0);
            const n = w + l;
            return n > 0 ? (w + 1) / (n + 2) : 0;
          };
          const confidenceLabel = (n) => {
            if (n >= 30) return "high";
            if (n >= 10) return "medium";
            if (n >= 5) return "low";
            return "very low";
          };
          const getExitReason = (trade) => {
            if (!trade) return null;
            if (trade.exitReason) return String(trade.exitReason);
            const hist = trade.history;
            if (Array.isArray(hist)) {
              for (let i = hist.length - 1; i >= 0; i--) {
                const e = hist[i];
                if (e && e.type === "EXIT") {
                  if (e.reason) return String(e.reason);
                  const note = String(e.note || "");
                  const m = note.match(/\(([^)]+)\)\s*$/);
                  if (m && m[1]) return String(m[1]);
                }
              }
            }
            return null;
          };
          const hasTrimEvent = (trade) => {
            if (!trade) return false;
            if ((Number(trade.trimmedPct) || 0) > EPS) return true;
            const hist = trade.history;
            return Array.isArray(hist) && hist.some((e) => e && e.type === "TRIM");
          };

          const horizonKeyForTrade = (trade) => {
            if (!trade) return "UNKNOWN";
            return computeHorizonKey(trade);
          };

          const computeExcursions = (trade) => {
            if (!trade) return null;
            const entry = Number(trade.entryPrice);
            if (!Number.isFinite(entry) || entry <= 0) return null;
            const prices = [entry];
            if (Array.isArray(trade.history)) {
              trade.history.forEach((e) => {
                if (e && Number.isFinite(Number(e.price))) {
                  prices.push(Number(e.price));
                }
              });
            }
            const exit = Number(trade.exitPrice ?? trade.exit_price);
            if (Number.isFinite(exit)) prices.push(exit);
            const current = Number(trade.currentPrice);
            if (Number.isFinite(current)) prices.push(current);
            const maxP = Math.max(...prices);
            const minP = Math.min(...prices);
            const isLong = String(trade.direction || "").toUpperCase() !== "SHORT";
            const mfe = isLong ? maxP - entry : entry - minP;
            const mae = isLong ? entry - minP : maxP - entry;
            const mfePct = (mfe / entry) * 100;
            const maePct = (mae / entry) * 100;
            return {
              mfe: Number.isFinite(mfe) ? mfe : null,
              mae: Number.isFinite(mae) ? mae : null,
              mfePct: Number.isFinite(mfePct) ? mfePct : null,
              maePct: Number.isFinite(maePct) ? maePct : null,
            };
          };

          // Helper to check if trade has remaining shares/contracts (not fully closed)
          const hasRemainingShares = (t) => {
            const tickerSym = String(t.ticker || "").toUpperCase();
            const isFut = FUTURES_SPECS[tickerSym] || tickerSym.endsWith("1!");
            const shares = t.shares || (isFut && FUTURES_SPECS[tickerSym] ? 1 : TRADE_SIZE / (t.entryPrice || 1));
            const trimmedPct = t.trimmedPct || 0;
            const remainingShares = shares - (shares * trimmedPct);
            return remainingShares > 0;
          };

          // Trimmed trades: positions that have been partially trimmed (check trimmedPct > 0 OR status TP_HIT_TRIM)
          // AND still have remaining shares (not fully closed)
          const trimmed = trades.filter((t) => {
            const trimmedPct = t.trimmedPct || 0;
            const isTrimmed = trimmedPct > 0 || t.status === "TP_HIT_TRIM";
            return isTrimmed && hasRemainingShares(t);
          });
          
          // Closed trades: positions with WIN or LOSS status (regardless of remaining shares)
          // Note: If status is WIN/LOSS, the trade is considered closed for analytics purposes
          const closed = trades.filter((t) => {
            return t.status === "WIN" || t.status === "LOSS";
          });
          
          // Open trades: currently open positions that haven't been trimmed yet
          const open = trades.filter((t) => {
            const trimmedPct = t.trimmedPct || 0;
            const isTrimmed = trimmedPct > 0 || t.status === "TP_HIT_TRIM";
            const isClosed = (t.status === "WIN" || t.status === "LOSS") && !hasRemainingShares(t);
            return (t.status === "OPEN" || !t.status) && !isTrimmed && !isClosed;
          });

          const openTrades = open.length;
          const trimmedTrades = trimmed.length;
          const closedTrades = closed.length;
          const totalTrades = openTrades + trimmedTrades + closedTrades; // Sum of all categories
          
          const wins = closed.filter((t) => t.status === "WIN").length;
          const losses = closed.filter((t) => t.status === "LOSS").length;
          const winRate = closedTrades > 0 ? (wins / closedTrades) * 100 : 0;

          // Calculate Closed P&L: includes fully closed trades + realized P&L from trimmed positions
          const closedPnl = closed.reduce((sum, t) => sum + (t.pnl || 0), 0);
          
          // Calculate realized P&L from trimmed positions
          const trimmedRealizedPnl = trimmed.reduce((sum, t) => {
            const tickerSym = String(t.ticker || "").toUpperCase();
            const isFut = FUTURES_SPECS[tickerSym] || tickerSym.endsWith("1!");
            const pointVal = isFut && FUTURES_SPECS[tickerSym] ? FUTURES_SPECS[tickerSym].pointValue : 1;
            const shares = t.shares || (isFut && FUTURES_SPECS[tickerSym] ? 1 : TRADE_SIZE / (t.entryPrice || 1));
            const trimmedPct = t.trimmedPct || 0;
            const trimmedShares = shares * trimmedPct;
            const entryPrice = t.entryPrice || 0;
            const tp = t.tp || entryPrice; // Use TP price where trimmed occurred
            
            if (trimmedShares > 0 && entryPrice > 0) {
              const direction = t.direction || "LONG";
              if (direction === "LONG") {
                // LONG: profit = (TP - Entry) * trimmed shares * point value
                const priceDiff = tp - entryPrice;
                return sum + (priceDiff * trimmedShares * pointVal);
              } else {
                // SHORT: profit = (Entry - TP) * trimmed shares * point value
                const priceDiff = entryPrice - tp;
                return sum + (priceDiff * trimmedShares * pointVal);
              }
            }
            return sum;
          }, 0);
          
          // Total Closed P&L = fully closed + trimmed realized
          const totalPnl = closedPnl + trimmedRealizedPnl;
          
          // Open P&L: unrealized P&L from open positions (including remaining shares in trimmed positions)
          const openPnl = [...open, ...trimmed].reduce((sum, t) => {
            const shares = t.shares || TRADE_SIZE / (t.entryPrice || 1); // Allow fractional shares
            const trimmedPct = t.trimmedPct || 0;
            const remainingShares = shares - (shares * trimmedPct); // Allow fractional shares
            const entryPrice = t.entryPrice || 0;
            const currentPrice = t.currentPrice || entryPrice;
            
            if (remainingShares > 0 && entryPrice > 0) {
              const direction = t.direction || "LONG";
              if (direction === "LONG") {
                return sum + ((currentPrice - entryPrice) * remainingShares);
              } else {
                return sum + ((entryPrice - currentPrice) * remainingShares);
              }
            }
            return sum;
          }, 0);

          // Calculate average win/loss
          const winningTrades = closed.filter((t) => t.status === "WIN");
          const losingTrades = closed.filter((t) => t.status === "LOSS");
          const avgWin = winningTrades.length > 0
            ? winningTrades.reduce((sum, t) => sum + (t.pnl || 0), 0) / winningTrades.length
            : 0;
          const avgLoss = losingTrades.length > 0
            ? losingTrades.reduce((sum, t) => sum + Math.abs(t.pnl || 0), 0) / losingTrades.length
            : 0;
          const profitFactor = avgLoss > 0 ? avgWin / avgLoss : avgWin > 0 ? Infinity : 0;

          const excursionStats = closed
            .map((t) => computeExcursions(t))
            .filter(Boolean);
          const avgMfePct =
            excursionStats.length > 0
              ? excursionStats.reduce((s, x) => s + (x.mfePct || 0), 0) /
                excursionStats.length
              : 0;
          const avgMaePct =
            excursionStats.length > 0
              ? excursionStats.reduce((s, x) => s + (x.maePct || 0), 0) /
                excursionStats.length
              : 0;

          const capturedStats = closed
            .map((t) => {
              const entry = Number(t.entryPrice);
              const exit = Number(t.exitPrice ?? t.exit_price);
              const target = Number(t.tp_target_price ?? t.tp);
              if (
                !Number.isFinite(entry) ||
                !Number.isFinite(exit) ||
                !Number.isFinite(target)
              )
                return null;
              const isLong = String(t.direction || "").toUpperCase() !== "SHORT";
              const denom = isLong ? target - entry : entry - target;
              const num = isLong ? exit - entry : entry - exit;
              if (!Number.isFinite(denom) || Math.abs(denom) < EPS) return null;
              const pct = (num / denom) * 100;
              return Number.isFinite(pct) ? pct : null;
            })
            .filter((v) => Number.isFinite(v));
          const avgCapturedPct =
            capturedStats.length > 0
              ? capturedStats.reduce((s, v) => s + v, 0) / capturedStats.length
              : 0;

          const horizonStats = {};
          for (const t of closed) {
            const key = horizonKeyForTrade(t);
            if (!horizonStats[key]) {
              horizonStats[key] = {
                n: 0,
                wins: 0,
                losses: 0,
                totalPnl: 0,
                mfePct: 0,
                maePct: 0,
                capturedPct: 0,
                capturedN: 0,
              };
            }
            const bucket = horizonStats[key];
            bucket.n += 1;
            if (t.status === "WIN") bucket.wins += 1;
            if (t.status === "LOSS") bucket.losses += 1;
            bucket.totalPnl += Number(t.pnl || 0);
            const ex = computeExcursions(t);
            if (ex && Number.isFinite(ex.mfePct)) bucket.mfePct += ex.mfePct;
            if (ex && Number.isFinite(ex.maePct)) bucket.maePct += ex.maePct;
            const entry = Number(t.entryPrice);
            const exit = Number(t.exitPrice ?? t.exit_price);
            const target = Number(t.tp_target_price ?? t.tp);
            const isLong = String(t.direction || "").toUpperCase() !== "SHORT";
            if (
              Number.isFinite(entry) &&
              Number.isFinite(exit) &&
              Number.isFinite(target)
            ) {
              const denom = isLong ? target - entry : entry - target;
              const num = isLong ? exit - entry : entry - exit;
              if (Number.isFinite(denom) && Math.abs(denom) > EPS) {
                bucket.capturedPct += (num / denom) * 100;
                bucket.capturedN += 1;
              }
            }
          }

          Object.keys(horizonStats).forEach((key) => {
            const s = horizonStats[key];
            const n = Math.max(1, s.n);
            const winRateH = s.n > 0 ? (s.wins / s.n) * 100 : 0;
            const avgWinH =
              s.wins > 0
                ? closed
                    .filter((t) => horizonKeyForTrade(t) === key && t.status === "WIN")
                    .reduce((sum, t) => sum + (t.pnl || 0), 0) / s.wins
                : 0;
            const avgLossH =
              s.losses > 0
                ? closed
                    .filter((t) => horizonKeyForTrade(t) === key && t.status === "LOSS")
                    .reduce((sum, t) => sum + Math.abs(t.pnl || 0), 0) / s.losses
                : 0;
            s.winRate = winRateH;
            s.expectancy = winRateH / 100 * avgWinH - (1 - winRateH / 100) * avgLossH;
            s.avgMfePct = s.mfePct / n;
            s.avgMaePct = s.maePct / n;
            s.avgCapturedPct =
              s.capturedN > 0 ? s.capturedPct / s.capturedN : 0;
          });

          // Analyze by signal combinations
          const signalAnalysis = {};
          closed.forEach((trade) => {
            const signals = [];
            if (trade.flags?.sq30_release) signals.push("SqueezeRelease");
            if (trade.flags?.sq30_on) signals.push("SqueezeOn");
            if (trade.flags?.phase_zone_change) signals.push("PhaseZoneChange");
            if (trade.inCorridor) signals.push("InCorridor");
            const key = signals.sort().join("+") || "None";
            
            if (!signalAnalysis[key]) {
              signalAnalysis[key] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") signalAnalysis[key].wins++;
            if (trade.status === "LOSS") signalAnalysis[key].losses++;
            signalAnalysis[key].totalPnl += trade.pnl || 0;
          });

          // Analyze by RR ranges
          const rrAnalysis = {};
          closed.forEach((trade) => {
            const rr = trade.rr || 0;
            let range = "Unknown";
            if (rr >= 2.0) range = "RR ≥ 2.0";
            else if (rr >= 1.5) range = "RR 1.5-2.0";
            else if (rr >= 1.0) range = "RR 1.0-1.5";
            else if (rr > 0) range = "RR < 1.0";
            
            if (!rrAnalysis[range]) {
              rrAnalysis[range] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") rrAnalysis[range].wins++;
            if (trade.status === "LOSS") rrAnalysis[range].losses++;
            rrAnalysis[range].totalPnl += trade.pnl || 0;
          });

          // Analyze by rank ranges
          const rankAnalysis = {};
          closed.forEach((trade) => {
            const rank = trade.rank || 0;
            let range = "Unknown";
            if (rank >= 80) range = "Rank ≥ 80";
            else if (rank >= 70) range = "Rank 70-80";
            else if (rank >= 60) range = "Rank 60-70";
            else if (rank > 0) range = "Rank < 60";
            
            if (!rankAnalysis[range]) {
              rankAnalysis[range] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") rankAnalysis[range].wins++;
            if (trade.status === "LOSS") rankAnalysis[range].losses++;
            rankAnalysis[range].totalPnl += trade.pnl || 0;
          });

          // Generate recommendations
          const recommendations = { filters: [], management: [] };

          const pushRec = (bucket, rec) => {
            if (!bucket || !recommendations[bucket]) return;
            recommendations[bucket].push(rec);
          };
          
          // Find best performing signal combinations
          const bestSignals = Object.entries(signalAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 5) // Reduce noise
            .sort((a, b) => {
              const aN = a[1].wins + a[1].losses;
              const bN = b[1].wins + b[1].losses;
              const aRate = smoothWinRate(a[1].wins, a[1].losses);
              const bRate = smoothWinRate(b[1].wins, b[1].losses);
              // Prefer higher winrate, then larger sample, then higher pnl
              if (bRate !== aRate) return bRate - aRate;
              if (bN !== aN) return bN - aN;
              return (b[1].totalPnl || 0) - (a[1].totalPnl || 0);
            })
            .slice(0, 3);
          
          if (bestSignals.length > 0) {
            const [sigKey, stats] = bestSignals[0];
            const n = stats.wins + stats.losses;
            const wr = smoothWinRate(stats.wins, stats.losses);
            const avgPnl = n > 0 ? (stats.totalPnl || 0) / n : 0;
            if (wr >= 0.55 && n >= 5) {
              pushRec("filters", {
                type: "signal",
                priority: n >= 15 ? "high" : "medium",
                message: `Filters: Favor ${sigKey} (smoothed win rate ${(wr * 100).toFixed(1)}%, avg $${avgPnl.toFixed(2)} per trade, n=${n}, confidence ${confidenceLabel(n)})`,
              });
            }
          }

          // Find best RR range
          const bestRR = Object.entries(rrAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 5)
            .sort((a, b) => {
              const aN = a[1].wins + a[1].losses;
              const bN = b[1].wins + b[1].losses;
              const aRate = smoothWinRate(a[1].wins, a[1].losses);
              const bRate = smoothWinRate(b[1].wins, b[1].losses);
              if (bRate !== aRate) return bRate - aRate;
              if (bN !== aN) return bN - aN;
              return (b[1].totalPnl || 0) - (a[1].totalPnl || 0);
            })[0];
          
          if (bestRR) {
            const [range, stats] = bestRR;
            const n = stats.wins + stats.losses;
            const wr = smoothWinRate(stats.wins, stats.losses);
            const avgPnl = n > 0 ? (stats.totalPnl || 0) / n : 0;
            if (n >= 5 && (wr >= 0.52 || avgPnl > 0)) {
              pushRec("filters", {
                type: "rr",
                priority: n >= 15 ? "medium" : "low",
                message: `Filters: RR sweet spot looks like ${range} (smoothed win rate ${(wr * 100).toFixed(1)}%, avg $${avgPnl.toFixed(2)}, n=${n})`,
              });
            }
          }

          // Find best rank range
          const bestRank = Object.entries(rankAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 5)
            .sort((a, b) => {
              const aN = a[1].wins + a[1].losses;
              const bN = b[1].wins + b[1].losses;
              const aRate = smoothWinRate(a[1].wins, a[1].losses);
              const bRate = smoothWinRate(b[1].wins, b[1].losses);
              if (bRate !== aRate) return bRate - aRate;
              if (bN !== aN) return bN - aN;
              return (b[1].totalPnl || 0) - (a[1].totalPnl || 0);
            })[0];
          
          if (bestRank) {
            const [range, stats] = bestRank;
            const n = stats.wins + stats.losses;
            const wr = smoothWinRate(stats.wins, stats.losses);
            const avgPnl = n > 0 ? (stats.totalPnl || 0) / n : 0;
            if (n >= 5 && (wr >= 0.52 || avgPnl > 0)) {
              pushRec("filters", {
                type: "rank",
                priority: n >= 15 ? "medium" : "low",
                message: `Filters: Best rank bucket so far is ${range} (smoothed win rate ${(wr * 100).toFixed(1)}%, avg $${avgPnl.toFixed(2)}, n=${n})`,
              });
            }
          }

          // Profit factor recommendations - only show if we have enough closed trades to analyze
          if (profitFactor < 1.0 && closedTrades >= 10) {
            pushRec("filters", {
              type: "risk",
              priority: "high",
              message: `Profit factor is ${profitFactor.toFixed(2)}. Consider tightening stops or improving entry selection.`,
            });
          }

          // Win rate recommendations - only show if we have enough closed trades to analyze
          if (winRate < 40 && closedTrades >= 10) {
            pushRec("filters", {
              type: "filter",
              priority: "high",
              message: `Win rate is ${winRate.toFixed(1)}%. Consider raising minimum rank threshold or requiring squeeze release.`,
            });
          }

          // Management learning (post-entry): trims + exit reasons
          if (closedTrades >= 5) {
            const closedWithTrim = closed.filter((t) => hasTrimEvent(t));
            const closedNoTrim = closed.filter((t) => !hasTrimEvent(t));

            const summarize = (arr) => {
              const n = arr.length;
              const w = arr.filter((t) => t.status === "WIN").length;
              const l = arr.filter((t) => t.status === "LOSS").length;
              const wr = smoothWinRate(w, l);
              const totalP = arr.reduce((s, t) => s + (t.pnl || 0), 0);
              const avgP = n > 0 ? totalP / n : 0;
              return { n, w, l, wr, avgP };
            };

            const trimStats = summarize(closedWithTrim);
            const noTrimStats = summarize(closedNoTrim);
            if (trimStats.n >= 5 || noTrimStats.n >= 5) {
              const better =
                trimStats.n >= 5 && noTrimStats.n >= 5
                  ? trimStats.avgP - noTrimStats.avgP
                  : 0;
              if (trimStats.n >= 5 && noTrimStats.n >= 5 && Math.abs(better) > 1e-9) {
                pushRec("management", {
                  type: "trim_vs_no_trim",
                  priority: "medium",
                  message: `Management: Trades with trims avg $${trimStats.avgP.toFixed(2)} (n=${trimStats.n}) vs no-trim avg $${noTrimStats.avgP.toFixed(2)} (n=${noTrimStats.n}). ${better > 0 ? "Trimming is helping." : "Trimming may be hurting."}`,
                });
              } else if (trimStats.n >= 5 && noTrimStats.n < 5) {
                pushRec("management", {
                  type: "trim_data",
                  priority: "low",
                  message: `Management: Most closed trades include trims (n=${trimStats.n}). Keep logging trims + exits to learn hold/trim improvements.`,
                });
              }
            }

            const exitReasonStats = {};
            closed.forEach((t) => {
              const r = getExitReason(t) || "UNKNOWN";
              if (!exitReasonStats[r]) exitReasonStats[r] = { n: 0, wins: 0, losses: 0, pnl: 0 };
              exitReasonStats[r].n += 1;
              if (t.status === "WIN") exitReasonStats[r].wins += 1;
              if (t.status === "LOSS") exitReasonStats[r].losses += 1;
              exitReasonStats[r].pnl += t.pnl || 0;
            });

            const topExit = Object.entries(exitReasonStats)
              .filter(([_, s]) => s.n >= 3)
              .sort((a, b) => (b[1].pnl || 0) - (a[1].pnl || 0))[0];

            if (topExit) {
              const [reason, s] = topExit;
              const wr = smoothWinRate(s.wins, s.losses);
              const avgP = s.n > 0 ? (s.pnl || 0) / s.n : 0;
              pushRec("management", {
                type: "exit_reason",
                priority: reason === "SL" ? "high" : "low",
                message: `Management: Exit reason ${reason} avg $${avgP.toFixed(2)} (smoothed win rate ${(wr * 100).toFixed(1)}%, n=${s.n}).`,
              });
            }
          } else {
            pushRec("management", {
              type: "needs_data",
              priority: "low",
              message: `Management: Need more closed trades (currently n=${closedTrades}) to learn trim/exit improvements reliably.`,
            });
          }

          return {
            totalTrades,
            openTrades,
            trimmedTrades,
            closedTrades,
            wins,
            losses,
            winRate,
            totalPnl,
            openPnl,
            avgWin,
            avgLoss,
            profitFactor,
            avgMfePct,
            avgMaePct,
            avgCapturedPct,
            horizonStats,
            signalAnalysis,
            rrAnalysis,
            rankAnalysis,
            recommendations,
          };
        }, [trades]);
      }

      // ─────────────────────────────────────────────────────────────
      // Components
      // ─────────────────────────────────────────────────────────────
      // Format RR display (e.g., "2.10:1" or "1:2.10")
      function formatRR(rr) {
        if (!rr || !Number.isFinite(rr)) return "N/A";
        if (rr >= 1) {
          return `${rr.toFixed(2)}:1`;
        } else {
          return `1:${(1 / rr).toFixed(2)}`;
        }
      }

      // Trade History Component
      function TradeHistory({ history = [] }) {
        if (!history || history.length === 0) {
          return (
            <div className="text-xs text-[#6b7a9f] italic p-2">
              No history available
            </div>
          );
        }

        const getEventIcon = (type) => {
          switch (type) {
            case "ENTRY": return "📥";
            case "SCALE_IN": return "➕";
            case "TRIM": return "✂️";
            case "EXIT": return "📤";
            default: return "•";
          }
        };

        const getEventColor = (type) => {
          switch (type) {
            case "ENTRY": return "text-green-400";
            case "SCALE_IN": return "text-blue-400";
            case "TRIM": return "text-yellow-400";
            case "EXIT": return "text-purple-400";
            default: return "text-[#93a4d6]";
          }
        };

        return (
          <div className="space-y-2 max-h-[400px] overflow-y-auto">
            {history.map((event, idx) => {
              const eventDate = new Date(event.timestamp);
              const formattedDate = eventDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
              });
              const formattedTime = eventDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
              });

              return (
                <div
                  key={idx}
                  className="bg-[#0f1630] border border-[#26325f] rounded-lg p-3"
                >
                  <div className="flex items-start gap-3">
                    <div className={`text-xl ${getEventColor(event.type)}`}>
                      {getEventIcon(event.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between mb-1">
                        <span className={`text-sm font-semibold ${getEventColor(event.type)}`}>
                          {event.type.replace('_', ' ')}
                        </span>
                        <span className="text-xs text-[#6b7a9f]">
                          {formattedDate} {formattedTime}
                        </span>
                      </div>
                      <div className="text-xs text-[#93a4d6] mb-2">
                        {event.note}
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-xs">
                        <div>
                          <span className="text-[#6b7a9f]">Price:</span>
                          <span className="ml-1 font-semibold text-white">
                            ${Number(event.price).toFixed(2)}
                          </span>
                        </div>
                        <div>
                          <span className="text-[#6b7a9f]">Shares:</span>
                          <span className="ml-1 font-semibold text-white">
                            {event.shares}
                          </span>
                        </div>
                        <div>
                          <span className="text-[#6b7a9f]">Value:</span>
                          <span className="ml-1 font-semibold text-white">
                            ${Number(event.value).toFixed(2)}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      // ─────────────────────────────────────────────────────────────
      // Unified Ticker Detail Right Rail Component
      // Reusable component that shows comprehensive ticker information
      // and optionally trade history if a trade is associated
      // ─────────────────────────────────────────────────────────────
      function TickerDetailRightRail({ ticker, trade = null, onClose, allLoadedData = null, sectors = [], rankedTickers = null, rankedTickerPositions = null }) {
        if (!ticker) return null;

        // Helper to get ticker data - prefer trade's ticker data if available, otherwise use ticker prop
        const tickerData = trade && trade.tickerData ? trade.tickerData : ticker;
        const tickerSymbol = tickerData.ticker || ticker.ticker || (trade ? trade.ticker : null);
        
        if (!tickerSymbol) return null;

        const prime = isPrimeBubble(tickerData);
        const ent = entryType(tickerData);
        const flags = tickerData.flags || {};
        const phase = Number(tickerData.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const actionInfo = getActionDescription(tickerData);
        const [bubbleJourney, setBubbleJourney] = useState([]);
        const [bubbleJourneyLoading, setBubbleJourneyLoading] = useState(false);
        const [bubbleJourneyError, setBubbleJourneyError] = useState(null);

        useEffect(() => {
          const sym = String(tickerSymbol || "").trim().toUpperCase();
          if (!sym) {
            setBubbleJourney([]);
            setBubbleJourneyError(null);
            setBubbleJourneyLoading(false);
            return;
          }
          let cancelled = false;
          const fetchTrail = async () => {
            try {
              setBubbleJourneyLoading(true);
              setBubbleJourneyError(null);
              const res = await fetch(
                `${API_BASE}/timed/trail?ticker=${encodeURIComponent(sym)}`,
                { cache: "no-store" }
              );
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const json = await res.json();
              const raw = Array.isArray(json.trail) ? json.trail : [];
              const withTs = raw
                .map((p) => {
                  const tsRaw = p.ts ?? p.timestamp ?? p.ingest_ts ?? p.ingest_time;
                  const ts =
                    typeof tsRaw === "string"
                      ? new Date(tsRaw).getTime()
                      : Number(tsRaw);
                  if (!Number.isFinite(ts)) return null;
                  return { ...p, __ts_ms: ts };
                })
                .filter(Boolean)
                .sort((a, b) => a.__ts_ms - b.__ts_ms);
              if (!cancelled) setBubbleJourney(withTs);
            } catch (e) {
              if (!cancelled) {
                setBubbleJourney([]);
                setBubbleJourneyError(String(e.message || e));
              }
            } finally {
              if (!cancelled) setBubbleJourneyLoading(false);
            }
          };
          fetchTrail();
          return () => {
            cancelled = true;
          };
        }, [tickerSymbol]);

        const detectedPatterns = useMemo(
          () => detectPatterns(bubbleJourney, flags || {}),
          [bubbleJourney, flags]
        );

        // Convert allLoadedData to array for ranking calculations
        const allLoadedTickersArray = (() => {
          if (allLoadedData && typeof allLoadedData === "object") {
            if (Array.isArray(allLoadedData)) return allLoadedData;
            return Object.values(allLoadedData).filter(
              (t) => t && typeof t === "object" && t.ticker
            );
          }
          return [];
        })();

        const baseScore = Number(tickerData.rank) || 0;
        // Crash-proofing: right rail renders "Dynamic Score" and expects `dynamicRank`.
        // Use the shared rank-score helper (prefers backend rank_score/dynamicScore).
        const dynamicRank = rankScoreForTicker(tickerData);
        const sortedByRank =
          rankedTickers && rankedTickers.length > 0
            ? rankedTickers
            : getRankedTickers(allLoadedData);
        const rankPosition =
          getRankPositionFromMap(rankedTickerPositions, tickerSymbol) ??
          getRankPositionFromMap(
            Object.fromEntries(
              sortedByRank.map((t, idx) => [String(t.ticker || "").toUpperCase(), idx + 1])
            ),
            tickerSymbol
          );
        const totalTickersRaw = sortedByRank.length;
        const rankTotal =
          Number.isFinite(Number(tickerData.rank_total)) && Number(tickerData.rank_total) > 0
            ? Number(tickerData.rank_total)
            : totalTickersRaw;
        // Back-compat / crash-proofing: some UI sections referenced `totalTickers`
        // (should be `rankTotal`). Keep an alias to avoid runtime ReferenceError.
        const totalTickers = rankTotal;
        const isInTop40 = rankPosition > 0 && rankPosition <= 40;

        // Determine if this is a futures contract
        const isFuturesDetail = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        const pointValueDetail = isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? FUTURES_SPECS[tickerSymbol].pointValue : 1;
        
        // Trade-specific calculations
        // For futures: shares = contracts (always 1), for stocks: calculate from TRADE_SIZE
        const shares = trade 
          ? (trade.shares || (isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? 1 : TRADE_SIZE / (trade.entryPrice || 1)))
          : null;
        const currentPrice = trade ? (trade.currentPrice || trade.entryPrice) : (tickerData.price || tickerData.currentPrice);
        const trimmedPct = trade ? (trade.trimmedPct || 0) : 0;
        const trimmedShares = trade ? (shares * trimmedPct) : 0;
        const remainingShares = trade ? (shares - trimmedShares) : null;

        const metricsSource = trade
          ? {
              ...tickerData,
              entryPrice: trade.entryPrice,
              tp: trade.tp ?? tickerData.tp,
              sl: trade.sl ?? tickerData.sl,
              direction: trade.direction,
            }
          : tickerData;
        const horizon = computeHorizonBucket(metricsSource);
        const eta = computeEtaDays(metricsSource);
        const retPct = computeReturnPct(metricsSource);
        const riskPct = computeRiskPct(metricsSource);
        const tpTarget = computeTpTargetPrice(metricsSource);
        const tpLevels = Array.isArray(metricsSource?.tp_levels)
          ? metricsSource.tp_levels
              .map((tp) =>
                typeof tp === "object" && tp?.price != null
                  ? Number(tp.price)
                  : Number(tp)
              )
              .filter((p) => Number.isFinite(p))
          : [];
        const tpList =
          tpLevels.length > 0
            ? tpLevels
                .slice(0, 6)
                .map((p) => p.toFixed(2))
                .join(", ")
            : null;
        const tpMax = computeTpMaxPrice(metricsSource);

        return (
          <div className="w-full h-full flex flex-col bg-[#0f1630]">
            {/* Scrollable Content Area */}
            <div className="flex-1 overflow-y-auto">
              {/* Floating Header */}
              <div className="sticky top-0 z-30 bg-[#121a33] border-b border-[#26325f] px-6 py-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-xl font-bold">
                      {tickerSymbol}{trade ? ` ${trade.direction}` : ''}
                    </h3>
                    {tickerData.price && (
                      <div className="text-sm text-white mt-1">
                        ${Number(tickerData.price).toFixed(2)}
                      </div>
                    )}
                  </div>
                  <button
                    onClick={onClose}
                    className="text-[#93a4d6] hover:text-white transition-colors text-xl leading-none w-8 h-8 flex items-center justify-center rounded hover:bg-[#26325f]"
                  >
                    ✕
                  </button>
                </div>
                {(() => {
                  const ingestTime = tickerData.ingest_ts || tickerData.ingest_time || tickerData.ts;
                  if (!ingestTime) return null;
                  try {
                    const timeValue = typeof ingestTime === "string" ? new Date(ingestTime) : new Date(Number(ingestTime));
                    if (isNaN(timeValue.getTime())) return null;
                    const displayDate = timeValue.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
                    const displayTime = timeValue.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });
                    return (
                      <div className="mt-2 text-xs flex items-center gap-2">
                        <span className="text-[#93a4d6]">Last Ingest:</span>
                        <span className="text-white font-semibold">{displayDate} {displayTime}</span>
                      </div>
                    );
                  } catch {
                    return null;
                  }
                })()}
              </div>

              {/* Padded body content (keeps header top-aligned) */}
              <div className="p-6 pt-4">
              {/* Sector, Sector Rating */}
              {(() => {
                const tickerSector = tickerData.sector || tickerData.fundamentals?.sector;
                if (!tickerSector || !sectors.length) return null;
                const sectorInfo = sectors.find((s) => (s.sector || s.name) === tickerSector);
                const rating = sectorInfo?.rating || "neutral";
                const emoji = rating === "overweight" ? "📈" : rating === "underweight" ? "📉" : "➡️";
                return (
                  <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                    <div className="text-sm text-[#93a4d6] mb-2">Sector</div>
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="text-lg">{emoji}</span>
                      <span className="font-semibold text-white">{tickerSector}</span>
                      <span className={`text-xs px-2 py-1 rounded ${
                        rating === "overweight" ? "bg-green-500/20 text-green-400" :
                        rating === "underweight" ? "bg-red-500/20 text-red-400" :
                        "bg-[#26325f] text-[#93a4d6]"
                      }`}>
                        {rating.charAt(0).toUpperCase() + rating.slice(1)}
                      </span>
                    </div>
                  </div>
                );
              })()}

              {/* Bias / Direction */}
              {(() => {
                const dir = getDirection(tickerData);
                return (
                  <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                    <div className="text-sm text-[#93a4d6] mb-2">Bias / Direction</div>
                    <div className={`inline-block px-4 py-2 rounded-lg font-bold text-lg ${dir.bg} ${dir.color}`}>
                      {dir.text === "LONG" ? "📈 LONG" : dir.text === "SHORT" ? "📉 SHORT" : dir.text}
                    </div>
                  </div>
                );
              })()}

              {/* System Decision + Guidance */}
              <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                <div className="text-sm text-[#93a4d6] mb-2">System Decision</div>
                <div className={`text-sm font-bold ${actionInfo.color}`}>{actionInfo.action}</div>
                <div className="text-xs text-[#93a4d6] mt-1">{actionInfo.description}</div>
              </div>

              {/* Score, Rank, Breakdown */}
              <div className="space-y-2.5 text-sm mb-4">
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Score</span>
                  <span className="font-semibold text-blue-400 text-lg">{baseScore}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Rank</span>
                  <span className="font-semibold">
                    {rankPosition > 0 ? `#${rankPosition} of ${rankTotal}` : "—"}
                  </span>
                </div>
                {(() => {
                  const breakdown = calculateScoreBreakdown(tickerData);
                  const breakdownComponents = [
                    { label: "Base Score", value: breakdown.base, color: "text-blue-400" },
                    breakdown.aligned > 0 ? { label: "Aligned State", value: `+${breakdown.aligned}`, color: "text-green-400" } : null,
                    breakdown.setup > 0 ? { label: "Setup State", value: `+${breakdown.setup}`, color: "text-green-400" } : null,
                    breakdown.htf > 0 ? { label: "HTF Score", value: `+${breakdown.htf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.ltf > 0 ? { label: "LTF Score", value: `+${breakdown.ltf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.completion > 0 ? { label: "Completion Bonus", value: `+${breakdown.completion}`, color: "text-yellow-400" } : null,
                    breakdown.phase !== 0 ? { label: "Phase", value: breakdown.phase > 0 ? `+${breakdown.phase.toFixed(2)}` : breakdown.phase.toFixed(2), color: breakdown.phase > 0 ? "text-green-400" : "text-red-400" } : null,
                    breakdown.squeezeRelease > 0 ? { label: "Squeeze Release", value: `+${breakdown.squeezeRelease}`, color: "text-cyan-400" } : null,
                    breakdown.squeezeOn > 0 ? { label: "Squeeze On", value: `+${breakdown.squeezeOn}`, color: "text-yellow-400" } : null,
                    breakdown.rr > 0 ? { label: "Risk/Reward", value: `+${breakdown.rr}`, color: "text-green-400" } : null,
                  ].filter(Boolean);
                  return breakdownComponents.length > 0 ? (
                    <div className="border-t border-[#26325f] my-3 pt-3">
                      <div className="text-xs text-[#93a4d6] mb-3 font-semibold">Score Breakdown</div>
                      <div className="space-y-1.5">
                        {breakdownComponents.map((comp, idx) => (
                          <div key={idx} className="flex justify-between items-center text-xs">
                            <span className="text-[#93a4d6]">{comp.label}</span>
                            <span className={`font-semibold ${comp.color}`}>{comp.value}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : null;
                })()}
              </div>

              {/* RR, SL, Max TP, TP Target, TP Levels */}
              <div className="space-y-2.5 text-sm mb-4">
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">RR</span>
                  <span className="font-semibold">{tickerData.rr ? Number(tickerData.rr).toFixed(2) : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">SL</span>
                  <span className="font-semibold text-red-400">{metricsSource.sl ? `$${Number(metricsSource.sl).toFixed(2)}` : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">TP Max</span>
                  <span className="font-semibold text-green-400">{Number.isFinite(tpMax) ? `$${tpMax.toFixed(2)}` : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">TP Target</span>
                  <span className="font-semibold text-green-400">{Number.isFinite(tpTarget) ? `$${tpTarget.toFixed(2)}` : "—"}</span>
                </div>
                {tpLevels.length > 0 && (
                  <div className="text-xs text-[#93a4d6]">
                    TP Levels: {tpLevels.slice(0, 6).map((p) => p.toFixed(2)).join(", ")}
                  </div>
                )}
              </div>

              {/* Trade Journey */}
              <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                <div className="text-sm text-[#93a4d6] mb-2">Trade Journey</div>
                {trade ? (
                  <>
                    <div className="grid grid-cols-2 gap-4 text-sm mb-3">
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">Entry Price</div>
                        <div className="font-semibold text-white text-lg">${trade.entryPrice?.toFixed(2) || "—"}</div>
                      </div>
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">Current Price</div>
                        <div className="font-semibold text-yellow-400 text-lg">${currentPrice?.toFixed(2) || "—"}</div>
                      </div>
                    </div>
                    {trade.history && trade.history.length > 0 && (
                      <TradeHistory history={trade.history} />
                    )}
                  </>
                ) : (
                  <div className="text-xs text-[#93a4d6]">No trade history for this ticker.</div>
                )}
              </div>

              {/* Completion, Phase, Dynamic ETA */}
              <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-[#93a4d6]">Phase</span>
                  <span className="text-sm font-semibold" style={{ color: phaseColor }}>
                    {(phase * 100).toFixed(2)}%
                  </span>
                </div>
                <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                  <div className="h-full rounded-full transition-all duration-500" style={{ width: `${phase * 100}%`, backgroundColor: phaseColor }} />
                </div>
                <div className="mt-2 flex items-center justify-between text-xs">
                  <span className="text-[#93a4d6]">Completion</span>
                  <span className="font-semibold text-white">
                    {tickerData.completion != null ? `${(Number(tickerData.completion) * 100).toFixed(2)}%` : "—"}
                  </span>
                </div>
                <div className="mt-1 flex items-center justify-between text-xs">
                  <span className="text-[#93a4d6]">Dynamic ETA</span>
                  <span className="font-semibold text-white">{Number.isFinite(eta) ? `${eta.toFixed(1)}d` : "—"}</span>
                </div>
              </div>

              {/* EMA Cloud Position */}
              {(tickerData.daily_ema_cloud || tickerData.fourh_ema_cloud || tickerData.oneh_ema_cloud) && (
                <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                  <div className="text-sm text-[#93a4d6] mb-2">EMA Cloud Position</div>
                  {["daily_ema_cloud", "fourh_ema_cloud", "oneh_ema_cloud"].map((key) => {
                    const cloud = tickerData[key];
                    if (!cloud) return null;
                    return (
                      <div key={key} className="text-xs text-[#93a4d6] flex justify-between">
                        <span>{key.replace("_ema_cloud", "").toUpperCase()}</span>
                        <span className="text-white font-semibold">{cloud.position || "—"}</span>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* TD Sequential */}
              {tickerData.td_sequential && (
                <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                  <div className="text-sm text-[#93a4d6] mb-2">TD Sequential</div>
                  <div className="text-xs text-[#93a4d6] flex justify-between">
                    <span>Bullish Prep</span>
                    <span className="text-white font-semibold">{tickerData.td_sequential.bullish_prep_count || 0}/9</span>
                  </div>
                  <div className="text-xs text-[#93a4d6] flex justify-between">
                    <span>Bearish Prep</span>
                    <span className="text-white font-semibold">{tickerData.td_sequential.bearish_prep_count || 0}/9</span>
                  </div>
                </div>
              )}

              {/* RSI & Divergence */}
              {tickerData.rsi && (
                <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                  <div className="text-sm text-[#93a4d6] mb-2">RSI & Divergence</div>
                  <div className="text-xs text-[#93a4d6] flex justify-between">
                    <span>RSI</span>
                    <span className="text-white font-semibold">{Number(tickerData.rsi.value || 0).toFixed(2)}</span>
                  </div>
                  <div className="text-xs text-[#93a4d6] flex justify-between">
                    <span>Divergence</span>
                    <span className="text-white font-semibold">{tickerData.rsi.divergence?.type || "none"}</span>
                  </div>
                </div>
              )}

              {/* State, Horizon, Detected Patterns */}
              <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                <div className="text-sm text-[#93a4d6] mb-2">State & Horizon</div>
                <div className="text-xs text-[#93a4d6] flex justify-between">
                  <span>State</span>
                  <span className="text-white font-semibold">{tickerData.state || "—"}</span>
                </div>
                <div className="text-xs text-[#93a4d6] flex justify-between">
                  <span>Horizon</span>
                  <span className="text-white font-semibold">{horizon}</span>
                </div>
                {detectedPatterns && detectedPatterns.length > 0 && (
                  <div className="mt-2 text-[10px] text-yellow-300">
                    {detectedPatterns.map((p) => p.description).slice(0, 3).join(" • ")}
                  </div>
                )}
              </div>

              {/* Bubble Journey (15m increments) */}
              <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                <div className="text-sm text-[#93a4d6] mb-2">Bubble Journey (15m)</div>
                {bubbleJourneyLoading ? (
                  <div className="text-xs text-[#93a4d6]">Loading trail…</div>
                ) : bubbleJourneyError ? (
                  <div className="text-xs text-red-400">{bubbleJourneyError}</div>
                ) : (
                  <div className="space-y-1 max-h-48 overflow-y-auto pr-1">
                    {downsampleByInterval(bubbleJourney, 15 * 60 * 1000)
                      .slice()
                      .reverse()
                      .slice(0, 24)
                      .map((p, idx) => (
                        <div key={`${p.__bucket || p.__ts_ms}-${idx}`} className="text-[10px] text-[#93a4d6] flex justify-between">
                          <span>{Number.isFinite(p.__ts_ms) ? new Date(p.__ts_ms).toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" }) : "—"}</span>
                          <span className="text-white">{p.state || "—"}</span>
                        </div>
                      ))}
                  </div>
                )}
              </div>

              {/* Quadrant Progression */}
              <QuadrantProgression ticker={tickerData} flags={flags} />

              {/* Action Description */}
              <div className={`mb-4 p-4 rounded-lg border ${actionInfo.bg} border-current/30`}>
                <div className={`text-lg font-bold mb-2 ${actionInfo.color}`}>{actionInfo.action}</div>
                <div className="text-sm text-[#93a4d6]">{actionInfo.description}</div>
              </div>

              {/* Quadrant Progression */}
              <QuadrantProgression ticker={tickerData} flags={flags} />

              {/* Phase indicator */}
              <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-[#93a4d6]">Phase</span>
                  <span className="text-sm font-semibold" style={{ color: phaseColor }}>
                    {(phase * 100).toFixed(2)}%
                  </span>
                </div>
                <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                  <div className="h-full rounded-full transition-all duration-500" style={{ width: `${phase * 100}%`, backgroundColor: phaseColor }} />
                </div>
              </div>

              {/* Score and Ranking */}
              <div className="space-y-2.5 text-sm mb-4">
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Score</span>
                  <span className="font-semibold text-blue-400 text-lg">{baseScore}</span>
                </div>
                {rankTotal > 0 && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Rank</span>
                    <span className="font-semibold">
                      {rankPosition > 0 ? `#${rankPosition} of ${rankTotal}` : "—"}
                    </span>
                  </div>
                )}
                {dynamicRank !== baseScore && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Dynamic Score</span>
                    <span className="font-semibold text-green-400">{dynamicRank}</span>
                  </div>
                )}
                {isInTop40 && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Top 40 Position</span>
                    <span className="font-semibold text-yellow-400">#{rankPosition} of 40</span>
                  </div>
                )}

                {/* Score Breakdown */}
                {(() => {
                  const breakdown = calculateScoreBreakdown(tickerData);
                  const breakdownComponents = [
                    { label: "Base Score", value: breakdown.base, color: "text-blue-400" },
                    breakdown.aligned > 0 ? { label: "Aligned State", value: `+${breakdown.aligned}`, color: "text-green-400" } : null,
                    breakdown.setup > 0 ? { label: "Setup State", value: `+${breakdown.setup}`, color: "text-green-400" } : null,
                    breakdown.htf > 0 ? { label: "HTF Score", value: `+${breakdown.htf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.ltf > 0 ? { label: "LTF Score", value: `+${breakdown.ltf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.completion > 0 ? { label: "Completion Bonus", value: `+${breakdown.completion}`, color: "text-yellow-400" } : null,
                    breakdown.phase !== 0 ? {
                      label: "Phase",
                      value: breakdown.phase > 0 ? `+${breakdown.phase.toFixed(2)}` : breakdown.phase.toFixed(2),
                      color: breakdown.phase > 0 ? "text-green-400" : "text-red-400"
                    } : null,
                    breakdown.squeezeRelease > 0 ? { label: "Squeeze Release", value: `+${breakdown.squeezeRelease}`, color: "text-purple-400" } : null,
                    breakdown.squeezeOn > 0 ? { label: "Squeeze On", value: `+${breakdown.squeezeOn}`, color: "text-yellow-400" } : null,
                    breakdown.phaseZoneChange > 0 ? { label: "Phase Zone Change", value: `+${breakdown.phaseZoneChange}`, color: "text-blue-400" } : null,
                    breakdown.rr > 0 ? { label: "Risk/Reward", value: `+${breakdown.rr}`, color: "text-green-400" } : null,
                    breakdown.momentumElite > 0 ? { label: "Momentum Elite", value: `+${breakdown.momentumElite}`, color: "text-purple-400" } : null,
                  ].filter(Boolean);

                  return breakdownComponents.length > 0 ? (
                    <div className="border-t border-[#26325f] my-3 pt-3">
                      <div className="text-xs text-[#93a4d6] mb-3 font-semibold">Score Breakdown</div>
                      <div className="space-y-1.5">
                        {breakdownComponents.map((comp, idx) => (
                          <div key={idx} className="flex justify-between items-center text-xs">
                            <span className="text-[#93a4d6]">{comp.label}</span>
                            <span className={`font-semibold ${comp.color}`}>{comp.value}</span>
                          </div>
                        ))}
                        <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t border-[#26325f]">
                          <span className="text-[#93a4d6] font-semibold">Total Score</span>
                          <span className="text-blue-400 font-bold text-base">{Math.round(breakdown.total)}</span>
                        </div>
                      </div>
                    </div>
                  ) : null;
                })()}

                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">RR</span>
                  <span className="font-semibold">{tickerData.rr ? Number(tickerData.rr).toFixed(2) : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">State</span>
                  <span className="font-semibold">{tickerData.state || "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">HTF Score</span>
                  <span className="font-semibold">{tickerData.htf_score != null ? Number(tickerData.htf_score).toFixed(2) : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">LTF Score</span>
                  <span className="font-semibold">{tickerData.ltf_score != null ? Number(tickerData.ltf_score).toFixed(2) : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Completion</span>
                  <span className="font-semibold">{tickerData.completion != null ? `${(Number(tickerData.completion) * 100).toFixed(2)}%` : "—"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Price</span>
                  <span className="font-semibold">${tickerData.price ? Number(tickerData.price).toFixed(2) : "—"}</span>
                </div>
              </div>

              {/* Fundamental & Valuation Metrics */}
              {tickerData.fundamentals && (() => {
                const fund = tickerData.fundamentals;
                const hasValuationData = fund.pe_ratio !== null || fund.peg_ratio !== null || fund.eps_growth_rate !== null;
                
                if (!hasValuationData) return null;

                const valuationSignal = fund.valuation_signal || "fair";
                const signalColor = valuationSignal === "undervalued" ? "text-green-400" : 
                                   valuationSignal === "overvalued" ? "text-red-400" : "text-yellow-400";
                const signalBg = valuationSignal === "undervalued" ? "bg-green-500/20 border-green-500/50" : 
                                valuationSignal === "overvalued" ? "bg-red-500/20 border-red-500/50" : 
                                "bg-yellow-500/20 border-yellow-500/50";

                return (
                  <div className="mt-6 pt-6 border-t-2 border-[#26325f]">
                    <div className="text-sm font-bold text-[#93a4d6] mb-4">📊 Fundamental & Valuation</div>
                    
                    {/* Valuation Signal Badge */}
                    {fund.valuation_signal && (
                      <div className={`mb-4 p-3 rounded-lg border-2 ${signalBg}`}>
                        <div className="flex items-center justify-between">
                          <span className="text-xs text-[#93a4d6]">Valuation Signal</span>
                          <span className={`font-bold text-sm ${signalColor}`}>
                            {fund.valuation_signal.toUpperCase()}
                          </span>
                        </div>
                        {fund.valuation_confidence && (
                          <div className="text-xs text-[#93a4d6] mt-1">
                            Confidence: <span className="font-semibold">{fund.valuation_confidence}</span>
                          </div>
                        )}
                        {fund.valuation_reasons && fund.valuation_reasons.length > 0 && (
                          <div className="mt-2 pt-2 border-t border-current/30">
                            <div className="text-[10px] text-[#93a4d6] mb-1">Reasons:</div>
                            {fund.valuation_reasons.map((reason, idx) => (
                              <div key={idx} className="text-[10px] text-[#93a4d6]/80 mb-0.5">• {reason}</div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Basic Metrics */}
                    <div className="space-y-2 text-sm mb-4">
                      {fund.pe_ratio !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">P/E Ratio</span>
                          <span className="font-semibold">{Number(fund.pe_ratio).toFixed(2)}</span>
                        </div>
                      )}
                      {fund.peg_ratio !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">PEG Ratio</span>
                          <span className={`font-semibold ${
                            fund.peg_ratio < 0.8 ? "text-green-400" : 
                            fund.peg_ratio < 1.0 ? "text-yellow-400" : 
                            fund.peg_ratio > 1.5 ? "text-red-400" : "text-[#93a4d6]"
                          }`}>
                            {Number(fund.peg_ratio).toFixed(2)}
                          </span>
                        </div>
                      )}
                      {fund.eps !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">EPS (TTM)</span>
                          <span className="font-semibold">${Number(fund.eps).toFixed(2)}</span>
                        </div>
                      )}
                      {fund.eps_growth_rate !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">EPS Growth (Annual)</span>
                          <span className={`font-semibold ${
                            fund.eps_growth_rate > 20 ? "text-green-400" : 
                            fund.eps_growth_rate > 10 ? "text-yellow-400" : 
                            fund.eps_growth_rate > 0 ? "text-[#93a4d6]" : "text-red-400"
                          }`}>
                            {Number(fund.eps_growth_rate).toFixed(1)}%
                          </span>
                        </div>
                      )}
                      {fund.market_cap !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">Market Cap</span>
                          <span className="font-semibold">
                            {fund.market_cap >= 1e12 ? `$${(fund.market_cap / 1e12).toFixed(2)}T` :
                             fund.market_cap >= 1e9 ? `$${(fund.market_cap / 1e9).toFixed(2)}B` :
                             fund.market_cap >= 1e6 ? `$${(fund.market_cap / 1e6).toFixed(2)}M` :
                             `$${fund.market_cap.toLocaleString()}`}
                          </span>
                        </div>
                      )}
                      {fund.industry && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">Industry</span>
                          <span className="font-semibold text-xs">{fund.industry}</span>
                        </div>
                      )}
                    </div>

                    {/* Fair Value */}
                    {fund.fair_value_price !== null && fund.fair_value_price > 0 && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-2">Fair Value</div>
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm text-[#93a4d6]">Fair Value Price</span>
                          <span className="font-bold text-lg text-blue-400">
                            ${Number(fund.fair_value_price).toFixed(2)}
                          </span>
                        </div>
                        {fund.premium_discount_pct !== null && (
                          <div className="flex items-center justify-between">
                            <span className="text-xs text-[#93a4d6]">Premium/Discount</span>
                            <span className={`font-semibold ${
                              fund.premium_discount_pct < -10 ? "text-green-400" : 
                              fund.premium_discount_pct < 0 ? "text-yellow-400" : 
                              fund.premium_discount_pct > 10 ? "text-red-400" : "text-[#93a4d6]"
                            }`}>
                              {fund.premium_discount_pct > 0 ? "+" : ""}{Number(fund.premium_discount_pct).toFixed(1)}%
                            </span>
                          </div>
                        )}
                        {fund.fair_value_pe && fund.fair_value_pe.preferred && (
                          <div className="mt-2 pt-2 border-t border-[#26325f] text-xs text-[#93a4d6]">
                            Fair P/E: <span className="font-semibold">{Number(fund.fair_value_pe.preferred).toFixed(2)}</span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Historical P/E Percentiles */}
                    {fund.pe_percentiles && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-2">Historical P/E Percentiles</div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          {fund.pe_percentiles.p10 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">10th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p10).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p25 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">25th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p25).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p50 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">50th (Median):</span>
                              <span className="font-semibold text-blue-400">{Number(fund.pe_percentiles.p50).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p75 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">75th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p75).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p90 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">90th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p90).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.avg !== null && (
                            <div className="flex justify-between col-span-2 pt-1 border-t border-[#26325f]">
                              <span className="text-[#93a4d6]">Average:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.avg).toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                        {fund.pe_percentile_position && (
                          <div className="mt-2 pt-2 border-t border-[#26325f] text-xs">
                            <span className="text-[#93a4d6]">Current Position: </span>
                            <span className={`font-semibold ${
                              fund.pe_percentile_position.includes("Bottom") ? "text-green-400" : 
                              fund.pe_percentile_position.includes("Top") ? "text-red-400" : "text-[#93a4d6]"
                            }`}>
                              {fund.pe_percentile_position}
                            </span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Valuation Boost in Rank */}
                    {tickerData.rank_components && tickerData.rank_components.valuation_boost !== undefined && tickerData.rank_components.valuation_boost !== 0 && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-1">Rank Components</div>
                        <div className="flex justify-between items-center text-xs">
                          <span className="text-[#93a4d6]">Base Rank</span>
                          <span className="font-semibold">{tickerData.rank_components.base_rank || baseScore}</span>
                        </div>
                        <div className="flex justify-between items-center text-xs mt-1">
                          <span className="text-[#93a4d6]">Valuation Boost</span>
                          <span className={`font-semibold ${
                            tickerData.rank_components.valuation_boost > 0 ? "text-green-400" : "text-red-400"
                          }`}>
                            {tickerData.rank_components.valuation_boost > 0 ? "+" : ""}{tickerData.rank_components.valuation_boost}
                          </span>
                        </div>
                        <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t border-[#26325f]">
                          <span className="text-[#93a4d6] font-semibold">Final Rank</span>
                          <span className="font-bold text-blue-400">{baseScore}</span>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}
              </div>
            </div>

            {/* Fixed Footer */}
            <div className="flex-shrink-0 p-6 pt-4 border-t border-[#26325f] bg-[#121a33]">
              <a
                href={`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(tickerSymbol)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="block w-full text-center px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-all hover:scale-105 font-semibold"
              >
                📊 Open in TradingView
              </a>
            </div>
          </div>
        );
      }

      function TradeRow({ trade, tickerData, onTickerClick, onTradeClick }) {
        const pnlColor = trade.pnl >= 0 ? "text-green-400" : "text-red-400";
        const statusColor =
          trade.status === "WIN"
            ? "text-green-400"
            : trade.status === "LOSS"
            ? "text-red-400"
            : trade.status === "TP_HIT_TRIM"
            ? "text-blue-400"
            : "text-yellow-400";

        // Determine if this is a futures contract
        const tickerSymbol = String(trade.ticker || "").toUpperCase();
        const isFutures = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        const pointValue = isFutures && FUTURES_SPECS[tickerSymbol] ? FUTURES_SPECS[tickerSymbol].pointValue : 1;
        
        // Metrics derived from latest ticker data (preferred) or trade data
        const metricsSource = tickerData || trade;
        const horizon = computeHorizonBucket(metricsSource);
        const eta = computeEtaDays(metricsSource);
        const retPct = computeReturnPct(metricsSource);
        const riskPct = computeRiskPct(metricsSource);
        const tpTarget = computeTpTargetPrice(metricsSource);
        const avgCorr = Number(metricsSource?.avg_corr);
        const diversity = Number(metricsSource?.diversity_score);
        const exitPrice = Number(trade.exitPrice ?? trade.exit_price);
        const trimPrice = Number(trade.trimPrice ?? trade.trim_price);

        // Calculate position values
        // For futures: shares = contracts (always 1), for stocks: calculate from TRADE_SIZE
        const shares = trade.shares || (isFutures && FUTURES_SPECS[tickerSymbol] ? 1 : TRADE_SIZE / (trade.entryPrice || 1));
        const currentPrice = trade.currentPrice || trade.entryPrice;
        
        // For futures: value calculation is different (contracts * point value * price)
        // For stocks: shares * price
        const marketValue = isFutures && FUTURES_SPECS[tickerSymbol] 
          ? shares * currentPrice * pointValue 
          : shares * currentPrice;
        const entryValue = isFutures && FUTURES_SPECS[tickerSymbol]
          ? shares * trade.entryPrice * pointValue
          : shares * trade.entryPrice;
        const trimmedPct = trade.trimmedPct || 0;
        const trimmedShares = shares * trimmedPct;
        const remainingShares = shares - trimmedShares;
        const trimmedValue = trimmedShares > 0 
          ? (isFutures && FUTURES_SPECS[tickerSymbol]
              ? trimmedShares * (trade.tp || currentPrice) * pointValue
              : trimmedShares * (trade.tp || currentPrice))
          : 0;
        const currentMarketValue = isFutures && FUTURES_SPECS[tickerSymbol]
          ? remainingShares * currentPrice * pointValue
          : remainingShares * currentPrice;

        // Recalculate P&L using correct futures logic (override stored value)
        // Note: trimmedPct is already declared above (line 1336)
        let recalculatedPnl = 0;
        let recalculatedPnlPct = 0;
        const priceDiff = currentPrice - trade.entryPrice;
        
        if (trade.direction === "LONG") {
          const hitTP = currentPrice >= trade.tp;
          const hitSL = currentPrice <= trade.sl;
          
          if (hitTP) {
            if (trimmedPct === 0) {
              // First TP hit - trim 50%
              const tpDiff = trade.tp - trade.entryPrice;
              recalculatedPnl = tpDiff * shares * pointValue * 0.5;
              recalculatedPnlPct = ((trade.tp - trade.entryPrice) / trade.entryPrice) * 100;
            } else {
              // Already trimmed - full exit at TP
              const tpDiff = trade.tp - trade.entryPrice;
              recalculatedPnl = tpDiff * shares * pointValue;
              recalculatedPnlPct = ((trade.tp - trade.entryPrice) / trade.entryPrice) * 100;
            }
          } else if (hitSL) {
            const slDiff = trade.sl - trade.entryPrice;
            recalculatedPnl = slDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.sl - trade.entryPrice) / trade.entryPrice) * 100;
          } else {
            // Still open - calculate current P&L
            recalculatedPnl = priceDiff * shares * pointValue;
            recalculatedPnlPct = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;
          }
        } else {
          // SHORT
          const hitTP = currentPrice <= trade.tp;
          const hitSL = currentPrice >= trade.sl;
          
          if (hitTP) {
            if (trimmedPct === 0) {
              // First TP hit - trim 50%
              const tpDiff = trade.entryPrice - trade.tp;
              recalculatedPnl = tpDiff * shares * pointValue * 0.5;
              recalculatedPnlPct = ((trade.entryPrice - trade.tp) / trade.entryPrice) * 100;
            } else {
              // Already trimmed - full exit at TP
              const tpDiff = trade.entryPrice - trade.tp;
              recalculatedPnl = tpDiff * shares * pointValue;
              recalculatedPnlPct = ((trade.entryPrice - trade.tp) / trade.entryPrice) * 100;
            }
          } else if (hitSL) {
            const slDiff = trade.entryPrice - trade.sl;
            recalculatedPnl = slDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.entryPrice - trade.sl) / trade.entryPrice) * 100;
          } else {
            // Still open - calculate current P&L
            const shortPriceDiff = trade.entryPrice - currentPrice;
            recalculatedPnl = shortPriceDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.entryPrice - currentPrice) / trade.entryPrice) * 100;
          }
        }

        // Parse entryTime - now uses current time when trade was created (not trigger_ts)
        const entryDate = new Date(trade.entryTime);
        const formattedDate = entryDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        const formattedTime = entryDate.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit', 
          hour12: true 
        });

        return (
          <tr 
            className="border-b border-[#26325f] hover:bg-[#1a2550] cursor-pointer transition-colors"
            onClick={() => {
              if (onTradeClick) onTradeClick(trade);
              else if (onTickerClick) onTickerClick(trade.ticker);
            }}
          >
            <td className="p-2 text-sm">{trade.ticker}</td>
            <td className="p-2 text-sm">
              <span
                className={`px-2 py-1 rounded text-xs ${
                  trade.direction === "LONG"
                    ? "bg-green-500/20 text-green-400"
                    : "bg-red-500/20 text-red-400"
                }`}
              >
                {trade.direction}
              </span>
            </td>
            <td className="p-2 text-sm">${trade.entryPrice.toFixed(2)}</td>
            <td className="p-2 text-sm">${currentPrice.toFixed(2)}</td>
            <td className="p-2 text-xs text-[#93a4d6]">
              <div className="font-semibold text-white">{formattedDate}</div>
              <div className="text-[#6b7a9f]">{formattedTime}</div>
            </td>
            <td className="p-2 text-sm font-mono">
              {isFutures && FUTURES_SPECS[tickerSymbol] ? (
                <>
                  <div className="text-xs text-[#93a4d6]">Total: {shares.toFixed(0)} contract{shares !== 1 ? 's' : ''}</div>
                  {trimmedShares > 0 && (
                    <div className="text-xs text-blue-400">Remaining: {remainingShares.toFixed(2)} contract{remainingShares !== 1 ? 's' : ''}</div>
                  )}
                </>
              ) : (
                <>
                  <div className="text-xs text-[#93a4d6]">Total: {shares.toFixed(4)}</div>
                  {trimmedShares > 0 && (
                    <div className="text-xs text-blue-400">Remaining: {remainingShares.toFixed(4)}</div>
                  )}
                </>
              )}
            </td>
            <td className="p-2 text-sm">
              <div className="text-xs text-[#93a4d6]">Entry: ${entryValue.toFixed(2)}</div>
              <div className={`font-semibold ${trade.status === "OPEN" || trade.status === "TP_HIT_TRIM" ? "text-yellow-400" : ""}`}>
                Current: ${currentMarketValue.toFixed(2)}
              </div>
            </td>
            <td className="p-2 text-sm">
              {trimmedShares > 0 ? (
                <div className="text-xs text-blue-400">
                  <div>${trimmedValue.toFixed(2)}</div>
                  <div className="text-[#93a4d6]">({(trimmedPct * 100).toFixed(0)}%)</div>
                </div>
              ) : (
                <span className="text-xs text-[#6b7a9f]">-</span>
              )}
            </td>
            <td className="p-2 text-sm">${trade.sl.toFixed(2)}</td>
            <td
              className="p-2 text-sm"
              title={tpList ? `TP Levels: ${tpList}` : ""}
            >
              ${Number.isFinite(tpTarget) ? tpTarget.toFixed(2) : trade.tp.toFixed(2)}
            </td>
            <td className="p-2 text-sm text-green-400">
              {Number.isFinite(retPct) ? `${retPct.toFixed(1)}%` : "—"}
            </td>
            <td className="p-2 text-sm text-red-400">
              {Number.isFinite(riskPct) ? `${riskPct.toFixed(1)}%` : "—"}
            </td>
            <td className="p-2 text-sm">
              {Number.isFinite(eta) ? `${eta.toFixed(1)}d` : "—"}
            </td>
            <td className="p-2 text-xs text-[#93a4d6]">{horizon}</td>
            <td className="p-2 text-sm text-[#93a4d6]">
              {Number.isFinite(diversity) ? Math.round(diversity) : "—"}
            </td>
            <td className="p-2 text-sm text-[#93a4d6]">
              {Number.isFinite(avgCorr) ? avgCorr.toFixed(2) : "—"}
            </td>
            <td className="p-2 text-sm">{formatRR(trade.rr)}</td>
            <td className="p-2 text-sm">{trade.rank}</td>
            <td className={`p-2 text-sm font-semibold ${recalculatedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
              ${recalculatedPnl.toFixed(2)}
            </td>
            <td className={`p-2 text-sm font-semibold ${recalculatedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
              {recalculatedPnlPct.toFixed(2)}%
            </td>
            <td className={`p-2 text-sm font-semibold ${statusColor}`}>
              <div>
                {trade.status === "TP_HIT_TRIM"
                  ? `TRIMMED (${((trade.trimmedPct || 0) * 100).toFixed(0)}%)`
                  : trade.status || "OPEN"}
              </div>
              {trade.status === "TP_HIT_TRIM" && Number.isFinite(trimPrice) && (
                <div className="text-[10px] text-yellow-300">
                  Trim @ ${trimPrice.toFixed(2)}
                </div>
              )}
              {(trade.status === "WIN" || trade.status === "LOSS") &&
                Number.isFinite(exitPrice) && (
                  <div className="text-[10px] text-purple-300">
                    Exit @ ${exitPrice.toFixed(2)}
                  </div>
                )}
            </td>
            <td className="p-2 text-xs text-[#93a4d6] font-mono">
              {trade.scriptVersion || "unknown"}
            </td>
          </tr>
        );
      }

      function AnalyticsPanel({ analytics }) {
        return (
          <div className="space-y-4">
            {/* Overall Stats */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Overall Performance</h3>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                <div>
                  <div className="text-xs text-[#93a4d6]">Total Trades</div>
                  <div className="text-2xl font-bold">{analytics.totalTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Open Trades</div>
                  <div className="text-2xl font-bold text-yellow-400">{analytics.openTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Trimmed Trades</div>
                  <div className="text-2xl font-bold text-blue-400">{analytics.trimmedTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Closed Trades</div>
                  <div className="text-2xl font-bold text-white">{analytics.closedTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Win Rate</div>
                  <div className="text-2xl font-bold text-green-400">
                    {analytics.winRate.toFixed(1)}%
                  </div>
                </div>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-2 gap-4 pt-4 border-t border-[#26325f]">
                <div>
                  <div className="text-xs text-[#93a4d6]">Closed P&L</div>
                  <div
                    className={`text-2xl font-bold ${
                      analytics.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                    }`}
                  >
                    ${analytics.totalPnl.toFixed(2)}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Open P&L</div>
                  <div
                    className={`text-2xl font-bold ${
                      analytics.openPnl >= 0 ? "text-green-400" : "text-yellow-400"
                    }`}
                  >
                    ${analytics.openPnl.toFixed(2)}
                  </div>
                </div>
              </div>
              {analytics.totalTrades > 0 && (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 pt-4 border-t border-[#26325f]">
                  <div>
                    <div className="text-xs text-[#93a4d6]">Avg Win</div>
                    <div className="text-lg font-bold text-green-400">
                      ${analytics.avgWin.toFixed(2)}
                    </div>
                  </div>
                  <div>
                    <div className="text-xs text-[#93a4d6]">Avg Loss</div>
                    <div className="text-lg font-bold text-red-400">
                      ${analytics.avgLoss.toFixed(2)}
                    </div>
                  </div>
                  <div>
                    <div className="text-xs text-[#93a4d6]">Profit Factor</div>
                    <div
                      className={`text-lg font-bold ${
                        analytics.profitFactor >= 1.5
                          ? "text-green-400"
                          : analytics.profitFactor >= 1.0
                          ? "text-yellow-400"
                          : "text-red-400"
                      }`}
                    >
                      {analytics.profitFactor.toFixed(2)}
                    </div>
                  </div>
                </div>
              )}
            </div>

            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Excursion & Capture</h3>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div>
                  <div className="text-xs text-[#93a4d6]">Avg MFE %</div>
                  <div className="text-lg font-bold text-green-400">
                    {analytics.avgMfePct.toFixed(1)}%
                  </div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Avg MAE %</div>
                  <div className="text-lg font-bold text-red-400">
                    {analytics.avgMaePct.toFixed(1)}%
                  </div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Avg Captured %</div>
                  <div className="text-lg font-bold text-blue-400">
                    {analytics.avgCapturedPct.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>

            {analytics.horizonStats && (
              <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                <h3 className="text-lg font-bold mb-4">Horizon Performance</h3>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead>
                      <tr className="border-b border-[#26325f] text-left text-xs text-[#93a4d6]">
                        <th className="p-2">Horizon</th>
                        <th className="p-2">Trades</th>
                        <th className="p-2">Win %</th>
                        <th className="p-2">Expectancy</th>
                        <th className="p-2">MFE %</th>
                        <th className="p-2">MAE %</th>
                        <th className="p-2">Captured %</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(analytics.horizonStats).map(([key, s]) => (
                        <tr key={key} className="border-b border-[#26325f]/50">
                          <td className="p-2 text-xs text-[#93a4d6]">
                            {String(key).replace("_", " ")}
                          </td>
                          <td className="p-2">{s.n}</td>
                          <td className="p-2">{s.winRate.toFixed(1)}%</td>
                          <td className="p-2">
                            {Number.isFinite(s.expectancy)
                              ? `$${s.expectancy.toFixed(2)}`
                              : "—"}
                          </td>
                          <td className="p-2">{s.avgMfePct.toFixed(1)}%</td>
                          <td className="p-2">{s.avgMaePct.toFixed(1)}%</td>
                          <td className="p-2">{s.avgCapturedPct.toFixed(1)}%</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Self-Learning Recommendations */}
            {(() => {
              const recs = analytics.recommendations || {};
              const filterRecs = Array.isArray(recs.filters) ? recs.filters : [];
              const mgmtRecs = Array.isArray(recs.management) ? recs.management : [];
              const hasAny = filterRecs.length + mgmtRecs.length > 0;
              if (!hasAny) return null;

              const renderRec = (rec, idx) => (
                <div
                  key={idx}
                  className={`p-3 rounded-lg border ${
                    rec.priority === "high"
                      ? "bg-yellow-500/10 border-yellow-500/30"
                      : "bg-blue-500/10 border-blue-500/30"
                  }`}
                >
                  <div className="flex items-start gap-2">
                    <span className="text-lg">{rec.priority === "high" ? "⚠️" : "💡"}</span>
                    <div className="flex-1">
                      <div className="text-sm font-semibold">{rec.message}</div>
                    </div>
                  </div>
                </div>
              );

              return (
                <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                  <h3 className="text-lg font-bold mb-4">🎓 Self-Learning Recommendations</h3>

                  {filterRecs.length > 0 && (
                    <div className="mb-4">
                      <div className="text-xs text-[#93a4d6] font-semibold mb-2">
                        Filters (before entry)
                      </div>
                      <div className="space-y-2">
                        {filterRecs.map(renderRec)}
                      </div>
                    </div>
                  )}

                  {mgmtRecs.length > 0 && (
                    <div>
                      <div className="text-xs text-[#93a4d6] font-semibold mb-2">
                        Management (after entry)
                      </div>
                      <div className="space-y-2">
                        {mgmtRecs.map(renderRec)}
                      </div>
                    </div>
                  )}
                </div>
              );
            })()}

            {/* Signal Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Signal Performance</h3>
              <div className="space-y-2 max-h-[300px] overflow-y-auto">
                {Object.entries(analytics.signalAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([signals, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={signals}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">
                            {signals || "No Signals"}
                          </div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>

            {/* RR Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Risk/Reward Performance</h3>
              <div className="space-y-2">
                {Object.entries(analytics.rrAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([range, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={range}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">{range}</div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>

            {/* Rank Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Rank Performance</h3>
              <div className="space-y-2">
                {Object.entries(analytics.rankAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([range, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={range}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">{range}</div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        );
      }

      function KpiCard({ label, value, sub = null, tone = "neutral" }) {
        const toneBar =
          tone === "green"
            ? "from-green-400 to-emerald-500"
            : tone === "red"
            ? "from-red-400 to-rose-500"
            : tone === "yellow"
            ? "from-yellow-300 to-amber-500"
            : tone === "blue"
            ? "from-blue-400 to-cyan-400"
            : "from-[#6b7a9f] to-[#26325f]";

        return (
          <div className="relative bg-[#0f1630] border border-[#26325f] rounded-xl p-3 overflow-hidden">
            <div className={`absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b ${toneBar}`} />
            <div className="pl-2">
              <div className="text-[11px] uppercase tracking-wide text-[#93a4d6]">{label}</div>
              <div className="mt-1 text-lg font-bold text-white leading-tight">{value}</div>
              {sub ? <div className="mt-1 text-[11px] text-[#6b7a9f]">{sub}</div> : null}
            </div>
          </div>
        );
      }

      function PerformanceDashboard({ mode, ledgerSummary, analytics }) {
        const isLedger = mode === "ledger";

        const loading = isLedger ? !!ledgerSummary?.loading : false;
        const err = isLedger ? ledgerSummary?.error : null;
        const t = isLedger ? ledgerSummary?.data?.totals : null;

        const totalTrades = isLedger ? Number(t?.totalTrades || 0) : Number(analytics?.totalTrades || 0);
        const openTrades = isLedger ? Number(t?.openTrades || 0) : Number(analytics?.openTrades || 0);
        const trimmedTrades = isLedger ? 0 : Number(analytics?.trimmedTrades || 0);
        const closedTrades = isLedger ? Number(t?.closedTrades || 0) : Number(analytics?.closedTrades || 0);
        const wins = isLedger ? Number(t?.wins || 0) : Number(analytics?.wins || 0);
        const losses = isLedger ? Number(t?.losses || 0) : Number(analytics?.losses || 0);
        const winRate = isLedger ? Number(t?.winRate || 0) : Number(analytics?.winRate || 0);

        const closedPnl = isLedger ? Number(t?.closedPnl || 0) : Number(analytics?.totalPnl || 0);
        const openPnl = !isLedger ? Number(analytics?.openPnl || 0) : null;

        const avgWin = isLedger ? Number(t?.avgWin || 0) : Number(analytics?.avgWin || 0);
        const avgLoss = isLedger ? Number(t?.avgLoss || 0) : Number(analytics?.avgLoss || 0);
        const profitFactor = isLedger ? Number(t?.profitFactor || 0) : Number(analytics?.profitFactor || 0);
        const expectancy = isLedger
          ? Number(t?.expectancy || 0)
          : closedTrades > 0
          ? closedPnl / closedTrades
          : 0;

        const openCapitalTrades = isLedger ? openTrades : openTrades + trimmedTrades;
        const openCapital = openCapitalTrades * TRADE_SIZE;
        const totalCapital = totalTrades * TRADE_SIZE;

        const pfLabel =
          Number.isFinite(profitFactor) && profitFactor !== Infinity ? profitFactor.toFixed(2) : "∞";

        const cards = [
          { label: "Total Trades", value: fmtInt(totalTrades) },
          {
            label: "Open Trades",
            value: fmtInt(openTrades),
            sub: isLedger ? "status ≠ WIN/LOSS" : "no trims yet",
            tone: "yellow",
          },
          ...(!isLedger
            ? [
                {
                  label: "Trimmed Trades",
                  value: fmtInt(trimmedTrades),
                  sub: "partial position left",
                  tone: "blue",
                },
              ]
            : []),
          { label: "Wins", value: fmtInt(wins), tone: "green" },
          { label: "Losses", value: fmtInt(losses), tone: "red" },
          {
            label: "Win Rate",
            value: `${Number.isFinite(winRate) ? winRate.toFixed(1) : "0.0"}%`,
            tone: winRate >= 55 ? "green" : winRate >= 45 ? "yellow" : "red",
          },
          {
            label: "Closed P&L",
            value: fmtUsd(closedPnl),
            sub: `${fmtInt(closedTrades)} closed`,
            tone: closedPnl >= 0 ? "green" : "red",
          },
          ...(!isLedger
            ? [
                {
                  label: "Open P&L",
                  value: fmtUsd(openPnl),
                  sub: "unrealized",
                  tone: (openPnl || 0) >= 0 ? "green" : "yellow",
                },
              ]
            : []),
          { label: "Avg Win", value: fmtUsd(avgWin), tone: "green" },
          { label: "Avg Loss", value: fmtUsd(avgLoss), tone: "red" },
          {
            label: "Profit Factor",
            value: pfLabel,
            sub: "gross wins / gross losses",
            tone: profitFactor >= 1.5 ? "green" : profitFactor >= 1.0 ? "yellow" : "red",
          },
          {
            label: "Expectancy",
            value: fmtUsd(expectancy),
            sub: "avg per closed trade",
            tone: expectancy >= 0 ? "green" : "red",
          },
          {
            label: "Open Capital",
            value: fmtUsd(openCapital),
            sub: `${fmtUsd(TRADE_SIZE)} model / trade`,
            tone: "blue",
          },
          {
            label: "Total Capital Deployed",
            value: fmtUsd(totalCapital),
            sub: "model allocation (lifetime)",
          },
        ];

        return (
          <div className="mb-6 bg-[#121a33] border border-[#26325f] rounded-xl p-4">
            <div className="flex items-center justify-between gap-3 flex-wrap mb-3">
              <div>
                <div className="text-xs text-[#93a4d6]">Dashboard</div>
                <div className="text-lg font-bold">
                  {isLedger ? "Ledger KPIs" : "Legacy KPIs"}
                </div>
              </div>
              <div className="text-xs text-[#6b7a9f]">
                {isLedger ? "Source: D1 ledger" : "Source: KV + live prices"}
              </div>
            </div>

            {loading ? (
              <div className="text-sm text-[#93a4d6]">Loading dashboard metrics…</div>
            ) : err ? (
              <div className="text-sm text-red-400">Dashboard unavailable: {err}</div>
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                {cards.map((c, idx) => (
                  <KpiCard
                    key={`${c.label}-${idx}`}
                    label={c.label}
                    value={c.value}
                    sub={c.sub || null}
                    tone={c.tone || "neutral"}
                  />
                ))}
              </div>
            )}
          </div>
        );
      }

      // ─────────────────────────────────────────────────────────────
      // Helper Functions for TickerDetails
      // ─────────────────────────────────────────────────────────────
      
      // Calculate score breakdown (mirrors worker computeRank logic)
      function calculateScoreBreakdown(ticker) {
        const htf = Number(ticker.htf_score) || 0;
        const ltf = Number(ticker.ltf_score) || 0;
        const comp = Number(ticker.completion) || 0;
        const phase = Number(ticker.phase_pct) || 0;
        const rr = ticker.rr != null ? Number(ticker.rr) : 0;
        
        const flags = ticker.flags || {};
        const sqRel = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        const phaseZoneChange = !!flags.phase_zone_change;
        const momentumElite = !!flags.momentum_elite;
        
        const state = String(ticker.state || "");
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const setup = state === "HTF_BULL_LTF_PULLBACK" || state === "HTF_BEAR_LTF_PULLBACK";
        
        const breakdown = {
          base: 30,
          aligned: aligned ? 12 : 0,
          setup: setup ? 4 : 0,
          htf: 0,
          ltf: 0,
          completion: 0,
          phase: 0,
          squeezeRelease: sqRel ? 12 : 0,
          squeezeOn: (sqOn && !sqRel) ? 4 : 0,
          phaseZoneChange: phaseZoneChange ? 2 : 0,
          rr: 0,
          momentumElite: momentumElite ? 15 : 0,
        };
        
        // HTF contribution
        if (Number.isFinite(htf)) {
          const htfAbs = Math.abs(htf);
          if (htfAbs >= 25) breakdown.htf = Math.min(10, htfAbs * 0.4);
          else if (htfAbs >= 15) breakdown.htf = Math.min(7, htfAbs * 0.35);
          else breakdown.htf = Math.min(4, htfAbs * 0.25);
        }
        
        // LTF contribution
        if (Number.isFinite(ltf)) {
          const ltfAbs = Math.abs(ltf);
          if (ltfAbs >= 20) breakdown.ltf = Math.min(10, ltfAbs * 0.3);
          else if (ltfAbs >= 12) breakdown.ltf = Math.min(6, ltfAbs * 0.25);
          else breakdown.ltf = Math.min(3, ltfAbs * 0.2);
        }
        
        // Completion bonus
        if (Number.isFinite(comp)) {
          if (comp <= 0.2) breakdown.completion = 15;
          else if (comp <= 0.4) breakdown.completion = 10;
          else if (comp <= 0.6) breakdown.completion = 5;
        }
        
        // Phase penalty/bonus
        if (Number.isFinite(phase)) {
          if (phase > 0.5) breakdown.phase = -Math.max(0, (phase - 0.5) * 30);
          if (phase <= 0.3) breakdown.phase = 3;
        }
        
        // RR contribution
        if (Number.isFinite(rr)) {
          if (rr >= 2.0) breakdown.rr = 10;
          else if (rr >= 1.5) breakdown.rr = 7;
          else if (rr >= 1.2) breakdown.rr = 4;
        }
        
        breakdown.total = Math.max(0, Math.min(100, 
          breakdown.base +
          breakdown.aligned +
          breakdown.setup +
          breakdown.htf +
          breakdown.ltf +
          breakdown.completion +
          breakdown.phase +
          breakdown.squeezeRelease +
          breakdown.squeezeOn +
          breakdown.phaseZoneChange +
          breakdown.rr +
          breakdown.momentumElite
        ));
        
        return breakdown;
      }
      
      function phaseToColor(phase) {
        const p = Math.max(0, Math.min(1, phase));
        if (p < 0.2) {
          const t = p / 0.2;
          return `rgb(${Math.round(46 + (39 - 46) * t)}, ${Math.round(204 + (174 - 204) * t)}, ${Math.round(113 + (96 - 113) * t)})`;
        } else if (p < 0.4) {
          const t = (p - 0.2) / 0.2;
          return `rgb(${Math.round(39 + (243 - 39) * t)}, ${Math.round(174 + (156 - 174) * t)}, ${Math.round(96 + (18 - 96) * t)})`;
        } else if (p < 0.6) {
          const t = (p - 0.4) / 0.2;
          return `rgb(${Math.round(243 + (230 - 243) * t)}, ${Math.round(156 + (126 - 156) * t)}, ${Math.round(18 + (34 - 18) * t)})`;
        } else if (p < 0.8) {
          const t = (p - 0.6) / 0.2;
          return `rgb(${Math.round(230 + (231 - 230) * t)}, ${Math.round(126 + (76 - 126) * t)}, ${Math.round(34 + (60 - 34) * t)})`;
        } else {
          const t = (p - 0.8) / 0.2;
          return `rgb(${Math.round(231 + (192 - 231) * t)}, ${Math.round(76 + (57 - 76) * t)}, ${Math.round(60 + (43 - 60) * t)})`;
        }
      }

      function isPrimeBubble(ticker) {
        const rank = Number(ticker.rank || 0);
        const rr = ticker.rr != null ? Number(ticker.rr) : 0;
        const comp = ticker.completion != null ? Number(ticker.completion) : 1;
        const phase = ticker.phase_pct != null ? Number(ticker.phase_pct) : 1;
        const flags = ticker.flags || {};
        const sqRel = !!flags.sq30_release;
        const phaseZoneChange = !!flags.phase_zone_change;
        const state = String(ticker.state || "");
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        return rank >= 75 && rr >= 1.5 && comp < 0.4 && phase < 0.6 && (aligned || sqRel || phaseZoneChange);
      }

      function completionForSize(ticker) {
        const c = Number(ticker.completion);
        return Number.isFinite(c) ? Math.max(0, Math.min(1, c)) : 0;
      }

      function computeDynamicRank(ticker) {
        const baseRank = Number(ticker.rank) || 50;
        const htf = Number(ticker.htf_score) || 0;
        const ltf = Number(ticker.ltf_score) || 0;
        const comp = completionForSize(ticker);
        const phase = Number(ticker.phase_pct) || 0;
        const rr = Number(ticker.rr) || 0;
        const flags = ticker.flags || {};
        const state = String(ticker.state || "");
        const sqRel = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        const phaseZoneChange = !!flags.phase_zone_change;
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const ent = entryType(ticker);
        const inCorridor = ent.corridor;
        let dynamicScore = baseRank;
        if (inCorridor) {
          dynamicScore += 12;
          if (aligned) dynamicScore += 8;
        }
        if (sqRel && inCorridor) dynamicScore += 10;
        if (sqOn && inCorridor && !sqRel) dynamicScore += 5;
        if (rr >= 2.0) dynamicScore += 8;
        else if (rr >= 1.5) dynamicScore += 5;
        else if (rr >= 1.0) dynamicScore += 2;
        if (phase < 0.3) dynamicScore += 6;
        else if (phase < 0.5) dynamicScore += 3;
        else if (phase > 0.7) dynamicScore -= 5;
        if (comp < 0.3) dynamicScore += 5;
        else if (comp > 0.8) dynamicScore -= 8;
        const htfStrength = Math.min(8, Math.abs(htf) * 0.15);
        const ltfStrength = Math.min(6, Math.abs(ltf) * 0.12);
        dynamicScore += htfStrength + ltfStrength;
        if (phaseZoneChange) dynamicScore += 4;
        return Math.max(0, Math.min(100, Math.round(dynamicScore)));
      }

      function toTickerArray(source) {
        if (!source) return [];
        if (Array.isArray(source)) {
          return source.filter((t) => t && typeof t === "object" && t.ticker);
        }
        if (typeof source === "object") {
          return Object.values(source).filter(
            (t) => t && typeof t === "object" && t.ticker
          );
        }
        return [];
      }

      function rankScoreForTicker(ticker) {
        const rankScore = Number(ticker?.rank_score);
        if (Number.isFinite(rankScore)) return rankScore;
        const dynamicRank = Number(ticker?.dynamicRank);
        if (Number.isFinite(dynamicRank)) return dynamicRank;
        const dynamicScore = Number(ticker?.dynamicScore);
        if (Number.isFinite(dynamicScore)) return dynamicScore;
        return Number(computeDynamicRank(ticker)) || 0;
      }

      function getRankedTickers(source) {
        const list = toTickerArray(source);
        const withScores = list.map((t) => ({
          ...t,
          __rankPos: Number(t?.rank_position),
          __rankScore: rankScoreForTicker(t),
        }));
        withScores.sort((a, b) => {
          const rankA = Number(a.__rankPos);
          const rankB = Number(b.__rankPos);
          const hasRankA = Number.isFinite(rankA) && rankA > 0;
          const hasRankB = Number.isFinite(rankB) && rankB > 0;
          if (hasRankA && hasRankB) return rankA - rankB;
          if (hasRankA) return -1;
          if (hasRankB) return 1;
          const scoreA = Number(a.__rankScore) || 0;
          const scoreB = Number(b.__rankScore) || 0;
          return scoreB - scoreA;
        });
        return withScores;
      }

      function getRankPositionFromMap(rankPositions, tickerSymbol) {
        if (!rankPositions) return null;
        const sym = String(tickerSymbol || "").trim().toUpperCase();
        if (!sym) return null;
        const pos = Number(rankPositions[sym]);
        return Number.isFinite(pos) && pos > 0 ? pos : null;
      }

      function downsampleByInterval(points, intervalMs) {
        if (!Array.isArray(points) || points.length === 0) return [];
        const buckets = new Map();
        points.forEach((p) => {
          const tsRaw = p.__ts_ms ?? p.ts ?? p.ingest_ts ?? p.ingest_time;
          const ts =
            typeof tsRaw === "string"
              ? new Date(tsRaw).getTime()
              : Number(tsRaw);
          if (!Number.isFinite(ts)) return;
          const bucket = Math.floor(ts / intervalMs) * intervalMs;
          const prev = buckets.get(bucket);
          if (!prev || ts > prev.__ts_ms) {
            buckets.set(bucket, { ...p, __ts_ms: ts, __bucket: bucket });
          }
        });
        return Array.from(buckets.values()).sort(
          (a, b) => a.__ts_ms - b.__ts_ms
        );
      }

      function getActionDescription(ticker) {
        const state = String(ticker.state || "");
        const phase = Number(ticker.phase_pct) || 0;
        const comp = completionForSize(ticker);
        const flags = ticker.flags || {};
        const ent = entryType(ticker);
        const rank = Number(ticker.rank || 0);
        const rr = Number(ticker.rr || 0);
        const momentumElite = !!flags.momentum_elite;
        const isAligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const isPullback = state === "HTF_BULL_LTF_PULLBACK" || state === "HTF_BEAR_LTF_PULLBACK";
        const isPrime = isPrimeBubble(ticker);
        const inCorridor = ent.corridor;
        const sqRelease = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        if (comp > 0.8) {
          return { action: "Prepare for Exit / Trim Position", description: `Position has reached ${(comp * 100).toFixed(0)}% completion. Consider taking profits or trimming 50-75% of position.`, color: "text-yellow-400", bg: "bg-yellow-500/20" };
        }
        if (phase > 0.7) {
          return { action: "Wait / Trim Existing Position", description: `Phase oscillator at ${(phase * 100).toFixed(0)}% indicates late-cycle conditions. Wait for pullback or trim existing positions.`, color: "text-orange-400", bg: "bg-orange-500/20" };
        }
        if (momentumElite && isPrime && inCorridor && rank >= 75 && rr >= 1.5) {
          return { action: "Initiate Position - High Conviction", description: `Momentum Elite stock showing Prime setup with exceptional alignment. High-probability setup with strong fundamentals.`, color: "text-green-400", bg: "bg-green-500/20" };
        }
        if (sqRelease && inCorridor && isAligned) {
          return { action: "Initiate Position - Squeeze Release", description: `Squeeze release detected with timeframe alignment in entry corridor. Enter on pullback or break.`, color: "text-green-400", bg: "bg-green-500/20" };
        }
        if (inCorridor && isAligned && comp < 0.5 && phase < 0.6) {
          return { action: "Consider Entry - Favorable Setup", description: `Setup is in entry corridor with both timeframes aligned. Early phase and low completion suggest room to run.`, color: "text-blue-400", bg: "bg-blue-500/20" };
        }
        return { action: "Wait - Setup Not Optimal", description: `Setup not yet optimal for entry. Wait for better conditions or confirmation signals.`, color: "text-[#93a4d6]", bg: "bg-[#26325f]" };
      }

      function getQuadrantFromState(state) {
        if (state === "HTF_BULL_LTF_PULLBACK") return { q: 1, name: "Q1", label: "Bull Setup", color: "blue" };
        if (state === "HTF_BULL_LTF_BULL") return { q: 2, name: "Q2", label: "Bull Momentum", color: "green" };
        if (state === "HTF_BEAR_LTF_BEAR") return { q: 3, name: "Q3", label: "Bear Momentum", color: "red" };
        if (state === "HTF_BEAR_LTF_PULLBACK") return { q: 4, name: "Q4", label: "Bear Setup", color: "orange" };
        return null;
      }

      function detectPatterns(trail, flags) {
        if (!trail || trail.length < 2) return [];
        const patterns = [];
        const states = trail.map(p => p.state).filter(Boolean);
        for (let i = 1; i < states.length; i++) {
          if (states[i-1] === "HTF_BULL_LTF_PULLBACK" && states[i] === "HTF_BULL_LTF_BULL") {
            patterns.push({ type: "IDEAL_ENTRY", description: "Clean Q1→Q2 transition (Bull Entry)", quadrant: "Q1→Q2", confidence: "HIGH" });
          }
          if (states[i-1] === "HTF_BEAR_LTF_PULLBACK" && states[i] === "HTF_BEAR_LTF_BEAR") {
            patterns.push({ type: "IDEAL_ENTRY", description: "Clean Q4→Q3 transition (Bear Entry)", quadrant: "Q4→Q3", confidence: "HIGH" });
          }
        }
        return patterns;
      }

      function QuadrantProgression({ ticker, flags }) {
        const [trail, setTrail] = useState([]);
        const [loading, setLoading] = useState(false);
        const [hasLoaded, setHasLoaded] = useState(false);
        useEffect(() => {
          if (!hasLoaded && ticker && ticker.ticker) {
            setLoading(true);
            const timeoutId = setTimeout(async () => {
              try {
                const res = await fetch(`${API_BASE}/timed/trail?ticker=${encodeURIComponent(ticker.ticker)}`);
                if (res.ok) {
                  const data = await res.json();
                  if (data.ok && Array.isArray(data.trail)) {
                    setTrail(data.trail);
                  }
                }
              } catch (e) {
                console.error("Failed to load trail:", e);
              } finally {
                setLoading(false);
                setHasLoaded(true);
              }
            }, 300);
            return () => clearTimeout(timeoutId);
          }
        }, [ticker?.ticker, hasLoaded]);
        const sampledTrail = useMemo(() => downsampleByInterval(trail, 15 * 60 * 1000), [trail]);
        const patterns = detectPatterns(sampledTrail, flags || {});
        const currentQuad = getQuadrantFromState(ticker.state);
        const quadHistory = sampledTrail.map(p => getQuadrantFromState(p.state)).filter(Boolean);
        return (
          <div className="mb-4 p-4 bg-[#0f1630] rounded-lg border border-[#26325f]">
            <div className="text-sm font-bold mb-3 text-[#93a4d6]">Quadrant Progression (15m increments)</div>
            <div className="grid grid-cols-2 gap-2 mb-4">
              {[1, 2, 4, 3].map(q => {
                const quad = q === 1 ? { q: 1, name: "Q1", label: "Bull Setup", color: "blue" } :
                             q === 2 ? { q: 2, name: "Q2", label: "Bull Momentum", color: "green" } :
                             q === 4 ? { q: 4, name: "Q4", label: "Bear Setup", color: "orange" } :
                             { q: 3, name: "Q3", label: "Bear Momentum", color: "red" };
                const isActive = currentQuad?.q === quad.q;
                const hasHistory = quadHistory.some(qh => qh && qh.q === quad.q);
                return (
                  <div key={q} className={`p-3 rounded-lg border-2 ${
                    isActive ? `border-${quad.color}-400 bg-${quad.color}-500/20` :
                    hasHistory ? `border-${quad.color}-500/50 bg-${quad.color}-500/10` :
                    "border-[#26325f] bg-[#0a0f1f]"
                  }`}>
                    <div className={`text-xs font-bold text-${quad.color}-400`}>{quad.name}: {quad.label}</div>
                  </div>
                );
              })}
            </div>
            {patterns.length > 0 && (
              <div className="mt-4 pt-4 border-t border-[#26325f]">
                <div className="text-xs font-bold text-yellow-400 mb-2">🎯 Detected Patterns</div>
                {patterns.map((pattern, idx) => (
                  <div key={idx} className="p-2 rounded border bg-yellow-500/20 border-yellow-400/50 mb-2">
                    <div className="text-xs font-bold text-white">{pattern.description}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      function TickerDetails({ ticker, onClose, allLoadedData = null }) {
        if (!ticker) return null;
        const prime = isPrimeBubble(ticker);
        const ent = entryType(ticker);
        const flags = ticker.flags || {};
        const phase = Number(ticker.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const actionInfo = getActionDescription(ticker);
        const allLoadedTickersArray = (() => {
          if (allLoadedData && typeof allLoadedData === 'object') {
            if (Array.isArray(allLoadedData)) return allLoadedData;
            return Object.values(allLoadedData).filter(t => t && typeof t === 'object' && t.ticker);
          }
          return [];
        })();
        const baseScore = Number(ticker.rank) || 0;
        const dynamicRank = computeDynamicRank(ticker);
        const allTickersWithRank = allLoadedTickersArray.map(t => ({ ...t, dynamicRank: computeDynamicRank(t) }));
        const sortedByDynamic = [...allTickersWithRank].sort((a, b) => b.dynamicRank - a.dynamicRank);
        const rankPosition = sortedByDynamic.findIndex(t => String(t.ticker || "").toUpperCase() === String(ticker.ticker || "").toUpperCase()) + 1;
        const totalTickers = allLoadedTickersArray.length;
        return (
          <div className="w-full h-full flex flex-col">
            <div className="bg-[#121a33] border-2 border-[#26325f] rounded-xl w-full h-full flex flex-col slide-in-right shadow-2xl">
              <div className="flex-1 overflow-y-auto p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold">{ticker.ticker}</h3>
                  <button onClick={onClose} className="text-[#93a4d6] hover:text-white transition-colors text-xl leading-none w-6 h-6 flex items-center justify-center rounded hover:bg-[#26325f]">✕</button>
                </div>
                {flags.momentum_elite && (
                  <div className="mb-4 p-3 bg-gradient-to-r from-purple-500/30 via-pink-500/30 to-purple-500/30 border-2 border-purple-400 rounded-lg">
                    <div className="text-center font-bold text-purple-300 mb-2">🚀 MOMENTUM ELITE 🚀</div>
                  </div>
                )}
                {prime && (
                  <div className="mb-4 p-3 bg-green-500/20 border-2 border-green-500 rounded-lg text-center font-bold text-green-500">⭐ PRIME SETUP ⭐</div>
                )}
                {(() => {
                  const dir = getDirection(ticker);
                  return (
                    <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                      <div className="text-sm text-[#93a4d6] mb-2">Bias / Direction</div>
                      <div className={`inline-block px-4 py-2 rounded-lg font-bold text-lg ${dir.bg} ${dir.color}`}>{dir.text === "LONG" ? "📈 LONG" : dir.text === "SHORT" ? "📉 SHORT" : dir.text}</div>
                    </div>
                  );
                })()}
                <div className={`mb-4 p-4 rounded-lg border ${actionInfo.bg} border-current/30`}>
                  <div className={`text-lg font-bold mb-2 ${actionInfo.color}`}>{actionInfo.action}</div>
                  <div className="text-sm text-[#93a4d6]">{actionInfo.description}</div>
                </div>
                <QuadrantProgression ticker={ticker} flags={flags} />
                <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-[#93a4d6]">Phase</span>
                    <span className="text-sm font-semibold" style={{ color: phaseColor }}>{(phase * 100).toFixed(2)}%</span>
                  </div>
                  <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                    <div className="h-full rounded-full transition-all duration-500" style={{ width: `${phase * 100}%`, backgroundColor: phaseColor }} />
                  </div>
                </div>
                <div className="space-y-2.5 text-sm">
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Score</span>
                    <span className="font-semibold text-blue-400 text-lg">{baseScore}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Rank</span>
                    <span className="font-semibold">{rankPosition > 0 ? `#${rankPosition} of ${totalTickers}` : "—"}</span>
                  </div>
                  {dynamicRank !== baseScore && (
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Dynamic Score</span>
                      <span className="font-semibold text-green-400">{dynamicRank}</span>
                    </div>
                  )}
                  
                  {/* Score Breakdown */}
                  {(() => {
                    const breakdown = calculateScoreBreakdown(ticker);
                    const components = [
                      { label: "Base Score", value: breakdown.base, color: "text-blue-400" },
                      breakdown.aligned > 0 ? { label: "Aligned State", value: `+${breakdown.aligned}`, color: "text-green-400" } : null,
                      breakdown.setup > 0 ? { label: "Setup State", value: `+${breakdown.setup}`, color: "text-green-400" } : null,
                      breakdown.htf > 0 ? { label: "HTF Score", value: `+${breakdown.htf.toFixed(1)}`, color: "text-cyan-400" } : null,
                      breakdown.ltf > 0 ? { label: "LTF Score", value: `+${breakdown.ltf.toFixed(1)}`, color: "text-cyan-400" } : null,
                      breakdown.completion > 0 ? { label: "Completion Bonus", value: `+${breakdown.completion}`, color: "text-yellow-400" } : null,
                      breakdown.phase !== 0 ? { label: "Phase", value: breakdown.phase > 0 ? `+${breakdown.phase.toFixed(2)}` : breakdown.phase.toFixed(2), color: breakdown.phase > 0 ? "text-green-400" : "text-red-400" } : null,
                      breakdown.squeezeRelease > 0 ? { label: "Squeeze Release", value: `+${breakdown.squeezeRelease}`, color: "text-purple-400" } : null,
                      breakdown.squeezeOn > 0 ? { label: "Squeeze On", value: `+${breakdown.squeezeOn}`, color: "text-yellow-400" } : null,
                      breakdown.phaseZoneChange > 0 ? { label: "Phase Zone Change", value: `+${breakdown.phaseZoneChange}`, color: "text-blue-400" } : null,
                      breakdown.rr > 0 ? { label: "Risk/Reward", value: `+${breakdown.rr}`, color: "text-green-400" } : null,
                      breakdown.momentumElite > 0 ? { label: "Momentum Elite", value: `+${breakdown.momentumElite}`, color: "text-purple-400" } : null,
                    ].filter(Boolean);
                    
                    return (
                      <div className="mt-4 pt-4 border-t border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-3 font-semibold">Score Breakdown</div>
                        <div className="space-y-1.5">
                          {components.map((comp, idx) => (
                            <div key={idx} className="flex justify-between items-center text-xs">
                              <span className="text-[#93a4d6]">{comp.label}</span>
                              <span className={`font-semibold ${comp.color}`}>{comp.value}</span>
                            </div>
                          ))}
                          <div className="flex justify-between items-center pt-2 mt-2 border-t border-[#26325f]/50">
                            <span className="text-[#93a4d6] font-semibold">Total Score</span>
                            <span className="font-bold text-lg text-blue-400">{Math.round(breakdown.total)}</span>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">RR</span>
                    <span className="font-semibold">{ticker.rr ? Number(ticker.rr).toFixed(2) : "—"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">State</span>
                    <span className="font-semibold">{ticker.state || "—"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Completion</span>
                    <span className="font-semibold">{Math.round(completionForSize(ticker) * 100)}%</span>
                  </div>
                  {ent.corridor && (
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Corridor</span>
                      <span className="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-semibold">{ent.side}</span>
                    </div>
                  )}
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Current Price</span>
                    <span className="font-semibold text-lg">{ticker.price ? `$${Number(ticker.price).toFixed(2)}` : "—"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">TP (Primary)</span>
                    <span className="font-semibold">{ticker.tp ? `$${Number(ticker.tp).toFixed(2)}` : "—"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">SL</span>
                    <span className="font-semibold">{ticker.sl ? Number(ticker.sl).toFixed(2) : "—"}</span>
                  </div>
                </div>
                {(flags.sq30_on || flags.sq30_release || flags.phase_dot || flags.phase_zone_change) && (
                  <div className="mt-4 pt-4">
                    <div className="text-xs text-[#93a4d6] mb-2">Flags:</div>
                    <div className="flex flex-wrap gap-2">
                      {flags.sq30_on && <span className="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs">🧨 Squeeze ON</span>}
                      {flags.sq30_release && <span className="px-2 py-1 rounded bg-cyan-500/20 text-cyan-400 text-xs">⚡ Squeeze Release</span>}
                      {flags.phase_dot && <span className="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs">Phase Dot</span>}
                      {flags.phase_zone_change && <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs">Zone Change</span>}
                    </div>
                  </div>
                )}
              </div>
              <div className="flex-shrink-0 p-6 pt-4 border-t border-[#26325f] bg-[#121a33]">
                <a href={`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(ticker.ticker)}`} target="_blank" rel="noopener noreferrer" className="block w-full text-center px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-all hover:scale-105 font-semibold">📊 Open in TradingView</a>
              </div>
            </div>
          </div>
        );
      }

      // ─────────────────────────────────────────────────────────────
      // TickerDetailsLoader - Loads ticker data and passes to unified component
      // ─────────────────────────────────────────────────────────────
      const TickerDetailsLoader = ({ tickerSymbol, trade = null, onClose, allLoadedData = null, sectors = [], rankedTickers = null, rankedTickerPositions = null }) => {
        const [tickerData, setTickerData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        
        useEffect(() => {
          const fetchTicker = async () => {
            try {
              setLoading(true);
              const res = await fetch(`${API_BASE}/timed/latest?ticker=${encodeURIComponent(tickerSymbol)}`);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const json = await res.json();
              if (!json.ok || !json.data) {
                throw new Error(json.error || 'Ticker not found');
              }
              setTickerData(json.data || json.latestData);
            } catch (err) {
              console.error('Failed to fetch ticker:', err);
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };
          fetchTicker();
        }, [tickerSymbol]);
        
        if (loading) {
          return (
            <div className="w-full h-full flex items-center justify-center bg-[#0f1630]">
              <div className="text-center">
                <div className="loading-spinner mx-auto mb-4"></div>
                <div className="text-[#93a4d6]">Loading {tickerSymbol}...</div>
              </div>
            </div>
          );
        }
        
        if (error || !tickerData) {
          return (
            <div className="w-full h-full flex items-center justify-center bg-[#0f1630]">
              <div className="text-center">
                <div className="text-red-400 mb-2">Failed to load {tickerSymbol}</div>
                <div className="text-[#93a4d6] text-sm mb-4">{error || 'No data available'}</div>
                <button onClick={onClose} className="px-4 py-2 bg-[#26325f] hover:bg-[#3a4aa0] rounded-lg text-white">Close</button>
              </div>
            </div>
          );
        }
        
        return (
          <TickerDetailRightRail
            ticker={tickerData}
            trade={trade}
            onClose={onClose}
            allLoadedData={allLoadedData}
            sectors={sectors}
            rankedTickers={rankedTickers}
            rankedTickerPositions={rankedTickerPositions}
          />
        );
      };

      // ─────────────────────────────────────────────────────────────
      // Welcome Modal Component - Dashboard Guide (Trading Concepts)
      // ─────────────────────────────────────────────────────────────
      function DashboardWelcomeModal({ onClose }) {
        const [currentStep, setCurrentStep] = useState(0);
        
        const steps = [
          {
            title: "Welcome to Timed Trading! 🎯",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  This dashboard helps you find high-quality trading setups by combining multiple timeframes and technical indicators.
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🎓 How to Use This Guide</h3>
                  <p className="text-sm text-[#93a4d6]">
                    Click "Next" to learn about each concept, or use the navigation dots to jump to any section. 
                    You can always reopen this guide from the navigation bar.
                  </p>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">✨ Quick Start</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Look for bubbles in the <strong className="text-white">green zones</strong> (Q1 & Q2) for LONG setups</li>
                    <li>Look for bubbles in the <strong className="text-white">red zones</strong> (Q3 & Q4) for SHORT setups</li>
                    <li>Click on any bubble to see detailed information</li>
                    <li>Use filters to narrow down the best opportunities</li>
                  </ol>
                </div>
              </div>
            ),
          },
          {
            title: "Understanding the Quadrants 📊",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The chart is divided into <strong>4 quadrants</strong> based on two scores:
                </p>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                    <h3 className="text-green-400 font-semibold mb-2">HTF Score (Y-axis)</h3>
                    <p className="text-sm text-[#93a4d6]">
                      <strong className="text-white">Higher Timeframe</strong> - Shows the overall trend direction.
                      <br />• Positive = Bullish trend
                      <br />• Negative = Bearish trend
                    </p>
                  </div>
                  <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                    <h3 className="text-blue-400 font-semibold mb-2">LTF Score (X-axis)</h3>
                    <p className="text-sm text-[#93a4d6]">
                      <strong className="text-white">Lower Timeframe</strong> - Shows entry timing.
                      <br />• Positive = Momentum/Continuation
                      <br />• Negative = Pullback/Setup
                    </p>
                  </div>
                </div>
                <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                  <h3 className="text-yellow-400 font-semibold mb-3">The 4 Quadrants:</h3>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Q1: Long Setup 📈</div>
                      <div className="text-[#93a4d6]">HTF Bull + LTF Pullback</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Best entry zone for LONG trades</div>
                    </div>
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Q2: Long Momentum 🚀</div>
                      <div className="text-[#93a4d6]">HTF Bull + LTF Bull</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Strong momentum, already moving</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Q3: Short Momentum 📉</div>
                      <div className="text-[#93a4d6]">HTF Bear + LTF Bear</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Strong momentum, already moving</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Q4: Short Setup 🔻</div>
                      <div className="text-[#93a4d6]">HTF Bear + LTF Pullback</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Best entry zone for SHORT trades</div>
                    </div>
                  </div>
                </div>
              </div>
            ),
          },
          {
            title: "Prime Setups ⭐",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  <strong className="text-yellow-400">Prime Setups</strong> are the highest-quality opportunities. 
                  They have a ⭐ icon and appear with a green glow.
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">Prime Setup Criteria:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Rank ≥ 75</strong> - High overall quality score</li>
                    <li><strong className="text-white">Risk/Reward ≥ 1.5</strong> - Good profit potential vs risk</li>
                    <li><strong className="text-white">Completion ≤ 40%</strong> - Still early in the move</li>
                    <li><strong className="text-white">In Corridor</strong> - Valid entry zone</li>
                  </ul>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">💡 How to Find Prime Setups:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"Prime Only"</strong> filter button</li>
                    <li>Look for bubbles with ⭐ icons and green borders</li>
                    <li>Click on a bubble to see detailed entry/exit levels</li>
                    <li>Check the Risk/Reward ratio - higher is better!</li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Tip:</strong> Prime setups are rare but offer the best risk/reward. 
                    Focus on Q1 (Long Setup) and Q4 (Short Setup) quadrants for the best entries.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "In Corridor 🎯",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The <strong className="text-cyan-400">Corridor</strong> is a specific zone where entries are considered valid and safe.
                </p>
                <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                  <h3 className="text-cyan-400 font-semibold mb-2">What is a Corridor?</h3>
                  <p className="text-sm text-[#93a4d6] mb-3">
                    A corridor is a narrow band on the chart where price action is optimal for entry. 
                    Think of it as a "sweet spot" where the setup is most likely to succeed.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Long Corridor 📈</div>
                      <div className="text-xs text-[#93a4d6]">
                        HTF Score &gt; 0<br />
                        LTF Score: -8 to +12
                      </div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Short Corridor 📉</div>
                      <div className="text-xs text-[#93a4d6]">
                        HTF Score &lt; 0<br />
                        LTF Score: -12 to +8
                      </div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🎯 How to Use Corridor Filter:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"In Corridor"</strong> filter button</li>
                    <li>This shows only tickers in valid entry zones</li>
                    <li>These are the safest setups to trade</li>
                    <li>Combine with "Prime Only" for the best opportunities</li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Why Corridors Matter:</strong> Tickers outside corridors may be too early, 
                    too late, or in unfavorable conditions. Corridor entries have the highest probability of success.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "TD Sequential (TD9) 🔢",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  <strong className="text-purple-400">TD Sequential</strong> is a powerful indicator that identifies potential reversal points.
                </p>
                <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                  <h3 className="text-purple-400 font-semibold mb-2">What is TD9?</h3>
                  <p className="text-sm text-[#93a4d6] mb-3">
                    TD Sequential counts consecutive bars in one direction. When it reaches <strong className="text-white">9</strong>, 
                    it signals potential exhaustion and reversal.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">TD9 Bullish 📈</div>
                      <div className="text-xs text-[#93a4d6]">
                        Signals potential <strong>bottom</strong> and upward reversal
                        <br /><br />
                        <strong>Action:</strong> Look for LONG entries
                      </div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">TD9 Bearish 📉</div>
                      <div className="text-xs text-[#93a4d6]">
                        Signals potential <strong>top</strong> and downward reversal
                        <br /><br />
                        <strong>Action:</strong> Look for SHORT entries or exit LONGs
                      </div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🔢 How to Use TD9 Filter:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"TD9 Setup"</strong> filter button</li>
                    <li>This shows only tickers with active TD9 signals</li>
                    <li>TD9 signals are strongest when combined with other factors:
                      <ul className="list-disc list-inside ml-4 mt-1">
                        <li>In the correct quadrant (Q1 for bullish, Q4 for bearish)</li>
                        <li>In corridor</li>
                        <li>With good Risk/Reward</li>
                      </ul>
                    </li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Pro Tip:</strong> TD9 signals are most powerful at extremes. 
                    If you see a TD9 signal in Q1 (Long Setup) or Q4 (Short Setup), it's a strong confirmation of a reversal setup.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Squeeze Indicators 🧨⚡",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The <strong className="text-yellow-400">Squeeze</strong> indicator shows when volatility is building up, 
                  like a spring being compressed before release.
                </p>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                    <h3 className="text-yellow-400 font-semibold mb-2 flex items-center gap-2">
                      🧨 In Squeeze
                    </h3>
                    <p className="text-sm text-[#93a4d6] mb-3">
                      Volatility is <strong className="text-white">compressed</strong> - price is consolidating.
                    </p>
                    <div className="text-xs text-[#93a4d6] space-y-1">
                      <div><strong className="text-white">What it means:</strong> Energy is building up</div>
                      <div><strong className="text-white">Action:</strong> Watch closely - a big move is coming</div>
                      <div><strong className="text-white">When to enter:</strong> Wait for squeeze release</div>
                    </div>
                  </div>
                  <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                    <h3 className="text-cyan-400 font-semibold mb-2 flex items-center gap-2">
                      ⚡ Squeeze Release
                    </h3>
                    <p className="text-sm text-[#93a4d6] mb-3">
                      Volatility has <strong className="text-white">exploded</strong> - price is breaking out.
                    </p>
                    <div className="text-xs text-[#93a4d6] space-y-1">
                      <div><strong className="text-white">What it means:</strong> The spring has released!</div>
                      <div><strong className="text-white">Action:</strong> Strong momentum signal</div>
                      <div><strong className="text-white">When to enter:</strong> Enter on pullback or breakout</div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🎯 How to Use Squeeze Filters:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">"In Squeeze" Filter:</strong> Shows tickers where volatility is building. 
                      These are good to watch but wait for release before entering.
                    </div>
                    <div>
                      <strong className="text-white">"Squeeze Release" Filter:</strong> Shows tickers where the squeeze has fired. 
                      These often have strong momentum - combine with Prime filter for best results.
                    </div>
                  </div>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">💡 Best Practices:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Squeeze Release + Prime Setup</strong> = Very strong signal</li>
                    <li><strong className="text-white">Squeeze Release + In Corridor</strong> = High probability entry</li>
                    <li><strong className="text-white">In Squeeze</strong> = Prepare but don't enter yet</li>
                    <li>Look for squeeze release in the direction of the HTF trend</li>
                  </ul>
                </div>
              </div>
            ),
          },
          {
            title: "Putting It All Together 🎓",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  Now that you understand the concepts, here's a <strong className="text-yellow-400">step-by-step workflow</strong> to find great setups:
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-3">📋 Your Trading Workflow:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-3">
                    <li>
                      <strong className="text-white">Step 1: Choose Your Direction</strong>
                      <br />
                      <span className="text-xs ml-4">• For LONG trades: Focus on Q1 (Long Setup) quadrant</span>
                      <br />
                      <span className="text-xs ml-4">• For SHORT trades: Focus on Q4 (Short Setup) quadrant</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 2: Apply Quality Filters</strong>
                      <br />
                      <span className="text-xs ml-4">• Click "Prime Only" to see only high-quality setups</span>
                      <br />
                      <span className="text-xs ml-4">• Click "In Corridor" to ensure valid entry zones</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 3: Look for Confirmation Signals</strong>
                      <br />
                      <span className="text-xs ml-4">• TD9 Setup: Strong reversal signal</span>
                      <br />
                      <span className="text-xs ml-4">• Squeeze Release ⚡: Strong momentum</span>
                      <br />
                      <span className="text-xs ml-4">• Momentum Elite 🚀: Best fundamentals</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 4: Analyze the Setup</strong>
                      <br />
                      <span className="text-xs ml-4">• Click on a bubble to see details</span>
                      <br />
                      <span className="text-xs ml-4">• Check Risk/Reward ratio (aim for ≥ 1.5)</span>
                      <br />
                      <span className="text-xs ml-4">• Verify entry price, stop loss, and take profit levels</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 5: Execute Your Trade</strong>
                      <br />
                      <span className="text-xs ml-4">• Enter at the suggested entry price</span>
                      <br />
                      <span className="text-xs ml-4">• Set stop loss at the SL level</span>
                      <br />
                      <span className="text-xs ml-4">• Target the TP levels (consider trimming at first TP)</span>
                    </li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">⭐ The Perfect Setup Checklist:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div>✅ In the correct quadrant (Q1 for LONG, Q4 for SHORT)</div>
                    <div>✅ Prime Setup (⭐ icon)</div>
                    <div>✅ In Corridor</div>
                    <div>✅ Risk/Reward ≥ 1.5</div>
                    <div>✅ Completion ≤ 40% (still early)</div>
                    <div>✅ TD9 signal OR Squeeze Release (bonus confirmation)</div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Remember:</strong> Not every setup will have all these factors. 
                    Use your judgment and risk management. Start with paper trading if you're new!
                  </p>
                </div>
              </div>
            ),
          },
        ];

        const nextStep = () => {
          if (currentStep < steps.length - 1) {
            setCurrentStep(currentStep + 1);
          }
        };

        const prevStep = () => {
          if (currentStep > 0) {
            setCurrentStep(currentStep - 1);
          }
        };

        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-[#0b1020] border-2 border-[#26325f] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
              <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-b border-[#26325f] p-6 flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-1">{steps[currentStep].title}</h2>
                  <div className="flex gap-1">
                    {steps.map((_, i) => (
                      <div
                        key={i}
                        className={`h-2 w-2 rounded-full transition-all ${
                          i === currentStep
                            ? "bg-blue-400 w-8"
                            : i < currentStep
                            ? "bg-green-400"
                            : "bg-[#26325f]"
                        }`}
                      />
                    ))}
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-[#93a4d6] hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-[#26325f] transition-colors"
                  title="Close Welcome Guide"
                >
                  ×
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-6">
                {steps[currentStep].content}
              </div>
              <div className="border-t border-[#26325f] p-4 flex items-center justify-between bg-[#0f1630]">
                <button
                  onClick={prevStep}
                  disabled={currentStep === 0}
                  className={`px-4 py-2 rounded-lg border transition-all ${
                    currentStep === 0
                      ? "border-[#26325f] text-[#93a4d6] opacity-50 cursor-not-allowed"
                      : "border-[#26325f] bg-[#1a2550] hover:bg-[#26325f] text-white"
                  }`}
                >
                  ← Previous
                </button>
                <div className="text-sm text-[#93a4d6]">
                  Step {currentStep + 1} of {steps.length}
                </div>
                {currentStep < steps.length - 1 ? (
                  <button
                    onClick={nextStep}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold transition-all"
                  >
                    Next →
                  </button>
                ) : (
                  <button
                    onClick={onClose}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold transition-all"
                  >
                    Start Trading! 🚀
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ─────────────────────────────────────────────────────────────
      // Welcome Modal Component - Simulated Trades Guide
      // ─────────────────────────────────────────────────────────────
      function TrackerWelcomeModal({ onClose }) {
        const [currentStep, setCurrentStep] = useState(0);
        
        const steps = [
          {
            title: "Welcome to Trade Tracker! 📊",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  The Trade Tracker automatically simulates trades based on alerts from the main dashboard, 
                  helping you learn which setups work best.
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🎯 How It Works:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>When an alert fires from TradingView, a simulated trade is automatically created</li>
                    <li>Each trade uses a <strong className="text-white">$1,000 position size</strong></li>
                    <li>Trades are tracked in real-time with live P&L updates</li>
                    <li>When price hits Stop Loss or Take Profit, the trade closes automatically</li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">✨ What You'll Learn:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li>Which setups have the best win rate</li>
                    <li>How different Risk/Reward ratios perform</li>
                    <li>Which model versions work best</li>
                    <li>Performance by rank, sector, and other factors</li>
                  </ul>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Note:</strong> These are simulated trades for learning purposes only. 
                    Always do your own research before making real trades!
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Understanding Trade Statuses 🏷️",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  Each trade has a <strong>status</strong> that tells you its current state:
                </p>
                <div className="grid grid-cols-1 gap-3">
                  <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                    <div className="font-bold text-green-400 mb-2 flex items-center gap-2">
                      <span>🟢 OPEN</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade is active and being tracked. P&L updates in real-time as price moves.
                      The trade will close when it hits Stop Loss or Take Profit.
                    </p>
                  </div>
                  <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <div className="font-bold text-blue-400 mb-2 flex items-center gap-2">
                      <span>🔵 TP_HIT_TRIM</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      First Take Profit level was hit! The system automatically trimmed (sold) part of the position 
                      to lock in profits. The remaining position stays open to target higher TP levels.
                    </p>
                  </div>
                  <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                    <div className="font-bold text-green-400 mb-2 flex items-center gap-2">
                      <span>✅ WIN</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade closed profitably! Either hit a Take Profit level or was manually closed in profit.
                      Check the trade history to see the exit details.
                    </p>
                  </div>
                  <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                    <div className="font-bold text-red-400 mb-2 flex items-center gap-2">
                      <span>❌ LOSS</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade hit Stop Loss and closed at a loss. This is normal - not every trade wins!
                      Review what went wrong to improve future setups.
                    </p>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Tip:</strong> Click on any trade row to see detailed information 
                    including entry price, stop loss, take profit levels, and full trade history.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Reading the Trade Table 📋",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The trade table shows all your simulated trades. Here's what each column means:
                </p>
                <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                  <div className="space-y-3 text-sm">
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Ticker</span>
                      <span className="text-[#93a4d6]">The stock or futures contract symbol</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Direction</span>
                      <span className="text-[#93a4d6]">LONG (buy) or SHORT (sell)</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Entry Price</span>
                      <span className="text-[#93a4d6]">Price when the trade was opened</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Current Price</span>
                      <span className="text-[#93a4d6]">Live market price (updates every 30 seconds)</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">P&L</span>
                      <span className="text-[#93a4d6]">
                        Profit or Loss in dollars. <span className="text-green-400">Green = profit</span>, 
                        <span className="text-red-400"> red = loss</span>
                      </span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">P&L %</span>
                      <span className="text-[#93a4d6]">Profit or Loss as a percentage</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Shares/Contracts</span>
                      <span className="text-[#93a4d6]">
                        For stocks: number of shares (based on $1,000 position). 
                        For futures: number of contracts (usually 1)
                      </span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Status</span>
                      <span className="text-[#93a4d6]">Current trade status (OPEN, WIN, LOSS, etc.)</span>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">💡 Pro Tips:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li>Click any trade row to see detailed information and trade history</li>
                    <li>Use the version filter to compare different model versions</li>
                    <li>Open trades show live P&L that updates automatically</li>
                    <li>Closed trades show final P&L and exit reason</li>
                  </ul>
                </div>
              </div>
            ),
          },
          {
            title: "How P&L is Calculated 💰",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  Understanding how profit and loss is calculated helps you interpret the results:
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">📈 For Stocks:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">Position Size:</strong> $1,000 per trade
                    </div>
                    <div>
                      <strong className="text-white">Shares:</strong> $1,000 ÷ Entry Price
                    </div>
                    <div>
                      <strong className="text-white">P&L (LONG):</strong> (Current Price - Entry Price) × Shares
                    </div>
                    <div>
                      <strong className="text-white">P&L (SHORT):</strong> (Entry Price - Current Price) × Shares
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">📊 For Futures:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">Contracts:</strong> Usually 1 contract per trade
                    </div>
                    <div>
                      <strong className="text-white">Point Value:</strong> Each futures contract has a point value:
                      <ul className="list-disc list-inside ml-4 mt-1">
                        <li>NQ1! (Nasdaq): $20 per point</li>
                        <li>ES1! (S&P 500): $50 per point</li>
                        <li>Other futures vary</li>
                      </ul>
                    </div>
                    <div>
                      <strong className="text-white">P&L:</strong> (Price Change) × Contracts × Point Value
                    </div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <h3 className="text-yellow-400 font-semibold mb-2">🎯 Example:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div><strong className="text-white">Stock Trade:</strong> AAPL at $150 entry, $155 current</div>
                    <div className="ml-4">Shares: $1,000 ÷ $150 = 6.67 shares</div>
                    <div className="ml-4">P&L: ($155 - $150) × 6.67 = <span className="text-green-400">+$33.35</span></div>
                    <div className="mt-2"><strong className="text-white">Futures Trade:</strong> NQ1! at 15,000 entry, 15,100 current</div>
                    <div className="ml-4">Price Change: 15,100 - 15,000 = 100 points</div>
                    <div className="ml-4">P&L: 100 × 1 × $20 = <span className="text-green-400">+$2,000</span></div>
                  </div>
                </div>
              </div>
            ),
          },
          {
            title: "Tracking & Analytics 📊",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The Trade Tracker provides powerful analytics to help you learn:
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">📈 Performance Metrics:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Win Rate:</strong> Percentage of winning trades</li>
                    <li><strong className="text-white">Total P&L:</strong> Sum of all profits and losses</li>
                    <li><strong className="text-white">Average Win/Loss:</strong> Average profit per win vs loss</li>
                    <li><strong className="text-white">Best/Worst Trade:</strong> Your biggest winners and losers</li>
                  </ul>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">🔍 Filter by Version:</h3>
                  <p className="text-sm text-[#93a4d6] mb-2">
                    Use the "Model Version" dropdown to compare performance across different versions of the trading model.
                    This helps you see which improvements work best.
                  </p>
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-white">Tip:</strong> Newer versions often include improvements, 
                    but older versions may have proven track records.
                  </p>
                </div>
                <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                  <h3 className="text-purple-400 font-semibold mb-2">📊 Daily Summary:</h3>
                  <p className="text-sm text-[#93a4d6]">
                    Click "View Daily Summary" to see performance breakdowns by:
                  </p>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1 mt-2">
                    <li>Rank ranges (which ranked setups perform best)</li>
                    <li>Risk/Reward ratios (which RR ratios win more)</li>
                    <li>Quadrants (which chart zones are most profitable)</li>
                    <li>Overall statistics and insights</li>
                  </ul>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Remember:</strong> The goal is to learn which setups work best. 
                    Review your wins and losses regularly to improve your trading strategy!
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Putting It All Together 🎓",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  Here's your <strong className="text-yellow-400">workflow</strong> for using the Trade Tracker:
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-3">📋 Daily Workflow:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-3">
                    <li>
                      <strong className="text-white">Monitor Open Trades</strong>
                      <br />
                      <span className="text-xs ml-4">• Check the "Open Trades" section regularly</span>
                      <br />
                      <span className="text-xs ml-4">• Watch P&L update in real-time</span>
                      <br />
                      <span className="text-xs ml-4">• Click trades to see detailed information</span>
                    </li>
                    <li>
                      <strong className="text-white">Review Closed Trades</strong>
                      <br />
                      <span className="text-xs ml-4">• Check "Closed Trades" to see final results</span>
                      <br />
                      <span className="text-xs ml-4">• Review trade history to understand what happened</span>
                      <br />
                      <span className="text-xs ml-4">• Learn from both wins and losses</span>
                    </li>
                    <li>
                      <strong className="text-white">Analyze Performance</strong>
                      <br />
                      <span className="text-xs ml-4">• Use the version filter to compare models</span>
                      <br />
                      <span className="text-xs ml-4">• Check daily summary for insights</span>
                      <br />
                      <span className="text-xs ml-4">• Look for patterns in winning vs losing trades</span>
                    </li>
                    <li>
                      <strong className="text-white">Improve Your Strategy</strong>
                      <br />
                      <span className="text-xs ml-4">• Focus on setups with high win rates</span>
                      <br />
                      <span className="text-xs ml-4">• Avoid setups that consistently lose</span>
                      <br />
                      <span className="text-xs ml-4">• Adjust filters on the main dashboard based on results</span>
                    </li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">⭐ Key Takeaways:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div>✅ Trades are created automatically from alerts</div>
                    <div>✅ Each trade uses $1,000 position size</div>
                    <div>✅ P&L updates in real-time for open trades</div>
                    <div>✅ Trades close automatically at SL or TP</div>
                    <div>✅ Use analytics to learn which setups work best</div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Ready to start tracking?</strong> The Trade Tracker refreshes every 30 seconds 
                    to show the latest trades and updates. Click "Start Tracking!" to begin!
                  </p>
                </div>
              </div>
            ),
          },
        ];

        const nextStep = () => {
          if (currentStep < steps.length - 1) {
            setCurrentStep(currentStep + 1);
          }
        };

        const prevStep = () => {
          if (currentStep > 0) {
            setCurrentStep(currentStep - 1);
          }
        };

        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-[#0b1020] border-2 border-[#26325f] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
              <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-b border-[#26325f] p-6 flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-1">{steps[currentStep].title}</h2>
                  <div className="flex gap-1">
                    {steps.map((_, i) => (
                      <div
                        key={i}
                        className={`h-2 w-2 rounded-full transition-all ${
                          i === currentStep
                            ? "bg-blue-400 w-8"
                            : i < currentStep
                            ? "bg-green-400"
                            : "bg-[#26325f]"
                        }`}
                      />
                    ))}
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-[#93a4d6] hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-[#26325f] transition-colors"
                  title="Close Welcome Guide"
                >
                  ×
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-6">
                {steps[currentStep].content}
              </div>
              <div className="border-t border-[#26325f] p-4 flex items-center justify-between bg-[#0f1630]">
                <button
                  onClick={prevStep}
                  disabled={currentStep === 0}
                  className={`px-4 py-2 rounded-lg border transition-all ${
                    currentStep === 0
                      ? "border-[#26325f] text-[#93a4d6] opacity-50 cursor-not-allowed"
                      : "border-[#26325f] bg-[#1a2550] hover:bg-[#26325f] text-white"
                  }`}
                >
                  ← Previous
                </button>
                <div className="text-sm text-[#93a4d6]">
                  Step {currentStep + 1} of {steps.length}
                </div>
                {currentStep < steps.length - 1 ? (
                  <button
                    onClick={nextStep}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold transition-all"
                  >
                    Next →
                  </button>
                ) : (
                  <button
                    onClick={onClose}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold transition-all"
                  >
                    Start Tracking! 🚀
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ─────────────────────────────────────────────────────────────
      // Main App
      // ─────────────────────────────────────────────────────────────
      function App() {
        const { data, loading, refreshing, error, lastUpdate, refetch } = useTickerData();
        const { trades, loading: tradesLoading, refreshing: tradesRefreshing, error: tradesError, addTrade, updateTrade, refetch: refetchTrades } = useSimulatedTrades();
        const { sectors } = useSectors();
        
        // Welcome Guide state
        const [showWelcomeDashboard, setShowWelcomeDashboard] = useState(false);
        const [showWelcomeTracker, setShowWelcomeTracker] = useState(() => {
          const hasSeenWelcome = localStorage.getItem("timedTrading_welcomeSeen");
          return !hasSeenWelcome;
        });
        
        const handleWelcomeDashboardClose = () => {
          setShowWelcomeDashboard(false);
        };
        
        const handleWelcomeTrackerClose = () => {
          setShowWelcomeTracker(false);
          localStorage.setItem("timedTrading_welcomeSeen", "true");
        };
        
        // Version filter state
        const [selectedVersion, setSelectedVersion] = useState("all");
        const [horizonFilter, setHorizonFilter] = useState("ALL");

        // Unified experience: D1-backed Trade Journey (single mode)
        const trackerMode = "ledger";
        const [ledgerTab, setLedgerTab] = useState("trades"); // trades | alerts | proof
        const initialLedgerTicker = (() => {
          try {
            const t = new URLSearchParams(window.location.search).get("ticker") || "";
            return String(t).trim().toUpperCase();
          } catch {
            return "";
          }
        })();
        const [ledgerTickerFilter, setLedgerTickerFilter] = useState(initialLedgerTicker);
        const [ledgerStatusFilter, setLedgerStatusFilter] = useState("all");
        const [ledgerRangeDays, setLedgerRangeDays] = useState(7);
        const [ledgerIncludeEvidence, setLedgerIncludeEvidence] = useState(true);

        const ledgerSince = useMemo(() => {
          const days = Number(ledgerRangeDays) || 7;
          return Date.now() - days * 24 * 60 * 60 * 1000;
        }, [ledgerRangeDays]);

        const ledgerTrades = useLedgerTrades({
          ticker: ledgerTickerFilter.trim(),
          status: ledgerStatusFilter,
          since: ledgerSince,
          until: null,
          pageSize: 200,
        });
        const ledgerAlerts = useLedgerAlerts({
          ticker: ledgerTickerFilter.trim(),
          since: ledgerSince,
          until: null,
          pageSize: 200,
        });
        const ledgerSummary = useLedgerSummary({ since: ledgerSince, until: null });
        // Legacy "Trade Detail" right rail removed; use unified ticker right rail instead.

        const rankedTickers = useMemo(() => {
          return getRankedTickers(data);
        }, [data]);

        const rankedTickerPositions = useMemo(() => {
          const map = {};
          rankedTickers.forEach((t, idx) => {
            const sym = String(t.ticker || "").trim().toUpperCase();
            const pos = Number(t?.rank_position);
            const rankPos =
              Number.isFinite(pos) && pos > 0 ? pos : idx + 1;
            if (sym && map[sym] == null) {
              map[sym] = rankPos;
            }
          });
          return map;
        }, [rankedTickers]);

        const ledgerFilteredTrades = useMemo(() => {
          const items = Array.isArray(ledgerTrades.items) ? ledgerTrades.items : [];
          if (horizonFilter === "ALL") return items;
          return items.filter((t) => {
            const sym = String(t.ticker || "").toUpperCase();
            const live = data && (data[sym] || data[t.ticker]);
            const key = computeHorizonKey(live || t);
            return key === horizonFilter;
          });
        }, [ledgerTrades.items, horizonFilter, data]);

        const ledgerOpenTrades = useMemo(
          () =>
            ledgerFilteredTrades.filter(
              (t) => t.status !== "WIN" && t.status !== "LOSS"
            ),
          [ledgerFilteredTrades]
        );

        const ledgerClosedTrades = useMemo(
          () =>
            ledgerFilteredTrades.filter(
              (t) => t.status === "WIN" || t.status === "LOSS"
            ),
          [ledgerFilteredTrades]
        );

        const ledgerActivityDays = useMemo(() => {
          const events = [];
          const dayKeyFor = (ts) => {
            const d = new Date(Number(ts));
            if (!Number.isFinite(d.getTime())) return "unknown";
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            return `${yyyy}-${mm}-${dd}`;
          };

          for (const t of ledgerFilteredTrades) {
            const entryTs = Number(t.entry_ts);
            if (Number.isFinite(entryTs)) {
              events.push({
                ts: entryTs,
                type: "ENTRY",
                trade: t,
                price: Number(t.entry_price),
              });
            }
            if (
              (t.status === "TP_HIT_TRIM" || Number(t.trimmed_pct) > 0) &&
              Number.isFinite(Number(t.updated_at || t.exit_ts || t.entry_ts))
            ) {
              const trimTs = Number(t.updated_at || t.exit_ts || t.entry_ts);
              events.push({
                ts: trimTs,
                type: "TRIM",
                trade: t,
                price: null,
              });
            }
            if (
              (t.status === "WIN" || t.status === "LOSS") &&
              Number.isFinite(Number(t.exit_ts))
            ) {
              events.push({
                ts: Number(t.exit_ts),
                type: "EXIT",
                trade: t,
                price: Number(t.exit_price),
              });
            }
          }

          const groups = new Map();
          for (const ev of events) {
            const key = dayKeyFor(ev.ts);
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(ev);
          }

          const keys = Array.from(groups.keys()).sort((a, b) => (a < b ? 1 : -1));
          return keys.map((key) => {
            const items = groups.get(key) || [];
            items.sort((a, b) => b.ts - a.ts);
            const stats = items.reduce(
              (acc, ev) => {
                if (ev.type === "ENTRY") acc.entries += 1;
                if (ev.type === "TRIM") acc.trims += 1;
                if (ev.type === "EXIT") acc.exits += 1;
                if (ev.type === "EXIT") acc.closedPnl += Number(ev.trade.pnl || 0);
                return acc;
              },
              { entries: 0, trims: 0, exits: 0, closedPnl: 0 }
            );
            const label =
              key === "unknown"
                ? "Unknown date"
                : new Date(`${key}T00:00:00`).toLocaleDateString(undefined, {
                    weekday: "short",
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  });
            return { key, label, events: items, stats };
          });
        }, [ledgerFilteredTrades]);

        const ledgerClosedByTicker = useMemo(() => {
          const groups = new Map();
          for (const t of ledgerClosedTrades) {
            const key = String(t.ticker || "").toUpperCase();
            if (!groups.has(key)) groups.set(key, []);
            groups.get(key).push(t);
          }
          const tickers = Array.from(groups.keys()).sort((a, b) =>
            a.localeCompare(b)
          );
          return tickers.map((ticker) => {
            const trades = groups.get(ticker) || [];
            trades.sort((a, b) => Number(b.exit_ts || 0) - Number(a.exit_ts || 0));
            const totalPnl = trades.reduce((sum, t) => sum + Number(t.pnl || 0), 0);
            return { ticker, trades, totalPnl };
          });
        }, [ledgerClosedTrades]);

        const portfolioSummary = useMemo(() => {
          let netPnl = 0;
          let totalGain = 0;
          let totalLoss = 0;
          for (const t of ledgerFilteredTrades) {
            const pnl = Number(t.pnl);
            if (!Number.isFinite(pnl)) continue;
            netPnl += pnl;
            if (pnl >= 0) totalGain += pnl;
            else totalLoss += pnl;
          }
          return {
            netPnl,
            totalGain,
            totalLoss,
            totalTrades: ledgerFilteredTrades.length,
          };
        }, [ledgerFilteredTrades]);

        const getPositionMetrics = (trade, live) => {
          const sym = String(trade.ticker || "").toUpperCase();
          const isFutures = FUTURES_SPECS[sym] || sym.endsWith("1!");
          const pointValue =
            isFutures && FUTURES_SPECS[sym] ? FUTURES_SPECS[sym].pointValue : 1;
          const entryPrice = Number(
            trade.entry_price ?? trade.entryPrice ?? 0
          );
          const shares =
            trade.shares ||
            (isFutures ? 1 : entryPrice > 0 ? TRADE_SIZE / entryPrice : 0);
          const current = Number(live?.price);
          const direction = String(trade.direction || "").toUpperCase();
          const signed = direction === "SHORT" ? -1 : 1;
          const pnlOpen =
            Number.isFinite(current) && Number.isFinite(entryPrice) && entryPrice
              ? (current - entryPrice) * shares * pointValue * signed
              : null;
          const retOpenPct =
            Number.isFinite(current) && Number.isFinite(entryPrice) && entryPrice
              ? ((current - entryPrice) / entryPrice) * 100 * signed
              : null;
          return {
            isFutures,
            pointValue,
            entryPrice,
            shares,
            current,
            pnlOpen,
            retOpenPct,
          };
        };
        
        // Daily summary state
        const [dailySummary, setDailySummary] = useState(null);
        const [summaryLoading, setSummaryLoading] = useState(false);
        const [showSummary, setShowSummary] = useState(false);
        
        // Selected ticker for detail view
        const [selectedTicker, setSelectedTicker] = useState(null);
        
        // Selected trade for history modal
        const [selectedTrade, setSelectedTrade] = useState(null);
        
        // Trade Tracker date range filter
        const [tradeDateRange, setTradeDateRange] = useState({
          startDate: (() => {
            const today = new Date();
            return today.toISOString().split('T')[0];
          })(),
          endDate: (() => {
            const today = new Date();
            return today.toISOString().split('T')[0];
          })(),
        });
        
        // Get unique versions from trades (for dropdown)
        const availableVersions = useMemo(() => {
          const versionSet = new Set(trades.map(t => t.scriptVersion || "unknown").filter(Boolean));
          return Array.from(versionSet).sort().reverse(); // Most recent first
        }, [trades]);
        
        // Filter trades by version (client-side), de-dupe only exact duplicates, and sort alphabetically
        const filteredTrades = useMemo(() => {
          let filtered = selectedVersion === "all" ? trades : trades.filter(t => (t.scriptVersion || "unknown") === selectedVersion);
          
          // Remove duplicates: keep the most recent trade for each exact trade key
          // (Ticker + Direction + EntryTime/Id). This prevents accidental collapsing of real historical trades.
          const tradeMap = new Map();
          filtered.forEach(trade => {
            const entryKey = trade.entryTime || trade.entryTs || trade.trigger_ts || trade.id || "";
            const key = `${trade.ticker}_${trade.direction}_${entryKey}`;
            const existing = tradeMap.get(key);
            if (!existing) {
              tradeMap.set(key, trade);
            } else {
              // Keep the most recent one (by entryTime)
              const existingTime = new Date(existing.entryTime || 0).getTime();
              const currentTime = new Date(trade.entryTime || 0).getTime();
              if (currentTime > existingTime) {
                tradeMap.set(key, trade);
              }
            }
          });
          
          // Convert back to array and sort alphabetically by ticker
          filtered = Array.from(tradeMap.values());
          filtered.sort((a, b) => {
            const tickerA = String(a.ticker || "").toUpperCase();
            const tickerB = String(b.ticker || "").toUpperCase();
            return tickerA.localeCompare(tickerB);
          });
          
          return filtered;
        }, [trades, selectedVersion]);

        // Keep Current Price fresh by overriding open/trimmed trades with latest ticker prices.
        // Trades returned by the Worker can lag between runs; this makes the UI reflect latest ingested prices.
        const filteredTradesWithLivePrices = useMemo(() => {
          if (!Array.isArray(filteredTrades)) return [];
          return filteredTrades.map((t) => {
            const symRaw = t?.ticker;
            if (!symRaw) return t;
            const sym = String(symRaw).toUpperCase();
            const live =
              (data && (data[sym] || data[symRaw])) ||
              null;
            const livePrice =
              live && live.price != null ? Number(live.price) : NaN;
            const isOpenLike =
              t.status === "OPEN" || !t.status || t.status === "TP_HIT_TRIM";
            if (!isOpenLike || !Number.isFinite(livePrice)) return t;
            const next = {
              ...t,
              currentPrice: livePrice,
              _uiPriceTs: live.ts || live.ingest_ts || null,
            };

            // Recompute P&L using latest price so the UI always reflects the latest move.
            // This does not change status; the Worker remains the source of truth for state transitions.
            const tickerSymbol = String(next.ticker || "").toUpperCase();
            const isFutures =
              FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
            const pointValue =
              isFutures && FUTURES_SPECS[tickerSymbol]
                ? FUTURES_SPECS[tickerSymbol].pointValue
                : 1;
            const entryPrice = Number(next.entryPrice);
            const tp = Number(next.tp);
            const sl = Number(next.sl);
            const currentPrice = Number(next.currentPrice);
            const trimmedPct = Number(next.trimmedPct) || 0;
            const shares =
              next.shares ||
              (isFutures && FUTURES_SPECS[tickerSymbol]
                ? 1
                : TRADE_SIZE / (entryPrice || 1));

            if (
              Number.isFinite(entryPrice) &&
              Number.isFinite(tp) &&
              Number.isFinite(sl) &&
              Number.isFinite(currentPrice) &&
              Number.isFinite(shares)
            ) {
              let pnl = 0;
              let pnlPct = 0;

              if (next.direction === "LONG") {
                const hitTP = currentPrice >= tp;
                const hitSL = currentPrice <= sl;
                if (hitTP) {
                  const tpDiff = tp - entryPrice;
                  pnl = tpDiff * shares * pointValue * (trimmedPct === 0 ? 0.5 : 1);
                  pnlPct = ((tp - entryPrice) / entryPrice) * 100;
                } else if (hitSL) {
                  const slDiff = sl - entryPrice;
                  pnl = slDiff * shares * pointValue;
                  pnlPct = ((sl - entryPrice) / entryPrice) * 100;
                } else {
                  const priceDiff = currentPrice - entryPrice;
                  pnl = priceDiff * shares * pointValue;
                  pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;
                }
              } else if (next.direction === "SHORT") {
                const hitTP = currentPrice <= tp;
                const hitSL = currentPrice >= sl;
                if (hitTP) {
                  const tpDiff = entryPrice - tp;
                  pnl = tpDiff * shares * pointValue * (trimmedPct === 0 ? 0.5 : 1);
                  pnlPct = ((entryPrice - tp) / entryPrice) * 100;
                } else if (hitSL) {
                  const slDiff = entryPrice - sl;
                  pnl = slDiff * shares * pointValue;
                  pnlPct = ((entryPrice - sl) / entryPrice) * 100;
                } else {
                  const priceDiff = entryPrice - currentPrice;
                  pnl = priceDiff * shares * pointValue;
                  pnlPct = ((entryPrice - currentPrice) / entryPrice) * 100;
                }
              }

              next.pnl = pnl;
              next.pnlPct = pnlPct;
            }

            return next;
          });
        }, [filteredTrades, data]);

        const tradesForDisplay = useMemo(() => {
          if (!Array.isArray(filteredTradesWithLivePrices)) return [];
          if (horizonFilter === "ALL") return filteredTradesWithLivePrices;
          return filteredTradesWithLivePrices.filter((t) => {
            const sym = String(t.ticker || "").toUpperCase();
            const live = data && (data[sym] || data[t.ticker]);
            const key = computeHorizonKey(live || t);
            return key === horizonFilter;
          });
        }, [filteredTradesWithLivePrices, data, horizonFilter]);
        
        const analytics = useTradeAnalytics(filteredTradesWithLivePrices);

        // Trade simulation is handled by Worker - just refresh trades periodically
        useEffect(() => {
          // Initial fetch on mount
          refetchTrades();
          
          // Refresh trades every 30 seconds to get latest updates from Worker
          const refreshInterval = setInterval(() => {
            refetchTrades();
          }, 30000);
          
          return () => clearInterval(refreshInterval);
        }, [refetchTrades]);

        // Fetch daily summary
        const fetchDailySummary = useCallback(async () => {
          setSummaryLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/ai/daily-summary`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (json.ok) {
              setDailySummary(json);
              setShowSummary(true);
            } else {
              throw new Error(json.error || "Failed to fetch summary");
            }
          } catch (err) {
            console.error("Daily summary error:", err);
            alert(`Failed to fetch daily summary: ${err.message}`);
          } finally {
            setSummaryLoading(false);
          }
        }, []);

        const openTrades = tradesForDisplay.filter((t) => t.status === "OPEN" || !t.status || t.status === "TP_HIT_TRIM");
        const closedTrades = tradesForDisplay.filter(
          (t) => t.status === "WIN" || t.status === "LOSS"
        );

        return (
          <>
            {/* Welcome Modals */}
            {showWelcomeDashboard && (
              <DashboardWelcomeModal onClose={handleWelcomeDashboardClose} />
            )}
            {showWelcomeTracker && (
              <TrackerWelcomeModal onClose={handleWelcomeTrackerClose} />
            )}
            
            <div className="min-h-screen p-4">
              <div className="w-full mx-auto px-2">
              {/* Navigation */}
              <nav className="mb-4 p-3 bg-[#121a33] border border-[#26325f] rounded-lg">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm text-[#93a4d6]">Navigate:</span>
                  <a
                    href="index-react.html"
                    className="px-3 py-1.5 rounded bg-[#0f1630] border border-[#26325f] text-sm hover:bg-[#1a2550] transition-colors"
                  >
                    Dashboard
                  </a>
                  <a
                    href="simulation-dashboard.html"
                    className="px-3 py-1.5 rounded bg-blue-500/20 border border-blue-500 text-sm text-blue-400 font-semibold"
                  >
                    Trade Tracker
                  </a>
                  <button
                    onClick={() => setShowWelcomeDashboard(true)}
                    className="px-3 py-1.5 rounded bg-purple-500/20 border border-purple-500 text-sm text-purple-400 font-semibold hover:bg-purple-500/30 transition-colors"
                    title="Show Dashboard Guide (Trading Concepts)"
                  >
                    📚 Dashboard Guide
                  </button>
                  <button
                    onClick={() => setShowWelcomeTracker(true)}
                    className="px-3 py-1.5 rounded bg-blue-500/20 border border-blue-500 text-sm text-blue-400 font-semibold hover:bg-blue-500/30 transition-colors"
                    title="Show Trade Tracker Guide (Simulated Trades)"
                  >
                    📊 Trade Tracker Guide
                  </button>
                </div>
              </nav>

              {/* Version Filter */}
              <div className="mb-4 p-3 bg-[#121a33] border border-[#26325f] rounded-lg">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm text-[#93a4d6]">Model Version:</span>
                  <select
                    value={selectedVersion}
                    onChange={(e) => setSelectedVersion(e.target.value)}
                    className="px-3 py-1.5 rounded bg-[#0f1630] border border-[#26325f] text-sm text-white hover:bg-[#1a2550] transition-colors"
                  >
                    <option value="all">All Versions ({trades.length} trades)</option>
                    {availableVersions.map((v) => {
                      const count = trades.filter(t => (t.scriptVersion || "unknown") === v).length;
                      return (
                        <option key={v} value={v}>
                          {v} ({count} trades)
                        </option>
                      );
                    })}
                  </select>
                  {selectedVersion !== "all" && (
                    <span className="text-xs text-[#93a4d6]">
                      Showing {filteredTrades.length} of {trades.length} trades
                    </span>
                  )}
                </div>
              </div>

              {/* Header */}
              <header className="mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h1 className="text-3xl font-bold">
                    Timed Trading — Trade Tracker
                  </h1>
                  <div className="flex items-center gap-4">
                    {(loading || tradesLoading) && <div className="loading-spinner"></div>}
                    <div className="px-3 py-2 rounded-lg border border-[#26325f] bg-[#0f1630] text-sm text-[#93a4d6]">
                      Trade Journey
                      <span className="ml-2 text-xs px-2 py-0.5 rounded bg-blue-500/20 border border-blue-500/30 text-blue-300">
                        Ledger
                      </span>
                    </div>
                    <button
                      onClick={() => { refetch(); refetchTrades(); }}
                      className="px-4 py-2 bg-[#1a2550] border border-[#26325f] rounded-lg hover:bg-[#26325f] transition-colors"
                    >
                      Refresh
                    </button>
                    <button
                      onClick={fetchDailySummary}
                      disabled={summaryLoading}
                      className="px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-colors text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {summaryLoading ? "Loading..." : "📊 Daily Summary"}
                    </button>
                    {lastUpdate && (
                      <span className="text-sm text-[#93a4d6]">
                        Prices updated{" "}
                        <span className="text-[#00ffff] font-semibold">
                          {lastUpdate.toLocaleTimeString()}
                        </span>
                        {(refreshing || tradesRefreshing) && (
                          <span className="ml-2 text-[#6b7a9f]">(refreshing…)</span>
                        )}
                      </span>
                    )}
                  </div>
                </div>
              </header>

              <PerformanceDashboard
                mode={trackerMode}
                ledgerSummary={ledgerSummary}
                analytics={analytics}
              />

              {/* Trade Journey (D1-backed) */}
              <div className="mb-6 bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                  <div className="flex items-center justify-between gap-4 flex-wrap mb-4">
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => setLedgerTab("trades")}
                        className={`px-3 py-2 rounded-lg text-sm border transition-colors ${
                          ledgerTab === "trades"
                            ? "bg-[#1a2550] border-[#3a4a7a] text-white"
                            : "bg-[#0f1630] border-[#26325f] text-[#93a4d6] hover:text-white"
                        }`}
                      >
                        Trades
                      </button>
                      <button
                        onClick={() => setLedgerTab("alerts")}
                        className={`px-3 py-2 rounded-lg text-sm border transition-colors ${
                          ledgerTab === "alerts"
                            ? "bg-[#1a2550] border-[#3a4a7a] text-white"
                            : "bg-[#0f1630] border-[#26325f] text-[#93a4d6] hover:text-white"
                        }`}
                      >
                        Alerts
                      </button>
                      <button
                        onClick={() => setLedgerTab("proof")}
                        className={`px-3 py-2 rounded-lg text-sm border transition-colors ${
                          ledgerTab === "proof"
                            ? "bg-[#1a2550] border-[#3a4a7a] text-white"
                            : "bg-[#0f1630] border-[#26325f] text-[#93a4d6] hover:text-white"
                        }`}
                      >
                        Proof
                      </button>
                    </div>

                    <div className="flex items-center gap-3 flex-wrap">
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-[#93a4d6]">Ticker</span>
                        <input
                          value={ledgerTickerFilter}
                          onChange={(e) => setLedgerTickerFilter(e.target.value.toUpperCase())}
                          placeholder="e.g. AMD"
                          className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white w-[120px]"
                        />
                      </div>

                      <div className="flex items-center gap-2">
                        <span className="text-xs text-[#93a4d6]">Range</span>
                        <select
                          value={ledgerRangeDays}
                          onChange={(e) => setLedgerRangeDays(Number(e.target.value))}
                          className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white"
                        >
                          <option value={1}>1d</option>
                          <option value={7}>7d</option>
                          <option value={14}>14d</option>
                          <option value={30}>30d</option>
                        </select>
                      </div>

                      {ledgerTab === "trades" && (
                        <div className="flex items-center gap-2">
                          <span className="text-xs text-[#93a4d6]">Status</span>
                          <select
                            value={ledgerStatusFilter}
                            onChange={(e) => setLedgerStatusFilter(e.target.value)}
                            className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white"
                          >
                            <option value="all">All</option>
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                          </select>
                        </div>
                      )}

                      {ledgerTab === "trades" && (
                        <div className="flex items-center gap-2">
                          <span className="text-xs text-[#93a4d6]">Horizon</span>
                          <select
                            value={horizonFilter}
                            onChange={(e) => setHorizonFilter(e.target.value)}
                            className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white"
                          >
                            <option value="ALL">All</option>
                            <option value="SHORT_TERM">Short-Term</option>
                            <option value="SWING">Swing</option>
                            <option value="POSITIONAL">Positional</option>
                          </select>
                        </div>
                      )}

                      {ledgerTab === "trades" && (
                        <label className="flex items-center gap-2 text-xs text-[#93a4d6]">
                          <input
                            type="checkbox"
                            checked={ledgerIncludeEvidence}
                            onChange={(e) => setLedgerIncludeEvidence(e.target.checked)}
                          />
                          Include evidence
                        </label>
                      )}
                    </div>
                  </div>

                  {ledgerTab === "trades" && (
                    <div className="flex gap-4 items-start">
                      <div className={`flex-1 ${(selectedTicker || selectedTrade) ? "mr-[470px]" : ""}`}>
                        {ledgerTrades.loading ? (
                          <div className="text-sm text-[#93a4d6]">Loading trades…</div>
                        ) : ledgerTrades.error ? (
                          <div className="text-sm text-red-400">
                            Ledger trades unavailable: {ledgerTrades.error}
                          </div>
                        ) : (
                          <>
                            {ledgerFilteredTrades.length === 0 ? (
                              <div className="p-6 text-center text-[#93a4d6]">
                                No trades found for this filter/range.
                              </div>
                            ) : (
                              <div className="space-y-6">
                                <div className="bg-[#0f1630] border border-[#26325f] rounded-xl overflow-hidden">
                                  <div className="p-3 flex items-center justify-between gap-3 flex-wrap border-b border-[#26325f]">
                                    <div>
                                      <div className="text-sm font-bold">Portfolio</div>
                                      <div className="text-xs text-[#93a4d6]">
                                        {fmtInt(ledgerOpenTrades.length)} open positions
                                      </div>
                                    </div>
                                    <div className="flex items-center gap-3 text-xs">
                                      <div className={`px-2 py-1 rounded bg-[#121a33] border border-[#26325f] font-semibold ${portfolioSummary.netPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                        Net P&L: {fmtUsd(portfolioSummary.netPnl)}
                                      </div>
                                      <div className="px-2 py-1 rounded bg-[#121a33] border border-[#26325f] text-green-400 font-semibold">
                                        Gain: {fmtUsd(portfolioSummary.totalGain)}
                                      </div>
                                      <div className="px-2 py-1 rounded bg-[#121a33] border border-[#26325f] text-red-400 font-semibold">
                                        Loss: {fmtUsd(Math.abs(portfolioSummary.totalLoss))}
                                      </div>
                                      <div className="px-2 py-1 rounded bg-[#121a33] border border-[#26325f] text-[#93a4d6] font-semibold">
                                        Trades: {fmtInt(portfolioSummary.totalTrades)}
                                      </div>
                                    </div>
                                  </div>
                                  {ledgerOpenTrades.length === 0 ? (
                                    <div className="p-6 text-center text-[#93a4d6]">
                                      No open trades in this range.
                                    </div>
                                  ) : (
                                    <div className="overflow-x-auto">
                                      <table className="w-full min-w-full">
                                        <thead>
                                          <tr className="border-b border-[#26325f] text-left">
                                            <th className="p-2 text-xs text-[#93a4d6]">Ticker</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Action</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Entry Date</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Entry Price</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Qty</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Current Return %</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Open P&L</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Closed P&L (Trim)</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">TP Max</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">ETA</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">SL</th>
                                            <th className="p-2 text-xs text-[#93a4d6]">Exit Price</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          {ledgerOpenTrades.map((t) => {
                                            const sym = String(t.ticker || "").toUpperCase();
                                            const live = data && (data[sym] || data[t.ticker]);
                                            const metrics = getPositionMetrics(t, live);
                                            const eta = computeEtaDays(live || t);
                                            const tpMax = computeTpMaxPrice(live || t);
                                            const entryTs = Number(t.entry_ts);
                                            const trimmedPct = Number(t.trimmed_pct || 0);
                                            const sl = Number(live?.sl ?? t.sl ?? t.sl_price);
                                            const trimPnl =
                                              Number.isFinite(tpMax) &&
                                              Number.isFinite(metrics.entryPrice) &&
                                              metrics.entryPrice &&
                                              trimmedPct > 0
                                                ? (tpMax - metrics.entryPrice) *
                                                  metrics.shares *
                                                  metrics.pointValue *
                                                  trimmedPct *
                                                  (String(t.direction || "").toUpperCase() === "SHORT" ? -1 : 1)
                                                : null;
                                            return (
                                              <tr
                                                key={t.trade_id}
                                                className="border-b border-[#26325f]/50 hover:bg-[#121a33] cursor-pointer"
                                                onClick={() => {
                                                  setSelectedTicker(t.ticker);
                                                  setSelectedTrade(t);
                                                }}
                                              >
                                                <td className="p-2">
                                                  <div className="font-semibold">{t.ticker}</div>
                                                  <div className="text-[10px] text-[#93a4d6]">
                                                    {Number.isFinite(metrics.current)
                                                      ? `Current: ${fmtUsd(metrics.current)}`
                                                      : "Current: —"}
                                                  </div>
                                                </td>
                                                <td className="p-2 text-xs">
                                                  <span className="px-2 py-0.5 rounded text-xs font-semibold bg-yellow-500/15 text-yellow-300">
                                                    {t.status || "OPEN"}
                                                  </span>
                                                </td>
                                                <td className="p-2 text-xs text-[#93a4d6]">
                                                  {Number.isFinite(entryTs)
                                                    ? new Date(entryTs).toLocaleString()
                                                    : "—"}
                                                </td>
                                                <td className="p-2 text-sm">{fmtUsd(metrics.entryPrice || 0)}</td>
                                                <td className="p-2 text-sm">
                                                  {metrics.isFutures
                                                    ? metrics.shares.toFixed(0)
                                                    : metrics.shares.toFixed(4)}
                                                </td>
                                                <td className="p-2 text-sm text-green-400">
                                                  {Number.isFinite(metrics.retOpenPct)
                                                    ? `${metrics.retOpenPct.toFixed(2)}%`
                                                    : "—"}
                                                </td>
                                                <td className="p-2 text-sm">
                                                  {Number.isFinite(metrics.pnlOpen) ? (
                                                    <span className={`font-semibold ${metrics.pnlOpen >= 0 ? "text-green-400" : "text-red-400"}`}>
                                                      {fmtUsd(metrics.pnlOpen)}
                                                    </span>
                                                  ) : (
                                                    <span className="text-[#6b7a9f]">—</span>
                                                  )}
                                                </td>
                                                <td className="p-2 text-sm">
                                                  {Number.isFinite(trimPnl) ? (
                                                    <span className={`font-semibold ${trimPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                                      {fmtUsd(trimPnl)}
                                                    </span>
                                                  ) : (
                                                    <span className="text-[#6b7a9f]">—</span>
                                                  )}
                                                </td>
                                                <td className="p-2 text-sm text-green-400">
                                                  {Number.isFinite(tpMax) ? fmtUsd(tpMax) : "—"}
                                                </td>
                                                <td className="p-2 text-sm">
                                                  {Number.isFinite(eta) ? `${eta.toFixed(1)}d` : "—"}
                                                </td>
                                                <td className="p-2 text-sm text-red-400">
                                                  {Number.isFinite(sl) ? fmtUsd(sl) : "—"}
                                                </td>
                                                <td className="p-2 text-sm text-[#93a4d6]">—</td>
                                              </tr>
                                            );
                                          })}
                                        </tbody>
                                      </table>
                                    </div>
                                  )}
                                </div>

                                <div className="bg-[#0f1630] border border-[#26325f] rounded-xl overflow-hidden">
                                  <div className="p-3 flex items-center justify-between gap-3 flex-wrap border-b border-[#26325f]">
                                    <div>
                                      <div className="text-sm font-bold">By Day Activity</div>
                                      <div className="text-xs text-[#93a4d6]">
                                        Entries, trims, and exits logged by day.
                                      </div>
                                    </div>
                                  </div>
                                  {ledgerActivityDays.length === 0 ? (
                                    <div className="p-6 text-center text-[#93a4d6]">
                                      No activity found in this range.
                                    </div>
                                  ) : (
                                    <div className="space-y-4 p-3">
                                      {ledgerActivityDays.map((g) => (
                                        <div key={g.key} className="bg-[#121a33] border border-[#26325f] rounded-xl overflow-hidden">
                                          <div className="p-3 flex items-center justify-between gap-3 flex-wrap border-b border-[#26325f]">
                                            <div>
                                              <div className="text-sm font-bold">{g.label}</div>
                                              <div className="text-xs text-[#93a4d6]">
                                                {fmtInt(g.stats.entries)} entries • {fmtInt(g.stats.trims)} trims • {fmtInt(g.stats.exits)} exits
                                              </div>
                                            </div>
                                            <div className={`px-2 py-1 rounded bg-[#0f1630] border border-[#26325f] text-xs font-semibold ${g.stats.closedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                              {fmtUsd(g.stats.closedPnl)}
                                            </div>
                                          </div>
                                          <div className="overflow-x-auto">
                                            <table className="w-full min-w-full">
                                              <thead>
                                                <tr className="border-b border-[#26325f] text-left">
                                                  <th className="p-2 text-xs text-[#93a4d6]">Time</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Entry Date/Time</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Ticker</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Action</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Side</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Entry Price</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Qty</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Price</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Exit Price</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Status</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">P&L</th>
                                                </tr>
                                              </thead>
                                              <tbody>
                                                {g.events.map((ev, idx) => {
                                                  const t = ev.trade;
                                                  const pnl = Number(t.pnl || 0);
                                                  const entryTs = Number(t.entry_ts);
                                                  const entryPrice = Number(t.entry_price);
                                                  const exitPrice = Number(t.exit_price);
                                                  const trimPrice = Number(
                                                    t.trimPrice ?? t.trim_price ?? t.trim_price
                                                  );
                                                  const isTrimExit =
                                                    ev.type === "TRIM" &&
                                                    Number.isFinite(exitPrice) &&
                                                    Number.isFinite(trimPrice) &&
                                                    Math.abs(exitPrice - trimPrice) <= 0.01;
                                                  const actionLabel =
                                                    ev.type === "TRIM" && isTrimExit
                                                      ? "EXIT"
                                                      : ev.type;
                                                  const actionColor =
                                                    actionLabel === "ENTRY"
                                                      ? "bg-green-500/20 text-green-400"
                                                      : actionLabel === "TRIM"
                                                      ? "bg-yellow-500/20 text-yellow-300"
                                                      : "bg-purple-500/20 text-purple-300";
                                                  const statusLabel =
                                                    ev.type === "EXIT"
                                                      ? t.exit_reason || t.status || "EXIT"
                                                      : ev.type === "TRIM"
                                                      ? "TRIMMED"
                                                      : t.status || "OPEN";
                                                  const metrics = getPositionMetrics(t, data && (data[String(t.ticker || "").toUpperCase()] || data[t.ticker]));
                                                  return (
                                                    <tr
                                                      key={`${t.trade_id}-${idx}-${ev.type}`}
                                                      className="border-b border-[#26325f]/50 hover:bg-[#0f1630] cursor-pointer"
                                                      onClick={() => {
                                                        setSelectedTicker(t.ticker);
                                                        setSelectedTrade(t);
                                                      }}
                                                    >
                                                      <td className="p-2 text-xs text-[#93a4d6] whitespace-nowrap">
                                                        {Number.isFinite(ev.ts) ? new Date(ev.ts).toLocaleTimeString() : "—"}
                                                      </td>
                                                      <td className="p-2 text-xs text-[#93a4d6] whitespace-nowrap">
                                                        {Number.isFinite(entryTs)
                                                          ? new Date(entryTs).toLocaleString()
                                                          : "—"}
                                                      </td>
                                                      <td className="p-2 font-semibold">{t.ticker}</td>
                                                      <td className="p-2 text-xs">
                                                        <span className={`px-2 py-0.5 rounded font-semibold ${actionColor}`}>
                                                          {actionLabel}
                                                        </span>
                                                      </td>
                                                      <td className="p-2">
                                                        <span
                                                          className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                                            t.direction === "LONG"
                                                              ? "bg-green-500/20 text-green-400"
                                                              : "bg-red-500/20 text-red-400"
                                                          }`}
                                                        >
                                                          {t.direction}
                                                        </span>
                                                      </td>
                                                      <td className="p-2 text-sm">
                                                        {Number.isFinite(entryPrice) ? fmtUsd(entryPrice) : "—"}
                                                      </td>
                                                      <td className="p-2 text-xs">
                                                        {metrics.isFutures
                                                          ? metrics.shares.toFixed(0)
                                                          : metrics.shares.toFixed(4)}
                                                      </td>
                                                      <td className="p-2 text-sm">
                                                        {Number.isFinite(ev.price) ? fmtUsd(ev.price) : "—"}
                                                      </td>
                                                      <td className="p-2 text-sm">
                                                        {(actionLabel === "EXIT" || ev.type === "EXIT") && Number.isFinite(exitPrice)
                                                          ? fmtUsd(exitPrice)
                                                          : "—"}
                                                      </td>
                                                      <td className="p-2 text-xs text-[#93a4d6]">{statusLabel}</td>
                                                      <td className="p-2 text-xs">
                                                        {ev.type === "EXIT" ? (
                                                          <span className={`font-semibold ${pnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                                            {fmtUsd(pnl)}
                                                          </span>
                                                        ) : (
                                                          <span className="text-[#6b7a9f]">—</span>
                                                        )}
                                                      </td>
                                                    </tr>
                                                  );
                                                })}
                                              </tbody>
                                            </table>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>

                                <div className="bg-[#0f1630] border border-[#26325f] rounded-xl overflow-hidden">
                                  <div className="p-3 flex items-center justify-between gap-3 flex-wrap border-b border-[#26325f]">
                                    <div>
                                      <div className="text-sm font-bold">Closed Trades by Ticker</div>
                                      <div className="text-xs text-[#93a4d6]">
                                        {fmtInt(ledgerClosedTrades.length)} closed trades
                                      </div>
                                    </div>
                                  </div>
                                  {ledgerClosedByTicker.length === 0 ? (
                                    <div className="p-6 text-center text-[#93a4d6]">
                                      No closed trades in this range.
                                    </div>
                                  ) : (
                                    <div className="space-y-3 p-3">
                                      {ledgerClosedByTicker.map((group) => (
                                        <div key={group.ticker} className="border border-[#26325f] rounded-lg overflow-hidden bg-[#121a33]">
                                          <div className="p-3 flex items-center justify-between gap-3 flex-wrap border-b border-[#26325f]">
                                            <div className="text-sm font-bold">{group.ticker}</div>
                                            <div className={`text-sm font-semibold ${group.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                              {fmtUsd(group.totalPnl)}
                                            </div>
                                          </div>
                                          <div className="overflow-x-auto">
                                            <table className="w-full min-w-full">
                                              <thead>
                                                <tr className="border-b border-[#26325f] text-left">
                                                  <th className="p-2 text-xs text-[#93a4d6]">Entry</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Action</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Exit</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Side</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Qty</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Exit Price</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">P&L</th>
                                                  <th className="p-2 text-xs text-[#93a4d6]">Status</th>
                                                </tr>
                                              </thead>
                                              <tbody>
                                                {group.trades.map((t) => {
                                                  const entryTs = Number(t.entry_ts);
                                                  const exitTs = Number(t.exit_ts);
                                                  const pnl = Number(t.pnl || 0);
                                                  const metrics = getPositionMetrics(
                                                    t,
                                                    data &&
                                                      (data[String(t.ticker || "").toUpperCase()] ||
                                                        data[t.ticker])
                                                  );
                                                  const exitPrice = Number(t.exit_price);
                                                  return (
                                                    <tr
                                                      key={t.trade_id}
                                                      className="border-b border-[#26325f]/50 hover:bg-[#0f1630] cursor-pointer"
                                                      onClick={() => {
                                                        setSelectedTicker(t.ticker);
                                                        setSelectedTrade(t);
                                                      }}
                                                    >
                                                      <td className="p-2 text-xs text-[#93a4d6]">
                                                        {Number.isFinite(entryTs)
                                                          ? new Date(entryTs).toLocaleString()
                                                          : "—"}
                                                      </td>
                                                      <td className="p-2 text-xs">
                                                        <span className="px-2 py-0.5 rounded text-xs font-semibold bg-purple-500/20 text-purple-300">
                                                          EXIT
                                                        </span>
                                                      </td>
                                                      <td className="p-2 text-xs text-[#93a4d6]">
                                                        {Number.isFinite(exitTs)
                                                          ? new Date(exitTs).toLocaleString()
                                                          : "—"}
                                                      </td>
                                                      <td className="p-2">
                                                        <span
                                                          className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                                            t.direction === "LONG"
                                                              ? "bg-green-500/20 text-green-400"
                                                              : "bg-red-500/20 text-red-400"
                                                          }`}
                                                        >
                                                          {t.direction}
                                                        </span>
                                                      </td>
                                                      <td className="p-2 text-xs">
                                                        {metrics.isFutures
                                                          ? metrics.shares.toFixed(0)
                                                          : metrics.shares.toFixed(4)}
                                                      </td>
                                                      <td className="p-2 text-xs text-[#93a4d6]">
                                                        {Number.isFinite(exitPrice)
                                                          ? fmtUsd(exitPrice)
                                                          : "—"}
                                                      </td>
                                                      <td className="p-2 text-sm">
                                                        <span className={`font-semibold ${pnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                                          {fmtUsd(pnl)}
                                                        </span>
                                                      </td>
                                                      <td className="p-2 text-xs text-[#93a4d6]">{t.status}</td>
                                                    </tr>
                                                  );
                                                })}
                                              </tbody>
                                            </table>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}

                            <div className="mt-3 flex items-center justify-between">
                              <div className="text-xs text-[#93a4d6]">
                                Showing {ledgerTrades.items.length}
                              </div>
                              <div className="flex items-center gap-2">
                                <button
                                  onClick={() => ledgerTrades.refetch()}
                                  className="px-3 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-[#93a4d6] hover:text-white"
                                >
                                  Refresh
                                </button>
                                <button
                                  onClick={() => ledgerTrades.fetchMore()}
                                  disabled={!ledgerTrades.hasMore || ledgerTrades.loadingMore}
                                  className="px-3 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-[#93a4d6] hover:text-white disabled:opacity-50"
                                >
                                  {ledgerTrades.loadingMore ? "Loading…" : ledgerTrades.hasMore ? "Load more" : "No more"}
                                </button>
                              </div>
                            </div>
                          </>
                        )}
                      </div>

                      {/* Right Rail - Unified Detail View */}
                      {(selectedTicker || selectedTrade) && (
                        <div className="fixed right-0 top-0 w-[450px] h-screen bg-[#0f1630] border-l border-[#26325f] z-40 slide-in-right shadow-2xl overflow-y-auto">
                          <TickerDetailsLoader
                            tickerSymbol={selectedTrade ? selectedTrade.ticker : selectedTicker}
                            trade={selectedTrade}
                            onClose={() => {
                              setSelectedTrade(null);
                              setSelectedTicker(null);
                            }}
                            allLoadedData={data}
                            sectors={sectors}
                            rankedTickers={rankedTickers}
                            rankedTickerPositions={rankedTickerPositions}
                          />
                        </div>
                      )}
                    </div>
                  )}

                  {ledgerTab === "alerts" && (
                    <div>
                      {ledgerAlerts.loading ? (
                        <div className="text-sm text-[#93a4d6]">Loading alerts…</div>
                      ) : ledgerAlerts.error ? (
                        <div className="text-sm text-red-400">
                          Ledger alerts unavailable: {ledgerAlerts.error}
                        </div>
                      ) : (
                        <>
                          <div className="overflow-x-auto -mx-4 px-4">
                            <table className="w-full min-w-full">
                              <thead>
                                <tr className="border-b border-[#26325f] text-left">
                                  <th className="p-2 text-xs text-[#93a4d6]">Time</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">Ticker</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">Side</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">Rank</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">RR</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">Trigger</th>
                                  <th className="p-2 text-xs text-[#93a4d6]">Discord</th>
                                </tr>
                              </thead>
                              <tbody>
                                {ledgerAlerts.items.length === 0 ? (
                                  <tr>
                                    <td colSpan="7" className="p-6 text-center text-[#93a4d6]">
                                      No ledger alerts found for this filter/range.
                                    </td>
                                  </tr>
                                ) : (
                                  ledgerAlerts.items.map((a) => (
                                    <tr key={a.alert_id} className="border-b border-[#26325f]/50">
                                      <td className="p-2 text-xs text-[#93a4d6]">{a.ts ? new Date(Number(a.ts)).toLocaleString() : "—"}</td>
                                      <td className="p-2 font-semibold">{a.ticker}</td>
                                      <td className="p-2 text-sm">{a.side || "—"}</td>
                                      <td className="p-2 text-sm text-blue-400 font-semibold">{a.rank ?? "—"}</td>
                                      <td className="p-2 text-sm">{a.rr_at_alert != null ? Number(a.rr_at_alert).toFixed(2) : "—"}</td>
                                      <td className="p-2 text-xs text-[#93a4d6]">{a.trigger_reason || "—"}</td>
                                      <td className="p-2 text-xs">
                                        {a.discord_sent ? (
                                          <span className="text-green-400 font-semibold">Sent</span>
                                        ) : (
                                          <span className="text-yellow-400">{a.discord_error || "Skipped"}</span>
                                        )}
                                      </td>
                                    </tr>
                                  ))
                                )}
                              </tbody>
                            </table>
                          </div>

                          <div className="mt-3 flex items-center justify-between">
                            <div className="text-xs text-[#93a4d6]">
                              Showing {ledgerAlerts.items.length}
                            </div>
                            <div className="flex items-center gap-2">
                              <button
                                onClick={() => ledgerAlerts.refetch()}
                                className="px-3 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-[#93a4d6] hover:text-white"
                              >
                                Refresh
                              </button>
                              <button
                                onClick={() => ledgerAlerts.fetchMore()}
                                disabled={!ledgerAlerts.hasMore || ledgerAlerts.loadingMore}
                                className="px-3 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-[#93a4d6] hover:text-white disabled:opacity-50"
                              >
                                {ledgerAlerts.loadingMore ? "Loading…" : ledgerAlerts.hasMore ? "Load more" : "No more"}
                              </button>
                            </div>
                          </div>
                        </>
                      )}
                    </div>
                  )}

                  {ledgerTab === "proof" && (
                    <div>
                      {ledgerSummary.loading ? (
                        <div className="text-sm text-[#93a4d6]">Loading proof metrics…</div>
                      ) : ledgerSummary.error ? (
                        <div className="text-sm text-red-400">
                          Ledger summary unavailable: {ledgerSummary.error}
                        </div>
                      ) : ledgerSummary.data ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                            <div className="text-xs text-[#93a4d6] mb-2">Totals (closed trades)</div>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                              <div>
                                <div className="text-xs text-[#93a4d6]">Closed trades</div>
                                <div className="text-lg font-bold">{ledgerSummary.data.totals.closedTrades}</div>
                              </div>
                              <div>
                                <div className="text-xs text-[#93a4d6]">Win rate</div>
                                <div className="text-lg font-bold">{ledgerSummary.data.totals.winRate.toFixed(1)}%</div>
                              </div>
                              <div>
                                <div className="text-xs text-[#93a4d6]">Closed P&L</div>
                                <div className={`text-lg font-bold ${ledgerSummary.data.totals.closedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                  ${ledgerSummary.data.totals.closedPnl.toFixed(2)}
                                </div>
                              </div>
                              <div>
                                <div className="text-xs text-[#93a4d6]">Profit factor</div>
                                <div className="text-lg font-bold">{Number(ledgerSummary.data.totals.profitFactor).toFixed(2)}</div>
                              </div>
                            </div>
                          </div>

                          <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                            <div className="text-xs text-[#93a4d6] mb-2">Calibration by Rank</div>
                            <div className="space-y-1 text-xs">
                              {(ledgerSummary.data.breakdown.byRank || []).map((r) => {
                                const n = Number(r.n || 0);
                                const wr = n > 0 ? (Number(r.wins || 0) / n) * 100 : 0;
                                return (
                                  <div key={r.bucket} className="flex items-center justify-between">
                                    <span className="text-[#93a4d6]">{r.bucket}</span>
                                    <span className="font-semibold">
                                      {r.wins}W/{r.losses}L ({wr.toFixed(1)}%) ${Number(r.pnl || 0).toFixed(2)}
                                    </span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4 md:col-span-2">
                            <div className="text-xs text-[#93a4d6] mb-2">Calibration by RR</div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                              {(ledgerSummary.data.breakdown.byRR || []).map((r) => {
                                const n = Number(r.n || 0);
                                const wr = n > 0 ? (Number(r.wins || 0) / n) * 100 : 0;
                                return (
                                  <div key={r.bucket} className="flex items-center justify-between bg-[#121a33] border border-[#26325f] rounded px-3 py-2">
                                    <span className="text-[#93a4d6]">{r.bucket}</span>
                                    <span className="font-semibold">
                                      {r.wins}W/{r.losses}L ({wr.toFixed(1)}%) ${Number(r.pnl || 0).toFixed(2)}
                                    </span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                            <div className="text-xs text-[#93a4d6] mb-2">Outcomes by Exit Reason</div>
                            <div className="space-y-1 text-xs">
                              {(ledgerSummary.data.breakdown.byExitReason || []).map((r) => {
                                const n = Number(r.n || 0);
                                const wr = n > 0 ? (Number(r.wins || 0) / n) * 100 : 0;
                                return (
                                  <div key={r.reason} className="flex items-center justify-between">
                                    <span className="text-[#93a4d6]">{r.reason}</span>
                                    <span className="font-semibold">
                                      {r.wins}W/{r.losses}L ({wr.toFixed(1)}%) ${Number(r.pnl || 0).toFixed(2)}
                                    </span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                            <div className="text-xs text-[#93a4d6] mb-2">Alerts by Trigger Reason</div>
                            <div className="space-y-1 text-xs">
                              {(ledgerSummary.data.breakdown.byTriggerReason || []).map((r) => (
                                <div key={r.reason} className="flex items-center justify-between">
                                  <span className="text-[#93a4d6]">{r.reason}</span>
                                  <span className="font-semibold">
                                    {r.sent} sent / {r.not_sent} skipped ({r.n} total)
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div className="text-sm text-[#93a4d6]">No proof data available.</div>
                      )}
                    </div>
                  )}
                </div>

              {/* Daily Summary Modal */}
              {showSummary && dailySummary && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="flex items-center justify-between mb-4">
                      <h2 className="text-2xl font-bold">📊 Daily Summary - {new Date(dailySummary.stats.date).toLocaleDateString()}</h2>
                      <button
                        onClick={() => setShowSummary(false)}
                        className="text-[#93a4d6] hover:text-white text-xl"
                      >
                        ✕
                      </button>
                    </div>
                    
                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">New Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.newTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Closed Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.closedTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Trimmed Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.trimmedTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Win Rate</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.winRate >= 50 ? "text-green-400" : "text-red-400"}`}>
                          {dailySummary.stats.winRate}%
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Closed P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.closedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          ${dailySummary.stats.closedPnl}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Open P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.openPnl >= 0 ? "text-green-400" : "text-yellow-400"}`}>
                          ${dailySummary.stats.openPnl}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Total P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          ${dailySummary.stats.totalPnl}
                        </div>
                      </div>
                    </div>

                    {/* AI Summary */}
                    <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-6 mb-4">
                      <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                        <span className="text-2xl">🤖</span>
                        <span>AI Analysis & Recommendations</span>
                      </h3>
                      <div className="text-sm text-[#e7ecff] leading-relaxed">
                        {(() => {
                          // Enhanced markdown renderer
                          const renderMarkdown = (text) => {
                            const parts = [];
                            let currentIndex = 0;
                            
                            // Split by double newlines for paragraphs
                            const paragraphs = text.split(/\n\n+/);
                            
                            return paragraphs.map((paragraph, pIdx) => {
                              if (!paragraph.trim()) return null;
                              
                              // Headers (## or ###)
                              const headerMatch = paragraph.trim().match(/^(#{2,3})\s+(.+)$/m);
                              if (headerMatch) {
                                const level = headerMatch[1].length;
                                const content = headerMatch[2];
                                return React.createElement(
                                  level === 2 ? 'h2' : 'h3',
                                  {
                                    key: pIdx,
                                    className: level === 2
                                      ? 'text-lg font-bold mt-6 mb-3 text-white border-b border-[#26325f] pb-2 first:mt-0'
                                      : 'text-base font-semibold mt-4 mb-2 text-white'
                                  },
                                  content
                                );
                              }
                              
                              // Lists (bulleted or numbered)
                              if (paragraph.trim().match(/^[-*•]\s+/m) || paragraph.trim().match(/^\d+\.\s+/m)) {
                                const listItems = paragraph.split('\n').filter(l => l.trim());
                                const isOrdered = listItems[0]?.trim().match(/^\d+\./);
                                
                                return React.createElement(
                                  isOrdered ? 'ol' : 'ul',
                                  {
                                    key: pIdx,
                                    className: 'list-none space-y-2 my-3 ml-4'
                                  },
                                  listItems.map((item, iIdx) => {
                                    const cleanItem = item.replace(/^[-*•]\s+/, '').replace(/^\d+\.\s+/, '');
                                    return React.createElement('li', {
                                      key: iIdx,
                                      className: 'flex items-start gap-2'
                                    }, [
                                      React.createElement('span', {
                                        key: 'bullet',
                                        className: 'text-blue-400 mt-1.5 flex-shrink-0'
                                      }, isOrdered ? `${iIdx + 1}.` : '•'),
                                      React.createElement('span', {
                                        key: 'content',
                                        className: 'flex-1',
                                        dangerouslySetInnerHTML: {
                                          __html: formatInlineMarkdown(cleanItem)
                                        }
                                      })
                                    ]);
                                  })
                                );
                              }
                              
                              // Regular paragraph
                              return React.createElement('div', {
                                key: pIdx,
                                className: 'mb-4 last:mb-0'
                              }, paragraph.split('\n').map((line, lIdx) => {
                                if (!line.trim()) {
                                  return React.createElement('br', { key: lIdx });
                                }
                                
                                // Check for special formatting patterns
                                const isBoldLine = line.match(/^\*\*(.+)\*\*$/);
                                if (isBoldLine) {
                                  return React.createElement('p', {
                                    key: lIdx,
                                    className: 'font-semibold text-white mb-2'
                                  }, isBoldLine[1]);
                                }
                                
                                // Check for emoji-prefixed lines (opportunities, warnings, etc.)
                                const emojiMatch = line.match(/^([🎯⚠️📊💡🚀]+)\s+(.+)$/);
                                if (emojiMatch) {
                                  const emoji = emojiMatch[1];
                                  const content = emojiMatch[2];
                                  const bgColor = emoji.includes('🎯') ? 'bg-blue-500/10 border-blue-500/30' :
                                                  emoji.includes('⚠️') ? 'bg-yellow-500/10 border-yellow-500/30' :
                                                  emoji.includes('📊') ? 'bg-purple-500/10 border-purple-500/30' :
                                                  emoji.includes('💡') ? 'bg-green-500/10 border-green-500/30' :
                                                  'bg-[#26325f]/50 border-[#26325f]';
                                  
                                  return React.createElement('div', {
                                    key: lIdx,
                                    className: `flex items-start gap-3 p-3 rounded-lg border ${bgColor} mb-2`
                                  }, [
                                    React.createElement('span', {
                                      key: 'emoji',
                                      className: 'text-xl flex-shrink-0'
                                    }, emoji),
                                    React.createElement('div', {
                                      key: 'content',
                                      className: 'flex-1',
                                      dangerouslySetInnerHTML: {
                                        __html: formatInlineMarkdown(content)
                                      }
                                    })
                                  ]);
                                }
                                
                                return React.createElement('p', {
                                  key: lIdx,
                                  className: 'mb-2 leading-relaxed',
                                  dangerouslySetInnerHTML: {
                                    __html: formatInlineMarkdown(line) || '&nbsp;'
                                  }
                                });
                              }));
                            });
                          };
                          
                          // Format inline markdown (bold, code, links, etc.)
                          const formatInlineMarkdown = (text) => {
                            let formatted = text;
                            
                            // Bold (**text**)
                            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');
                            
                            // Inline code (`code`)
                            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-[#26325f] px-1.5 py-0.5 rounded text-xs font-mono text-blue-300">$1</code>');
                            
                            // Links [text](url) - not common in AI responses but good to have
                            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank" rel="noopener noreferrer">$1</a>');
                            
                            // Ticker symbols (uppercase 2-5 letter codes)
                            formatted = formatted.replace(/\b([A-Z]{2,5})\b/g, '<span class="font-semibold text-blue-300">$1</span>');
                            
                            // Numbers with $ (prices)
                            formatted = formatted.replace(/\$(\d+\.?\d*)/g, '<span class="text-green-400 font-medium">$$1</span>');
                            
                            // Percentages
                            formatted = formatted.replace(/(\d+\.?\d*)%/g, '<span class="text-yellow-400 font-medium">$1%</span>');
                            
                            // RR ratios (X:1 or 1:X)
                            formatted = formatted.replace(/(\d+\.?\d*):1/g, '<span class="text-purple-400 font-medium">$1:1</span>');
                            
                            // Table separators (|)
                            formatted = formatted.replace(/\|/g, '<span class="text-[#6b7a9f] mx-1">|</span>');
                            
                            return formatted;
                          };
                          
                          return renderMarkdown(dailySummary.summary);
                        })()}
                      </div>
                    </div>

                    {/* Performance Breakdown */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                        <h4 className="text-sm font-semibold mb-2">Performance by Rank</h4>
                        <div className="space-y-1 text-xs">
                          {Object.entries(dailySummary.stats.rankAnalysis || {}).map(([range, stats]) => (
                            <div key={range} className="flex justify-between">
                              <span className="text-[#93a4d6]">{range}:</span>
                              <span className={`font-semibold ${stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                {stats.wins}W/{stats.losses}L (${stats.totalPnl.toFixed(2)})
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                        <h4 className="text-sm font-semibold mb-2">Performance by RR</h4>
                        <div className="space-y-1 text-xs">
                          {Object.entries(dailySummary.stats.rrAnalysis || {}).map(([range, stats]) => (
                            <div key={range} className="flex justify-between">
                              <span className="text-[#93a4d6]">{range}:</span>
                              <span className={`font-semibold ${stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                {stats.wins}W/{stats.losses}L (${stats.totalPnl.toFixed(2)})
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {false && (
                <>
              {/* Trade Tracker Section with Date Filter */}
              <div className="mb-6">
                <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold text-white">📊 Trade Tracker</h2>
                    <div className="flex items-center gap-3">
                      {/* Date Range Filter */}
                      <div className="flex items-center gap-2">
                        <label className="text-xs text-[#93a4d6]">From:</label>
                        <input
                          type="date"
                          value={tradeDateRange.startDate}
                          onChange={(e) => {
                            setTradeDateRange(prev => ({ ...prev, startDate: e.target.value }));
                          }}
                          className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white"
                        />
                        <label className="text-xs text-[#93a4d6]">To:</label>
                        <input
                          type="date"
                          value={tradeDateRange.endDate}
                          onChange={(e) => {
                            setTradeDateRange(prev => ({ ...prev, endDate: e.target.value }));
                          }}
                          className="px-2 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-white"
                        />
                      </div>
                      <button
                        onClick={() => {
                          const today = new Date();
                          setTradeDateRange({
                            startDate: today.toISOString().split('T')[0],
                            endDate: today.toISOString().split('T')[0],
                          });
                        }}
                        className="px-3 py-1 text-xs bg-[#0f1630] border border-[#26325f] rounded text-[#93a4d6] hover:text-white hover:border-[#3a4a7a] transition-colors"
                      >
                        Today
                      </button>
                    </div>
                  </div>
                  
                  {/* Trade List */}
                  <div className="space-y-2 max-h-[400px] overflow-y-auto">
                    {(() => {
                      const tradesSource = filteredTradesWithLivePrices;
                      const tradesInDateRange = tradesSource && tradesSource.length > 0 ? tradesSource.filter((trade) => {
                        if (!trade.entryTime) return false;
                        const entryDate = new Date(trade.entryTime);
                        const startDate = new Date(tradeDateRange.startDate);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(tradeDateRange.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        return entryDate >= startDate && entryDate <= endDate;
                      }).sort((a, b) => {
                        const timeA = new Date(a.entryTime || 0).getTime();
                        const timeB = new Date(b.entryTime || 0).getTime();
                        return timeB - timeA; // Newest first
                      }) : [];
                      
                      return tradesInDateRange.length > 0 ? (
                        tradesInDateRange.map((trade) => (
                          <div
                            key={trade.id || `${trade.ticker}-${trade.entryTime}`}
                            className="bg-[#0f1630] border border-[#26325f] rounded p-3 hover:border-[#3a4a7a] transition-colors cursor-pointer"
                            onClick={() => {
                              setSelectedTicker(trade.ticker);
                              setSelectedTrade(trade);
                            }}
                          >
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <span className="font-semibold text-white">{trade.ticker}</span>
                                <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                  trade.direction === "LONG" 
                                    ? "bg-green-500/20 text-green-400" 
                                    : "bg-red-500/20 text-red-400"
                                }`}>
                                  {trade.direction || "—"}
                                </span>
                                <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                  trade.status === "WIN" 
                                    ? "bg-green-500/20 text-green-400"
                                    : trade.status === "LOSS"
                                    ? "bg-red-500/20 text-red-400"
                                    : trade.status === "TP_HIT_TRIM"
                                    ? "bg-blue-500/20 text-blue-400"
                                    : "bg-yellow-500/20 text-yellow-400"
                                }`}>
                                  {trade.status || "OPEN"}
                                </span>
                              </div>
                              <div className={`text-sm font-semibold ${
                                trade.pnl >= 0 ? "text-green-400" : "text-red-400"
                              }`}>
                                ${trade.pnl?.toFixed(2) || "0.00"}
                              </div>
                            </div>
                            <div className="flex items-center justify-between text-xs text-[#93a4d6]">
                              <span>Entry: ${trade.entryPrice?.toFixed(2) || "—"}</span>
                              <span className="text-yellow-400">
                                Current: ${(trade.currentPrice || trade.entryPrice)?.toFixed(2) || "—"}
                              </span>
                              <span>RR: {trade.rr?.toFixed(2) || "—"}</span>
                              <span>Rank: {trade.rank || "—"}</span>
                              {trade.entryTime && (
                                <span>
                                  {new Date(trade.entryTime).toLocaleTimeString('en-US', {
                                    hour: 'numeric',
                                    minute: '2-digit',
                                    hour12: true
                                  })}
                                </span>
                              )}
                            </div>
                          </div>
                        ))
                      ) : (
                        <div className="text-center text-[#93a4d6] py-8">
                          No trades in selected date range
                        </div>
                      );
                    })()}
                  </div>
                  {filteredTradesWithLivePrices && filteredTradesWithLivePrices.length > 0 && (() => {
                    const filteredTrades = filteredTradesWithLivePrices.filter((trade) => {
                      if (!trade.entryTime) return false;
                      const entryDate = new Date(trade.entryTime);
                      const startDate = new Date(tradeDateRange.startDate);
                      startDate.setHours(0, 0, 0, 0);
                      const endDate = new Date(tradeDateRange.endDate);
                      endDate.setHours(23, 59, 59, 999);
                      return entryDate >= startDate && entryDate <= endDate;
                    });
                    return filteredTrades.length > 0 && (
                      <div className="mt-3 pt-3 border-t border-[#26325f] text-xs text-[#93a4d6] text-center">
                        Showing {filteredTrades.length} trade{filteredTrades.length !== 1 ? 's' : ''} in selected range
                      </div>
                    );
                  })()}
                </div>
              </div>

                  {/* Trades Table with Right Rail Detail View */}
                  <div className="flex gap-4 items-start relative">
                {/* Table Container - Left Side */}
                <div className={`flex-1 bg-[#121a33] border border-[#26325f] rounded-xl p-4 transition-all ${selectedTicker ? 'mr-[470px]' : ''}`}>
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold">Simulated Trades</h2>
                    <div className="flex gap-2 text-sm">
                      <span className="px-3 py-1 rounded bg-[#0f1630]">
                        Open: {openTrades.length}
                      </span>
                      <span className="px-3 py-1 rounded bg-[#0f1630]">
                        Closed: {closedTrades.length}
                      </span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2 mb-3 text-xs">
                    {[
                      { key: "ALL", label: "All" },
                      { key: "SHORT_TERM", label: "Short-Term" },
                      { key: "SWING", label: "Swing" },
                      { key: "POSITIONAL", label: "Positional" },
                    ].map((tab) => (
                      <button
                        key={tab.key}
                        onClick={() => setHorizonFilter(tab.key)}
                        className={`px-3 py-1 rounded border transition-all ${
                          horizonFilter === tab.key
                            ? "border-blue-400 bg-blue-500/20 text-blue-200"
                            : "border-[#26325f] bg-[#0f1630] text-[#93a4d6] hover:text-white"
                        }`}
                      >
                        {tab.label}
                      </button>
                    ))}
                  </div>
                  <div className="overflow-x-auto -mx-4 px-4">
                    <table className="w-full min-w-full">
                      <thead>
                        <tr className="border-b border-[#26325f] text-left">
                          <th className="p-2 text-xs text-[#93a4d6]">Ticker</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Direction</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Entry</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Current</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Entry Time</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Qty</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Market Value</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Trimmed</th>
                          <th className="p-2 text-xs text-[#93a4d6]">SL</th>
                          <th className="p-2 text-xs text-[#93a4d6]">TP Target</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Return %</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Risk %</th>
                          <th className="p-2 text-xs text-[#93a4d6]">ETA</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Horizon</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Div</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Corr</th>
                          <th className="p-2 text-xs text-[#93a4d6]">RR</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Score</th>
                          <th className="p-2 text-xs text-[#93a4d6]">P&L</th>
                          <th className="p-2 text-xs text-[#93a4d6]">P&L %</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Status</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Version</th>
                        </tr>
                      </thead>
                      <tbody>
                        {tradesForDisplay.length === 0 ? (
                          <tr>
                            <td colSpan="22" className="p-8 text-center text-[#93a4d6]">
                              {selectedVersion === "all" 
                                ? "No trades yet. Trades will be automatically created when alerts trigger."
                                : `No trades found for version ${selectedVersion}.`}
                            </td>
                          </tr>
                        ) : (
                          tradesForDisplay.map((trade) => {
                            const sym = String(trade.ticker || "").toUpperCase();
                            const tickerData = data && (data[sym] || data[trade.ticker]);
                            return (
                            <TradeRow 
                              key={trade.id} 
                              trade={trade}
                              tickerData={tickerData}
                              onTickerClick={(ticker) => {
                                setSelectedTicker(ticker);
                                setSelectedTrade(null); // Clear trade selection when selecting ticker
                              }}
                              onTradeClick={(trade) => {
                                // When clicking a trade, show both ticker and trade
                                setSelectedTicker(trade.ticker);
                                setSelectedTrade(trade);
                              }}
                            />
                          );
                          })
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Right Rail - Detail View (slides in from right, fixed to viewport) */}
                {(selectedTicker || selectedTrade) && (
                  <div className="fixed right-0 top-0 w-[450px] h-screen bg-[#0f1630] border-l border-[#26325f] z-40 slide-in-right shadow-2xl overflow-y-auto">
                    <TickerDetailsLoader 
                      tickerSymbol={selectedTrade ? selectedTrade.ticker : selectedTicker}
                      trade={selectedTrade}
                      onClose={() => {
                        setSelectedTrade(null);
                        setSelectedTicker(null);
                      }}
                      allLoadedData={data}
                      sectors={sectors}
                      rankedTickers={rankedTickers}
                      rankedTickerPositions={rankedTickerPositions}
                    />
                  </div>
                )}
                  </div>
                </>
              )}
            </div>
          </div>
          </>
        );
      }

      // Render
      try {
        if (typeof React === "undefined" || typeof ReactDOM === "undefined") {
          throw new Error("React or ReactDOM not loaded");
        }

        const rootElement = document.getElementById("root");
        if (!rootElement) {
          throw new Error("Root element not found");
        }

        if (ReactDOM.createRoot) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(<App />);
        } else {
          ReactDOM.render(<App />, rootElement);
        }
      } catch (error) {
        console.error("Error rendering app:", error);
        document.getElementById("root").innerHTML = `
          <div style="padding: 40px; text-align: center; color: #e7ecff;">
            <h2 style="color: #e74c3c;">Error Loading Dashboard</h2>
            <p>${error.message}</p>
            <p style="margin-top: 20px; color: #93a4d6;">
              Please check the browser console (F12) for details.
            </p>
          </div>
        `;
      }
    </script>
  </body>
</html>

