<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>Daily Brief — Timed Trading</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2300c853'/%3E%3Cstop offset='50%25' stop-color='%2300e676'/%3E%3Cstop offset='100%25' stop-color='%2369f0ae'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='24' height='24' rx='5.5' fill='url(%23g)'/%3E%3Cpolyline points='22 7 13.5 15.5 8.5 10.5 2 17' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpolyline points='16 7 22 7 22 13' fill='none' stroke='white' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="auth-gate.js?v=20260219a"></script>
    <style>
      :root {
        --tt-bg-base: #0b0e11;
        --tt-bg-surface: rgba(255,255,255,0.02);
        --tt-bg-elevated: rgba(255,255,255,0.035);
        --tt-bg-hover: rgba(255,255,255,0.04);
        --tt-border: rgba(255,255,255,0.04);
        --tt-border-strong: rgba(255,255,255,0.08);
        --tt-text: #e5e7eb;
        --tt-text-muted: #6b7280;
        --tt-text-faint: #4b5563;
        /* Brand colors — aligned with main app (index-react.html) */
        --tt-accent: #14b8a6;
        --tt-accent-dim: rgba(20, 184, 166, 0.12);
        --tt-negative: #e11d48;
        --tt-negative-dim: rgba(225, 29, 72, 0.12);
        /* Chart candle colors — standardized across all charts */
        --tt-candle-up: #22c55e;
        --tt-candle-down: #ef4444;
        --tt-amber: #f59e0b;
        --tt-amber-dim: rgba(245, 158, 11, 0.12);
        --tt-indigo: #6366f1;
        --tt-indigo-dim: rgba(99, 102, 241, 0.12);
        --tt-radius: 12px;
        --tt-radius-sm: 8px;
        --tt-font: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --tt-shadow-sm: 0 1px 2px rgba(0,0,0,0.15);
        --tt-shadow-md: 0 2px 8px rgba(0,0,0,0.12);
        --tt-shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
      }
      body {
        background: var(--tt-bg-base);
        color: var(--tt-text);
        font-family: var(--tt-font);
        -webkit-font-smoothing: antialiased;
        margin: 0;
      }
      .tt-card {
        background: var(--tt-bg-surface);
        border: 1px solid var(--tt-border);
        border-radius: var(--tt-radius);
      }
      .loading-spinner {
        width: 28px; height: 28px;
        position: relative; display: inline-block;
      }
      .loading-spinner::before {
        content: ""; position: absolute; inset: 0; border-radius: 6px;
        background: linear-gradient(135deg, rgba(0,200,83,0.15), rgba(0,200,83,0.04));
        animation: tt-loader-pulse 1.6s ease-in-out infinite;
      }
      .loading-spinner::after {
        content: ""; position: absolute; left: 3px; right: 3px; top: 50%; height: 2px;
        background: linear-gradient(90deg, transparent, #00c853, #00e676, #69f0ae, transparent);
        background-size: 200% 100%; border-radius: 1px;
        animation: tt-loader-sweep 1.2s ease-in-out infinite;
      }
      @keyframes tt-loader-pulse { 0%, 100% { opacity: 0.4; transform: scale(0.92); } 50% { opacity: 1; transform: scale(1); } }
      @keyframes tt-loader-sweep { 0% { background-position: -100% 0; opacity: 0.5; } 50% { opacity: 1; } 100% { background-position: 200% 0; opacity: 0.5; } }
      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes pulse-badge {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.15); }
      }
      .badge-pulse { animation: pulse-badge 2s ease-in-out infinite; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
      body:not([data-user-role="admin"]) a[data-admin-only] {
        display: none !important;
      }
      /* Markdown styling for brief content */
      .brief-content h2 {
        font-size: 15px;
        font-weight: 600;
        color: #e5e7eb;
        margin: 20px 0 8px 0;
        padding-bottom: 6px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }
      .brief-content h3 {
        font-size: 13px;
        font-weight: 600;
        color: #d1d5db;
        margin: 16px 0 6px 0;
      }
      .brief-content p {
        font-size: 13px;
        line-height: 1.7;
        color: #9ca3af;
        margin: 6px 0;
      }
      .brief-content ul, .brief-content ol {
        font-size: 13px;
        line-height: 1.7;
        color: #9ca3af;
        margin: 6px 0;
        padding-left: 20px;
      }
      .brief-content li { margin: 3px 0; }
      .brief-content strong { color: #e5e7eb; }
      .brief-content em { color: #d1d5db; }
      .brief-content code {
        background: rgba(255,255,255,0.05);
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 12px;
        color: #f59e0b;
      }
      .brief-content blockquote {
        border-left: 3px solid rgba(245, 158, 11, 0.4);
        padding-left: 12px;
        margin: 12px 0;
        color: #9ca3af;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, useRef } = React;

      const API_BASE = "";

      // ── Markdown Renderer ──────────────────────────────────────────────────
      function renderMarkdown(md) {
        if (!md) return "";
        if (typeof marked !== "undefined" && marked.parse) {
          return marked.parse(md, { breaks: true, gfm: true });
        }
        // Fallback: basic line breaks
        return md.replace(/\n/g, "<br/>");
      }

      // ── Brief Card Component ───────────────────────────────────────────────
      function BriefCard({ brief, type }) {
        if (!brief) return null;
        const isMorning = type === "morning";
        const accentColor = isMorning ? "var(--tt-amber)" : "var(--tt-indigo)";
        const bgDim = isMorning ? "var(--tt-amber-dim)" : "var(--tt-indigo-dim)";
        const icon = isMorning ? "\u2600\uFE0F" : "\uD83C\uDF19";
        const label = isMorning ? "Morning Brief" : "Evening Brief";
        const time = brief.publishedAt
          ? new Date(brief.publishedAt).toLocaleString("en-US", { timeZone: "America/New_York", hour: "numeric", minute: "2-digit", hour12: true })
          : "";

        return (
          <div className="tt-card p-6 mb-4">
            <div className="flex items-center gap-3 mb-4">
              <div style={{ background: bgDim, color: accentColor }} className="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-semibold">
                {icon}
              </div>
              <div>
                <div className="text-[14px] font-semibold text-white">{label}</div>
                {time && <div className="text-[11px] text-[#6b7280]">Published at {time} ET</div>}
              </div>
              {brief.esPrediction && (
                <div className="ml-auto px-3 py-1 rounded-full text-[11px] font-medium" style={{ background: bgDim, color: accentColor }}>
                  {brief.esPrediction.slice(0, 80)}{brief.esPrediction.length > 80 ? "..." : ""}
                </div>
              )}
            </div>
            <div className="brief-content" dangerouslySetInnerHTML={{ __html: renderMarkdown(brief.content) }} />
          </div>
        );
      }

      // ── Placeholder Component ──────────────────────────────────────────────
      function BriefPlaceholder({ type }) {
        const isMorning = type === "morning";
        const label = isMorning ? "Morning Brief" : "Evening Brief";
        const time = isMorning ? "9:00 AM" : "5:00 PM";
        const icon = isMorning ? "\u2600\uFE0F" : "\uD83C\uDF19";
        return (
          <div className="tt-card p-6 mb-4">
            <div className="flex items-center gap-3 mb-3">
              <div className="w-8 h-8 rounded-lg flex items-center justify-center text-sm bg-white/[0.03] text-[#4b5563]">
                {icon}
              </div>
              <div className="text-[14px] font-semibold text-[#4b5563]">{label}</div>
            </div>
            <div className="text-[13px] text-[#4b5563] leading-relaxed">
              The {label.toLowerCase()} is being prepared and will be available by <span className="text-[#6b7280] font-medium">{time} ET</span>.
            </div>
            <div className="mt-4 flex gap-3">
              {[1, 2, 3].map(i => (
                <div key={i} className="flex-1 h-2 rounded-full bg-white/[0.03] overflow-hidden">
                  <div className="h-full bg-white/[0.04] rounded-full" style={{ width: `${30 + i * 20}%`, animation: `pulse-badge ${2 + i * 0.3}s ease-in-out infinite` }} />
                </div>
              ))}
            </div>
          </div>
        );
      }

      // ── Prediction Badge ───────────────────────────────────────────────────
      function PredictionBadge({ value }) {
        if (value === 1) return <span className="text-[11px] font-medium text-[#00c853]" title="ES prediction correct">&#10003;</span>;
        if (value === 0) return <span className="text-[11px] font-medium text-[#ff5252]" title="ES prediction incorrect">&#10007;</span>;
        return <span className="text-[11px] text-[#4b5563]" title="Pending">{"\u23F3"}</span>;
      }

      // ── Archive Tree Component ─────────────────────────────────────────────
      function ArchiveTree({ briefs, onSelect }) {
        const [expandedMonths, setExpandedMonths] = useState({});
        const [expandedDays, setExpandedDays] = useState({});

        // Group by month, then by day
        const tree = useMemo(() => {
          const grouped = {};
          for (const b of briefs) {
            const month = b.date?.slice(0, 7); // YYYY-MM
            const day = b.date; // YYYY-MM-DD
            if (!month || !day) continue;
            if (!grouped[month]) grouped[month] = {};
            if (!grouped[month][day]) grouped[month][day] = [];
            grouped[month][day].push(b);
          }
          return grouped;
        }, [briefs]);

        const months = Object.keys(tree).sort().reverse();

        const toggleMonth = (m) => setExpandedMonths(prev => ({ ...prev, [m]: !prev[m] }));
        const toggleDay = (d) => setExpandedDays(prev => ({ ...prev, [d]: !prev[d] }));

        const fmtMonthLabel = (m) => {
          const [y, mo] = m.split("-");
          const d = new Date(Number(y), Number(mo) - 1, 1);
          return d.toLocaleDateString("en-US", { month: "long", year: "numeric" });
        };

        const fmtDayLabel = (d) => {
          const dt = new Date(d + "T12:00:00");
          const dow = dt.toLocaleDateString("en-US", { weekday: "short" });
          const day = dt.toLocaleDateString("en-US", { month: "short", day: "numeric" });
          return `${dow}, ${day}`;
        };

        if (months.length === 0) {
          return <div className="text-[13px] text-[#4b5563] py-4">No archived briefs yet.</div>;
        }

        return (
          <div className="space-y-1">
            {months.map(month => (
              <div key={month}>
                <button
                  onClick={() => toggleMonth(month)}
                  className="w-full flex items-center gap-2 px-3 py-2 rounded-lg text-[13px] font-medium text-[#9ca3af] hover:bg-white/[0.03] transition-all"
                >
                  <span className="text-[10px] text-[#4b5563]">{expandedMonths[month] ? "\u25BC" : "\u25B6"}</span>
                  {fmtMonthLabel(month)}
                  <span className="text-[11px] text-[#4b5563] ml-auto">{Object.keys(tree[month]).length} days</span>
                </button>
                {expandedMonths[month] && (
                  <div className="ml-4 space-y-0.5">
                    {Object.keys(tree[month]).sort().reverse().map(day => {
                      const dayBriefs = tree[month][day];
                      const morning = dayBriefs.find(b => b.type === "morning");
                      const evening = dayBriefs.find(b => b.type === "evening");
                      return (
                        <div key={day}>
                          <button
                            onClick={() => toggleDay(day)}
                            className="w-full flex items-center gap-2 px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:bg-white/[0.03] transition-all"
                          >
                            <span className="text-[9px] text-[#4b5563]">{expandedDays[day] ? "\u25BC" : "\u25B6"}</span>
                            <span>{fmtDayLabel(day)}</span>
                            <div className="ml-auto flex items-center gap-3">
                              {morning && (
                                <span className="flex items-center gap-1 text-[11px]">
                                  <span className="text-[#f59e0b]">{"\u2600\uFE0F"}</span>
                                  <PredictionBadge value={morning.es_prediction_correct} />
                                </span>
                              )}
                              {evening && (
                                <span className="flex items-center gap-1 text-[11px]">
                                  <span className="text-[#6366f1]">{"\uD83C\uDF19"}</span>
                                  <PredictionBadge value={evening.es_prediction_correct} />
                                </span>
                              )}
                            </div>
                          </button>
                          {expandedDays[day] && (
                            <div className="ml-6 py-1 space-y-1">
                              {morning && (
                                <button
                                  onClick={() => onSelect(morning.id)}
                                  className="w-full text-left px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all flex items-center gap-2"
                                >
                                  <span>{"\u2600\uFE0F"}</span> Morning Brief
                                  <PredictionBadge value={morning.es_prediction_correct} />
                                  {morning.es_prediction && (
                                    <span className="ml-auto text-[10px] text-[#4b5563] truncate max-w-[200px]">{morning.es_prediction}</span>
                                  )}
                                </button>
                              )}
                              {evening && (
                                <button
                                  onClick={() => onSelect(evening.id)}
                                  className="w-full text-left px-3 py-1.5 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all flex items-center gap-2"
                                >
                                  <span>{"\uD83C\uDF19"}</span> Evening Brief
                                  <PredictionBadge value={evening.es_prediction_correct} />
                                </button>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      }

      // ── Mini Chart Component (TradingView Lightweight Charts) ────────────
      // Paired layout: Futures | ETF (2 columns)
      const CHART_SYMBOLS = [
        { sym: "ES1!", label: "ES", color: "#f59e0b" },
        { sym: "SPY", label: "SPY", color: "#00c853" },
        { sym: "NQ1!", label: "NQ", color: "#6366f1" },
        { sym: "QQQ", label: "QQQ", color: "#2196f3" },
        { sym: "RTY1!", label: "RTY", color: "#ec4899" },
        { sym: "IWM", label: "IWM", color: "#e91e63" },
        { sym: "YM1!", label: "YM", color: "#14b8a6" },
        { sym: "DIA", label: "DIA", color: "#06b6d4" },
      ];
      const TF_OPTIONS = [
        { value: "5", label: "5m", limit: 250 },
        { value: "10", label: "10m", limit: 180 },
        { value: "60", label: "1H", limit: 100 },
        { value: "D", label: "D", limit: 60 },
      ];

      // Check if we're currently in Regular Trading Hours (for live update frequency)
      function isMarketOpen() {
        const d = new Date();
        const et = new Date(d.toLocaleString("en-US", { timeZone: "America/New_York" }));
        const day = et.getDay();
        const min = et.getHours() * 60 + et.getMinutes();
        if (day === 0 || day === 6) return false;
        return min >= 570 && min < 960; // 9:30 AM - 4:00 PM ET
      }

      // Stable empty array reference — avoids useEffect re-runs from levels={[]}
      const EMPTY_LEVELS = [];

      function MiniChart({ sym, label, accentColor, tf, limit }) {
        const containerRef = useRef(null);
        const chartRef = useRef(null);
        const seriesRef = useRef(null);
        const firstCandleRef = useRef(null);
        const priceLinesRef = useRef([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastPrice, setLastPrice] = useState(null);
        const [change, setChange] = useState(null);
        const [isLive, setIsLive] = useState(false);

        // Map raw API candles to chart format
        // ETH candles (outside 9:30am-4pm ET) get dimmer colors
        const mapCandles = useCallback((candles) => {
          return candles.map(c => {
            const ts = c.ts / 1000;
            const d = new Date(ts * 1000);
            // Convert to ET minutes-of-day
            const etStr = d.toLocaleString("en-US", { timeZone: "America/New_York", hour12: false, hour: "2-digit", minute: "2-digit" });
            const [hh, mm] = etStr.split(":").map(Number);
            const etMin = hh * 60 + mm;
            // RTH: 9:30am (570min) to 4:00pm (960min) ET
            const isRTH = etMin >= 570 && etMin < 960;
            const up = Number(c.c) >= Number(c.o);
            const mapped = {
              time: ts,
              open: Number(c.o),
              high: Number(c.h),
              low: Number(c.l),
              close: Number(c.c),
            };
            if (!isRTH && tf !== "D" && tf !== "W") {
              // ETH: dimmer, slightly desaturated candles
              mapped.color = up ? "rgba(34,197,94,0.35)" : "rgba(239,68,68,0.35)";
              mapped.borderColor = up ? "rgba(34,197,94,0.45)" : "rgba(239,68,68,0.45)";
              mapped.wickColor = up ? "rgba(34,197,94,0.30)" : "rgba(239,68,68,0.30)";
            }
            return mapped;
          }).filter(c => c.open > 0 && c.high > 0);
        }, [tf]);

        // Fetch candle data from API
        const fetchCandles = useCallback(async (fetchLimit) => {
          const res = await fetch(
            `${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=${tf}&limit=${fetchLimit}`,
            { cache: "no-store" }
          );
          const data = await res.json();
          if (!data.ok || !data.candles || data.candles.length === 0) return [];
          return data.candles;
        }, [sym, tf]);

        // Initial chart setup + full data load
        useEffect(() => {
          let cancelled = false; // prevents stale async from adding duplicate levels

          if (!containerRef.current || typeof LightweightCharts === "undefined") {
            setError("Charts unavailable");
            setLoading(false);
            return;
          }

          // Create chart — styled to match Right Rail (shared-right-rail.js)
          const chart = LightweightCharts.createChart(containerRef.current, {
            width: containerRef.current.clientWidth,
            height: 220,
            layout: {
              background: { type: "solid", color: "#0b0e11" },
              textColor: "#6b7280",
              fontSize: 10,
            },
            grid: {
              vertLines: { color: "rgba(38,50,95,0.35)" },
              horzLines: { color: "rgba(38,50,95,0.35)" },
            },
            crosshair: {
              mode: LightweightCharts.CrosshairMode.Normal,
              vertLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2, labelBackgroundColor: "#1e293b" },
              horzLine: { color: "rgba(255,255,255,0.15)", width: 1, style: 2, labelBackgroundColor: "#1e293b" },
            },
            rightPriceScale: {
              borderColor: "rgba(38,50,95,0.5)",
              scaleMargins: { top: 0.08, bottom: 0.08 },
              autoScale: true,
            },
            timeScale: {
              borderColor: "rgba(38,50,95,0.5)",
              timeVisible: tf !== "D" && tf !== "W",
              secondsVisible: false,
              rightOffset: 3,
              tickMarkFormatter: (time) => {
                // Display in ET (America/New_York)
                try {
                  const d = new Date(time * 1000);
                  return d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", timeZone: "America/New_York" });
                } catch { return ""; }
              },
            },
            localization: {
              timeFormatter: (time) => {
                try {
                  const d = new Date(time * 1000);
                  return d.toLocaleString("en-US", { hour: "numeric", minute: "2-digit", second: "2-digit", timeZone: "America/New_York" });
                } catch { return ""; }
              },
            },
            handleScroll: { vertTouchDrag: false },
          });
          chartRef.current = chart;

          // Candle colors — standardized across all charts
          const candleSeries = chart.addCandlestickSeries({
            upColor: "#22c55e",
            downColor: "#ef4444",
            borderUpColor: "#22c55e",
            borderDownColor: "#ef4444",
            wickUpColor: "#22c55e",
            wickDownColor: "#ef4444",
          });
          seriesRef.current = candleSeries;

          // Initial full load with retry + multi-timeframe fallback chain
          const loadWithRetry = async (retriesLeft = 2) => {
            let raw = await fetchCandles(limit);
            // If selected TF has very few candles, cascade through fallback TFs
            if (raw.length < 5 && (tf === "5" || tf === "10" || tf === "30" || tf === "60")) {
              // Try 1m with more data
              const fallback1mRes = await fetch(
                `${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=1&limit=500`,
                { cache: "no-store" }
              ).catch(() => null);
              if (fallback1mRes) {
                const fallback1mData = await fallback1mRes.json().catch(() => ({}));
                if (fallback1mData.ok && fallback1mData.candles?.length > raw.length) {
                  raw = fallback1mData.candles;
                }
              }
            }
            // If still no data, try daily as last resort
            if (raw.length < 2) {
              const fallbackDRes = await fetch(
                `${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=D&limit=30`,
                { cache: "no-store" }
              ).catch(() => null);
              if (fallbackDRes) {
                const fallbackDData = await fallbackDRes.json().catch(() => ({}));
                if (fallbackDData.ok && fallbackDData.candles?.length > raw.length) {
                  raw = fallbackDData.candles;
                }
              }
            }
            if (raw.length === 0 && retriesLeft > 0) {
              await new Promise(r => setTimeout(r, 3000));
              return loadWithRetry(retriesLeft - 1);
            }
            return raw;
          };
          loadWithRetry().then(async (raw) => {
            const mapped = mapCandles(raw);
            if (mapped.length === 0) {
              // Try to show last known price even when chart data is unavailable
              try {
                const latestRes = await fetch(`${API_BASE}/timed/latest?ticker=${encodeURIComponent(sym)}`, { cache: "no-store" });
                const latestData = await latestRes.json();
                if (latestData?.price) {
                  setLastPrice(Number(latestData.price));
                  if (latestData.day_change_pct != null) setChange(Number(latestData.day_change_pct));
                }
              } catch (_) {}
              setError("Chart data unavailable — candles still loading");
              setLoading(false);
              return;
            }

            candleSeries.setData(mapped);
            firstCandleRef.current = mapped[0];
            const lastCandle = mapped[mapped.length - 1];
            setLastPrice(lastCandle.close);
            setChange((lastCandle.close - mapped[0].open) / mapped[0].open * 100);

            // Robust viewport initialization:
            // On first load, the CSS grid may not have finished laying out all 8 chart
            // containers. We use a ResizeObserver to wait for the container to reach its
            // final width, then sync the chart and scroll to the right edge.
            const settleChart = () => {
              if (!chartRef.current || !containerRef.current) return;
              const w = containerRef.current.clientWidth;
              if (w > 0) {
                chartRef.current.applyOptions({ width: w });
              }
              chartRef.current.timeScale().fitContent();
              // After fitContent, nudge to show latest candles near the right edge
              requestAnimationFrame(() => {
                if (chartRef.current) {
                  chartRef.current.timeScale().scrollToPosition(-3, false);
                }
              });
            };

            // Wait for next frame so layout is committed, then settle
            requestAnimationFrame(() => {
              settleChart();
              // Safety net: re-settle after a short delay in case the grid is still
              // reflowing (e.g., images / other charts are still loading)
              setTimeout(settleChart, 250);
            });

            setLoading(false);
            setIsLive(false);

            // Async: fetch daily ATR levels and overlay on intraday charts
            // Use cancelled flag to prevent stale fetches from adding duplicate levels
            if (tf === "5" || tf === "10" || tf === "60") {
              const applyAtrLevels = (fibData) => {
                if (cancelled || !fibData?.levels || !seriesRef.current) return;
                // Remove any existing price lines first
                for (const pl of priceLinesRef.current) {
                  try { seriesRef.current.removePriceLine(pl); } catch (_) {}
                }
                priceLinesRef.current = [];
                for (const lvl of fibData.levels) {
                  const pl = seriesRef.current.createPriceLine({
                    price: lvl.price,
                    color: lvl.color || "rgba(255,255,255,0.2)",
                    lineWidth: lvl.label?.startsWith("Target") || lvl.label?.startsWith("Watch") ? 2 : 1,
                    lineStyle: lvl.label?.startsWith("Target") || lvl.label?.startsWith("Watch")
                      ? LightweightCharts.LineStyle.LargeDashed
                      : LightweightCharts.LineStyle.Dashed,
                    axisLabelVisible: true,
                    title: lvl.label || "",
                  });
                  priceLinesRef.current.push(pl);
                }
              };
              // Fetch with retry — stagger to avoid all 8 charts hitting API simultaneously
              const fetchWithRetry = async (attempt = 0) => {
                try {
                  const fibData = await fetchAtrFibLevels(sym);
                  applyAtrLevels(fibData);
                } catch (e) {
                  console.warn(`[ATR] ${sym} attempt ${attempt} failed:`, e);
                  if (attempt < 2 && !cancelled) {
                    await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
                    return fetchWithRetry(attempt + 1);
                  }
                }
              };
              fetchWithRetry();
            }
          }).catch(e => {
            console.error(`Chart ${sym} initial load error:`, e);
            setError("Load failed");
            setLoading(false);
          });

          // Resize handler — use ResizeObserver on the container so we catch both
          // window resizes AND CSS grid reflows (which don't fire window.resize)
          let resizeObserver = null;
          const handleResize = () => {
            if (containerRef.current && chart) {
              chart.applyOptions({ width: containerRef.current.clientWidth });
            }
          };
          if (typeof ResizeObserver !== "undefined") {
            resizeObserver = new ResizeObserver(handleResize);
            resizeObserver.observe(containerRef.current);
          }
          window.addEventListener("resize", handleResize);

          return () => {
            cancelled = true; // prevent stale async fetchAtrFibLevels from adding levels
            window.removeEventListener("resize", handleResize);
            if (resizeObserver) resizeObserver.disconnect();
            priceLinesRef.current = [];
            chart.remove();
            chartRef.current = null;
            seriesRef.current = null;
            firstCandleRef.current = null;
          };
        }, [sym, tf, limit, fetchCandles, mapCandles]);

        // Live update polling — fetches last few candles and updates the series
        useEffect(() => {
          if (!isLive) return;

          const poll = async () => {
            try {
              // Fetch only last 5 candles for the update
              const raw = await fetchCandles(5);
              const mapped = mapCandles(raw);
              if (mapped.length === 0 || !seriesRef.current) return;

              // update() adds new candles or updates the last one in-place
              // without resetting zoom/pan state
              for (const candle of mapped) {
                seriesRef.current.update(candle);
              }

              const lastCandle = mapped[mapped.length - 1];
              setLastPrice(lastCandle.close);
              if (firstCandleRef.current) {
                setChange((lastCandle.close - firstCandleRef.current.open) / firstCandleRef.current.open * 100);
              }
            } catch (_) { /* silent — next tick will retry */ }
          };

          // Poll every 30s during market hours, 60s otherwise
          const intervalMs = isMarketOpen() ? 30000 : 60000;
          const id = setInterval(poll, intervalMs);
          return () => clearInterval(id);
        }, [isLive, fetchCandles, mapCandles]);

        return (
          <div className="tt-card overflow-hidden">
            <div className="px-3 py-2 flex items-center justify-between border-b border-white/[0.04]">
              <div className="flex items-center gap-2">
                <span className="text-[13px] font-semibold" style={{ color: accentColor }}>{label}</span>
                {lastPrice != null && (
                  <span className="text-[12px] text-[#9ca3af]">{lastPrice.toFixed(2)}</span>
                )}
                {change != null && (
                  <span className={`text-[11px] font-medium ${change >= 0 ? "text-[#00c853]" : "text-[#ff5252]"}`}>
                    {change >= 0 ? "+" : ""}{change.toFixed(2)}%
                  </span>
                )}
              </div>
              {loading && <div className="loading-spinner" style={{ width: 12, height: 12, borderWidth: 1.5 }} />}
              {isLive && !loading && (
                <span className="flex items-center gap-1 text-[9px] font-medium text-[#00c853] uppercase tracking-wider">
                  <span className="inline-block w-1.5 h-1.5 rounded-full bg-[#00c853] badge-pulse" />
                  Live
                </span>
              )}
            </div>
            <div ref={containerRef} style={{ height: 220 }}>
              {error && (
                <div className="flex items-center justify-center h-full">
                  <span className="text-[11px] text-[#4b5563]">{error}</span>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Fetch daily ATR and compute ATR Fibonacci levels for a symbol
      // Uses actual daily candles for accurate day-level ATR (not scaled from intraday)
      const atrLevelCache = {};
      async function fetchAtrFibLevels(sym) {
        if (atrLevelCache[sym] && Date.now() - atrLevelCache[sym].ts < 300000) {
          return atrLevelCache[sym].data;
        }
        try {
          // Fetch last 20 daily candles for ATR calculation
          const res = await fetch(`${API_BASE}/timed/candles?ticker=${encodeURIComponent(sym)}&tf=D&limit=20`, { cache: "no-store" });
          const data = await res.json();
          if (!data.ok || !data.candles || data.candles.length < 5) return null;

          const dailies = data.candles;
          // Previous day close = anchor
          const prevDay = dailies[dailies.length - 2];
          const lastDay = dailies[dailies.length - 1];
          if (!prevDay || !lastDay) return null;
          const anchor = Number(prevDay.c);
          if (anchor <= 0) return null;

          // Compute 14-period daily ATR (true range: max of H-L, |H-prevC|, |L-prevC|)
          let atrSum = 0;
          let atrCount = 0;
          for (let i = 1; i < dailies.length; i++) {
            const h = Number(dailies[i].h);
            const l = Number(dailies[i].l);
            const pc = Number(dailies[i - 1].c);
            const tr = Math.max(h - l, Math.abs(h - pc), Math.abs(l - pc));
            if (tr > 0) { atrSum += tr; atrCount++; }
          }
          const dayAtr = atrCount > 0 ? atrSum / atrCount : 0;
          if (dayAtr <= 0) return null;

          // Get current price from /timed/latest
          let currentPrice = Number(lastDay.c);
          try {
            const latestRes = await fetch(`${API_BASE}/timed/latest?ticker=${encodeURIComponent(sym)}`, { cache: "no-store" });
            const latestData = await latestRes.json();
            if (latestData.ok && latestData.data?.price) currentPrice = Number(latestData.data.price);
          } catch (_) {}

          const rnd = (v) => Math.round(v * 100) / 100;
          const fibs = [0.236, 0.382, 0.5, 0.618, 1.0];
          const levels = [];

          // Anchor line (previous close)
          levels.push({ price: rnd(anchor), color: "rgba(255,255,255,0.35)", label: "Prev Close" });

          // Directional assessment — where is price relative to the ATR levels?
          let direction = "neutral";
          const distFromAnchor = currentPrice - anchor;
          const pctOfAtr = distFromAnchor / dayAtr;

          if (pctOfAtr > 0.382) direction = "bullish";
          else if (pctOfAtr < -0.382) direction = "bearish";

          // Build fib levels — Watch/Target labels replace plain labels at the
          // same price to avoid duplicates on the chart.
          const levelsByPrice = new Map();
          const addLevel = (price, color, label, priority) => {
            const key = price.toFixed(2);
            const existing = levelsByPrice.get(key);
            if (!existing || priority > existing.priority) {
              levelsByPrice.set(key, { price, color, label, priority });
            }
          };

          // Base fib levels (priority 0)
          for (const f of fibs) {
            const pctLabel = (f * 100).toFixed(1).replace(/\.0$/, "");
            addLevel(rnd(anchor + dayAtr * f), `rgba(0,200,83,${0.25 + f * 0.45})`, `+${pctLabel}%`, 0);
            addLevel(rnd(anchor - dayAtr * f), `rgba(255,82,82,${0.25 + f * 0.45})`, `-${pctLabel}%`, 0);
          }

          // Watch/Target levels (priority 1 — override plain labels at same price)
          if (direction === "bullish") {
            addLevel(rnd(anchor + dayAtr * 0.5), "rgba(245,158,11,0.7)", "Target +50%", 1);
            addLevel(rnd(anchor + dayAtr * 0.618), "rgba(245,158,11,0.7)", "Target +61.8%", 1);
          } else if (direction === "bearish") {
            addLevel(rnd(anchor - dayAtr * 0.5), "rgba(245,158,11,0.7)", "Target -50%", 1);
            addLevel(rnd(anchor - dayAtr * 0.618), "rgba(245,158,11,0.7)", "Target -61.8%", 1);
          } else {
            addLevel(rnd(anchor + dayAtr * 0.382), "rgba(245,158,11,0.7)", "Watch +38.2%", 1);
            addLevel(rnd(anchor - dayAtr * 0.382), "rgba(245,158,11,0.7)", "Watch -38.2%", 1);
          }

          for (const entry of levelsByPrice.values()) {
            levels.push({ price: entry.price, color: entry.color, label: entry.label });
          }

          const result = { levels, dayAtr: rnd(dayAtr), anchor: rnd(anchor), currentPrice: rnd(currentPrice), direction, pctOfAtr: rnd(pctOfAtr) };
          atrLevelCache[sym] = { data: result, ts: Date.now() };
          return result;
        } catch (e) {
          console.error(`ATR levels error for ${sym}:`, e);
          return null;
        }
      }

      function MarketCharts() {
        const [tf, setTf] = useState("10");
        const tfConfig = TF_OPTIONS.find(t => t.value === tf) || TF_OPTIONS[0];

        return (
          <div className="mb-6">
            <div className="flex items-center justify-between mb-3">
              <h2 className="text-[13px] font-semibold text-[#9ca3af] flex items-center gap-2">
                Market Overview
                <span className="text-[10px] text-[#4b5563] font-normal">Live Charts</span>
              </h2>
              <div className="flex items-center gap-1 bg-white/[0.02] rounded-lg p-0.5 border border-white/[0.04]">
                {TF_OPTIONS.map(opt => (
                  <button
                    key={opt.value}
                    onClick={() => setTf(opt.value)}
                    className={`px-2.5 py-1 rounded-md text-[11px] font-medium transition-all ${
                      tf === opt.value
                        ? "bg-white/[0.08] text-white"
                        : "text-[#6b7280] hover:text-white hover:bg-white/[0.04]"
                    }`}
                  >
                    {opt.label}
                  </button>
                ))}
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {CHART_SYMBOLS.map(({ sym, label, color }) => (
                <MiniChart
                  key={`${sym}-${tf}`}
                  sym={sym}
                  label={label}
                  accentColor={color}
                  tf={tfConfig.value}
                  limit={tfConfig.limit}
                />
              ))}
            </div>
          </div>
        );
      }

      // ── Main App ───────────────────────────────────────────────────────────
      function App({ user }) {
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
        const isAdmin = user?.role === "admin" || user?.tier === "admin";
        const [brief, setBrief] = useState(null);
        const [loading, setLoading] = useState(true);
        const [archiveBriefs, setArchiveBriefs] = useState([]);
        const [archiveLoading, setArchiveLoading] = useState(false);
        const [selectedArchive, setSelectedArchive] = useState(null);
        const [selectedArchiveData, setSelectedArchiveData] = useState(null);
        const [archiveDetailLoading, setArchiveDetailLoading] = useState(false);

        // Fetch current brief
        const fetchBrief = useCallback(async () => {
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setBrief(data.brief || {});
            }
          } catch (e) {
            console.error("Failed to fetch brief:", e);
          } finally {
            setLoading(false);
          }
        }, []);

        // Fetch archive
        const fetchArchive = useCallback(async () => {
          setArchiveLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/archive`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setArchiveBriefs(data.briefs || []);
            }
          } catch (e) {
            console.error("Failed to fetch archive:", e);
          } finally {
            setArchiveLoading(false);
          }
        }, []);

        // Fetch single archive brief
        const fetchArchiveBrief = useCallback(async (id) => {
          setSelectedArchive(id);
          setArchiveDetailLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/archive/${encodeURIComponent(id)}`, { cache: "no-store" });
            if (res.ok) {
              const data = await res.json();
              setSelectedArchiveData(data.brief || null);
            }
          } catch (e) {
            console.error("Failed to fetch archive brief:", e);
          } finally {
            setArchiveDetailLoading(false);
          }
        }, []);

        // Mark ES prediction
        const markPrediction = useCallback(async (id, correct) => {
          try {
            const res = await fetch(`${API_BASE}/timed/daily-brief/predict?id=${encodeURIComponent(id)}&correct=${correct}`, { method: "POST" });
            if (res.ok) {
              fetchArchive(); // refresh
            }
          } catch (e) {
            console.error("Failed to mark prediction:", e);
          }
        }, [fetchArchive]);

        useEffect(() => {
          fetchBrief();
          fetchArchive();
          // Mark brief as seen for badge
          localStorage.setItem("tt_brief_seen", String(Date.now()));
        }, [fetchBrief, fetchArchive]);

        // Determine current ET time for placeholder logic
        const etNow = useMemo(() => {
          const d = new Date();
          const et = d.toLocaleString("en-US", { timeZone: "America/New_York", hour: "numeric", minute: "numeric", hour12: false });
          const [h] = et.split(":").map(Number);
          return h;
        }, []);

        const hasMorning = brief?.morning?.content;
        const hasEvening = brief?.evening?.content;
        const today = new Date().toLocaleDateString("en-US", { timeZone: "America/New_York", weekday: "long", month: "long", day: "numeric", year: "numeric" });

        return (
          <div className="min-h-screen" style={{ background: "var(--tt-bg-base)" }}>
            {/* Nav */}
            <nav className="sticky top-0 z-50 border-b border-white/[0.04]" style={{ background: "rgba(11,14,17,0.85)", backdropFilter: "blur(12px)" }}>
              <div className="max-w-[1400px] mx-auto px-4 md:px-6 py-2.5 md:py-3 flex items-center justify-between">
                <div className="flex items-center gap-3 md:gap-5 min-w-0">
                  <a href="index-react.html" className="flex items-center gap-2 no-underline shrink-0">
                    <div className="w-[28px] h-[28px] md:w-[32px] md:h-[32px] rounded-[8px] flex items-center justify-center" style={{background:"linear-gradient(135deg, #00c853, #00e676, #69f0ae)"}}>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                        <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                        <polyline points="16 7 22 7 22 13" />
                      </svg>
                    </div>
                    <span className="text-[14px] md:text-[15px] font-bold text-white hidden sm:inline" style={{letterSpacing:"-0.03em"}}>Timed Trading</span>
                  </a>
                  <div className="hidden lg:flex items-center gap-1">
                    <a href="index-react.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Active Trader</a>
                    <a href="investor-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Investor</a>
                    <a href="simulation-dashboard.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Trades</a>
                    <a href="system-intelligence.html" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">System Intelligence</a>
                    <a href="screener.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Screener</a>
                    <a href="ticker-management.html" data-admin-only="true" className="px-3 py-1 rounded-md text-[13px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Tickers</a>
                    <a href="daily-brief.html" className="px-3 py-1.5 rounded-md text-[13px] font-medium text-[#f59e0b] bg-[#f59e0b]/[0.08] border border-[#f59e0b]/20">Daily Brief</a>
                  </div>
                </div>
                <div className="flex items-center gap-1.5 md:gap-2 shrink-0">
                  <a href="/faq.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Guide</a>
                  <a href="/faq.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">FAQ</a>
                  <a href="index-react.html" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#60a5fa] hover:text-[#93bbfc] hover:bg-[#60a5fa]/[0.06] transition-all font-medium">Ask AI</a>
                  {(typeof window !== 'undefined' && (window.TimedAuthHelpers?.getStoredSession()?.role === 'admin' || window.TimedAuthHelpers?.getStoredSession()?.tier === 'admin')) && (
                    <a href="admin-clients.html" data-admin-only="true" className="hidden md:inline-flex px-2 py-1 rounded-md text-[11px] text-[#a78bfa]/80 hover:text-[#a78bfa] font-medium">Admin</a>
                  )}
                  {window.TimedNotificationCenter && <window.TimedNotificationCenter apiBase="" />}
                  {window.TimedUserBadge && <window.TimedUserBadge user={window.TimedAuthHelpers?.getStoredSession()} compact />}
                  <button onClick={() => setMobileMenuOpen(v => !v)} className="lg:hidden p-1.5 rounded-md text-[#6b7280] hover:text-white hover:bg-white/[0.06] transition-all" aria-label="Toggle menu">
                    {mobileMenuOpen ? (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    ) : (
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                    )}
                  </button>
                </div>
              </div>
              {mobileMenuOpen && (
                <div className="lg:hidden border-t border-white/[0.06] px-4 py-2 flex flex-col gap-0.5" style={{background:"rgba(10,10,15,0.98)"}}>
                  <a href="index-react.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Active Trader</a>
                  <a href="investor-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Investor</a>
                  <a href="simulation-dashboard.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Trades</a>
                  <a href="system-intelligence.html" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>System Intelligence</a>
                  <a href="screener.html" data-admin-only="true" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Screener</a>
                  <a href="ticker-management.html" data-admin-only="true" className="px-3 py-2 rounded-md text-[13px] text-[#9ca3af] hover:text-white hover:bg-white/[0.04] transition-all" onClick={() => setMobileMenuOpen(false)}>Tickers</a>
                  <a href="daily-brief.html" className="px-3 py-2 rounded-md text-[13px] text-[#f59e0b] bg-[#f59e0b]/[0.08] font-medium" onClick={() => setMobileMenuOpen(false)}>Daily Brief</a>
                  <div className="border-t border-white/[0.06] mt-1 pt-1 flex items-center gap-2">
                    <a href="/faq.html" className="px-3 py-2 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Guide</a>
                    <a href="/faq.html" className="px-3 py-2 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">FAQ</a>
                    <a href="index-react.html" className="px-3 py-2 rounded-md text-[12px] text-[#60a5fa] hover:text-white hover:bg-white/[0.04] transition-all">Ask AI</a>
                    <a href="mailto:support@timed-trading.com" className="px-3 py-2 rounded-md text-[12px] text-[#6b7280] hover:text-white hover:bg-white/[0.04] transition-all">Contact</a>
                  </div>
                </div>
              )}
            </nav>

            {/* Content */}
            <div className="max-w-[1100px] mx-auto px-6 py-8">
              {/* Header */}
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h1 className="text-lg font-semibold tracking-tight text-white flex items-center gap-2">
                    Daily Brief
                    <span className="text-[11px] font-normal text-[#f59e0b] bg-[#f59e0b]/10 px-2 py-0.5 rounded-full">AI-Powered</span>
                  </h1>
                  <p className="text-[13px] text-[#6b7280] mt-0.5">{today}</p>
                </div>
                {loading && <div className="loading-spinner" />}
              </div>

              {/* Market Overview Charts */}
              <MarketCharts />

              {/* Current Briefs */}
              {loading ? (
                <div className="flex items-center justify-center py-20">
                  <div className="loading-spinner mr-3" />
                  <span className="text-[13px] text-[#6b7280]">Loading brief...</span>
                </div>
              ) : (
                <div>
                  {/* Evening Brief (shown first when available — most recent) */}
                  {hasEvening ? (
                    <BriefCard brief={brief.evening} type="evening" />
                  ) : etNow >= 17 ? (
                    <BriefPlaceholder type="evening" />
                  ) : null}

                  {/* Morning Brief */}
                  {hasMorning ? (
                    <BriefCard brief={brief.morning} type="morning" />
                  ) : (
                    <BriefPlaceholder type="morning" />
                  )}
                </div>
              )}

              {/* Selected Archive Brief */}
              {selectedArchive && (
                <div className="mt-6">
                  <div className="flex items-center gap-3 mb-3">
                    <button onClick={() => { setSelectedArchive(null); setSelectedArchiveData(null); }} className="text-[12px] text-[#6b7280] hover:text-white transition-all">&larr; Back to current</button>
                    <span className="text-[12px] text-[#4b5563]">{selectedArchive}</span>
                    {isAdmin && selectedArchiveData && (
                      <div className="ml-auto flex items-center gap-2">
                        <span className="text-[11px] text-[#4b5563]">ES Prediction:</span>
                        <button onClick={() => markPrediction(selectedArchive, 1)} className="text-[11px] px-2 py-0.5 rounded bg-[#00c853]/10 text-[#00c853] hover:bg-[#00c853]/20 transition-all">Correct</button>
                        <button onClick={() => markPrediction(selectedArchive, 0)} className="text-[11px] px-2 py-0.5 rounded bg-[#ff5252]/10 text-[#ff5252] hover:bg-[#ff5252]/20 transition-all">Incorrect</button>
                      </div>
                    )}
                  </div>
                  {archiveDetailLoading ? (
                    <div className="flex items-center py-8"><div className="loading-spinner mr-3" /><span className="text-[13px] text-[#6b7280]">Loading...</span></div>
                  ) : selectedArchiveData ? (
                    <div className="tt-card p-6">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="text-sm">{selectedArchiveData.type === "morning" ? "\u2600\uFE0F" : "\uD83C\uDF19"}</span>
                        <span className="text-[14px] font-semibold text-white">{selectedArchiveData.type === "morning" ? "Morning Brief" : "Evening Brief"}</span>
                        <span className="text-[11px] text-[#6b7280]">{selectedArchiveData.date}</span>
                        {selectedArchiveData.es_prediction_correct != null && (
                          <PredictionBadge value={selectedArchiveData.es_prediction_correct} />
                        )}
                      </div>
                      <div className="brief-content" dangerouslySetInnerHTML={{ __html: renderMarkdown(selectedArchiveData.content) }} />
                    </div>
                  ) : (
                    <div className="text-[13px] text-[#4b5563]">Brief not found.</div>
                  )}
                </div>
              )}

              {/* Archive Section */}
              <div className="mt-10">
                <div className="flex items-center gap-3 mb-4">
                  <h2 className="text-[14px] font-semibold text-[#9ca3af]">Archive</h2>
                  {archiveLoading && <div className="loading-spinner" style={{ width: 14, height: 14, borderWidth: 1.5 }} />}
                </div>
                <div className="tt-card p-4">
                  <ArchiveTree briefs={archiveBriefs} onSelect={fetchArchiveBrief} />
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ── Mount ──────────────────────────────────────────────────────────────
      const AuthGate = window.TimedAuthGate;
      const briefApp = AuthGate
        ? <AuthGate apiBase={API_BASE} requiredTier="pro">{(user) => <App user={user} />}</AuthGate>
        : <App />;
      ReactDOM.createRoot(document.getElementById("root")).render(briefApp);
    </script>
    <footer id="legal-footer" style="position:fixed;bottom:0;left:0;right:0;z-index:9999;background:rgba(10,10,15,0.92);backdrop-filter:blur(6px);border-top:1px solid rgba(255,255,255,0.06);padding:6px 16px;text-align:center;font-size:10px;color:#6b7280;line-height:1.4;">
      For informational and educational purposes only. Not investment advice. Past performance does not guarantee future results. All trading involves risk of loss. <a href="/terms.html" style="color:#6b7280;text-decoration:underline;">Full Terms</a>
    </footer>
  </body>
</html>
