<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timed Trading - Trade Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background: #0a0f1e;
        color: #e7ecff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      }
      .loading-spinner {
        border: 3px solid #26325f;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .slide-in-right {
        animation: slideInRight 0.3s ease-out;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useCallback, memo } = React;

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Constants
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const API_BASE = "https://timed-trading-ingest.shashant.workers.dev";
      // API_KEY removed for security - write operations disabled for public access
      // To enable trade management, implement proper authentication
      const TRADE_SIZE = 1000; // $1000 per trade
      const FUTURES_TICKERS = new Set(["ES", "NQ", "YM", "RTY", "CL", "GC", "SI", "HG", "NG"]);

      // Futures contract specifications (point value per contract) - matches worker
      const FUTURES_SPECS = {
        "ES1!": { pointValue: 50, name: "E-mini S&P 500" },
        "NQ1!": { pointValue: 20, name: "E-mini Nasdaq-100" },
        "MES1!": { pointValue: 5, name: "Micro E-mini S&P 500" },
        "MNQ1!": { pointValue: 2, name: "Micro E-mini Nasdaq-100" },
        "YM1!": { pointValue: 5, name: "E-mini Dow" },
        "RTY1!": { pointValue: 50, name: "E-mini Russell 2000" },
        "ES": { pointValue: 50, name: "E-mini S&P 500" },
        "NQ": { pointValue: 20, name: "E-mini Nasdaq-100" },
        "YM": { pointValue: 5, name: "E-mini Dow" },
      };

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Hooks
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function useTickerData() {
        const [data, setData] = useState({});
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [lastUpdate, setLastUpdate] = useState(null);

        const fetchData = useCallback(async () => {
          try {
            setLoading(true);
            setError(null);
            const res = await fetch(`${API_BASE}/timed/all`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (json.ok && json.data) {
              setData(json.data);
              setLastUpdate(new Date());
            } else {
              throw new Error(json.error || "Invalid response");
            }
          } catch (err) {
            setError(err.message);
            console.error("Fetch error:", err);
          } finally {
            setLoading(false);
          }
        }, []);

        useEffect(() => {
          fetchData();
          const interval = setInterval(fetchData, 180000); // Refresh every 3 minutes
          return () => clearInterval(interval);
        }, [fetchData]);

        return { data, loading, error, lastUpdate, refetch: fetchData };
      }

      function useSimulatedTrades() {
        const [trades, setTrades] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);

        // Fetch trades from Worker
        const fetchTrades = useCallback(async (version = null) => {
          try {
            setLoading(true);
            setError(null);
            const url = version ? `${API_BASE}/timed/trades?version=${encodeURIComponent(version)}` : `${API_BASE}/timed/trades`;
            console.log(`[UI] Fetching trades from ${url}`);
            const res = await fetch(url);
            console.log(`[UI] Response status: ${res.status}, ok: ${res.ok}`);
            if (!res.ok) {
              const errorText = await res.text();
              console.error(`[UI] HTTP ${res.status} error:`, errorText);
              throw new Error(`HTTP ${res.status}: ${errorText.substring(0, 100)}`);
            }
            const json = await res.json();
            console.log(`[UI] Response:`, { 
              ok: json.ok, 
              count: json.count, 
              totalCount: json.totalCount, 
              tradesLength: json.trades?.length,
              versions: json.versions 
            });
            if (json.ok && Array.isArray(json.trades)) {
              console.log(`[UI] ‚úÖ Setting ${json.trades.length} trades`);
              setTrades(json.trades);
            } else {
              console.error(`[UI] ‚ùå Invalid response:`, json);
              setTrades([]); // Set empty array instead of throwing
              throw new Error(json.error || "Invalid response format");
            }
          } catch (err) {
            setError(err.message);
            console.error("[UI] Fetch trades error:", err);
            setTrades([]); // Ensure trades is set to empty array on error
          } finally {
            setLoading(false);
          }
        }, []);

        // Load trades on mount
        useEffect(() => {
          fetchTrades();
        }, [fetchTrades]);

        // Save trade to Worker - DISABLED for public access (security)
        const saveTrade = useCallback(async (trade) => {
          throw new Error("Trade management is disabled for public access. This is a read-only dashboard.");
        }, []);

        const addTrade = useCallback(async (trade) => {
          await saveTrade(trade);
        }, [saveTrade]);

        const updateTrade = useCallback(async (tradeId, updates) => {
          const existingTrade = trades.find((t) => t.id === tradeId);
          if (!existingTrade) {
            console.error("Trade not found:", tradeId);
            return;
          }
          const updatedTrade = { ...existingTrade, ...updates };
          await saveTrade(updatedTrade);
        }, [trades, saveTrade]);


        return { trades, loading, error, addTrade, updateTrade, refetch: fetchTrades };
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Trade Simulation Logic
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function shouldTriggerTrade(ticker, prevData) {
        // Skip futures
        if (FUTURES_TICKERS.has(ticker.ticker.toUpperCase())) return false;

        // Must have valid entry/exit levels
        if (!ticker.price || !ticker.sl || !ticker.tp) return false;

        const flags = ticker.flags || {};
        const state = String(ticker.state || "");
        const alignedLong = state === "HTF_BULL_LTF_BULL";
        const alignedShort = state === "HTF_BEAR_LTF_BEAR";
        const aligned = alignedLong || alignedShort;
        const ent = entryType(ticker);
        const inCorridor = ent.corridor;
        const side = ent.side; // LONG or SHORT

        // Corridor must match alignment
        const corridorAlignedOK =
          (side === "LONG" && alignedLong) ||
          (side === "SHORT" && alignedShort);

        if (!inCorridor || !corridorAlignedOK) return false;

        // Check for trigger conditions (matches worker logic)
        const enteredAligned = prevData && prevData.state !== state && aligned;
        const trigReason = String(ticker.trigger_reason || "");
        const trigOk = trigReason === "EMA_CROSS" || trigReason === "SQUEEZE_RELEASE";
        const sqRelease = !!flags.sq30_release;
        const hasTrigger = !!ticker.trigger_price && !!ticker.trigger_ts;

        // Must be: in corridor + corridor aligns + (entered aligned OR trigger OR squeeze release)
        const shouldConsiderAlert =
          inCorridor &&
          corridorAlignedOK &&
          (enteredAligned || trigOk || sqRelease || hasTrigger);

        // Check Momentum Elite status
        const momentumElite = !!flags.momentum_elite;
        
        // Threshold gates (with Momentum Elite adjustments - matching worker logic)
        const baseMinRR = 1.5;
        const baseMaxComp = 0.4;
        const baseMaxPhase = 0.6;
        const baseMinRank = 70;
        
        // Adjust thresholds for Momentum Elite (more lenient for quality stocks)
        const minRR = momentumElite ? Math.max(1.2, baseMinRR * 0.9) : baseMinRR; // Lower RR requirement
        const maxComp = momentumElite ? Math.min(0.5, baseMaxComp * 1.25) : baseMaxComp; // Allow higher completion
        const maxPhase = momentumElite ? Math.min(0.7, baseMaxPhase * 1.17) : baseMaxPhase; // Allow higher phase
        const minRank = momentumElite ? Math.max(60, baseMinRank - 10) : baseMinRank; // Lower rank requirement

        const rr = Number(ticker.rr) || 0;
        const comp = Number(ticker.completion) || 0;
        const phase = Number(ticker.phase_pct) || 0;
        const rank = Number(ticker.rank) || 0;

        const rrOk = rr >= minRR;
        const compOk = comp <= maxComp;
        const phaseOk = phase <= maxPhase;
        const rankOk = rank >= minRank;

        // Also consider Momentum Elite as a trigger condition (quality signal)
        const momentumEliteTrigger = momentumElite && inCorridor && corridorAlignedOK;
        
        // Enhanced trigger: original conditions OR Momentum Elite in good setup
        const enhancedTrigger = shouldConsiderAlert || momentumEliteTrigger;

        return enhancedTrigger && rrOk && compOk && phaseOk && rankOk;
      }

      function entryType(ticker) {
        const h = Number(ticker.htf_score);
        const l = Number(ticker.ltf_score);
        if (!Number.isFinite(h) || !Number.isFinite(l)) {
          return { corridor: false, side: null };
        }
        const LONG_CORRIDOR = { ltfMin: -8, ltfMax: 12 };
        const SHORT_CORRIDOR = { ltfMin: -12, ltfMax: 8 };
        if (h > 0 && l >= LONG_CORRIDOR.ltfMin && l <= LONG_CORRIDOR.ltfMax) {
          return { corridor: true, side: "LONG" };
        }
        if (h < 0 && l >= SHORT_CORRIDOR.ltfMin && l <= SHORT_CORRIDOR.ltfMax) {
          return { corridor: true, side: "SHORT" };
        }
        return { corridor: false, side: null };
      }

      function getDirection(ticker) {
        const state = String(ticker.state || "");
        if (state.includes("BULL")) return { text: "LONG", color: "text-green-400", bg: "bg-green-500/20" };
        if (state.includes("BEAR")) return { text: "SHORT", color: "text-red-400", bg: "bg-red-500/20" };
        return { text: null, color: "text-[#93a4d6]", bg: "bg-[#26325f]" };
      }

      function calculateTrade(ticker, entryPrice, existingTrade = null) {
        const directionObj = getDirection(ticker);
        const direction = directionObj.text;
        if (!direction) return null;

        const sl = Number(ticker.sl);
        const tp = Number(ticker.tp);
        const currentPrice = Number(ticker.price);

        if (!Number.isFinite(sl) || !Number.isFinite(tp) || !Number.isFinite(currentPrice)) {
          return null;
        }

        // Determine if this is a futures contract
        const tickerSymbol = String(ticker.ticker || "").toUpperCase();
        const isFutures = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        
        // For futures: trade 1 contract, calculate P&L based on point value
        // For stocks: calculate shares based on dollar amount
        let shares;
        let pointValue = 1; // Default for stocks (price per share)
        
        if (isFutures && FUTURES_SPECS[tickerSymbol]) {
          // Futures: always trade 1 contract
          shares = 1;
          pointValue = FUTURES_SPECS[tickerSymbol].pointValue;
        } else {
          // Stocks: calculate shares from dollar amount
          shares = TRADE_SIZE / entryPrice;
        }

        // Calculate P&L based on current price
        let pnl = 0;
        let pnlPct = 0;
        let status = "OPEN";

        // Check for partial trim (if position was already trimmed)
        const trimmedPct = existingTrade ? (existingTrade.trimmedPct || 0) : 0;
        const remainingShares = shares * (1 - trimmedPct);
        
        // Calculate price differences (in points for futures, dollars for stocks)
        const priceDiff = currentPrice - entryPrice;
        const tpDiff = tp - entryPrice;
        const slDiff = sl - entryPrice;
        
        if (direction === "LONG") {
          // Check if hit TP or SL first
          const hitTP = currentPrice >= tp;
          const hitSL = currentPrice <= sl;
          
          if (hitTP) {
            // If not already trimmed, trim 50% at first TP hit
            if (trimmedPct === 0) {
              const trimPnl = tpDiff * shares * pointValue * 0.5;
              const trimPnlPct = ((tp - entryPrice) / entryPrice) * 100;
              // Return special status for trimming
              return {
                shares,
                pnl: trimPnl,
                pnlPct: trimPnlPct,
                status: "TP_HIT_TRIM",
                currentPrice,
                trimmedPct: 0.5, // Mark as 50% trimmed
              };
            } else {
              // Already trimmed, full exit at TP
              pnl = tpDiff * shares * pointValue;
              pnlPct = ((tp - entryPrice) / entryPrice) * 100;
              // Status based on actual P&L, not just TP hit
              status = pnl >= 0 ? "WIN" : "LOSS";
            }
          } else if (hitSL) {
            pnl = slDiff * shares * pointValue;
            pnlPct = ((sl - entryPrice) / entryPrice) * 100;
            status = "LOSS";
          } else {
            // Still open - calculate current P&L
            pnl = priceDiff * shares * pointValue;
            pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;
            status = "OPEN";
          }
        } else {
          // SHORT
          // Check if hit TP or SL first
          const hitTP = currentPrice <= tp;
          const hitSL = currentPrice >= sl;
          
          if (hitTP) {
            // If not already trimmed, trim 50% at first TP hit
            if (trimmedPct === 0) {
              const shortTpDiff = entryPrice - tp;
              const trimPnl = shortTpDiff * shares * pointValue * 0.5;
              const trimPnlPct = ((entryPrice - tp) / entryPrice) * 100;
              // Return special status for trimming
              return {
                shares,
                pnl: trimPnl,
                pnlPct: trimPnlPct,
                status: "TP_HIT_TRIM",
                currentPrice,
                trimmedPct: 0.5, // Mark as 50% trimmed
              };
            } else {
              // Already trimmed, full exit at TP
              const shortTpDiff = entryPrice - tp;
              pnl = shortTpDiff * shares * pointValue;
              pnlPct = ((entryPrice - tp) / entryPrice) * 100;
              // Status based on actual P&L, not just TP hit
              status = pnl >= 0 ? "WIN" : "LOSS";
            }
          } else if (hitSL) {
            const shortSlDiff = entryPrice - sl;
            pnl = shortSlDiff * shares * pointValue;
            pnlPct = ((entryPrice - sl) / entryPrice) * 100;
            status = "LOSS";
          } else {
            // Still open - calculate current P&L
            const shortPriceDiff = entryPrice - currentPrice;
            pnl = shortPriceDiff * shares * pointValue;
            pnlPct = ((entryPrice - currentPrice) / entryPrice) * 100;
            status = "OPEN";
          }
        }

        return {
          shares,
          pnl,
          pnlPct,
          status,
          currentPrice,
        };
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Trade Tracking
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Trade simulation is now handled by Worker - UI just fetches and displays
      // No need for useTradeSimulation hook anymore - Worker handles everything

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Analytics & Learning
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function useTradeAnalytics(trades) {
        return useMemo(() => {
          // Helper to check if trade has remaining shares/contracts (not fully closed)
          const hasRemainingShares = (t) => {
            const tickerSym = String(t.ticker || "").toUpperCase();
            const isFut = FUTURES_SPECS[tickerSym] || tickerSym.endsWith("1!");
            const shares = t.shares || (isFut && FUTURES_SPECS[tickerSym] ? 1 : TRADE_SIZE / (t.entryPrice || 1));
            const trimmedPct = t.trimmedPct || 0;
            const remainingShares = shares - (shares * trimmedPct);
            return remainingShares > 0;
          };

          // Trimmed trades: positions that have been partially trimmed (check trimmedPct > 0 OR status TP_HIT_TRIM)
          // AND still have remaining shares (not fully closed)
          const trimmed = trades.filter((t) => {
            const trimmedPct = t.trimmedPct || 0;
            const isTrimmed = trimmedPct > 0 || t.status === "TP_HIT_TRIM";
            return isTrimmed && hasRemainingShares(t);
          });
          
          // Closed trades: positions with WIN or LOSS status (regardless of remaining shares)
          // Note: If status is WIN/LOSS, the trade is considered closed for analytics purposes
          const closed = trades.filter((t) => {
            return t.status === "WIN" || t.status === "LOSS";
          });
          
          // Open trades: currently open positions that haven't been trimmed yet
          const open = trades.filter((t) => {
            const trimmedPct = t.trimmedPct || 0;
            const isTrimmed = trimmedPct > 0 || t.status === "TP_HIT_TRIM";
            const isClosed = (t.status === "WIN" || t.status === "LOSS") && !hasRemainingShares(t);
            return (t.status === "OPEN" || !t.status) && !isTrimmed && !isClosed;
          });

          const openTrades = open.length;
          const trimmedTrades = trimmed.length;
          const closedTrades = closed.length;
          const totalTrades = openTrades + trimmedTrades + closedTrades; // Sum of all categories
          
          const wins = closed.filter((t) => t.status === "WIN").length;
          const losses = closed.filter((t) => t.status === "LOSS").length;
          const winRate = closedTrades > 0 ? (wins / closedTrades) * 100 : 0;

          // Calculate Closed P&L: includes fully closed trades + realized P&L from trimmed positions
          const closedPnl = closed.reduce((sum, t) => sum + (t.pnl || 0), 0);
          
          // Calculate realized P&L from trimmed positions
          const trimmedRealizedPnl = trimmed.reduce((sum, t) => {
            const tickerSym = String(t.ticker || "").toUpperCase();
            const isFut = FUTURES_SPECS[tickerSym] || tickerSym.endsWith("1!");
            const pointVal = isFut && FUTURES_SPECS[tickerSym] ? FUTURES_SPECS[tickerSym].pointValue : 1;
            const shares = t.shares || (isFut && FUTURES_SPECS[tickerSym] ? 1 : TRADE_SIZE / (t.entryPrice || 1));
            const trimmedPct = t.trimmedPct || 0;
            const trimmedShares = shares * trimmedPct;
            const entryPrice = t.entryPrice || 0;
            const tp = t.tp || entryPrice; // Use TP price where trimmed occurred
            
            if (trimmedShares > 0 && entryPrice > 0) {
              const direction = t.direction || "LONG";
              if (direction === "LONG") {
                // LONG: profit = (TP - Entry) * trimmed shares * point value
                const priceDiff = tp - entryPrice;
                return sum + (priceDiff * trimmedShares * pointVal);
              } else {
                // SHORT: profit = (Entry - TP) * trimmed shares * point value
                const priceDiff = entryPrice - tp;
                return sum + (priceDiff * trimmedShares * pointVal);
              }
            }
            return sum;
          }, 0);
          
          // Total Closed P&L = fully closed + trimmed realized
          const totalPnl = closedPnl + trimmedRealizedPnl;
          
          // Open P&L: unrealized P&L from open positions (including remaining shares in trimmed positions)
          const openPnl = [...open, ...trimmed].reduce((sum, t) => {
            const shares = t.shares || TRADE_SIZE / (t.entryPrice || 1); // Allow fractional shares
            const trimmedPct = t.trimmedPct || 0;
            const remainingShares = shares - (shares * trimmedPct); // Allow fractional shares
            const entryPrice = t.entryPrice || 0;
            const currentPrice = t.currentPrice || entryPrice;
            
            if (remainingShares > 0 && entryPrice > 0) {
              const direction = t.direction || "LONG";
              if (direction === "LONG") {
                return sum + ((currentPrice - entryPrice) * remainingShares);
              } else {
                return sum + ((entryPrice - currentPrice) * remainingShares);
              }
            }
            return sum;
          }, 0);

          // Calculate average win/loss
          const winningTrades = closed.filter((t) => t.status === "WIN");
          const losingTrades = closed.filter((t) => t.status === "LOSS");
          const avgWin = winningTrades.length > 0
            ? winningTrades.reduce((sum, t) => sum + (t.pnl || 0), 0) / winningTrades.length
            : 0;
          const avgLoss = losingTrades.length > 0
            ? losingTrades.reduce((sum, t) => sum + Math.abs(t.pnl || 0), 0) / losingTrades.length
            : 0;
          const profitFactor = avgLoss > 0 ? avgWin / avgLoss : avgWin > 0 ? Infinity : 0;

          // Analyze by signal combinations
          const signalAnalysis = {};
          closed.forEach((trade) => {
            const signals = [];
            if (trade.flags?.sq30_release) signals.push("SqueezeRelease");
            if (trade.flags?.sq30_on) signals.push("SqueezeOn");
            if (trade.flags?.phase_zone_change) signals.push("PhaseZoneChange");
            if (trade.inCorridor) signals.push("InCorridor");
            const key = signals.sort().join("+") || "None";
            
            if (!signalAnalysis[key]) {
              signalAnalysis[key] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") signalAnalysis[key].wins++;
            if (trade.status === "LOSS") signalAnalysis[key].losses++;
            signalAnalysis[key].totalPnl += trade.pnl || 0;
          });

          // Analyze by RR ranges
          const rrAnalysis = {};
          closed.forEach((trade) => {
            const rr = trade.rr || 0;
            let range = "Unknown";
            if (rr >= 2.0) range = "RR ‚â• 2.0";
            else if (rr >= 1.5) range = "RR 1.5-2.0";
            else if (rr >= 1.0) range = "RR 1.0-1.5";
            else if (rr > 0) range = "RR < 1.0";
            
            if (!rrAnalysis[range]) {
              rrAnalysis[range] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") rrAnalysis[range].wins++;
            if (trade.status === "LOSS") rrAnalysis[range].losses++;
            rrAnalysis[range].totalPnl += trade.pnl || 0;
          });

          // Analyze by rank ranges
          const rankAnalysis = {};
          closed.forEach((trade) => {
            const rank = trade.rank || 0;
            let range = "Unknown";
            if (rank >= 80) range = "Rank ‚â• 80";
            else if (rank >= 70) range = "Rank 70-80";
            else if (rank >= 60) range = "Rank 60-70";
            else if (rank > 0) range = "Rank < 60";
            
            if (!rankAnalysis[range]) {
              rankAnalysis[range] = { wins: 0, losses: 0, totalPnl: 0 };
            }
            if (trade.status === "WIN") rankAnalysis[range].wins++;
            if (trade.status === "LOSS") rankAnalysis[range].losses++;
            rankAnalysis[range].totalPnl += trade.pnl || 0;
          });

          // Generate recommendations
          const recommendations = [];
          
          // Find best performing signal combinations
          const bestSignals = Object.entries(signalAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 3) // At least 3 trades
            .sort((a, b) => {
              const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
              const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
              return bRate - aRate;
            })
            .slice(0, 3);
          
          if (bestSignals.length > 0 && bestSignals[0][1].wins / (bestSignals[0][1].wins + bestSignals[0][1].losses) >= 0.6) {
            recommendations.push({
              type: "signal",
              priority: "high",
              message: `Focus on setups with: ${bestSignals[0][0]}. Win rate: ${((bestSignals[0][1].wins / (bestSignals[0][1].wins + bestSignals[0][1].losses)) * 100).toFixed(1)}%`,
            });
          }

          // Find best RR range
          const bestRR = Object.entries(rrAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 3)
            .sort((a, b) => {
              const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
              const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
              return bRate - aRate;
            })[0];
          
          if (bestRR && bestRR[1].wins / (bestRR[1].wins + bestRR[1].losses) >= 0.55) {
            recommendations.push({
              type: "rr",
              priority: "medium",
              message: `Best performing RR range: ${bestRR[0]} (${((bestRR[1].wins / (bestRR[1].wins + bestRR[1].losses)) * 100).toFixed(1)}% win rate)`,
            });
          }

          // Find best rank range
          const bestRank = Object.entries(rankAnalysis)
            .filter(([_, stats]) => stats.wins + stats.losses >= 3)
            .sort((a, b) => {
              const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
              const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
              return bRate - aRate;
            })[0];
          
          if (bestRank && bestRank[1].wins / (bestRank[1].wins + bestRank[1].losses) >= 0.55) {
            recommendations.push({
              type: "rank",
              priority: "medium",
              message: `Best performing rank range: ${bestRank[0]} (${((bestRank[1].wins / (bestRank[1].wins + bestRank[1].losses)) * 100).toFixed(1)}% win rate)`,
            });
          }

          // Profit factor recommendations - only show if we have enough closed trades to analyze
          if (profitFactor < 1.0 && closedTrades >= 10) {
            recommendations.push({
              type: "risk",
              priority: "high",
              message: `Profit factor is ${profitFactor.toFixed(2)}. Consider tightening stops or improving entry selection.`,
            });
          }

          // Win rate recommendations - only show if we have enough closed trades to analyze
          if (winRate < 40 && closedTrades >= 10) {
            recommendations.push({
              type: "filter",
              priority: "high",
              message: `Win rate is ${winRate.toFixed(1)}%. Consider raising minimum rank threshold or requiring squeeze release.`,
            });
          }

          return {
            totalTrades,
            openTrades,
            trimmedTrades,
            closedTrades,
            wins,
            losses,
            winRate,
            totalPnl,
            openPnl,
            avgWin,
            avgLoss,
            profitFactor,
            signalAnalysis,
            rrAnalysis,
            rankAnalysis,
            recommendations,
          };
        }, [trades]);
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Components
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Format RR display (e.g., "2.10:1" or "1:2.10")
      function formatRR(rr) {
        if (!rr || !Number.isFinite(rr)) return "N/A";
        if (rr >= 1) {
          return `${rr.toFixed(2)}:1`;
        } else {
          return `1:${(1 / rr).toFixed(2)}`;
        }
      }

      // Trade History Component
      function TradeHistory({ history = [] }) {
        if (!history || history.length === 0) {
          return (
            <div className="text-xs text-[#6b7a9f] italic p-2">
              No history available
            </div>
          );
        }

        const getEventIcon = (type) => {
          switch (type) {
            case "ENTRY": return "üì•";
            case "SCALE_IN": return "‚ûï";
            case "TRIM": return "‚úÇÔ∏è";
            case "EXIT": return "üì§";
            default: return "‚Ä¢";
          }
        };

        const getEventColor = (type) => {
          switch (type) {
            case "ENTRY": return "text-green-400";
            case "SCALE_IN": return "text-blue-400";
            case "TRIM": return "text-yellow-400";
            case "EXIT": return "text-purple-400";
            default: return "text-[#93a4d6]";
          }
        };

        return (
          <div className="space-y-2 max-h-[400px] overflow-y-auto">
            {history.map((event, idx) => {
              const eventDate = new Date(event.timestamp);
              const formattedDate = eventDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
              });
              const formattedTime = eventDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: true 
              });

              return (
                <div
                  key={idx}
                  className="bg-[#0f1630] border border-[#26325f] rounded-lg p-3"
                >
                  <div className="flex items-start gap-3">
                    <div className={`text-xl ${getEventColor(event.type)}`}>
                      {getEventIcon(event.type)}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between mb-1">
                        <span className={`text-sm font-semibold ${getEventColor(event.type)}`}>
                          {event.type.replace('_', ' ')}
                        </span>
                        <span className="text-xs text-[#6b7a9f]">
                          {formattedDate} {formattedTime}
                        </span>
                      </div>
                      <div className="text-xs text-[#93a4d6] mb-2">
                        {event.note}
                      </div>
                      <div className="grid grid-cols-3 gap-2 text-xs">
                        <div>
                          <span className="text-[#6b7a9f]">Price:</span>
                          <span className="ml-1 font-semibold text-white">
                            ${Number(event.price).toFixed(2)}
                          </span>
                        </div>
                        <div>
                          <span className="text-[#6b7a9f]">Shares:</span>
                          <span className="ml-1 font-semibold text-white">
                            {event.shares}
                          </span>
                        </div>
                        <div>
                          <span className="text-[#6b7a9f]">Value:</span>
                          <span className="ml-1 font-semibold text-white">
                            ${Number(event.value).toFixed(2)}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Unified Ticker Detail Right Rail Component
      // Reusable component that shows comprehensive ticker information
      // and optionally trade history if a trade is associated
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function TickerDetailRightRail({ ticker, trade = null, onClose, allLoadedData = null }) {
        if (!ticker) return null;

        // Helper to get ticker data - prefer trade's ticker data if available, otherwise use ticker prop
        const tickerData = trade && trade.tickerData ? trade.tickerData : ticker;
        const tickerSymbol = tickerData.ticker || ticker.ticker || (trade ? trade.ticker : null);
        
        if (!tickerSymbol) return null;

        const prime = isPrimeBubble(tickerData);
        const ent = entryType(tickerData);
        const flags = tickerData.flags || {};
        const phase = Number(tickerData.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const actionInfo = getActionDescription(tickerData);

        // Convert allLoadedData to array for ranking calculations
        const allLoadedTickersArray = (() => {
          if (allLoadedData && typeof allLoadedData === "object") {
            if (Array.isArray(allLoadedData)) return allLoadedData;
            return Object.values(allLoadedData).filter(
              (t) => t && typeof t === "object" && t.ticker
            );
          }
          return [];
        })();

        const baseScore = Number(tickerData.rank) || 0;
        const dynamicRank = computeDynamicRank(tickerData);
        const allTickersWithRank = allLoadedTickersArray.map(t => ({ ...t, dynamicRank: computeDynamicRank(t) }));
        const sortedByDynamic = [...allTickersWithRank].sort((a, b) => b.dynamicRank - a.dynamicRank);
        const rankPosition = sortedByDynamic.findIndex(t => String(t.ticker || "").toUpperCase() === String(tickerSymbol).toUpperCase()) + 1;
        const totalTickers = allLoadedTickersArray.length;
        const isInTop40 = rankPosition > 0 && rankPosition <= 40;

        // Determine if this is a futures contract
        const isFuturesDetail = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        const pointValueDetail = isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? FUTURES_SPECS[tickerSymbol].pointValue : 1;
        
        // Trade-specific calculations
        // For futures: shares = contracts (always 1), for stocks: calculate from TRADE_SIZE
        const shares = trade 
          ? (trade.shares || (isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? 1 : TRADE_SIZE / (trade.entryPrice || 1)))
          : null;
        const currentPrice = trade ? (trade.currentPrice || trade.entryPrice) : (tickerData.price || tickerData.currentPrice);
        const trimmedPct = trade ? (trade.trimmedPct || 0) : 0;
        const trimmedShares = trade ? (shares * trimmedPct) : 0;
        const remainingShares = trade ? (shares - trimmedShares) : null;

        return (
          <div className="w-full h-full flex flex-col bg-[#0f1630]">
            {/* Scrollable Content Area */}
            <div className="flex-1 overflow-y-auto p-6">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold">{tickerSymbol}{trade ? ` ${trade.direction}` : ''}</h3>
                <button
                  onClick={onClose}
                  className="text-[#93a4d6] hover:text-white transition-colors text-xl leading-none w-6 h-6 flex items-center justify-center rounded hover:bg-[#26325f]"
                >
                  ‚úï
                </button>
              </div>

              {/* Trade Summary - Only show if trade exists */}
              {trade && (
                <>
                  <div className="bg-[#121a33] border border-[#26325f] rounded-lg p-4 mb-4">
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">Entry Price</div>
                        <div className="font-semibold text-white text-lg">${trade.entryPrice?.toFixed(2) || "‚Äî"}</div>
                        {trade.entryTime && (
                          <div className="text-[#6b7a9f] text-[10px] mt-1">
                            {new Date(trade.entryTime).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}{' '}
                            {new Date(trade.entryTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })}
                          </div>
                        )}
                      </div>
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">Current Price</div>
                        <div className="font-semibold text-yellow-400 text-lg">${currentPrice?.toFixed(2) || "‚Äî"}</div>
                      </div>
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">P&L</div>
                        <div className={`font-semibold text-lg ${trade.pnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          ${trade.pnl?.toFixed(2) || "0.00"}
                        </div>
                        <div className={`text-xs ${trade.pnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          {trade.pnlPct?.toFixed(2) || "0.00"}%
                        </div>
                      </div>
                      <div>
                        <div className="text-[#93a4d6] text-xs mb-1">Status</div>
                        <div className={`font-semibold text-lg ${
                          trade.status === "WIN" ? "text-green-400" :
                          trade.status === "LOSS" ? "text-red-400" :
                          trade.status === "TP_HIT_TRIM" ? "text-blue-400" :
                          "text-yellow-400"
                        }`}>
                          {trade.status || "OPEN"}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Trade Details */}
                  <div className="space-y-2.5 text-sm mb-4">
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">{isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? "Contracts" : "Shares"} {trimmedShares > 0 ? "(remaining)" : ""}</span>
                      <span className="font-semibold text-white">
                        {isFuturesDetail && FUTURES_SPECS[tickerSymbol] ? (
                          <>
                            {shares?.toFixed(0)} {trimmedShares > 0 && <span className="text-blue-400">({remainingShares?.toFixed(2)} remaining)</span>}
                          </>
                        ) : (
                          <>
                            {shares?.toFixed(4)} {trimmedShares > 0 && <span className="text-blue-400">({remainingShares?.toFixed(4)} remaining)</span>}
                          </>
                        )}
                      </span>
                    </div>
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Stop Loss</span>
                      <span className="font-semibold text-red-400">${trade.sl?.toFixed(2) || "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Take Profit</span>
                      <span className="font-semibold text-green-400">${trade.tp?.toFixed(2) || "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Risk/Reward</span>
                      <span className="font-semibold text-white">{trade.rr?.toFixed(2) || "‚Äî"}</span>
                    </div>
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Score</span>
                      <span className="font-semibold text-blue-400">{trade.rank || baseScore || "‚Äî"}</span>
                    </div>
                  </div>

                  {/* Trade History Timeline */}
                  {trade.history && trade.history.length > 0 && (
                    <div className="mt-4 pt-4 border-t border-[#26325f]">
                      <h3 className="text-lg font-bold mb-3">üìä Trade Journey</h3>
                      <TradeHistory history={trade.history} />
                    </div>
                  )}
                </>
              )}

              {/* Ticker Details Section */}
              {flags.momentum_elite && (
                <div className="mb-4 p-3 bg-gradient-to-r from-purple-500/30 via-pink-500/30 to-purple-500/30 border-2 border-purple-400 rounded-lg">
                  <div className="text-center font-bold text-purple-300 mb-2">üöÄ MOMENTUM ELITE üöÄ</div>
                </div>
              )}

              {prime && (
                <div className="mb-4 p-3 bg-green-500/20 border-2 border-green-500 rounded-lg text-center font-bold text-green-500">
                  ‚≠ê PRIME SETUP ‚≠ê
                </div>
              )}

              {/* Bias/Direction */}
              {(() => {
                const dir = getDirection(tickerData);
                return (
                  <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                    <div className="text-sm text-[#93a4d6] mb-2">Bias / Direction</div>
                    <div className={`inline-block px-4 py-2 rounded-lg font-bold text-lg ${dir.bg} ${dir.color}`}>
                      {dir.text === "LONG" ? "üìà LONG" : dir.text === "SHORT" ? "üìâ SHORT" : dir.text}
                    </div>
                  </div>
                );
              })()}

              {/* Action Description */}
              <div className={`mb-4 p-4 rounded-lg border ${actionInfo.bg} border-current/30`}>
                <div className={`text-lg font-bold mb-2 ${actionInfo.color}`}>{actionInfo.action}</div>
                <div className="text-sm text-[#93a4d6]">{actionInfo.description}</div>
              </div>

              {/* Quadrant Progression */}
              <QuadrantProgression ticker={tickerData} flags={flags} />

              {/* Phase indicator */}
              <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-[#93a4d6]">Phase</span>
                  <span className="text-sm font-semibold" style={{ color: phaseColor }}>
                    {(phase * 100).toFixed(2)}%
                  </span>
                </div>
                <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                  <div className="h-full rounded-full transition-all duration-500" style={{ width: `${phase * 100}%`, backgroundColor: phaseColor }} />
                </div>
              </div>

              {/* Score and Ranking */}
              <div className="space-y-2.5 text-sm mb-4">
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Score</span>
                  <span className="font-semibold text-blue-400 text-lg">{baseScore}</span>
                </div>
                {totalTickers > 0 && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Rank</span>
                    <span className="font-semibold">
                      {rankPosition > 0 ? `#${rankPosition} of ${totalTickers}` : "‚Äî"}
                    </span>
                  </div>
                )}
                {dynamicRank !== baseScore && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Dynamic Score</span>
                    <span className="font-semibold text-green-400">{dynamicRank}</span>
                  </div>
                )}
                {isInTop40 && (
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Top 40 Position</span>
                    <span className="font-semibold text-yellow-400">#{rankPosition} of 40</span>
                  </div>
                )}

                {/* Score Breakdown */}
                {(() => {
                  const breakdown = calculateScoreBreakdown(tickerData);
                  const breakdownComponents = [
                    { label: "Base Score", value: breakdown.base, color: "text-blue-400" },
                    breakdown.aligned > 0 ? { label: "Aligned State", value: `+${breakdown.aligned}`, color: "text-green-400" } : null,
                    breakdown.setup > 0 ? { label: "Setup State", value: `+${breakdown.setup}`, color: "text-green-400" } : null,
                    breakdown.htf > 0 ? { label: "HTF Score", value: `+${breakdown.htf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.ltf > 0 ? { label: "LTF Score", value: `+${breakdown.ltf.toFixed(2)}`, color: "text-cyan-400" } : null,
                    breakdown.completion > 0 ? { label: "Completion Bonus", value: `+${breakdown.completion}`, color: "text-yellow-400" } : null,
                    breakdown.phase !== 0 ? {
                      label: "Phase",
                      value: breakdown.phase > 0 ? `+${breakdown.phase.toFixed(2)}` : breakdown.phase.toFixed(2),
                      color: breakdown.phase > 0 ? "text-green-400" : "text-red-400"
                    } : null,
                    breakdown.squeezeRelease > 0 ? { label: "Squeeze Release", value: `+${breakdown.squeezeRelease}`, color: "text-purple-400" } : null,
                    breakdown.squeezeOn > 0 ? { label: "Squeeze On", value: `+${breakdown.squeezeOn}`, color: "text-yellow-400" } : null,
                    breakdown.phaseZoneChange > 0 ? { label: "Phase Zone Change", value: `+${breakdown.phaseZoneChange}`, color: "text-blue-400" } : null,
                    breakdown.rr > 0 ? { label: "Risk/Reward", value: `+${breakdown.rr}`, color: "text-green-400" } : null,
                    breakdown.momentumElite > 0 ? { label: "Momentum Elite", value: `+${breakdown.momentumElite}`, color: "text-purple-400" } : null,
                  ].filter(Boolean);

                  return breakdownComponents.length > 0 ? (
                    <div className="border-t border-[#26325f] my-3 pt-3">
                      <div className="text-xs text-[#93a4d6] mb-3 font-semibold">Score Breakdown</div>
                      <div className="space-y-1.5">
                        {breakdownComponents.map((comp, idx) => (
                          <div key={idx} className="flex justify-between items-center text-xs">
                            <span className="text-[#93a4d6]">{comp.label}</span>
                            <span className={`font-semibold ${comp.color}`}>{comp.value}</span>
                          </div>
                        ))}
                        <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t border-[#26325f]">
                          <span className="text-[#93a4d6] font-semibold">Total Score</span>
                          <span className="text-blue-400 font-bold text-base">{Math.round(breakdown.total)}</span>
                        </div>
                      </div>
                    </div>
                  ) : null;
                })()}

                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">RR</span>
                  <span className="font-semibold">{tickerData.rr ? Number(tickerData.rr).toFixed(2) : "‚Äî"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">State</span>
                  <span className="font-semibold">{tickerData.state || "‚Äî"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">HTF Score</span>
                  <span className="font-semibold">{tickerData.htf_score != null ? Number(tickerData.htf_score).toFixed(2) : "‚Äî"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">LTF Score</span>
                  <span className="font-semibold">{tickerData.ltf_score != null ? Number(tickerData.ltf_score).toFixed(2) : "‚Äî"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Completion</span>
                  <span className="font-semibold">{tickerData.completion != null ? `${(Number(tickerData.completion) * 100).toFixed(2)}%` : "‚Äî"}</span>
                </div>
                <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                  <span className="text-[#93a4d6]">Price</span>
                  <span className="font-semibold">${tickerData.price ? Number(tickerData.price).toFixed(2) : "‚Äî"}</span>
                </div>
              </div>

              {/* Fundamental & Valuation Metrics */}
              {tickerData.fundamentals && (() => {
                const fund = tickerData.fundamentals;
                const hasValuationData = fund.pe_ratio !== null || fund.peg_ratio !== null || fund.eps_growth_rate !== null;
                
                if (!hasValuationData) return null;

                const valuationSignal = fund.valuation_signal || "fair";
                const signalColor = valuationSignal === "undervalued" ? "text-green-400" : 
                                   valuationSignal === "overvalued" ? "text-red-400" : "text-yellow-400";
                const signalBg = valuationSignal === "undervalued" ? "bg-green-500/20 border-green-500/50" : 
                                valuationSignal === "overvalued" ? "bg-red-500/20 border-red-500/50" : 
                                "bg-yellow-500/20 border-yellow-500/50";

                return (
                  <div className="mt-6 pt-6 border-t-2 border-[#26325f]">
                    <div className="text-sm font-bold text-[#93a4d6] mb-4">üìä Fundamental & Valuation</div>
                    
                    {/* Valuation Signal Badge */}
                    {fund.valuation_signal && (
                      <div className={`mb-4 p-3 rounded-lg border-2 ${signalBg}`}>
                        <div className="flex items-center justify-between">
                          <span className="text-xs text-[#93a4d6]">Valuation Signal</span>
                          <span className={`font-bold text-sm ${signalColor}`}>
                            {fund.valuation_signal.toUpperCase()}
                          </span>
                        </div>
                        {fund.valuation_confidence && (
                          <div className="text-xs text-[#93a4d6] mt-1">
                            Confidence: <span className="font-semibold">{fund.valuation_confidence}</span>
                          </div>
                        )}
                        {fund.valuation_reasons && fund.valuation_reasons.length > 0 && (
                          <div className="mt-2 pt-2 border-t border-current/30">
                            <div className="text-[10px] text-[#93a4d6] mb-1">Reasons:</div>
                            {fund.valuation_reasons.map((reason, idx) => (
                              <div key={idx} className="text-[10px] text-[#93a4d6]/80 mb-0.5">‚Ä¢ {reason}</div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}

                    {/* Basic Metrics */}
                    <div className="space-y-2 text-sm mb-4">
                      {fund.pe_ratio !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">P/E Ratio</span>
                          <span className="font-semibold">{Number(fund.pe_ratio).toFixed(2)}</span>
                        </div>
                      )}
                      {fund.peg_ratio !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">PEG Ratio</span>
                          <span className={`font-semibold ${
                            fund.peg_ratio < 0.8 ? "text-green-400" : 
                            fund.peg_ratio < 1.0 ? "text-yellow-400" : 
                            fund.peg_ratio > 1.5 ? "text-red-400" : "text-[#93a4d6]"
                          }`}>
                            {Number(fund.peg_ratio).toFixed(2)}
                          </span>
                        </div>
                      )}
                      {fund.eps !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">EPS (TTM)</span>
                          <span className="font-semibold">${Number(fund.eps).toFixed(2)}</span>
                        </div>
                      )}
                      {fund.eps_growth_rate !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">EPS Growth (Annual)</span>
                          <span className={`font-semibold ${
                            fund.eps_growth_rate > 20 ? "text-green-400" : 
                            fund.eps_growth_rate > 10 ? "text-yellow-400" : 
                            fund.eps_growth_rate > 0 ? "text-[#93a4d6]" : "text-red-400"
                          }`}>
                            {Number(fund.eps_growth_rate).toFixed(1)}%
                          </span>
                        </div>
                      )}
                      {fund.market_cap !== null && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">Market Cap</span>
                          <span className="font-semibold">
                            {fund.market_cap >= 1e12 ? `$${(fund.market_cap / 1e12).toFixed(2)}T` :
                             fund.market_cap >= 1e9 ? `$${(fund.market_cap / 1e9).toFixed(2)}B` :
                             fund.market_cap >= 1e6 ? `$${(fund.market_cap / 1e6).toFixed(2)}M` :
                             `$${fund.market_cap.toLocaleString()}`}
                          </span>
                        </div>
                      )}
                      {fund.industry && (
                        <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                          <span className="text-[#93a4d6]">Industry</span>
                          <span className="font-semibold text-xs">{fund.industry}</span>
                        </div>
                      )}
                    </div>

                    {/* Fair Value */}
                    {fund.fair_value_price !== null && fund.fair_value_price > 0 && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-2">Fair Value</div>
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm text-[#93a4d6]">Fair Value Price</span>
                          <span className="font-bold text-lg text-blue-400">
                            ${Number(fund.fair_value_price).toFixed(2)}
                          </span>
                        </div>
                        {fund.premium_discount_pct !== null && (
                          <div className="flex items-center justify-between">
                            <span className="text-xs text-[#93a4d6]">Premium/Discount</span>
                            <span className={`font-semibold ${
                              fund.premium_discount_pct < -10 ? "text-green-400" : 
                              fund.premium_discount_pct < 0 ? "text-yellow-400" : 
                              fund.premium_discount_pct > 10 ? "text-red-400" : "text-[#93a4d6]"
                            }`}>
                              {fund.premium_discount_pct > 0 ? "+" : ""}{Number(fund.premium_discount_pct).toFixed(1)}%
                            </span>
                          </div>
                        )}
                        {fund.fair_value_pe && fund.fair_value_pe.preferred && (
                          <div className="mt-2 pt-2 border-t border-[#26325f] text-xs text-[#93a4d6]">
                            Fair P/E: <span className="font-semibold">{Number(fund.fair_value_pe.preferred).toFixed(2)}</span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Historical P/E Percentiles */}
                    {fund.pe_percentiles && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-2">Historical P/E Percentiles</div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          {fund.pe_percentiles.p10 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">10th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p10).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p25 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">25th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p25).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p50 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">50th (Median):</span>
                              <span className="font-semibold text-blue-400">{Number(fund.pe_percentiles.p50).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p75 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">75th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p75).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.p90 !== null && (
                            <div className="flex justify-between">
                              <span className="text-[#93a4d6]">90th:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.p90).toFixed(1)}</span>
                            </div>
                          )}
                          {fund.pe_percentiles.avg !== null && (
                            <div className="flex justify-between col-span-2 pt-1 border-t border-[#26325f]">
                              <span className="text-[#93a4d6]">Average:</span>
                              <span className="font-semibold">{Number(fund.pe_percentiles.avg).toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                        {fund.pe_percentile_position && (
                          <div className="mt-2 pt-2 border-t border-[#26325f] text-xs">
                            <span className="text-[#93a4d6]">Current Position: </span>
                            <span className={`font-semibold ${
                              fund.pe_percentile_position.includes("Bottom") ? "text-green-400" : 
                              fund.pe_percentile_position.includes("Top") ? "text-red-400" : "text-[#93a4d6]"
                            }`}>
                              {fund.pe_percentile_position}
                            </span>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Valuation Boost in Rank */}
                    {tickerData.rank_components && tickerData.rank_components.valuation_boost !== undefined && tickerData.rank_components.valuation_boost !== 0 && (
                      <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-1">Rank Components</div>
                        <div className="flex justify-between items-center text-xs">
                          <span className="text-[#93a4d6]">Base Rank</span>
                          <span className="font-semibold">{tickerData.rank_components.base_rank || baseScore}</span>
                        </div>
                        <div className="flex justify-between items-center text-xs mt-1">
                          <span className="text-[#93a4d6]">Valuation Boost</span>
                          <span className={`font-semibold ${
                            tickerData.rank_components.valuation_boost > 0 ? "text-green-400" : "text-red-400"
                          }`}>
                            {tickerData.rank_components.valuation_boost > 0 ? "+" : ""}{tickerData.rank_components.valuation_boost}
                          </span>
                        </div>
                        <div className="flex justify-between items-center text-sm mt-2 pt-2 border-t border-[#26325f]">
                          <span className="text-[#93a4d6] font-semibold">Final Rank</span>
                          <span className="font-bold text-blue-400">{baseScore}</span>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>

            {/* Fixed Footer */}
            <div className="flex-shrink-0 p-6 pt-4 border-t border-[#26325f] bg-[#121a33]">
              <a
                href={`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(tickerSymbol)}`}
                target="_blank"
                rel="noopener noreferrer"
                className="block w-full text-center px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-all hover:scale-105 font-semibold"
              >
                üìä Open in TradingView
              </a>
            </div>
          </div>
        );
      }

      function TradeRow({ trade, onTickerClick, onTradeClick }) {
        const pnlColor = trade.pnl >= 0 ? "text-green-400" : "text-red-400";
        const statusColor =
          trade.status === "WIN"
            ? "text-green-400"
            : trade.status === "LOSS"
            ? "text-red-400"
            : trade.status === "TP_HIT_TRIM"
            ? "text-blue-400"
            : "text-yellow-400";

        // Determine if this is a futures contract
        const tickerSymbol = String(trade.ticker || "").toUpperCase();
        const isFutures = FUTURES_SPECS[tickerSymbol] || tickerSymbol.endsWith("1!");
        const pointValue = isFutures && FUTURES_SPECS[tickerSymbol] ? FUTURES_SPECS[tickerSymbol].pointValue : 1;
        
        // Calculate position values
        // For futures: shares = contracts (always 1), for stocks: calculate from TRADE_SIZE
        const shares = trade.shares || (isFutures && FUTURES_SPECS[tickerSymbol] ? 1 : TRADE_SIZE / (trade.entryPrice || 1));
        const currentPrice = trade.currentPrice || trade.entryPrice;
        
        // For futures: value calculation is different (contracts * point value * price)
        // For stocks: shares * price
        const marketValue = isFutures && FUTURES_SPECS[tickerSymbol] 
          ? shares * currentPrice * pointValue 
          : shares * currentPrice;
        const entryValue = isFutures && FUTURES_SPECS[tickerSymbol]
          ? shares * trade.entryPrice * pointValue
          : shares * trade.entryPrice;
        const trimmedPct = trade.trimmedPct || 0;
        const trimmedShares = shares * trimmedPct;
        const remainingShares = shares - trimmedShares;
        const trimmedValue = trimmedShares > 0 
          ? (isFutures && FUTURES_SPECS[tickerSymbol]
              ? trimmedShares * (trade.tp || currentPrice) * pointValue
              : trimmedShares * (trade.tp || currentPrice))
          : 0;
        const currentMarketValue = isFutures && FUTURES_SPECS[tickerSymbol]
          ? remainingShares * currentPrice * pointValue
          : remainingShares * currentPrice;

        // Recalculate P&L using correct futures logic (override stored value)
        // Note: trimmedPct is already declared above (line 1336)
        let recalculatedPnl = 0;
        let recalculatedPnlPct = 0;
        const priceDiff = currentPrice - trade.entryPrice;
        
        if (trade.direction === "LONG") {
          const hitTP = currentPrice >= trade.tp;
          const hitSL = currentPrice <= trade.sl;
          
          if (hitTP) {
            if (trimmedPct === 0) {
              // First TP hit - trim 50%
              const tpDiff = trade.tp - trade.entryPrice;
              recalculatedPnl = tpDiff * shares * pointValue * 0.5;
              recalculatedPnlPct = ((trade.tp - trade.entryPrice) / trade.entryPrice) * 100;
            } else {
              // Already trimmed - full exit at TP
              const tpDiff = trade.tp - trade.entryPrice;
              recalculatedPnl = tpDiff * shares * pointValue;
              recalculatedPnlPct = ((trade.tp - trade.entryPrice) / trade.entryPrice) * 100;
            }
          } else if (hitSL) {
            const slDiff = trade.sl - trade.entryPrice;
            recalculatedPnl = slDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.sl - trade.entryPrice) / trade.entryPrice) * 100;
          } else {
            // Still open - calculate current P&L
            recalculatedPnl = priceDiff * shares * pointValue;
            recalculatedPnlPct = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;
          }
        } else {
          // SHORT
          const hitTP = currentPrice <= trade.tp;
          const hitSL = currentPrice >= trade.sl;
          
          if (hitTP) {
            if (trimmedPct === 0) {
              // First TP hit - trim 50%
              const tpDiff = trade.entryPrice - trade.tp;
              recalculatedPnl = tpDiff * shares * pointValue * 0.5;
              recalculatedPnlPct = ((trade.entryPrice - trade.tp) / trade.entryPrice) * 100;
            } else {
              // Already trimmed - full exit at TP
              const tpDiff = trade.entryPrice - trade.tp;
              recalculatedPnl = tpDiff * shares * pointValue;
              recalculatedPnlPct = ((trade.entryPrice - trade.tp) / trade.entryPrice) * 100;
            }
          } else if (hitSL) {
            const slDiff = trade.entryPrice - trade.sl;
            recalculatedPnl = slDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.entryPrice - trade.sl) / trade.entryPrice) * 100;
          } else {
            // Still open - calculate current P&L
            const shortPriceDiff = trade.entryPrice - currentPrice;
            recalculatedPnl = shortPriceDiff * shares * pointValue;
            recalculatedPnlPct = ((trade.entryPrice - currentPrice) / trade.entryPrice) * 100;
          }
        }

        // Parse entryTime - now uses current time when trade was created (not trigger_ts)
        const entryDate = new Date(trade.entryTime);
        const formattedDate = entryDate.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        const formattedTime = entryDate.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit', 
          hour12: true 
        });

        return (
          <tr 
            className="border-b border-[#26325f] hover:bg-[#1a2550] cursor-pointer transition-colors"
            onClick={() => {
              if (onTradeClick) onTradeClick(trade);
              else if (onTickerClick) onTickerClick(trade.ticker);
            }}
          >
            <td className="p-2 text-sm">{trade.ticker}</td>
            <td className="p-2 text-sm">
              <span
                className={`px-2 py-1 rounded text-xs ${
                  trade.direction === "LONG"
                    ? "bg-green-500/20 text-green-400"
                    : "bg-red-500/20 text-red-400"
                }`}
              >
                {trade.direction}
              </span>
            </td>
            <td className="p-2 text-sm">${trade.entryPrice.toFixed(2)}</td>
            <td className="p-2 text-sm">${currentPrice.toFixed(2)}</td>
            <td className="p-2 text-xs text-[#93a4d6]">
              <div className="font-semibold text-white">{formattedDate}</div>
              <div className="text-[#6b7a9f]">{formattedTime}</div>
            </td>
            <td className="p-2 text-sm font-mono">
              {isFutures && FUTURES_SPECS[tickerSymbol] ? (
                <>
                  <div className="text-xs text-[#93a4d6]">Total: {shares.toFixed(0)} contract{shares !== 1 ? 's' : ''}</div>
                  {trimmedShares > 0 && (
                    <div className="text-xs text-blue-400">Remaining: {remainingShares.toFixed(2)} contract{remainingShares !== 1 ? 's' : ''}</div>
                  )}
                </>
              ) : (
                <>
                  <div className="text-xs text-[#93a4d6]">Total: {shares.toFixed(4)}</div>
                  {trimmedShares > 0 && (
                    <div className="text-xs text-blue-400">Remaining: {remainingShares.toFixed(4)}</div>
                  )}
                </>
              )}
            </td>
            <td className="p-2 text-sm">
              <div className="text-xs text-[#93a4d6]">Entry: ${entryValue.toFixed(2)}</div>
              <div className={`font-semibold ${trade.status === "OPEN" || trade.status === "TP_HIT_TRIM" ? "text-yellow-400" : ""}`}>
                Current: ${currentMarketValue.toFixed(2)}
              </div>
            </td>
            <td className="p-2 text-sm">
              {trimmedShares > 0 ? (
                <div className="text-xs text-blue-400">
                  <div>${trimmedValue.toFixed(2)}</div>
                  <div className="text-[#93a4d6]">({(trimmedPct * 100).toFixed(0)}%)</div>
                </div>
              ) : (
                <span className="text-xs text-[#6b7a9f]">-</span>
              )}
            </td>
            <td className="p-2 text-sm">${trade.sl.toFixed(2)}</td>
            <td className="p-2 text-sm">${trade.tp.toFixed(2)}</td>
            <td className="p-2 text-sm">{formatRR(trade.rr)}</td>
            <td className="p-2 text-sm">{trade.rank}</td>
            <td className={`p-2 text-sm font-semibold ${recalculatedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
              ${recalculatedPnl.toFixed(2)}
            </td>
            <td className={`p-2 text-sm font-semibold ${recalculatedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
              {recalculatedPnlPct.toFixed(2)}%
            </td>
            <td className={`p-2 text-sm font-semibold ${statusColor}`}>
              {trade.status === "TP_HIT_TRIM" 
                ? `TRIMMED (${((trade.trimmedPct || 0) * 100).toFixed(0)}%)`
                : trade.status || "OPEN"}
            </td>
            <td className="p-2 text-xs text-[#93a4d6] font-mono">
              {trade.scriptVersion || "unknown"}
            </td>
          </tr>
        );
      }

      function AnalyticsPanel({ analytics }) {
        return (
          <div className="space-y-4">
            {/* Overall Stats */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Overall Performance</h3>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
                <div>
                  <div className="text-xs text-[#93a4d6]">Total Trades</div>
                  <div className="text-2xl font-bold">{analytics.totalTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Open Trades</div>
                  <div className="text-2xl font-bold text-yellow-400">{analytics.openTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Trimmed Trades</div>
                  <div className="text-2xl font-bold text-blue-400">{analytics.trimmedTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Closed Trades</div>
                  <div className="text-2xl font-bold text-white">{analytics.closedTrades}</div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Win Rate</div>
                  <div className="text-2xl font-bold text-green-400">
                    {analytics.winRate.toFixed(1)}%
                  </div>
                </div>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-2 gap-4 pt-4 border-t border-[#26325f]">
                <div>
                  <div className="text-xs text-[#93a4d6]">Closed P&L</div>
                  <div
                    className={`text-2xl font-bold ${
                      analytics.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                    }`}
                  >
                    ${analytics.totalPnl.toFixed(2)}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-[#93a4d6]">Open P&L</div>
                  <div
                    className={`text-2xl font-bold ${
                      analytics.openPnl >= 0 ? "text-green-400" : "text-yellow-400"
                    }`}
                  >
                    ${analytics.openPnl.toFixed(2)}
                  </div>
                </div>
              </div>
              {analytics.totalTrades > 0 && (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 pt-4 border-t border-[#26325f]">
                  <div>
                    <div className="text-xs text-[#93a4d6]">Avg Win</div>
                    <div className="text-lg font-bold text-green-400">
                      ${analytics.avgWin.toFixed(2)}
                    </div>
                  </div>
                  <div>
                    <div className="text-xs text-[#93a4d6]">Avg Loss</div>
                    <div className="text-lg font-bold text-red-400">
                      ${analytics.avgLoss.toFixed(2)}
                    </div>
                  </div>
                  <div>
                    <div className="text-xs text-[#93a4d6]">Profit Factor</div>
                    <div
                      className={`text-lg font-bold ${
                        analytics.profitFactor >= 1.5
                          ? "text-green-400"
                          : analytics.profitFactor >= 1.0
                          ? "text-yellow-400"
                          : "text-red-400"
                      }`}
                    >
                      {analytics.profitFactor.toFixed(2)}
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Self-Learning Recommendations */}
            {analytics.recommendations && analytics.recommendations.length > 0 && (
              <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
                <h3 className="text-lg font-bold mb-4">üéì Self-Learning Recommendations</h3>
                <div className="space-y-2">
                  {analytics.recommendations.map((rec, idx) => (
                    <div
                      key={idx}
                      className={`p-3 rounded-lg border ${
                        rec.priority === "high"
                          ? "bg-yellow-500/10 border-yellow-500/30"
                          : "bg-blue-500/10 border-blue-500/30"
                      }`}
                    >
                      <div className="flex items-start gap-2">
                        <span className="text-lg">
                          {rec.priority === "high" ? "‚ö†Ô∏è" : "üí°"}
                        </span>
                        <div className="flex-1">
                          <div className="text-sm font-semibold">{rec.message}</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Signal Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Signal Performance</h3>
              <div className="space-y-2 max-h-[300px] overflow-y-auto">
                {Object.entries(analytics.signalAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([signals, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={signals}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">
                            {signals || "No Signals"}
                          </div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>

            {/* RR Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Risk/Reward Performance</h3>
              <div className="space-y-2">
                {Object.entries(analytics.rrAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([range, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={range}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">{range}</div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>

            {/* Rank Analysis */}
            <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-4">
              <h3 className="text-lg font-bold mb-4">Rank Performance</h3>
              <div className="space-y-2">
                {Object.entries(analytics.rankAnalysis)
                  .sort((a, b) => {
                    const aRate = a[1].wins / (a[1].wins + a[1].losses || 1);
                    const bRate = b[1].wins / (b[1].wins + b[1].losses || 1);
                    return bRate - aRate;
                  })
                  .map(([range, stats]) => {
                    const total = stats.wins + stats.losses;
                    const winRate = total > 0 ? (stats.wins / total) * 100 : 0;
                    return (
                      <div
                        key={range}
                        className="flex items-center justify-between p-2 bg-[#0f1630] rounded"
                      >
                        <div className="flex-1">
                          <div className="text-sm font-semibold">{range}</div>
                          <div className="text-xs text-[#93a4d6]">
                            {stats.wins}W / {stats.losses}L ({total} trades)
                          </div>
                        </div>
                        <div className="text-right">
                          <div
                            className={`text-sm font-bold ${
                              winRate >= 50 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            {winRate.toFixed(1)}%
                          </div>
                          <div
                            className={`text-xs ${
                              stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"
                            }`}
                          >
                            ${stats.totalPnl.toFixed(2)}
                          </div>
                        </div>
                      </div>
                    );
                  })}
              </div>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Helper Functions for TickerDetails
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      
      // Calculate score breakdown (mirrors worker computeRank logic)
      function calculateScoreBreakdown(ticker) {
        const htf = Number(ticker.htf_score) || 0;
        const ltf = Number(ticker.ltf_score) || 0;
        const comp = Number(ticker.completion) || 0;
        const phase = Number(ticker.phase_pct) || 0;
        const rr = ticker.rr != null ? Number(ticker.rr) : 0;
        
        const flags = ticker.flags || {};
        const sqRel = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        const phaseZoneChange = !!flags.phase_zone_change;
        const momentumElite = !!flags.momentum_elite;
        
        const state = String(ticker.state || "");
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const setup = state === "HTF_BULL_LTF_PULLBACK" || state === "HTF_BEAR_LTF_PULLBACK";
        
        const breakdown = {
          base: 30,
          aligned: aligned ? 12 : 0,
          setup: setup ? 4 : 0,
          htf: 0,
          ltf: 0,
          completion: 0,
          phase: 0,
          squeezeRelease: sqRel ? 12 : 0,
          squeezeOn: (sqOn && !sqRel) ? 4 : 0,
          phaseZoneChange: phaseZoneChange ? 2 : 0,
          rr: 0,
          momentumElite: momentumElite ? 15 : 0,
        };
        
        // HTF contribution
        if (Number.isFinite(htf)) {
          const htfAbs = Math.abs(htf);
          if (htfAbs >= 25) breakdown.htf = Math.min(10, htfAbs * 0.4);
          else if (htfAbs >= 15) breakdown.htf = Math.min(7, htfAbs * 0.35);
          else breakdown.htf = Math.min(4, htfAbs * 0.25);
        }
        
        // LTF contribution
        if (Number.isFinite(ltf)) {
          const ltfAbs = Math.abs(ltf);
          if (ltfAbs >= 20) breakdown.ltf = Math.min(10, ltfAbs * 0.3);
          else if (ltfAbs >= 12) breakdown.ltf = Math.min(6, ltfAbs * 0.25);
          else breakdown.ltf = Math.min(3, ltfAbs * 0.2);
        }
        
        // Completion bonus
        if (Number.isFinite(comp)) {
          if (comp <= 0.2) breakdown.completion = 15;
          else if (comp <= 0.4) breakdown.completion = 10;
          else if (comp <= 0.6) breakdown.completion = 5;
        }
        
        // Phase penalty/bonus
        if (Number.isFinite(phase)) {
          if (phase > 0.5) breakdown.phase = -Math.max(0, (phase - 0.5) * 30);
          if (phase <= 0.3) breakdown.phase = 3;
        }
        
        // RR contribution
        if (Number.isFinite(rr)) {
          if (rr >= 2.0) breakdown.rr = 10;
          else if (rr >= 1.5) breakdown.rr = 7;
          else if (rr >= 1.2) breakdown.rr = 4;
        }
        
        breakdown.total = Math.max(0, Math.min(100, 
          breakdown.base +
          breakdown.aligned +
          breakdown.setup +
          breakdown.htf +
          breakdown.ltf +
          breakdown.completion +
          breakdown.phase +
          breakdown.squeezeRelease +
          breakdown.squeezeOn +
          breakdown.phaseZoneChange +
          breakdown.rr +
          breakdown.momentumElite
        ));
        
        return breakdown;
      }
      
      function phaseToColor(phase) {
        const p = Math.max(0, Math.min(1, phase));
        if (p < 0.2) {
          const t = p / 0.2;
          return `rgb(${Math.round(46 + (39 - 46) * t)}, ${Math.round(204 + (174 - 204) * t)}, ${Math.round(113 + (96 - 113) * t)})`;
        } else if (p < 0.4) {
          const t = (p - 0.2) / 0.2;
          return `rgb(${Math.round(39 + (243 - 39) * t)}, ${Math.round(174 + (156 - 174) * t)}, ${Math.round(96 + (18 - 96) * t)})`;
        } else if (p < 0.6) {
          const t = (p - 0.4) / 0.2;
          return `rgb(${Math.round(243 + (230 - 243) * t)}, ${Math.round(156 + (126 - 156) * t)}, ${Math.round(18 + (34 - 18) * t)})`;
        } else if (p < 0.8) {
          const t = (p - 0.6) / 0.2;
          return `rgb(${Math.round(230 + (231 - 230) * t)}, ${Math.round(126 + (76 - 126) * t)}, ${Math.round(34 + (60 - 34) * t)})`;
        } else {
          const t = (p - 0.8) / 0.2;
          return `rgb(${Math.round(231 + (192 - 231) * t)}, ${Math.round(76 + (57 - 76) * t)}, ${Math.round(60 + (43 - 60) * t)})`;
        }
      }

      function isPrimeBubble(ticker) {
        const rank = Number(ticker.rank || 0);
        const rr = ticker.rr != null ? Number(ticker.rr) : 0;
        const comp = ticker.completion != null ? Number(ticker.completion) : 1;
        const phase = ticker.phase_pct != null ? Number(ticker.phase_pct) : 1;
        const flags = ticker.flags || {};
        const sqRel = !!flags.sq30_release;
        const phaseZoneChange = !!flags.phase_zone_change;
        const state = String(ticker.state || "");
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        return rank >= 75 && rr >= 1.5 && comp < 0.4 && phase < 0.6 && (aligned || sqRel || phaseZoneChange);
      }

      function completionForSize(ticker) {
        const c = Number(ticker.completion);
        return Number.isFinite(c) ? Math.max(0, Math.min(1, c)) : 0;
      }

      function computeDynamicRank(ticker) {
        const baseRank = Number(ticker.rank) || 50;
        const htf = Number(ticker.htf_score) || 0;
        const ltf = Number(ticker.ltf_score) || 0;
        const comp = completionForSize(ticker);
        const phase = Number(ticker.phase_pct) || 0;
        const rr = Number(ticker.rr) || 0;
        const flags = ticker.flags || {};
        const state = String(ticker.state || "");
        const sqRel = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        const phaseZoneChange = !!flags.phase_zone_change;
        const aligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const ent = entryType(ticker);
        const inCorridor = ent.corridor;
        let dynamicScore = baseRank;
        if (inCorridor) {
          dynamicScore += 12;
          if (aligned) dynamicScore += 8;
        }
        if (sqRel && inCorridor) dynamicScore += 10;
        if (sqOn && inCorridor && !sqRel) dynamicScore += 5;
        if (rr >= 2.0) dynamicScore += 8;
        else if (rr >= 1.5) dynamicScore += 5;
        else if (rr >= 1.0) dynamicScore += 2;
        if (phase < 0.3) dynamicScore += 6;
        else if (phase < 0.5) dynamicScore += 3;
        else if (phase > 0.7) dynamicScore -= 5;
        if (comp < 0.3) dynamicScore += 5;
        else if (comp > 0.8) dynamicScore -= 8;
        const htfStrength = Math.min(8, Math.abs(htf) * 0.15);
        const ltfStrength = Math.min(6, Math.abs(ltf) * 0.12);
        dynamicScore += htfStrength + ltfStrength;
        if (phaseZoneChange) dynamicScore += 4;
        return Math.max(0, Math.min(100, Math.round(dynamicScore)));
      }

      function getActionDescription(ticker) {
        const state = String(ticker.state || "");
        const phase = Number(ticker.phase_pct) || 0;
        const comp = completionForSize(ticker);
        const flags = ticker.flags || {};
        const ent = entryType(ticker);
        const rank = Number(ticker.rank || 0);
        const rr = Number(ticker.rr || 0);
        const momentumElite = !!flags.momentum_elite;
        const isAligned = state === "HTF_BULL_LTF_BULL" || state === "HTF_BEAR_LTF_BEAR";
        const isPullback = state === "HTF_BULL_LTF_PULLBACK" || state === "HTF_BEAR_LTF_PULLBACK";
        const isPrime = isPrimeBubble(ticker);
        const inCorridor = ent.corridor;
        const sqRelease = !!flags.sq30_release;
        const sqOn = !!flags.sq30_on;
        if (comp > 0.8) {
          return { action: "Prepare for Exit / Trim Position", description: `Position has reached ${(comp * 100).toFixed(0)}% completion. Consider taking profits or trimming 50-75% of position.`, color: "text-yellow-400", bg: "bg-yellow-500/20" };
        }
        if (phase > 0.7) {
          return { action: "Wait / Trim Existing Position", description: `Phase oscillator at ${(phase * 100).toFixed(0)}% indicates late-cycle conditions. Wait for pullback or trim existing positions.`, color: "text-orange-400", bg: "bg-orange-500/20" };
        }
        if (momentumElite && isPrime && inCorridor && rank >= 75 && rr >= 1.5) {
          return { action: "Initiate Position - High Conviction", description: `Momentum Elite stock showing Prime setup with exceptional alignment. High-probability setup with strong fundamentals.`, color: "text-green-400", bg: "bg-green-500/20" };
        }
        if (sqRelease && inCorridor && isAligned) {
          return { action: "Initiate Position - Squeeze Release", description: `Squeeze release detected with timeframe alignment in entry corridor. Enter on pullback or break.`, color: "text-green-400", bg: "bg-green-500/20" };
        }
        if (inCorridor && isAligned && comp < 0.5 && phase < 0.6) {
          return { action: "Consider Entry - Favorable Setup", description: `Setup is in entry corridor with both timeframes aligned. Early phase and low completion suggest room to run.`, color: "text-blue-400", bg: "bg-blue-500/20" };
        }
        return { action: "Wait - Setup Not Optimal", description: `Setup not yet optimal for entry. Wait for better conditions or confirmation signals.`, color: "text-[#93a4d6]", bg: "bg-[#26325f]" };
      }

      function getQuadrantFromState(state) {
        if (state === "HTF_BULL_LTF_PULLBACK") return { q: 1, name: "Q1", label: "Bull Setup", color: "blue" };
        if (state === "HTF_BULL_LTF_BULL") return { q: 2, name: "Q2", label: "Bull Momentum", color: "green" };
        if (state === "HTF_BEAR_LTF_BEAR") return { q: 3, name: "Q3", label: "Bear Momentum", color: "red" };
        if (state === "HTF_BEAR_LTF_PULLBACK") return { q: 4, name: "Q4", label: "Bear Setup", color: "orange" };
        return null;
      }

      function detectPatterns(trail, flags) {
        if (!trail || trail.length < 2) return [];
        const patterns = [];
        const states = trail.map(p => p.state).filter(Boolean);
        for (let i = 1; i < states.length; i++) {
          if (states[i-1] === "HTF_BULL_LTF_PULLBACK" && states[i] === "HTF_BULL_LTF_BULL") {
            patterns.push({ type: "IDEAL_ENTRY", description: "Clean Q1‚ÜíQ2 transition (Bull Entry)", quadrant: "Q1‚ÜíQ2", confidence: "HIGH" });
          }
          if (states[i-1] === "HTF_BEAR_LTF_PULLBACK" && states[i] === "HTF_BEAR_LTF_BEAR") {
            patterns.push({ type: "IDEAL_ENTRY", description: "Clean Q4‚ÜíQ3 transition (Bear Entry)", quadrant: "Q4‚ÜíQ3", confidence: "HIGH" });
          }
        }
        return patterns;
      }

      function QuadrantProgression({ ticker, flags }) {
        const [trail, setTrail] = useState([]);
        const [loading, setLoading] = useState(false);
        const [hasLoaded, setHasLoaded] = useState(false);
        useEffect(() => {
          if (!hasLoaded && ticker && ticker.ticker) {
            setLoading(true);
            const timeoutId = setTimeout(async () => {
              try {
                const res = await fetch(`${API_BASE}/timed/trail?ticker=${encodeURIComponent(ticker.ticker)}`);
                if (res.ok) {
                  const data = await res.json();
                  if (data.ok && Array.isArray(data.trail)) {
                    setTrail(data.trail);
                  }
                }
              } catch (e) {
                console.error("Failed to load trail:", e);
              } finally {
                setLoading(false);
                setHasLoaded(true);
              }
            }, 300);
            return () => clearTimeout(timeoutId);
          }
        }, [ticker?.ticker, hasLoaded]);
        const patterns = detectPatterns(trail, flags || {});
        const currentQuad = getQuadrantFromState(ticker.state);
        const quadHistory = trail.map(p => getQuadrantFromState(p.state)).filter(Boolean);
        return (
          <div className="mb-4 p-4 bg-[#0f1630] rounded-lg border border-[#26325f]">
            <div className="text-sm font-bold mb-3 text-[#93a4d6]">Quadrant Progression</div>
            <div className="grid grid-cols-2 gap-2 mb-4">
              {[1, 2, 4, 3].map(q => {
                const quad = q === 1 ? { q: 1, name: "Q1", label: "Bull Setup", color: "blue" } :
                             q === 2 ? { q: 2, name: "Q2", label: "Bull Momentum", color: "green" } :
                             q === 4 ? { q: 4, name: "Q4", label: "Bear Setup", color: "orange" } :
                             { q: 3, name: "Q3", label: "Bear Momentum", color: "red" };
                const isActive = currentQuad?.q === quad.q;
                const hasHistory = quadHistory.some(qh => qh && qh.q === quad.q);
                return (
                  <div key={q} className={`p-3 rounded-lg border-2 ${
                    isActive ? `border-${quad.color}-400 bg-${quad.color}-500/20` :
                    hasHistory ? `border-${quad.color}-500/50 bg-${quad.color}-500/10` :
                    "border-[#26325f] bg-[#0a0f1f]"
                  }`}>
                    <div className={`text-xs font-bold text-${quad.color}-400`}>{quad.name}: {quad.label}</div>
                  </div>
                );
              })}
            </div>
            {patterns.length > 0 && (
              <div className="mt-4 pt-4 border-t border-[#26325f]">
                <div className="text-xs font-bold text-yellow-400 mb-2">üéØ Detected Patterns</div>
                {patterns.map((pattern, idx) => (
                  <div key={idx} className="p-2 rounded border bg-yellow-500/20 border-yellow-400/50 mb-2">
                    <div className="text-xs font-bold text-white">{pattern.description}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      function TickerDetails({ ticker, onClose, allLoadedData = null }) {
        if (!ticker) return null;
        const prime = isPrimeBubble(ticker);
        const ent = entryType(ticker);
        const flags = ticker.flags || {};
        const phase = Number(ticker.phase_pct) || 0;
        const phaseColor = phaseToColor(phase);
        const actionInfo = getActionDescription(ticker);
        const allLoadedTickersArray = (() => {
          if (allLoadedData && typeof allLoadedData === 'object') {
            if (Array.isArray(allLoadedData)) return allLoadedData;
            return Object.values(allLoadedData).filter(t => t && typeof t === 'object' && t.ticker);
          }
          return [];
        })();
        const baseScore = Number(ticker.rank) || 0;
        const dynamicRank = computeDynamicRank(ticker);
        const allTickersWithRank = allLoadedTickersArray.map(t => ({ ...t, dynamicRank: computeDynamicRank(t) }));
        const sortedByDynamic = [...allTickersWithRank].sort((a, b) => b.dynamicRank - a.dynamicRank);
        const rankPosition = sortedByDynamic.findIndex(t => String(t.ticker || "").toUpperCase() === String(ticker.ticker || "").toUpperCase()) + 1;
        const totalTickers = allLoadedTickersArray.length;
        return (
          <div className="w-full h-full flex flex-col">
            <div className="bg-[#121a33] border-2 border-[#26325f] rounded-xl w-full h-full flex flex-col slide-in-right shadow-2xl">
              <div className="flex-1 overflow-y-auto p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-xl font-bold">{ticker.ticker}</h3>
                  <button onClick={onClose} className="text-[#93a4d6] hover:text-white transition-colors text-xl leading-none w-6 h-6 flex items-center justify-center rounded hover:bg-[#26325f]">‚úï</button>
                </div>
                {flags.momentum_elite && (
                  <div className="mb-4 p-3 bg-gradient-to-r from-purple-500/30 via-pink-500/30 to-purple-500/30 border-2 border-purple-400 rounded-lg">
                    <div className="text-center font-bold text-purple-300 mb-2">üöÄ MOMENTUM ELITE üöÄ</div>
                  </div>
                )}
                {prime && (
                  <div className="mb-4 p-3 bg-green-500/20 border-2 border-green-500 rounded-lg text-center font-bold text-green-500">‚≠ê PRIME SETUP ‚≠ê</div>
                )}
                {(() => {
                  const dir = getDirection(ticker);
                  return (
                    <div className="mb-4 p-3 bg-[#0f1630] border-2 border-[#26325f] rounded-lg">
                      <div className="text-sm text-[#93a4d6] mb-2">Bias / Direction</div>
                      <div className={`inline-block px-4 py-2 rounded-lg font-bold text-lg ${dir.bg} ${dir.color}`}>{dir.text === "LONG" ? "üìà LONG" : dir.text === "SHORT" ? "üìâ SHORT" : dir.text}</div>
                    </div>
                  );
                })()}
                <div className={`mb-4 p-4 rounded-lg border ${actionInfo.bg} border-current/30`}>
                  <div className={`text-lg font-bold mb-2 ${actionInfo.color}`}>{actionInfo.action}</div>
                  <div className="text-sm text-[#93a4d6]">{actionInfo.description}</div>
                </div>
                <QuadrantProgression ticker={ticker} flags={flags} />
                <div className="mb-4 p-3 bg-[#0f1630] rounded-lg border border-[#26325f]">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-[#93a4d6]">Phase</span>
                    <span className="text-sm font-semibold" style={{ color: phaseColor }}>{(phase * 100).toFixed(2)}%</span>
                  </div>
                  <div className="h-3 bg-[#26325f] rounded-full overflow-hidden">
                    <div className="h-full rounded-full transition-all duration-500" style={{ width: `${phase * 100}%`, backgroundColor: phaseColor }} />
                  </div>
                </div>
                <div className="space-y-2.5 text-sm">
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Score</span>
                    <span className="font-semibold text-blue-400 text-lg">{baseScore}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Rank</span>
                    <span className="font-semibold">{rankPosition > 0 ? `#${rankPosition} of ${totalTickers}` : "‚Äî"}</span>
                  </div>
                  {dynamicRank !== baseScore && (
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Dynamic Score</span>
                      <span className="font-semibold text-green-400">{dynamicRank}</span>
                    </div>
                  )}
                  
                  {/* Score Breakdown */}
                  {(() => {
                    const breakdown = calculateScoreBreakdown(ticker);
                    const components = [
                      { label: "Base Score", value: breakdown.base, color: "text-blue-400" },
                      breakdown.aligned > 0 ? { label: "Aligned State", value: `+${breakdown.aligned}`, color: "text-green-400" } : null,
                      breakdown.setup > 0 ? { label: "Setup State", value: `+${breakdown.setup}`, color: "text-green-400" } : null,
                      breakdown.htf > 0 ? { label: "HTF Score", value: `+${breakdown.htf.toFixed(1)}`, color: "text-cyan-400" } : null,
                      breakdown.ltf > 0 ? { label: "LTF Score", value: `+${breakdown.ltf.toFixed(1)}`, color: "text-cyan-400" } : null,
                      breakdown.completion > 0 ? { label: "Completion Bonus", value: `+${breakdown.completion}`, color: "text-yellow-400" } : null,
                      breakdown.phase !== 0 ? { label: "Phase", value: breakdown.phase > 0 ? `+${breakdown.phase.toFixed(2)}` : breakdown.phase.toFixed(2), color: breakdown.phase > 0 ? "text-green-400" : "text-red-400" } : null,
                      breakdown.squeezeRelease > 0 ? { label: "Squeeze Release", value: `+${breakdown.squeezeRelease}`, color: "text-purple-400" } : null,
                      breakdown.squeezeOn > 0 ? { label: "Squeeze On", value: `+${breakdown.squeezeOn}`, color: "text-yellow-400" } : null,
                      breakdown.phaseZoneChange > 0 ? { label: "Phase Zone Change", value: `+${breakdown.phaseZoneChange}`, color: "text-blue-400" } : null,
                      breakdown.rr > 0 ? { label: "Risk/Reward", value: `+${breakdown.rr}`, color: "text-green-400" } : null,
                      breakdown.momentumElite > 0 ? { label: "Momentum Elite", value: `+${breakdown.momentumElite}`, color: "text-purple-400" } : null,
                    ].filter(Boolean);
                    
                    return (
                      <div className="mt-4 pt-4 border-t border-[#26325f]">
                        <div className="text-xs text-[#93a4d6] mb-3 font-semibold">Score Breakdown</div>
                        <div className="space-y-1.5">
                          {components.map((comp, idx) => (
                            <div key={idx} className="flex justify-between items-center text-xs">
                              <span className="text-[#93a4d6]">{comp.label}</span>
                              <span className={`font-semibold ${comp.color}`}>{comp.value}</span>
                            </div>
                          ))}
                          <div className="flex justify-between items-center pt-2 mt-2 border-t border-[#26325f]/50">
                            <span className="text-[#93a4d6] font-semibold">Total Score</span>
                            <span className="font-bold text-lg text-blue-400">{Math.round(breakdown.total)}</span>
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">RR</span>
                    <span className="font-semibold">{ticker.rr ? Number(ticker.rr).toFixed(2) : "‚Äî"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">State</span>
                    <span className="font-semibold">{ticker.state || "‚Äî"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Completion</span>
                    <span className="font-semibold">{Math.round(completionForSize(ticker) * 100)}%</span>
                  </div>
                  {ent.corridor && (
                    <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                      <span className="text-[#93a4d6]">Corridor</span>
                      <span className="px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-semibold">{ent.side}</span>
                    </div>
                  )}
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">Current Price</span>
                    <span className="font-semibold text-lg">{ticker.price ? `$${Number(ticker.price).toFixed(2)}` : "‚Äî"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">TP (Primary)</span>
                    <span className="font-semibold">{ticker.tp ? `$${Number(ticker.tp).toFixed(2)}` : "‚Äî"}</span>
                  </div>
                  <div className="flex justify-between items-center py-1 border-b border-[#26325f]/50">
                    <span className="text-[#93a4d6]">SL</span>
                    <span className="font-semibold">{ticker.sl ? Number(ticker.sl).toFixed(2) : "‚Äî"}</span>
                  </div>
                </div>
                {(flags.sq30_on || flags.sq30_release || flags.phase_dot || flags.phase_zone_change) && (
                  <div className="mt-4 pt-4">
                    <div className="text-xs text-[#93a4d6] mb-2">Flags:</div>
                    <div className="flex flex-wrap gap-2">
                      {flags.sq30_on && <span className="px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 text-xs">üß® Squeeze ON</span>}
                      {flags.sq30_release && <span className="px-2 py-1 rounded bg-cyan-500/20 text-cyan-400 text-xs">‚ö° Squeeze Release</span>}
                      {flags.phase_dot && <span className="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs">Phase Dot</span>}
                      {flags.phase_zone_change && <span className="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs">Zone Change</span>}
                    </div>
                  </div>
                )}
              </div>
              <div className="flex-shrink-0 p-6 pt-4 border-t border-[#26325f] bg-[#121a33]">
                <a href={`https://www.tradingview.com/chart/?symbol=${encodeURIComponent(ticker.ticker)}`} target="_blank" rel="noopener noreferrer" className="block w-full text-center px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-all hover:scale-105 font-semibold">üìä Open in TradingView</a>
              </div>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // TickerDetailsLoader - Loads ticker data and passes to unified component
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const TickerDetailsLoader = ({ tickerSymbol, trade = null, onClose, allLoadedData = null }) => {
        const [tickerData, setTickerData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        
        useEffect(() => {
          const fetchTicker = async () => {
            try {
              setLoading(true);
              const res = await fetch(`${API_BASE}/timed/latest?ticker=${encodeURIComponent(tickerSymbol)}`);
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const json = await res.json();
              if (!json.ok || !json.data) {
                throw new Error(json.error || 'Ticker not found');
              }
              setTickerData(json.data || json.latestData);
            } catch (err) {
              console.error('Failed to fetch ticker:', err);
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };
          fetchTicker();
        }, [tickerSymbol]);
        
        if (loading) {
          return (
            <div className="w-full h-full flex items-center justify-center bg-[#0f1630]">
              <div className="text-center">
                <div className="loading-spinner mx-auto mb-4"></div>
                <div className="text-[#93a4d6]">Loading {tickerSymbol}...</div>
              </div>
            </div>
          );
        }
        
        if (error || !tickerData) {
          return (
            <div className="w-full h-full flex items-center justify-center bg-[#0f1630]">
              <div className="text-center">
                <div className="text-red-400 mb-2">Failed to load {tickerSymbol}</div>
                <div className="text-[#93a4d6] text-sm mb-4">{error || 'No data available'}</div>
                <button onClick={onClose} className="px-4 py-2 bg-[#26325f] hover:bg-[#3a4aa0] rounded-lg text-white">Close</button>
              </div>
            </div>
          );
        }
        
        return <TickerDetailRightRail ticker={tickerData} trade={trade} onClose={onClose} allLoadedData={allLoadedData} />;
      };

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Welcome Modal Component - Dashboard Guide (Trading Concepts)
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function DashboardWelcomeModal({ onClose }) {
        const [currentStep, setCurrentStep] = useState(0);
        
        const steps = [
          {
            title: "Welcome to Timed Trading! üéØ",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  This dashboard helps you find high-quality trading setups by combining multiple timeframes and technical indicators.
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üéì How to Use This Guide</h3>
                  <p className="text-sm text-[#93a4d6]">
                    Click "Next" to learn about each concept, or use the navigation dots to jump to any section. 
                    You can always reopen this guide from the navigation bar.
                  </p>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">‚ú® Quick Start</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Look for bubbles in the <strong className="text-white">green zones</strong> (Q1 & Q2) for LONG setups</li>
                    <li>Look for bubbles in the <strong className="text-white">red zones</strong> (Q3 & Q4) for SHORT setups</li>
                    <li>Click on any bubble to see detailed information</li>
                    <li>Use filters to narrow down the best opportunities</li>
                  </ol>
                </div>
              </div>
            ),
          },
          {
            title: "Understanding the Quadrants üìä",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The chart is divided into <strong>4 quadrants</strong> based on two scores:
                </p>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                    <h3 className="text-green-400 font-semibold mb-2">HTF Score (Y-axis)</h3>
                    <p className="text-sm text-[#93a4d6]">
                      <strong className="text-white">Higher Timeframe</strong> - Shows the overall trend direction.
                      <br />‚Ä¢ Positive = Bullish trend
                      <br />‚Ä¢ Negative = Bearish trend
                    </p>
                  </div>
                  <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                    <h3 className="text-blue-400 font-semibold mb-2">LTF Score (X-axis)</h3>
                    <p className="text-sm text-[#93a4d6]">
                      <strong className="text-white">Lower Timeframe</strong> - Shows entry timing.
                      <br />‚Ä¢ Positive = Momentum/Continuation
                      <br />‚Ä¢ Negative = Pullback/Setup
                    </p>
                  </div>
                </div>
                <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                  <h3 className="text-yellow-400 font-semibold mb-3">The 4 Quadrants:</h3>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Q1: Long Setup üìà</div>
                      <div className="text-[#93a4d6]">HTF Bull + LTF Pullback</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Best entry zone for LONG trades</div>
                    </div>
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Q2: Long Momentum üöÄ</div>
                      <div className="text-[#93a4d6]">HTF Bull + LTF Bull</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Strong momentum, already moving</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Q3: Short Momentum üìâ</div>
                      <div className="text-[#93a4d6]">HTF Bear + LTF Bear</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Strong momentum, already moving</div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Q4: Short Setup üîª</div>
                      <div className="text-[#93a4d6]">HTF Bear + LTF Pullback</div>
                      <div className="text-xs text-[#93a4d6] mt-1">Best entry zone for SHORT trades</div>
                    </div>
                  </div>
                </div>
              </div>
            ),
          },
          {
            title: "Prime Setups ‚≠ê",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  <strong className="text-yellow-400">Prime Setups</strong> are the highest-quality opportunities. 
                  They have a ‚≠ê icon and appear with a green glow.
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">Prime Setup Criteria:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Rank ‚â• 75</strong> - High overall quality score</li>
                    <li><strong className="text-white">Risk/Reward ‚â• 1.5</strong> - Good profit potential vs risk</li>
                    <li><strong className="text-white">Completion ‚â§ 40%</strong> - Still early in the move</li>
                    <li><strong className="text-white">In Corridor</strong> - Valid entry zone</li>
                  </ul>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üí° How to Find Prime Setups:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"Prime Only"</strong> filter button</li>
                    <li>Look for bubbles with ‚≠ê icons and green borders</li>
                    <li>Click on a bubble to see detailed entry/exit levels</li>
                    <li>Check the Risk/Reward ratio - higher is better!</li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Tip:</strong> Prime setups are rare but offer the best risk/reward. 
                    Focus on Q1 (Long Setup) and Q4 (Short Setup) quadrants for the best entries.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "In Corridor üéØ",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The <strong className="text-cyan-400">Corridor</strong> is a specific zone where entries are considered valid and safe.
                </p>
                <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                  <h3 className="text-cyan-400 font-semibold mb-2">What is a Corridor?</h3>
                  <p className="text-sm text-[#93a4d6] mb-3">
                    A corridor is a narrow band on the chart where price action is optimal for entry. 
                    Think of it as a "sweet spot" where the setup is most likely to succeed.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">Long Corridor üìà</div>
                      <div className="text-xs text-[#93a4d6]">
                        HTF Score &gt; 0<br />
                        LTF Score: -8 to +12
                      </div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">Short Corridor üìâ</div>
                      <div className="text-xs text-[#93a4d6]">
                        HTF Score &lt; 0<br />
                        LTF Score: -12 to +8
                      </div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üéØ How to Use Corridor Filter:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"In Corridor"</strong> filter button</li>
                    <li>This shows only tickers in valid entry zones</li>
                    <li>These are the safest setups to trade</li>
                    <li>Combine with "Prime Only" for the best opportunities</li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Why Corridors Matter:</strong> Tickers outside corridors may be too early, 
                    too late, or in unfavorable conditions. Corridor entries have the highest probability of success.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "TD Sequential (TD9) üî¢",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  <strong className="text-purple-400">TD Sequential</strong> is a powerful indicator that identifies potential reversal points.
                </p>
                <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                  <h3 className="text-purple-400 font-semibold mb-2">What is TD9?</h3>
                  <p className="text-sm text-[#93a4d6] mb-3">
                    TD Sequential counts consecutive bars in one direction. When it reaches <strong className="text-white">9</strong>, 
                    it signals potential exhaustion and reversal.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <div className="bg-green-500/10 border border-green-500/30 rounded p-3">
                      <div className="font-bold text-green-400 mb-1">TD9 Bullish üìà</div>
                      <div className="text-xs text-[#93a4d6]">
                        Signals potential <strong>bottom</strong> and upward reversal
                        <br /><br />
                        <strong>Action:</strong> Look for LONG entries
                      </div>
                    </div>
                    <div className="bg-red-500/10 border border-red-500/30 rounded p-3">
                      <div className="font-bold text-red-400 mb-1">TD9 Bearish üìâ</div>
                      <div className="text-xs text-[#93a4d6]">
                        Signals potential <strong>top</strong> and downward reversal
                        <br /><br />
                        <strong>Action:</strong> Look for SHORT entries or exit LONGs
                      </div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üî¢ How to Use TD9 Filter:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>Click the <strong className="text-white">"TD9 Setup"</strong> filter button</li>
                    <li>This shows only tickers with active TD9 signals</li>
                    <li>TD9 signals are strongest when combined with other factors:
                      <ul className="list-disc list-inside ml-4 mt-1">
                        <li>In the correct quadrant (Q1 for bullish, Q4 for bearish)</li>
                        <li>In corridor</li>
                        <li>With good Risk/Reward</li>
                      </ul>
                    </li>
                  </ol>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Pro Tip:</strong> TD9 signals are most powerful at extremes. 
                    If you see a TD9 signal in Q1 (Long Setup) or Q4 (Short Setup), it's a strong confirmation of a reversal setup.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Squeeze Indicators üß®‚ö°",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The <strong className="text-yellow-400">Squeeze</strong> indicator shows when volatility is building up, 
                  like a spring being compressed before release.
                </p>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                    <h3 className="text-yellow-400 font-semibold mb-2 flex items-center gap-2">
                      üß® In Squeeze
                    </h3>
                    <p className="text-sm text-[#93a4d6] mb-3">
                      Volatility is <strong className="text-white">compressed</strong> - price is consolidating.
                    </p>
                    <div className="text-xs text-[#93a4d6] space-y-1">
                      <div><strong className="text-white">What it means:</strong> Energy is building up</div>
                      <div><strong className="text-white">Action:</strong> Watch closely - a big move is coming</div>
                      <div><strong className="text-white">When to enter:</strong> Wait for squeeze release</div>
                    </div>
                  </div>
                  <div className="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                    <h3 className="text-cyan-400 font-semibold mb-2 flex items-center gap-2">
                      ‚ö° Squeeze Release
                    </h3>
                    <p className="text-sm text-[#93a4d6] mb-3">
                      Volatility has <strong className="text-white">exploded</strong> - price is breaking out.
                    </p>
                    <div className="text-xs text-[#93a4d6] space-y-1">
                      <div><strong className="text-white">What it means:</strong> The spring has released!</div>
                      <div><strong className="text-white">Action:</strong> Strong momentum signal</div>
                      <div><strong className="text-white">When to enter:</strong> Enter on pullback or breakout</div>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üéØ How to Use Squeeze Filters:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">"In Squeeze" Filter:</strong> Shows tickers where volatility is building. 
                      These are good to watch but wait for release before entering.
                    </div>
                    <div>
                      <strong className="text-white">"Squeeze Release" Filter:</strong> Shows tickers where the squeeze has fired. 
                      These often have strong momentum - combine with Prime filter for best results.
                    </div>
                  </div>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">üí° Best Practices:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Squeeze Release + Prime Setup</strong> = Very strong signal</li>
                    <li><strong className="text-white">Squeeze Release + In Corridor</strong> = High probability entry</li>
                    <li><strong className="text-white">In Squeeze</strong> = Prepare but don't enter yet</li>
                    <li>Look for squeeze release in the direction of the HTF trend</li>
                  </ul>
                </div>
              </div>
            ),
          },
          {
            title: "Putting It All Together üéì",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  Now that you understand the concepts, here's a <strong className="text-yellow-400">step-by-step workflow</strong> to find great setups:
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-3">üìã Your Trading Workflow:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-3">
                    <li>
                      <strong className="text-white">Step 1: Choose Your Direction</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ For LONG trades: Focus on Q1 (Long Setup) quadrant</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ For SHORT trades: Focus on Q4 (Short Setup) quadrant</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 2: Apply Quality Filters</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Click "Prime Only" to see only high-quality setups</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Click "In Corridor" to ensure valid entry zones</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 3: Look for Confirmation Signals</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ TD9 Setup: Strong reversal signal</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Squeeze Release ‚ö°: Strong momentum</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Momentum Elite üöÄ: Best fundamentals</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 4: Analyze the Setup</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Click on a bubble to see details</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Check Risk/Reward ratio (aim for ‚â• 1.5)</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Verify entry price, stop loss, and take profit levels</span>
                    </li>
                    <li>
                      <strong className="text-white">Step 5: Execute Your Trade</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Enter at the suggested entry price</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Set stop loss at the SL level</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Target the TP levels (consider trimming at first TP)</span>
                    </li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">‚≠ê The Perfect Setup Checklist:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div>‚úÖ In the correct quadrant (Q1 for LONG, Q4 for SHORT)</div>
                    <div>‚úÖ Prime Setup (‚≠ê icon)</div>
                    <div>‚úÖ In Corridor</div>
                    <div>‚úÖ Risk/Reward ‚â• 1.5</div>
                    <div>‚úÖ Completion ‚â§ 40% (still early)</div>
                    <div>‚úÖ TD9 signal OR Squeeze Release (bonus confirmation)</div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Remember:</strong> Not every setup will have all these factors. 
                    Use your judgment and risk management. Start with paper trading if you're new!
                  </p>
                </div>
              </div>
            ),
          },
        ];

        const nextStep = () => {
          if (currentStep < steps.length - 1) {
            setCurrentStep(currentStep + 1);
          }
        };

        const prevStep = () => {
          if (currentStep > 0) {
            setCurrentStep(currentStep - 1);
          }
        };

        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-[#0b1020] border-2 border-[#26325f] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
              <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-b border-[#26325f] p-6 flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-1">{steps[currentStep].title}</h2>
                  <div className="flex gap-1">
                    {steps.map((_, i) => (
                      <div
                        key={i}
                        className={`h-2 w-2 rounded-full transition-all ${
                          i === currentStep
                            ? "bg-blue-400 w-8"
                            : i < currentStep
                            ? "bg-green-400"
                            : "bg-[#26325f]"
                        }`}
                      />
                    ))}
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-[#93a4d6] hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-[#26325f] transition-colors"
                  title="Close Welcome Guide"
                >
                  √ó
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-6">
                {steps[currentStep].content}
              </div>
              <div className="border-t border-[#26325f] p-4 flex items-center justify-between bg-[#0f1630]">
                <button
                  onClick={prevStep}
                  disabled={currentStep === 0}
                  className={`px-4 py-2 rounded-lg border transition-all ${
                    currentStep === 0
                      ? "border-[#26325f] text-[#93a4d6] opacity-50 cursor-not-allowed"
                      : "border-[#26325f] bg-[#1a2550] hover:bg-[#26325f] text-white"
                  }`}
                >
                  ‚Üê Previous
                </button>
                <div className="text-sm text-[#93a4d6]">
                  Step {currentStep + 1} of {steps.length}
                </div>
                {currentStep < steps.length - 1 ? (
                  <button
                    onClick={nextStep}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold transition-all"
                  >
                    Next ‚Üí
                  </button>
                ) : (
                  <button
                    onClick={onClose}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold transition-all"
                  >
                    Start Trading! üöÄ
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Welcome Modal Component - Simulated Trades Guide
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function TrackerWelcomeModal({ onClose }) {
        const [currentStep, setCurrentStep] = useState(0);
        
        const steps = [
          {
            title: "Welcome to Trade Tracker! üìä",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  The Trade Tracker automatically simulates trades based on alerts from the main dashboard, 
                  helping you learn which setups work best.
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üéØ How It Works:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-1">
                    <li>When an alert fires from TradingView, a simulated trade is automatically created</li>
                    <li>Each trade uses a <strong className="text-white">$1,000 position size</strong></li>
                    <li>Trades are tracked in real-time with live P&L updates</li>
                    <li>When price hits Stop Loss or Take Profit, the trade closes automatically</li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">‚ú® What You'll Learn:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li>Which setups have the best win rate</li>
                    <li>How different Risk/Reward ratios perform</li>
                    <li>Which model versions work best</li>
                    <li>Performance by rank, sector, and other factors</li>
                  </ul>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Note:</strong> These are simulated trades for learning purposes only. 
                    Always do your own research before making real trades!
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Understanding Trade Statuses üè∑Ô∏è",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  Each trade has a <strong>status</strong> that tells you its current state:
                </p>
                <div className="grid grid-cols-1 gap-3">
                  <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                    <div className="font-bold text-green-400 mb-2 flex items-center gap-2">
                      <span>üü¢ OPEN</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade is active and being tracked. P&L updates in real-time as price moves.
                      The trade will close when it hits Stop Loss or Take Profit.
                    </p>
                  </div>
                  <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                    <div className="font-bold text-blue-400 mb-2 flex items-center gap-2">
                      <span>üîµ TP_HIT_TRIM</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      First Take Profit level was hit! The system automatically trimmed (sold) part of the position 
                      to lock in profits. The remaining position stays open to target higher TP levels.
                    </p>
                  </div>
                  <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                    <div className="font-bold text-green-400 mb-2 flex items-center gap-2">
                      <span>‚úÖ WIN</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade closed profitably! Either hit a Take Profit level or was manually closed in profit.
                      Check the trade history to see the exit details.
                    </p>
                  </div>
                  <div className="bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                    <div className="font-bold text-red-400 mb-2 flex items-center gap-2">
                      <span>‚ùå LOSS</span>
                    </div>
                    <p className="text-sm text-[#93a4d6]">
                      Trade hit Stop Loss and closed at a loss. This is normal - not every trade wins!
                      Review what went wrong to improve future setups.
                    </p>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Tip:</strong> Click on any trade row to see detailed information 
                    including entry price, stop loss, take profit levels, and full trade history.
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Reading the Trade Table üìã",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The trade table shows all your simulated trades. Here's what each column means:
                </p>
                <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                  <div className="space-y-3 text-sm">
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Ticker</span>
                      <span className="text-[#93a4d6]">The stock or futures contract symbol</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Direction</span>
                      <span className="text-[#93a4d6]">LONG (buy) or SHORT (sell)</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Entry Price</span>
                      <span className="text-[#93a4d6]">Price when the trade was opened</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Current Price</span>
                      <span className="text-[#93a4d6]">Live market price (updates every 30 seconds)</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">P&L</span>
                      <span className="text-[#93a4d6]">
                        Profit or Loss in dollars. <span className="text-green-400">Green = profit</span>, 
                        <span className="text-red-400"> red = loss</span>
                      </span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">P&L %</span>
                      <span className="text-[#93a4d6]">Profit or Loss as a percentage</span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Shares/Contracts</span>
                      <span className="text-[#93a4d6]">
                        For stocks: number of shares (based on $1,000 position). 
                        For futures: number of contracts (usually 1)
                      </span>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="font-bold text-white min-w-[120px]">Status</span>
                      <span className="text-[#93a4d6]">Current trade status (OPEN, WIN, LOSS, etc.)</span>
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üí° Pro Tips:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li>Click any trade row to see detailed information and trade history</li>
                    <li>Use the version filter to compare different model versions</li>
                    <li>Open trades show live P&L that updates automatically</li>
                    <li>Closed trades show final P&L and exit reason</li>
                  </ul>
                </div>
              </div>
            ),
          },
          {
            title: "How P&L is Calculated üí∞",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  Understanding how profit and loss is calculated helps you interpret the results:
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">üìà For Stocks:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">Position Size:</strong> $1,000 per trade
                    </div>
                    <div>
                      <strong className="text-white">Shares:</strong> $1,000 √∑ Entry Price
                    </div>
                    <div>
                      <strong className="text-white">P&L (LONG):</strong> (Current Price - Entry Price) √ó Shares
                    </div>
                    <div>
                      <strong className="text-white">P&L (SHORT):</strong> (Entry Price - Current Price) √ó Shares
                    </div>
                  </div>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üìä For Futures:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-2">
                    <div>
                      <strong className="text-white">Contracts:</strong> Usually 1 contract per trade
                    </div>
                    <div>
                      <strong className="text-white">Point Value:</strong> Each futures contract has a point value:
                      <ul className="list-disc list-inside ml-4 mt-1">
                        <li>NQ1! (Nasdaq): $20 per point</li>
                        <li>ES1! (S&P 500): $50 per point</li>
                        <li>Other futures vary</li>
                      </ul>
                    </div>
                    <div>
                      <strong className="text-white">P&L:</strong> (Price Change) √ó Contracts √ó Point Value
                    </div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <h3 className="text-yellow-400 font-semibold mb-2">üéØ Example:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div><strong className="text-white">Stock Trade:</strong> AAPL at $150 entry, $155 current</div>
                    <div className="ml-4">Shares: $1,000 √∑ $150 = 6.67 shares</div>
                    <div className="ml-4">P&L: ($155 - $150) √ó 6.67 = <span className="text-green-400">+$33.35</span></div>
                    <div className="mt-2"><strong className="text-white">Futures Trade:</strong> NQ1! at 15,000 entry, 15,100 current</div>
                    <div className="ml-4">Price Change: 15,100 - 15,000 = 100 points</div>
                    <div className="ml-4">P&L: 100 √ó 1 √ó $20 = <span className="text-green-400">+$2,000</span></div>
                  </div>
                </div>
              </div>
            ),
          },
          {
            title: "Tracking & Analytics üìä",
            content: (
              <div className="space-y-4">
                <p className="text-[#e7ecff]">
                  The Trade Tracker provides powerful analytics to help you learn:
                </p>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">üìà Performance Metrics:</h3>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1">
                    <li><strong className="text-white">Win Rate:</strong> Percentage of winning trades</li>
                    <li><strong className="text-white">Total P&L:</strong> Sum of all profits and losses</li>
                    <li><strong className="text-white">Average Win/Loss:</strong> Average profit per win vs loss</li>
                    <li><strong className="text-white">Best/Worst Trade:</strong> Your biggest winners and losers</li>
                  </ul>
                </div>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-2">üîç Filter by Version:</h3>
                  <p className="text-sm text-[#93a4d6] mb-2">
                    Use the "Model Version" dropdown to compare performance across different versions of the trading model.
                    This helps you see which improvements work best.
                  </p>
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-white">Tip:</strong> Newer versions often include improvements, 
                    but older versions may have proven track records.
                  </p>
                </div>
                <div className="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
                  <h3 className="text-purple-400 font-semibold mb-2">üìä Daily Summary:</h3>
                  <p className="text-sm text-[#93a4d6]">
                    Click "View Daily Summary" to see performance breakdowns by:
                  </p>
                  <ul className="text-sm text-[#93a4d6] list-disc list-inside space-y-1 mt-2">
                    <li>Rank ranges (which ranked setups perform best)</li>
                    <li>Risk/Reward ratios (which RR ratios win more)</li>
                    <li>Quadrants (which chart zones are most profitable)</li>
                    <li>Overall statistics and insights</li>
                  </ul>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Remember:</strong> The goal is to learn which setups work best. 
                    Review your wins and losses regularly to improve your trading strategy!
                  </p>
                </div>
              </div>
            ),
          },
          {
            title: "Putting It All Together üéì",
            content: (
              <div className="space-y-4">
                <p className="text-lg text-[#e7ecff]">
                  Here's your <strong className="text-yellow-400">workflow</strong> for using the Trade Tracker:
                </p>
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
                  <h3 className="text-blue-400 font-semibold mb-3">üìã Daily Workflow:</h3>
                  <ol className="text-sm text-[#93a4d6] list-decimal list-inside space-y-3">
                    <li>
                      <strong className="text-white">Monitor Open Trades</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Check the "Open Trades" section regularly</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Watch P&L update in real-time</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Click trades to see detailed information</span>
                    </li>
                    <li>
                      <strong className="text-white">Review Closed Trades</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Check "Closed Trades" to see final results</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Review trade history to understand what happened</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Learn from both wins and losses</span>
                    </li>
                    <li>
                      <strong className="text-white">Analyze Performance</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Use the version filter to compare models</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Check daily summary for insights</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Look for patterns in winning vs losing trades</span>
                    </li>
                    <li>
                      <strong className="text-white">Improve Your Strategy</strong>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Focus on setups with high win rates</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Avoid setups that consistently lose</span>
                      <br />
                      <span className="text-xs ml-4">‚Ä¢ Adjust filters on the main dashboard based on results</span>
                    </li>
                  </ol>
                </div>
                <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
                  <h3 className="text-green-400 font-semibold mb-2">‚≠ê Key Takeaways:</h3>
                  <div className="text-sm text-[#93a4d6] space-y-1">
                    <div>‚úÖ Trades are created automatically from alerts</div>
                    <div>‚úÖ Each trade uses $1,000 position size</div>
                    <div>‚úÖ P&L updates in real-time for open trades</div>
                    <div>‚úÖ Trades close automatically at SL or TP</div>
                    <div>‚úÖ Use analytics to learn which setups work best</div>
                  </div>
                </div>
                <div className="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
                  <p className="text-sm text-[#93a4d6]">
                    <strong className="text-yellow-400">Ready to start tracking?</strong> The Trade Tracker refreshes every 30 seconds 
                    to show the latest trades and updates. Click "Start Tracking!" to begin!
                  </p>
                </div>
              </div>
            ),
          },
        ];

        const nextStep = () => {
          if (currentStep < steps.length - 1) {
            setCurrentStep(currentStep + 1);
          }
        };

        const prevStep = () => {
          if (currentStep > 0) {
            setCurrentStep(currentStep - 1);
          }
        };

        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-[#0b1020] border-2 border-[#26325f] rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
              <div className="bg-gradient-to-r from-blue-500/20 to-purple-500/20 border-b border-[#26325f] p-6 flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-white mb-1">{steps[currentStep].title}</h2>
                  <div className="flex gap-1">
                    {steps.map((_, i) => (
                      <div
                        key={i}
                        className={`h-2 w-2 rounded-full transition-all ${
                          i === currentStep
                            ? "bg-blue-400 w-8"
                            : i < currentStep
                            ? "bg-green-400"
                            : "bg-[#26325f]"
                        }`}
                      />
                    ))}
                  </div>
                </div>
                <button
                  onClick={onClose}
                  className="text-[#93a4d6] hover:text-white text-2xl font-bold w-8 h-8 flex items-center justify-center rounded hover:bg-[#26325f] transition-colors"
                  title="Close Welcome Guide"
                >
                  √ó
                </button>
              </div>
              <div className="flex-1 overflow-y-auto p-6">
                {steps[currentStep].content}
              </div>
              <div className="border-t border-[#26325f] p-4 flex items-center justify-between bg-[#0f1630]">
                <button
                  onClick={prevStep}
                  disabled={currentStep === 0}
                  className={`px-4 py-2 rounded-lg border transition-all ${
                    currentStep === 0
                      ? "border-[#26325f] text-[#93a4d6] opacity-50 cursor-not-allowed"
                      : "border-[#26325f] bg-[#1a2550] hover:bg-[#26325f] text-white"
                  }`}
                >
                  ‚Üê Previous
                </button>
                <div className="text-sm text-[#93a4d6]">
                  Step {currentStep + 1} of {steps.length}
                </div>
                {currentStep < steps.length - 1 ? (
                  <button
                    onClick={nextStep}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold transition-all"
                  >
                    Next ‚Üí
                  </button>
                ) : (
                  <button
                    onClick={onClose}
                    className="px-6 py-2 rounded-lg bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold transition-all"
                  >
                    Start Tracking! üöÄ
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Main App
      // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function App() {
        const { data, loading, error, lastUpdate, refetch } = useTickerData();
        const { trades, loading: tradesLoading, error: tradesError, addTrade, updateTrade, refetch: refetchTrades } = useSimulatedTrades();
        
        // Welcome Guide state
        const [showWelcomeDashboard, setShowWelcomeDashboard] = useState(false);
        const [showWelcomeTracker, setShowWelcomeTracker] = useState(() => {
          const hasSeenWelcome = localStorage.getItem("timedTrading_welcomeSeen");
          return !hasSeenWelcome;
        });
        
        const handleWelcomeDashboardClose = () => {
          setShowWelcomeDashboard(false);
        };
        
        const handleWelcomeTrackerClose = () => {
          setShowWelcomeTracker(false);
          localStorage.setItem("timedTrading_welcomeSeen", "true");
        };
        
        // Version filter state
        const [selectedVersion, setSelectedVersion] = useState("all");
        
        // Daily summary state
        const [dailySummary, setDailySummary] = useState(null);
        const [summaryLoading, setSummaryLoading] = useState(false);
        const [showSummary, setShowSummary] = useState(false);
        
        // Selected ticker for detail view
        const [selectedTicker, setSelectedTicker] = useState(null);
        
        // Selected trade for history modal
        const [selectedTrade, setSelectedTrade] = useState(null);
        
        // Get unique versions from trades (for dropdown)
        const availableVersions = useMemo(() => {
          const versionSet = new Set(trades.map(t => t.scriptVersion || "unknown").filter(Boolean));
          return Array.from(versionSet).sort().reverse(); // Most recent first
        }, [trades]);
        
        // Filter trades by version (client-side), remove duplicates, and sort alphabetically
        const filteredTrades = useMemo(() => {
          let filtered = selectedVersion === "all" ? trades : trades.filter(t => (t.scriptVersion || "unknown") === selectedVersion);
          
          // Remove duplicates: keep the most recent trade for each ticker+direction combination
          const tradeMap = new Map();
          filtered.forEach(trade => {
            const key = `${trade.ticker}_${trade.direction}`;
            const existing = tradeMap.get(key);
            if (!existing) {
              tradeMap.set(key, trade);
            } else {
              // Keep the most recent one (by entryTime)
              const existingTime = new Date(existing.entryTime || 0).getTime();
              const currentTime = new Date(trade.entryTime || 0).getTime();
              if (currentTime > existingTime) {
                tradeMap.set(key, trade);
              }
            }
          });
          
          // Convert back to array and sort alphabetically by ticker
          filtered = Array.from(tradeMap.values());
          filtered.sort((a, b) => {
            const tickerA = String(a.ticker || "").toUpperCase();
            const tickerB = String(b.ticker || "").toUpperCase();
            return tickerA.localeCompare(tickerB);
          });
          
          return filtered;
        }, [trades, selectedVersion]);
        
        const analytics = useTradeAnalytics(filteredTrades);

        // Trade simulation is handled by Worker - just refresh trades periodically
        useEffect(() => {
          // Initial fetch on mount
          refetchTrades();
          
          // Refresh trades every 30 seconds to get latest updates from Worker
          const refreshInterval = setInterval(() => {
            refetchTrades();
          }, 30000);
          
          return () => clearInterval(refreshInterval);
        }, [refetchTrades]);

        // Fetch daily summary
        const fetchDailySummary = useCallback(async () => {
          setSummaryLoading(true);
          try {
            const res = await fetch(`${API_BASE}/timed/ai/daily-summary`);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const json = await res.json();
            if (json.ok) {
              setDailySummary(json);
              setShowSummary(true);
            } else {
              throw new Error(json.error || "Failed to fetch summary");
            }
          } catch (err) {
            console.error("Daily summary error:", err);
            alert(`Failed to fetch daily summary: ${err.message}`);
          } finally {
            setSummaryLoading(false);
          }
        }, []);

        const openTrades = filteredTrades.filter((t) => t.status === "OPEN" || !t.status || t.status === "TP_HIT_TRIM");
        const closedTrades = filteredTrades.filter(
          (t) => t.status === "WIN" || t.status === "LOSS"
        );

        return (
          <>
            {/* Welcome Modals */}
            {showWelcomeDashboard && (
              <DashboardWelcomeModal onClose={handleWelcomeDashboardClose} />
            )}
            {showWelcomeTracker && (
              <TrackerWelcomeModal onClose={handleWelcomeTrackerClose} />
            )}
            
            <div className="min-h-screen p-4">
              <div className="w-full mx-auto px-2">
              {/* Navigation */}
              <nav className="mb-4 p-3 bg-[#121a33] border border-[#26325f] rounded-lg">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm text-[#93a4d6]">Navigate:</span>
                  <a
                    href="index-react.html"
                    className="px-3 py-1.5 rounded bg-[#0f1630] border border-[#26325f] text-sm hover:bg-[#1a2550] transition-colors"
                  >
                    Dashboard
                  </a>
                  <a
                    href="simulation-dashboard.html"
                    className="px-3 py-1.5 rounded bg-blue-500/20 border border-blue-500 text-sm text-blue-400 font-semibold"
                  >
                    Trade Tracker
                  </a>
                  <button
                    onClick={() => setShowWelcomeDashboard(true)}
                    className="px-3 py-1.5 rounded bg-purple-500/20 border border-purple-500 text-sm text-purple-400 font-semibold hover:bg-purple-500/30 transition-colors"
                    title="Show Dashboard Guide (Trading Concepts)"
                  >
                    üìö Dashboard Guide
                  </button>
                  <button
                    onClick={() => setShowWelcomeTracker(true)}
                    className="px-3 py-1.5 rounded bg-blue-500/20 border border-blue-500 text-sm text-blue-400 font-semibold hover:bg-blue-500/30 transition-colors"
                    title="Show Trade Tracker Guide (Simulated Trades)"
                  >
                    üìä Trade Tracker Guide
                  </button>
                </div>
              </nav>

              {/* Version Filter */}
              <div className="mb-4 p-3 bg-[#121a33] border border-[#26325f] rounded-lg">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm text-[#93a4d6]">Model Version:</span>
                  <select
                    value={selectedVersion}
                    onChange={(e) => setSelectedVersion(e.target.value)}
                    className="px-3 py-1.5 rounded bg-[#0f1630] border border-[#26325f] text-sm text-white hover:bg-[#1a2550] transition-colors"
                  >
                    <option value="all">All Versions ({trades.length} trades)</option>
                    {availableVersions.map((v) => {
                      const count = trades.filter(t => (t.scriptVersion || "unknown") === v).length;
                      return (
                        <option key={v} value={v}>
                          {v} ({count} trades)
                        </option>
                      );
                    })}
                  </select>
                  {selectedVersion !== "all" && (
                    <span className="text-xs text-[#93a4d6]">
                      Showing {filteredTrades.length} of {trades.length} trades
                    </span>
                  )}
                </div>
              </div>

              {/* Header */}
              <header className="mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h1 className="text-3xl font-bold">
                    Timed Trading ‚Äî Trade Tracker
                  </h1>
                  <div className="flex items-center gap-4">
                    {(loading || tradesLoading) && <div className="loading-spinner"></div>}
                    <button
                      onClick={() => { refetch(); refetchTrades(); }}
                      className="px-4 py-2 bg-[#1a2550] border border-[#26325f] rounded-lg hover:bg-[#26325f] transition-colors"
                    >
                      Refresh
                    </button>
                    <button
                      onClick={fetchDailySummary}
                      disabled={summaryLoading}
                      className="px-4 py-2 bg-blue-500/20 border border-blue-500 rounded-lg hover:bg-blue-500/30 transition-colors text-blue-400 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {summaryLoading ? "Loading..." : "üìä Daily Summary"}
                    </button>
                    {lastUpdate && (
                      <span className="text-sm text-[#93a4d6]">
                        Updated {lastUpdate.toLocaleTimeString()}
                      </span>
                    )}
                  </div>
                </div>
              </header>

              {/* Daily Summary Modal */}
              {showSummary && dailySummary && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-[#121a33] border border-[#26325f] rounded-xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="flex items-center justify-between mb-4">
                      <h2 className="text-2xl font-bold">üìä Daily Summary - {new Date(dailySummary.stats.date).toLocaleDateString()}</h2>
                      <button
                        onClick={() => setShowSummary(false)}
                        className="text-[#93a4d6] hover:text-white text-xl"
                      >
                        ‚úï
                      </button>
                    </div>
                    
                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">New Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.newTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Closed Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.closedTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Trimmed Trades</div>
                        <div className="text-xl font-bold text-white">{dailySummary.stats.trimmedTrades}</div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Win Rate</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.winRate >= 50 ? "text-green-400" : "text-red-400"}`}>
                          {dailySummary.stats.winRate}%
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Closed P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.closedPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          ${dailySummary.stats.closedPnl}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Open P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.openPnl >= 0 ? "text-green-400" : "text-yellow-400"}`}>
                          ${dailySummary.stats.openPnl}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] p-3 rounded-lg border border-[#26325f]">
                        <div className="text-xs text-[#93a4d6]">Total P&L</div>
                        <div className={`text-xl font-bold ${dailySummary.stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                          ${dailySummary.stats.totalPnl}
                        </div>
                      </div>
                    </div>

                    {/* AI Summary */}
                    <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-6 mb-4">
                      <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                        <span className="text-2xl">ü§ñ</span>
                        <span>AI Analysis & Recommendations</span>
                      </h3>
                      <div className="text-sm text-[#e7ecff] leading-relaxed">
                        {(() => {
                          // Enhanced markdown renderer
                          const renderMarkdown = (text) => {
                            const parts = [];
                            let currentIndex = 0;
                            
                            // Split by double newlines for paragraphs
                            const paragraphs = text.split(/\n\n+/);
                            
                            return paragraphs.map((paragraph, pIdx) => {
                              if (!paragraph.trim()) return null;
                              
                              // Headers (## or ###)
                              const headerMatch = paragraph.trim().match(/^(#{2,3})\s+(.+)$/m);
                              if (headerMatch) {
                                const level = headerMatch[1].length;
                                const content = headerMatch[2];
                                return React.createElement(
                                  level === 2 ? 'h2' : 'h3',
                                  {
                                    key: pIdx,
                                    className: level === 2
                                      ? 'text-lg font-bold mt-6 mb-3 text-white border-b border-[#26325f] pb-2 first:mt-0'
                                      : 'text-base font-semibold mt-4 mb-2 text-white'
                                  },
                                  content
                                );
                              }
                              
                              // Lists (bulleted or numbered)
                              if (paragraph.trim().match(/^[-*‚Ä¢]\s+/m) || paragraph.trim().match(/^\d+\.\s+/m)) {
                                const listItems = paragraph.split('\n').filter(l => l.trim());
                                const isOrdered = listItems[0]?.trim().match(/^\d+\./);
                                
                                return React.createElement(
                                  isOrdered ? 'ol' : 'ul',
                                  {
                                    key: pIdx,
                                    className: 'list-none space-y-2 my-3 ml-4'
                                  },
                                  listItems.map((item, iIdx) => {
                                    const cleanItem = item.replace(/^[-*‚Ä¢]\s+/, '').replace(/^\d+\.\s+/, '');
                                    return React.createElement('li', {
                                      key: iIdx,
                                      className: 'flex items-start gap-2'
                                    }, [
                                      React.createElement('span', {
                                        key: 'bullet',
                                        className: 'text-blue-400 mt-1.5 flex-shrink-0'
                                      }, isOrdered ? `${iIdx + 1}.` : '‚Ä¢'),
                                      React.createElement('span', {
                                        key: 'content',
                                        className: 'flex-1',
                                        dangerouslySetInnerHTML: {
                                          __html: formatInlineMarkdown(cleanItem)
                                        }
                                      })
                                    ]);
                                  })
                                );
                              }
                              
                              // Regular paragraph
                              return React.createElement('div', {
                                key: pIdx,
                                className: 'mb-4 last:mb-0'
                              }, paragraph.split('\n').map((line, lIdx) => {
                                if (!line.trim()) {
                                  return React.createElement('br', { key: lIdx });
                                }
                                
                                // Check for special formatting patterns
                                const isBoldLine = line.match(/^\*\*(.+)\*\*$/);
                                if (isBoldLine) {
                                  return React.createElement('p', {
                                    key: lIdx,
                                    className: 'font-semibold text-white mb-2'
                                  }, isBoldLine[1]);
                                }
                                
                                // Check for emoji-prefixed lines (opportunities, warnings, etc.)
                                const emojiMatch = line.match(/^([üéØ‚ö†Ô∏èüìäüí°üöÄ]+)\s+(.+)$/);
                                if (emojiMatch) {
                                  const emoji = emojiMatch[1];
                                  const content = emojiMatch[2];
                                  const bgColor = emoji.includes('üéØ') ? 'bg-blue-500/10 border-blue-500/30' :
                                                  emoji.includes('‚ö†Ô∏è') ? 'bg-yellow-500/10 border-yellow-500/30' :
                                                  emoji.includes('üìä') ? 'bg-purple-500/10 border-purple-500/30' :
                                                  emoji.includes('üí°') ? 'bg-green-500/10 border-green-500/30' :
                                                  'bg-[#26325f]/50 border-[#26325f]';
                                  
                                  return React.createElement('div', {
                                    key: lIdx,
                                    className: `flex items-start gap-3 p-3 rounded-lg border ${bgColor} mb-2`
                                  }, [
                                    React.createElement('span', {
                                      key: 'emoji',
                                      className: 'text-xl flex-shrink-0'
                                    }, emoji),
                                    React.createElement('div', {
                                      key: 'content',
                                      className: 'flex-1',
                                      dangerouslySetInnerHTML: {
                                        __html: formatInlineMarkdown(content)
                                      }
                                    })
                                  ]);
                                }
                                
                                return React.createElement('p', {
                                  key: lIdx,
                                  className: 'mb-2 leading-relaxed',
                                  dangerouslySetInnerHTML: {
                                    __html: formatInlineMarkdown(line) || '&nbsp;'
                                  }
                                });
                              }));
                            });
                          };
                          
                          // Format inline markdown (bold, code, links, etc.)
                          const formatInlineMarkdown = (text) => {
                            let formatted = text;
                            
                            // Bold (**text**)
                            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>');
                            
                            // Inline code (`code`)
                            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-[#26325f] px-1.5 py-0.5 rounded text-xs font-mono text-blue-300">$1</code>');
                            
                            // Links [text](url) - not common in AI responses but good to have
                            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-400 hover:text-blue-300 underline" target="_blank" rel="noopener noreferrer">$1</a>');
                            
                            // Ticker symbols (uppercase 2-5 letter codes)
                            formatted = formatted.replace(/\b([A-Z]{2,5})\b/g, '<span class="font-semibold text-blue-300">$1</span>');
                            
                            // Numbers with $ (prices)
                            formatted = formatted.replace(/\$(\d+\.?\d*)/g, '<span class="text-green-400 font-medium">$$1</span>');
                            
                            // Percentages
                            formatted = formatted.replace(/(\d+\.?\d*)%/g, '<span class="text-yellow-400 font-medium">$1%</span>');
                            
                            // RR ratios (X:1 or 1:X)
                            formatted = formatted.replace(/(\d+\.?\d*):1/g, '<span class="text-purple-400 font-medium">$1:1</span>');
                            
                            // Table separators (|)
                            formatted = formatted.replace(/\|/g, '<span class="text-[#6b7a9f] mx-1">|</span>');
                            
                            return formatted;
                          };
                          
                          return renderMarkdown(dailySummary.summary);
                        })()}
                      </div>
                    </div>

                    {/* Performance Breakdown */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                        <h4 className="text-sm font-semibold mb-2">Performance by Rank</h4>
                        <div className="space-y-1 text-xs">
                          {Object.entries(dailySummary.stats.rankAnalysis || {}).map(([range, stats]) => (
                            <div key={range} className="flex justify-between">
                              <span className="text-[#93a4d6]">{range}:</span>
                              <span className={`font-semibold ${stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                {stats.wins}W/{stats.losses}L (${stats.totalPnl.toFixed(2)})
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="bg-[#0f1630] border border-[#26325f] rounded-lg p-4">
                        <h4 className="text-sm font-semibold mb-2">Performance by RR</h4>
                        <div className="space-y-1 text-xs">
                          {Object.entries(dailySummary.stats.rrAnalysis || {}).map(([range, stats]) => (
                            <div key={range} className="flex justify-between">
                              <span className="text-[#93a4d6]">{range}:</span>
                              <span className={`font-semibold ${stats.totalPnl >= 0 ? "text-green-400" : "text-red-400"}`}>
                                {stats.wins}W/{stats.losses}L (${stats.totalPnl.toFixed(2)})
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Analytics */}
              <div className="mb-6">
                <AnalyticsPanel analytics={analytics} />
              </div>

              {/* Trades Table with Right Rail Detail View */}
              <div className="flex gap-4 items-start relative">
                {/* Table Container - Left Side */}
                <div className={`flex-1 bg-[#121a33] border border-[#26325f] rounded-xl p-4 transition-all ${selectedTicker ? 'mr-[470px]' : ''}`}>
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-bold">Simulated Trades</h2>
                    <div className="flex gap-2 text-sm">
                      <span className="px-3 py-1 rounded bg-[#0f1630]">
                        Open: {openTrades.length}
                      </span>
                      <span className="px-3 py-1 rounded bg-[#0f1630]">
                        Closed: {closedTrades.length}
                      </span>
                    </div>
                  </div>
                  <div className="overflow-x-auto -mx-4 px-4">
                    <table className="w-full min-w-full">
                      <thead>
                        <tr className="border-b border-[#26325f] text-left">
                          <th className="p-2 text-xs text-[#93a4d6]">Ticker</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Direction</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Entry</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Current</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Entry Time</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Qty</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Market Value</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Trimmed</th>
                          <th className="p-2 text-xs text-[#93a4d6]">SL</th>
                          <th className="p-2 text-xs text-[#93a4d6]">TP</th>
                          <th className="p-2 text-xs text-[#93a4d6]">RR</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Score</th>
                          <th className="p-2 text-xs text-[#93a4d6]">P&L</th>
                          <th className="p-2 text-xs text-[#93a4d6]">P&L %</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Status</th>
                          <th className="p-2 text-xs text-[#93a4d6]">Version</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredTrades.length === 0 ? (
                          <tr>
                            <td colSpan="16" className="p-8 text-center text-[#93a4d6]">
                              {selectedVersion === "all" 
                                ? "No trades yet. Trades will be automatically created when alerts trigger."
                                : `No trades found for version ${selectedVersion}.`}
                            </td>
                          </tr>
                        ) : (
                          filteredTrades.map((trade) => (
                            <TradeRow 
                              key={trade.id} 
                              trade={trade} 
                              onTickerClick={(ticker) => {
                                setSelectedTicker(ticker);
                                setSelectedTrade(null); // Clear trade selection when selecting ticker
                              }}
                              onTradeClick={(trade) => {
                                // When clicking a trade, show both ticker and trade
                                setSelectedTicker(trade.ticker);
                                setSelectedTrade(trade);
                              }}
                            />
                          ))
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Right Rail - Detail View (slides in from right, fixed to viewport) */}
                {(selectedTicker || selectedTrade) && (
                  <div className="fixed right-0 top-0 w-[450px] h-screen bg-[#0f1630] border-l border-[#26325f] z-40 slide-in-right shadow-2xl overflow-y-auto">
                    <TickerDetailsLoader 
                      tickerSymbol={selectedTrade ? selectedTrade.ticker : selectedTicker}
                      trade={selectedTrade}
                      onClose={() => {
                        setSelectedTrade(null);
                        setSelectedTicker(null);
                      }}
                      allLoadedData={data}
                    />
                  </div>
                )}
              </div>
            </div>
          </div>
          </>
        );
      }

      // Render
      try {
        if (typeof React === "undefined" || typeof ReactDOM === "undefined") {
          throw new Error("React or ReactDOM not loaded");
        }

        const rootElement = document.getElementById("root");
        if (!rootElement) {
          throw new Error("Root element not found");
        }

        if (ReactDOM.createRoot) {
          const root = ReactDOM.createRoot(rootElement);
          root.render(<App />);
        } else {
          ReactDOM.render(<App />, rootElement);
        }
      } catch (error) {
        console.error("Error rendering app:", error);
        document.getElementById("root").innerHTML = `
          <div style="padding: 40px; text-align: center; color: #e7ecff;">
            <h2 style="color: #e74c3c;">Error Loading Dashboard</h2>
            <p>${error.message}</p>
            <p style="margin-top: 20px; color: #93a4d6;">
              Please check the browser console (F12) for details.
            </p>
          </div>
        `;
      }
    </script>
  </body>
</html>

