name = "timed-trading-ingest"
main = "index.js"
compatibility_date = "2024-01-01"

# Top-level bindings (used when deploying without --env flag)
[[kv_namespaces]]
binding = "KV_TIMED"
id = "e48593af3ef74bf986b2592909ed40cb"

[[d1_databases]]
binding = "DB"
database_name = "timed-trading-ledger"
database_id = "99fae5d6-98df-4e29-bab5-0665cac7a9ff"

# Durable Object: PriceHub — real-time WebSocket price + scoring push
[[durable_objects.bindings]]
name = "PRICE_HUB"
class_name = "PriceHub"

# Durable Object: AlpacaStream — real-time Alpaca WebSocket price streaming
[[durable_objects.bindings]]
name = "ALPACA_STREAM"
class_name = "AlpacaStream"

[[migrations]]
tag = "v1"
new_classes = ["PriceHub"]

[[migrations]]
tag = "v2"
new_classes = ["AlpacaStream"]

[vars]
DISCORD_ENABLE = "true"
ALERT_MIN_RR = "1.5"
ALERT_MAX_COMPLETION = "0.4"
ALERT_MAX_PHASE = "0.6"
ALERT_MIN_RANK = "70"
OPENAI_MODEL = "gpt-3.5-turbo"
CORS_ALLOW_ORIGIN = "*"
TV_ACK_ALWAYS_200 = "true"
ALPACA_ENABLED = "true"
EXECUTION_MODE = "simulation"
ALPACA_BASE_URL = "https://paper-api.alpaca.markets"
CF_ACCESS_TEAM_DOMAIN = "timedtrading"
ADMIN_EMAIL = "shashant@gmail.com"
# ── Dynamic Position Sizing (risk-based) ──
# Uncomment and adjust to override defaults:
# SIZING_BASE_RISK_PCT = "0.01"    # 1% of account per trade (baseline)
# SIZING_MIN_RISK_PCT = "0.005"    # 0.5% minimum (low confidence)
# SIZING_MAX_RISK_PCT = "0.02"     # 2% maximum (highest confidence)
# SIZING_MIN_NOTIONAL = "500"      # $500 floor per trade
# SIZING_MAX_NOTIONAL = "8000"     # $8,000 ceiling per trade
# SIZING_VIX_HIGH = "25"           # Scale down above this VIX level
# SIZING_VIX_EXTREME = "35"        # Aggressive scale-down above this VIX level

# Top-level triggers (used when deploying without --env flag)
# Architecture: 3 loops — Price feed, Scoring, Bar fetching
# Times: Sunday 6pm ET = 23:00 UTC, pre-market 4am ET = 09:00 UTC, close 4pm ET = 21:00 UTC
# CF Workers limit: 5 cron triggers per worker.
# Consolidate all schedules into 3 crons; handler uses time-based dispatch.
[triggers]
crons = [
  "*/1 * * * *",    # Every minute: price feed + Alpaca bar ingestion (time-gated in handler)
  "*/5 * * * *",    # Every 5 min: scoring + alerts + AI updates + investor tasks
  "0 * * * *",      # Top of hour: briefs + lifecycle + ML + ETF sync + investor hourly
  "30 * * * *",     # Half-hour: calibration run when requested (queued from POST /timed/calibration/run)
]

[env.production]
name = "timed-trading-ingest"
main = "index.js"
# Note: workers.dev subdomains don't need route configuration
# Routes are only needed for custom domains
# The worker is automatically available at: timed-trading-ingest.shashant.workers.dev

# KV Namespace binding for production
# IMPORTANT: Configure bindings in wrangler.toml to persist across deployments
# Dashboard bindings are NOT preserved when deploying via wrangler
# 
# To get your KV namespace ID:
# 1. Go to: https://dash.cloudflare.com -> Workers & Pages -> KV
# 2. Click on your namespace (e.g., "TIMED_TRADING_KV")
# 3. Copy the "Namespace ID" (long alphanumeric string)
# 4. Replace "YOUR_KV_NAMESPACE_ID" below with your actual ID
#
[[env.production.kv_namespaces]]
binding = "KV_TIMED"
id = "e48593af3ef74bf986b2592909ed40cb"

# D1 Database binding (for 7-day historical trails)
# Create via: `wrangler d1 create timed_trading_db`
# Then paste the resulting database_id below.
[[env.production.d1_databases]]
binding = "DB"
database_name = "timed-trading-ledger"
database_id = "99fae5d6-98df-4e29-bab5-0665cac7a9ff"

# Durable Object: PriceHub — real-time WebSocket price + scoring push
[[env.production.durable_objects.bindings]]
name = "PRICE_HUB"
class_name = "PriceHub"

# Durable Object: AlpacaStream — real-time Alpaca WebSocket price streaming
[[env.production.durable_objects.bindings]]
name = "ALPACA_STREAM"
class_name = "AlpacaStream"

# Environment variables (non-sensitive config - stored here for persistence)
# IMPORTANT: Secrets (API keys, webhooks) are NOT stored here for security
# Secrets must be set via Cloudflare Dashboard or `wrangler secret put`
#
# Required Secrets (set via Dashboard or CLI):
# - TIMED_API_KEY: API key for POST /timed/ingest authentication
# - DISCORD_WEBHOOK_URL: Discord webhook URL
# - OPENAI_API_KEY: OpenAI API key for AI Assistant
# - ALPACA_API_KEY_ID: Alpaca Markets API Key ID (Algo Trader+ plan)
# - ALPACA_API_SECRET_KEY: Alpaca Markets API Secret Key
# - FINNHUB_API_KEY: Finnhub API key for earnings & economic calendar (Daily Brief)
#
# Environment Variables (non-sensitive - stored in wrangler.toml):
# Required Secrets for Cloudflare Access (set via `wrangler secret put --env production`):
# - CF_ACCESS_AUD: Application Audience (AUD) tag from Zero Trust dashboard
#
# Non-sensitive Access config (stored here):
# CF_ACCESS_TEAM_DOMAIN: Your Cloudflare Zero Trust team domain (e.g., "myteam")
# ADMIN_EMAIL: Email address of the admin user (auto-promoted to admin role)

[env.production.vars]
DISCORD_ENABLE = "true"
ALERT_MIN_RR = "1.5"
ALERT_MAX_COMPLETION = "0.4"
ALERT_MAX_PHASE = "0.6"
ALERT_MIN_RANK = "70"
OPENAI_MODEL = "gpt-3.5-turbo"
CORS_ALLOW_ORIGIN = "*"
TV_ACK_ALWAYS_200 = "true"
ALPACA_ENABLED = "true"
EXECUTION_MODE = "simulation"
ALPACA_BASE_URL = "https://paper-api.alpaca.markets"
# Cloudflare Access — user auth via Google SSO / One-time PIN
CF_ACCESS_TEAM_DOMAIN = "timedtrading"
ADMIN_EMAIL = "shashant@gmail.com"

# Scheduled triggers — mirrors top-level [triggers] above
[env.production.triggers]
crons = [
  "*/1 * * * *",
  "*/5 * * * *",
  "0 * * * *",
  "30 * * * *",
]

